Notebook[{

Cell[CellGroupData[{
Cell[TextData[{
 "       ",
 StyleBox["xLightCone",
  FontSize->36],
 StyleBox["    ",
  FontSize->24]
}], "Title",
 InitializationCell->True,
 FontSize->48],

Cell[CellGroupData[{

Cell["Authors", "Subsection",
 InitializationCell->True,
 FontSize->18],

Cell["\<\
Obinna Umeh & Cyril Pitrou

umeobinna@gmail.com
cyril.pitrou@ens-lyon.org

2014-\
\>", "Text"],

Cell[CellGroupData[{

Cell["Dates and versions", "Subsubsection"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Date", "[", "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
  "2014", ",", "9", ",", "26", ",", "11", ",", "23", ",", 
   "43.964404`8.395676167486464"}], "}"}]], "Output"]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"xAct`xLightCone`$Version", "=", 
   RowBox[{"{", 
    RowBox[{"\"\<0.0.1\>\"", ",", 
     RowBox[{"{", 
      RowBox[{"2014", ",", "09", ",", "29"}], "}"}]}], "}"}]}], 
  ";"}]], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{"xAct`xLightCone`$xTensorVersionExpected", "=", 
   RowBox[{"{", 
    RowBox[{"\"\<1.1.1\>\"", ",", 
     RowBox[{"{", 
      RowBox[{"2014", ",", "9", ",", "28"}], "}"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"xAct`xLightCone`$xPertVersionExpected", "=", 
   RowBox[{"{", 
    RowBox[{"\"\<1.0.5\>\"", ",", 
     RowBox[{"{", 
      RowBox[{"2014", ",", "9", ",", "28"}], "}"}]}], "}"}]}], 
  ";"}]}], "Input",
 InitializationCell->True],

Cell["", "Text"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["1. Initialization", "Subsection",
 InitializationCell->True,
 FontColor->RGBColor[
  0.20389105058365758`, 0.38530556191348136`, 0.9685969329365988]],

Cell[CellGroupData[{

Cell["1.1. GPL", "Subsubsection"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{"xLightCone", ":"}], "  ", "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{"Copyright", " ", 
      RowBox[{"(", "C", ")"}], " ", "2014"}], "-", " ", 
     RowBox[{"Obinna", " ", "Umeh"}]}], ",", " ", 
    RowBox[{"Cyril", " ", "Pitrou"}]}], " ", "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{
     "This", " ", "program", " ", "is", " ", "free", " ", "software"}], ";", 
     " ", 
     RowBox[{"you", " ", "can", " ", "redistribute", " ", "it", " ", 
      RowBox[{"and", "/", "or"}], "\[IndentingNewLine]", " ", "modify", " ", 
      "it", " ", "under", " ", "the", " ", "terms", " ", "of", " ", "the", 
      " ", "GNU", " ", "General", " ", "Public", " ", "License", " ", "as", 
      "\[IndentingNewLine]", " ", "published", " ", "by", " ", "the", " ", 
      "Free", " ", "Software", " ", "Foundation"}], ";", " ", 
     RowBox[{
     "either", " ", "version", " ", "2", " ", "of", "\[IndentingNewLine]", 
      " ", "the", " ", "License"}]}], ",", 
    RowBox[{"or", " ", 
     RowBox[{"(", 
      RowBox[{"at", " ", "your", " ", "option"}], ")"}], " ", "any", " ", 
     "later", " ", 
     RowBox[{
     "version", ".", "\[IndentingNewLine]", "\[IndentingNewLine]", "This"}], 
     " ", "program", " ", "is", " ", "distributed", " ", "in", " ", "the", 
     " ", "hope", " ", "that", " ", "it", " ", "will", " ", "be", " ", 
     "useful"}], ",", "\[IndentingNewLine]", "  ", 
    RowBox[{
     RowBox[{"but", " ", "WITHOUT", " ", "ANY", " ", "WARRANTY"}], ";", " ", 
     RowBox[{
     "without", " ", "even", " ", "the", " ", "implied", " ", "warranty", " ",
       "of", "\[IndentingNewLine]", " ", "MERCHANTABILITY", " ", "or", " ", 
      "FITNESS", " ", "FOR", " ", "A", " ", "PARTICULAR", " ", 
      RowBox[{"PURPOSE", ".", " ", "See"}], " ", "the", " ", "GNU", 
      "\[IndentingNewLine]", " ", "General", " ", "Public", " ", "License", 
      " ", "for", " ", "more", " ", 
      RowBox[{
      "details", ".", "\[IndentingNewLine]", "\[IndentingNewLine]", "You"}], 
      " ", "should", " ", "have", " ", "received", " ", "a", " ", "copy", " ",
       "of", " ", "the", " ", "GNU", " ", "General", " ", "Public", " ", 
      "License", "\[IndentingNewLine]", " ", "along", " ", "with", " ", 
      "this", " ", "program"}], ";", " ", 
     RowBox[{"if", " ", "not"}]}], ",", " ", 
    RowBox[{
    "write", " ", "to", " ", "the", " ", "Free", " ", "Software", 
     "\[IndentingNewLine]", " ", "Foundation"}], ",", " ", 
    RowBox[{"Inc", "."}], ",", " ", 
    RowBox[{
     RowBox[{"59", " ", "Temple", " ", "Place"}], "-", 
     RowBox[{"Suite", " ", "330"}]}], ",", " ", "Boston", ",", " ", 
    RowBox[{
     RowBox[{"MA", " ", "02111"}], "-", "1307"}], ",", "\[IndentingNewLine]", 
    "  ", 
    RowBox[{"USA", "."}]}], " ", "\[IndentingNewLine]", "*)"}]}]], "Input",
 InitializationCell->True],

Cell["", "Text"]
}, Open  ]],

Cell[CellGroupData[{

Cell["1.2. Info package", "Subsubsection"],

Cell["\<\
(* :Title: xLightCone *)

(* :Author: Obinna Umeh & Cyril Pitrou*)

(* :Context: xAct`xLightCone` *)

(* :Copyright: Obinna Umeh & Cyril Pitrou (2014-) *)

(* :Keywords: *)

(* :Source: xLightCone.nb *)

(* :Warning: *)

(* :Mathematica Version: 9.0 and later *)

(* :Limitations: *)\
\>", "Input",
 PageWidth->PaperWidth,
 CellMargins->{{60, -272}, {Inherited, Inherited}},
 InitializationCell->True],

Cell["", "Text"]
}, Open  ]],

Cell[CellGroupData[{

Cell["1.3. Begin package", "Subsubsection"],

Cell["\<\

Decide what is the last package being read:\
\>", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"Unevaluated", "[", "xAct`xCore`Private`$LastPackage", "]"}], "===",
      "xAct`xCore`Private`$LastPackage"}], ",", 
    RowBox[{
    "xAct`xCore`Private`$LastPackage", "=", "\"\<xAct`xLightCone`\>\""}]}], 
   "]"}], ";"}]], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell[BoxData["xAct`xCore`Private`$LastPackage"], "Input"],

Cell[BoxData["\<\"xAct`xLightCone`\"\>"], "Output"]
}, Open  ]],

Cell["\<\

Explicit (not hidden) import of other packages:\
\>", "Text"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{"Off", "[", 
  StyleBox[
   RowBox[{"General", "::", "nostdvar"}], "MessageName"], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{"Off", "[", 
  StyleBox[
   RowBox[{"General", "::", "nostdopt"}], "MessageName"], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{"BeginPackage", "[", 
  RowBox[{"\"\<xAct`xLightCone`\>\"", ",", 
   RowBox[{"{", 
    RowBox[{
    "\"\<xAct`xPert`\>\"", ",", "\"\<xAct`xTensor`\>\"", ",", 
     "\"\<xAct`xPerm`\>\"", ",", "\"\<xAct`xCore`\>\"", ",", 
     "\"\<xAct`ExpressionManipulation`\>\""}], "}"}]}], "]"}]}], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell[BoxData["\<\"------------------------------------------------------------\
\"\>"], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"Package xAct`xPerm`  version \"\>", 
   "\[InvisibleSpace]", "\<\"1.2.2\"\>", "\[InvisibleSpace]", "\<\", \"\>", 
   "\[InvisibleSpace]", 
   RowBox[{"{", 
    RowBox[{"2014", ",", "9", ",", "28"}], "}"}]}],
  SequenceForm["Package xAct`xPerm`  version ", "1.2.2", ", ", {2014, 9, 28}],
  
  Editable->False]], "Print"],

Cell[BoxData["\<\"CopyRight (C) 2003-2014, Jose M. Martin-Garcia, under the \
General Public License.\"\>"], "Print"],

Cell[BoxData["\<\"Connecting to external linux executable...\"\>"], "Print"],

Cell[BoxData["\<\"Connection established.\"\>"], "Print"],

Cell[BoxData["\<\"------------------------------------------------------------\
\"\>"], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"Package xAct`xTensor`  version \"\>", 
   "\[InvisibleSpace]", "\<\"1.1.1\"\>", "\[InvisibleSpace]", "\<\", \"\>", 
   "\[InvisibleSpace]", 
   RowBox[{"{", 
    RowBox[{"2014", ",", "9", ",", "28"}], "}"}]}],
  SequenceForm[
  "Package xAct`xTensor`  version ", "1.1.1", ", ", {2014, 9, 28}],
  Editable->False]], "Print"],

Cell[BoxData["\<\"CopyRight (C) 2002-2014, Jose M. Martin-Garcia, under the \
General Public License.\"\>"], "Print"],

Cell[BoxData["\<\"------------------------------------------------------------\
\"\>"], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"Package xAct`xPert`  version \"\>", 
   "\[InvisibleSpace]", "\<\"1.0.5\"\>", "\[InvisibleSpace]", "\<\", \"\>", 
   "\[InvisibleSpace]", 
   RowBox[{"{", 
    RowBox[{"2014", ",", "9", ",", "28"}], "}"}]}],
  SequenceForm["Package xAct`xPert`  version ", "1.0.5", ", ", {2014, 9, 28}],
  
  Editable->False]], "Print"],

Cell[BoxData["\<\"CopyRight (C) 2005-2014, David Brizuela, Jose M. \
Martin-Garcia and Guillermo A. Mena Marugan, under the General Public \
License.\"\>"], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"** Variable \"\>", "\[InvisibleSpace]", "$PrePrint", 
   "\[InvisibleSpace]", "\<\" assigned value \"\>", "\[InvisibleSpace]", 
   "ScreenDollarIndices"}],
  SequenceForm[
  "** Variable ", $PrePrint, " assigned value ", 
   xAct`xTensor`ScreenDollarIndices],
  Editable->False]], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"** Variable \"\>", "\[InvisibleSpace]", "$CovDFormat", 
   "\[InvisibleSpace]", "\<\" changed from \"\>", 
   "\[InvisibleSpace]", "\<\"Prefix\"\>", "\[InvisibleSpace]", "\<\" to \"\>",
    "\[InvisibleSpace]", "\<\"Postfix\"\>"}],
  SequenceForm[
  "** Variable ", xAct`xTensor`$CovDFormat, " changed from ", "Prefix", 
   " to ", "Postfix"],
  Editable->False]], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"** Option \"\>", "\[InvisibleSpace]", "AllowUpperDerivatives", 
   "\[InvisibleSpace]", "\<\" of \"\>", "\[InvisibleSpace]", "ContractMetric",
    "\[InvisibleSpace]", "\<\" changed from \"\>", "\[InvisibleSpace]", 
   "False", "\[InvisibleSpace]", "\<\" to \"\>", "\[InvisibleSpace]", "True"}],
  SequenceForm[
  "** Option ", xAct`xTensor`AllowUpperDerivatives, " of ", 
   xAct`xTensor`ContractMetric, " changed from ", False, " to ", True],
  Editable->False]], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"** Option \"\>", "\[InvisibleSpace]", "MetricOn", 
   "\[InvisibleSpace]", "\<\" of \"\>", "\[InvisibleSpace]", "MakeRule", 
   "\[InvisibleSpace]", "\<\" changed from \"\>", "\[InvisibleSpace]", "None",
    "\[InvisibleSpace]", "\<\" to \"\>", "\[InvisibleSpace]", "All"}],
  SequenceForm[
  "** Option ", xAct`xTensor`MetricOn, " of ", xAct`xTensor`MakeRule, 
   " changed from ", None, " to ", All],
  Editable->False]], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"** Option \"\>", "\[InvisibleSpace]", "ContractMetrics", 
   "\[InvisibleSpace]", "\<\" of \"\>", "\[InvisibleSpace]", "MakeRule", 
   "\[InvisibleSpace]", "\<\" changed from \"\>", "\[InvisibleSpace]", 
   "False", "\[InvisibleSpace]", "\<\" to \"\>", "\[InvisibleSpace]", "True"}],
  SequenceForm[
  "** Option ", xAct`xTensor`ContractMetrics, " of ", xAct`xTensor`MakeRule, 
   " changed from ", False, " to ", True],
  Editable->False]], "Print"]
}, Open  ]],

Cell[BoxData["\<\"xAct`xLightCone`\"\>"], "Output"]
}, Open  ]],

Cell[TextData[{
 "\nCheck version of ",
 StyleBox["xTensor",
  FontSlant->"Italic"],
 ". We simply compare dates:"
}], "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{"Not", "@", 
     RowBox[{"OrderedQ", "@", 
      RowBox[{"Map", "[", 
       RowBox[{"Last", ",", 
        RowBox[{"{", 
         RowBox[{"$xTensorVersionExpected", ",", "xAct`xTensor`$Version"}], 
         "}"}]}], "]"}]}]}], ",", 
    RowBox[{"Throw", "@", 
     RowBox[{"Message", "[", 
      RowBox[{
       RowBox[{"General", "::", "versions"}], ",", "\"\<xTensor\>\"", ",", 
       "xAct`xTensor`$Version", ",", "$xTensorVersionExpected"}], "]"}]}]}], 
   "]"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"If", "[", 
  RowBox[{
   RowBox[{"Not", "@", 
    RowBox[{"OrderedQ", "@", 
     RowBox[{"Map", "[", 
      RowBox[{"Last", ",", 
       RowBox[{"{", 
        RowBox[{"$xPertVersionExpected", ",", "xAct`xPert`$Version"}], 
        "}"}]}], "]"}]}]}], ",", 
   RowBox[{"Throw", "@", 
    RowBox[{"Message", "[", 
     RowBox[{
      RowBox[{"General", "::", "versions"}], ",", "\"\<xPert\>\"", ",", 
      "xAct`xPert`$Version", ",", "$xPertVersionExpected"}], "]"}]}]}], 
  "]"}]}], "Input",
 InitializationCell->True],

Cell["\<\

Welcome message:\
\>", "Text"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"Print", "[", "xAct`xCore`Private`bars", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Print", "[", 
   RowBox[{"\"\<Package xAct`xLightCone`  version \>\"", ",", 
    RowBox[{"$Version", "[", 
     RowBox[{"[", "1", "]"}], "]"}], ",", "\"\<, \>\"", ",", 
    RowBox[{"$Version", "[", 
     RowBox[{"[", "2", "]"}], "]"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<CopyRight (C) 2015-, Obinna Umeh under the General Public \
License.\>\"", "]"}], ";"}]}], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell[BoxData["\<\"------------------------------------------------------------\
\"\>"], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"Package xAct`xLight`  version \"\>", 
   "\[InvisibleSpace]", "\<\"0.0.1\"\>", "\[InvisibleSpace]", "\<\", \"\>", 
   "\[InvisibleSpace]", 
   RowBox[{"{", 
    RowBox[{"2014", ",", "9", ",", "29"}], "}"}]}],
  SequenceForm["Package xAct`xLight`  version ", "0.0.1", ", ", {2014, 9, 29}],
  Editable->False]], "Print"],

Cell[BoxData["\<\"CopyRight (C) 2015-, Obinna Umeh under the General Public \
License.\"\>"], "Print"]
}, Open  ]]
}, Open  ]],

Cell["\<\

We specify the context xAct`xLightConce` to avoid overriding the Disclaimer \
of the other packages. However, we need to turn off the message General:shdw \
temporarily:\
\>", "Text"],

Cell[BoxData[{
 RowBox[{"Off", "[", 
  RowBox[{"General", "::", "shdw"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"xAct`xLightCone`Disclaimer", "[", "]"}], ":=", 
  RowBox[{
  "Print", "[", 
   "\"\<These are points 11 and 12 of the General Public \
License:\\n\\nBECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO \
WARRANTY FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW. EXCEPT \
WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES \
PROVIDE THE PROGRAM `AS IS\.b4 WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED \
OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF \
MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE ENTIRE RISK AS TO \
THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU. SHOULD THE PROGRAM \
PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING, REPAIR OR \
CORRECTION.\\n\\nIN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO \
IN WRITING WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY \
AND/OR REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR \
DAMAGES, INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES \
ARISING OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT \
LIMITED TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED \
BY YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER \
PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE \
POSSIBILITY OF SUCH DAMAGES.\>\"", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{"On", "[", 
  RowBox[{"General", "::", "shdw"}], "]"}]}], "Input",
 InitializationCell->True],

Cell["\<\

If this is the last package show the GPL short disclaimer:\
\>", "Text"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
    "xAct`xCore`Private`$LastPackage", "===", "\"\<xAct`xLightCone`\>\""}], 
    ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Unset", "[", "xAct`xCore`Private`$LastPackage", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "xAct`xCore`Private`bars", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
     "Print", "[", 
      "\"\<These packages come with ABSOLUTELY NO WARRANTY; for details type \
Disclaimer[]. This is free software, and you are welcome to redistribute it \
under certain conditions. See the General Public License for details.\>\"", 
      "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "xAct`xCore`Private`bars", "]"}]}]}], "]"}], 
  ";"}]], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell[BoxData["\<\"------------------------------------------------------------\
\"\>"], "Print"],

Cell[BoxData["\<\"These packages come with ABSOLUTELY NO WARRANTY; for \
details type Disclaimer[]. This is free software, and you are welcome to \
redistribute it under certain conditions. See the General Public License for \
details.\"\>"], "Print"],

Cell[BoxData["\<\"------------------------------------------------------------\
\"\>"], "Print"]
}, Open  ]]
}, Open  ]],

Cell["\<\

Note that symbols in the Global` context cannot be accessed while building \
the package:\
\>", "Text"],

Cell[CellGroupData[{

Cell[BoxData["$ContextPath"], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"\<\"xAct`xLightCone`\"\>", ",", "\<\"xAct`xPert`\"\>", 
   ",", "\<\"xAct`xTensor`\"\>", ",", "\<\"xAct`xPerm`\"\>", 
   ",", "\<\"xAct`xCore`\"\>", ",", "\<\"xAct`ExpressionManipulation`\"\>", 
   ",", "\<\"System`\"\>"}], "}"}]], "Output"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData["$Context"], "Input"],

Cell[BoxData["\<\"xAct`xLightCone`\"\>"], "Output"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["1.4. Set up", "Subsubsection"],

Cell["\<\

Prefix format for derivatives:\
\>", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"$CovDFormat", "=", "\"\<Prefix\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Message", "[", 
   RowBox[{
    RowBox[{"General", "::", "nostdvar"}], ",", "\"\<$CovDFormat\>\"", ",", 
    "\"\<Prefix\>\""}], "]"}], ";"}]}], "Input",
 InitializationCell->True],

Cell["\<\

We do not modify the option MathLink of CanonicalPerm:\
\>", "Text"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Options", "[", "CanonicalPerm", "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"MathLink", "\[RuleDelayed]", "$xpermQ"}], ",", 
   RowBox[{"TimeVerbose", "\[Rule]", "False"}], ",", 
   RowBox[{"xPermVerbose", "\[Rule]", "False"}], ",", 
   RowBox[{"OrderedBase", "\[Rule]", "True"}]}], "}"}]], "Output"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData["$xpermQ"], "Input"],

Cell[BoxData["True"], "Output"]
}, Open  ]],

Cell["", "Text"]
}, Open  ]],

Cell[CellGroupData[{

Cell["1.5. Usage and error messages", "Subsubsection"],

Cell["\<\

Versions:\
\>", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{"**", " ", "VERSIONS"}], " ", "***)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"$Version", "::", "usage"}], "=", 
     "\"\<$Version is a global variable giving the version of the package \
xLightCone in use.\>\""}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"$xTensorVersionExpected", "::", "usage"}], "=", 
     "\"\<$xTensorVersionExpected is a global variable giving the oldest \
possible version of the package xTensor which is required by the version of \
the package xLightCone in use.\>\""}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"$xPertVersionExpected", "::", "usage"}], "=", 
     "\"\<$xPertVersionExpected is a global variable giving the oldest \
possible version of the package xPert which is required by the version of the \
package xLightCone in use.\>\""}], ";"}]}]}]], "Input",
 InitializationCell->True],

Cell["Usage Messages in Alphabetic order", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"DefMatterFields", "::", "usage"}], "  ", "=", " ", "\"\<\>\""}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"DefMetricFields", "::", "usage"}], " ", "=", " ", "\"\<\>\""}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"DefScreenProjectedTensor", "::", "usage"}], " ", "=", " ", 
    "\"\<\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"DefScreenSpaceMetric", "::", "usage"}], " ", "=", " ", 
    "\"\<\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"SetSlicingUpToScreenSpace", "::", "usage"}], " ", "=", " ", 
    "\"\<\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"SetSlicingUpToScreenSpaceObinna", "::", "usage"}], " ", "=", 
    " ", "\"\<\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 

 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"SplitMetric", " ", "::", "usage"}], " ", "=", " ", "\"\<\>\""}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ToInducedDerivativeScreenSpace", "::", "usage"}], "=", 
    "\"\<\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ToLightConeFromRules", "::", "usage"}], " ", "=", " ", 
    "\"\<\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"$DebugInfoQ", "::", "usage"}], " ", "=", " ", "\"\<\>\""}], 
  ";"}]}], "Input",
 InitializationCell->True]
}, Open  ]],

Cell[CellGroupData[{

Cell["1.6. Begin private", "Subsubsection"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Begin", "[", "\"\<xAct`xLightCone`Private`\>\"", "]"}]], "Input",
 InitializationCell->True],

Cell[BoxData["\<\"xAct`xLightCone`Private`\"\>"], "Output"]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "*", "Why", " ", "a", " ", "scalar", " ", "head", " ", "inside", " ", "a", 
    " ", "scalar", " ", 
    RowBox[{"function", "?"}]}], "**)"}], 
  RowBox[{"(*", 
   RowBox[{
   "*", "We", " ", "choose", " ", "that", " ", "the", " ", "Scalar", " ", 
    "head", " ", "should", " ", "be", " ", "removed"}], "**)"}], 
  RowBox[{
   RowBox[{
    RowBox[{"Unprotect", "[", "xAct`xTensor`NoScalar", "]"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"xAct`xTensor`NoScalar", "[", 
     RowBox[{
      RowBox[{"f_", "?", "ScalarFunctionQ"}], "[", "expr_", "]"}], "]"}], ":=", 
    RowBox[{"f", "[", 
     RowBox[{"NoScalar", "@", "expr"}], "]"}]}], "\n", 
   RowBox[{
    RowBox[{"Protect", "[", "xAct`xTensor`NoScalar", "]"}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
    "*", "To", " ", "avoid", " ", "complaints", " ", "from", " ", "MakeRule", 
     " ", "when", " ", "the", " ", "rule", " ", "has", " ", "already", " ", 
     "been", " ", "defined", " ", "and", " ", "the", " ", "lhs", " ", "is", 
     " ", 
     RowBox[{"zero", "."}]}], "**)"}], "\n", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"xAct`xTensor`MakeRule", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"lhs_", "?", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{
              RowBox[{"Evaluate", "[", "#", "]"}], "===", "0"}], "&"}], 
            ")"}]}], ",", "rhs_", ",", "conditions___"}], "}"}], ",", 
        RowBox[{"options", ":", 
         RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
      RowBox[{"{", "}"}]}], ";"}], "*)"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
     "We", " ", "create", " ", "our", " ", "own", " ", "function", " ", 
      "based", " ", "on", " ", "MakeRule"}], ",", 
     RowBox[{
     "but", " ", "separating", " ", "the", " ", "special", " ", "problematic",
       " ", 
      RowBox[{"case", ".", "This"}], " ", "avoids", " ", "overloading", " ", 
      "a", " ", "definition", " ", "from", " ", 
      RowBox[{"xTensor", ".", "It"}], " ", "does", " ", "not", " ", "change", 
      " ", "the", " ", "way", " ", "xLightCone", " ", "works"}], ",", 
     RowBox[{"but", " ", "that", " ", "way"}], ",", 
     RowBox[{
     "the", " ", "code", " ", "is", " ", "clearly", " ", "separated", " ", 
      "from", " ", 
      RowBox[{"xTensor", ".", "This"}], " ", "is", " ", "a", " ", "much", " ",
       "more", " ", "polite", " ", "way", " ", "to", " ", "modify", " ", 
      "the", " ", "behaviour", " ", "of", " ", 
      RowBox[{"xTensor", ".", "This"}], " ", "method", " ", "was", " ", 
      "advised", " ", "by", " ", "Leo", " ", "Stein"}]}], "**)"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"SetAttributes", "[", 
    RowBox[{"BuildRule", ",", "HoldFirst"}], "]"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"BuildRule", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"lhs_", "?", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{
             RowBox[{"Evaluate", "[", "#", "]"}], "===", "0"}], "&"}], 
           ")"}]}], ",", "rhs_", ",", "conditions___"}], "}"}], ",", 
       RowBox[{"options", ":", 
        RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
     RowBox[{"{", "}"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"BuildRule", "[", 
      RowBox[{"{", 
       RowBox[{"lhs_", ",", "rhs_", ",", "conditions___"}], "}"}], "]"}], ":=", 
     RowBox[{"MakeRule", "[", 
      RowBox[{"{", 
       RowBox[{"lhs", ",", "rhs", ",", "conditions"}], "}"}], "]"}]}], ";"}], 
   "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"BuildRule", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"lhs_", ",", "rhs_", ",", "conditions___"}], "}"}], ",", 
       RowBox[{"options", ":", 
        RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
     RowBox[{"MakeRule", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"lhs", ",", "rhs", ",", "conditions"}], "}"}], ",", 
       "options"}], "]"}]}], ";"}]}]}]], "Input"],

Cell["Default options and protected names", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"**", "DEFAULT"}], " ", "OPTIONS", " ", "AND", " ", "PROTECTED", 
    " ", "NAMES"}], "***)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "We", " ", "should", " ", "clean", " ", "that", " ", "to", " ", "make", 
    " ", "sure", " ", "there", " ", "are", " ", "no", " ", "usueless", " ", 
    "definitions"}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"BackgroundFieldMethod", "=", "False"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"$DebugInfoQ", "=", "False"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"$CommutecdRules", "=", 
     RowBox[{"{", "}"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"$ConformalTime", "=", "True"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"$FirstOrderVectorPerturbations", "=", "True"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"$FirstOrderTensorPerturbations", "=", "True"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"$OpenConstantsOfStructure", "=", "True"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"$PrePrint", "=", "ScreenDollarIndices"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"$SortCovDAutomatic", "=", "True"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Off", "[", 
     RowBox[{"RuleDelayed", "::", "rhs"}], "]"}], ";"}]}]}]], "Input"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Implementation", "Subsection"],

Cell[CellGroupData[{

Cell["Miscellaneous tools ", "Subsubsection"],

Cell["Private Boolean function inherited from xPand", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"**", "PRIVATE"}], " ", "BOOLEAN", " ", "FUNCTIONS"}], "***)"}], 
  RowBox[{"(*", 
   RowBox[{"*", "Miscellaneous"}], "**)"}], 
  RowBox[{
   RowBox[{
    RowBox[{"$DefInfoQ", "=", "True"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"If", " ", "set", " ", 
      RowBox[{"to", "'"}], 
      RowBox[{"False", "'"}]}], ",", 
     RowBox[{
     "the", " ", "information", " ", "messages", " ", "are", " ", "not", " ", 
      
      RowBox[{"printed", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"*", "Testing", " ", "expressions"}], "**)"}], 
   "\[IndentingNewLine]", "\n", 
   RowBox[{
    RowBox[{"AnyIndicesListQ", "[", "inds_List", "]"}], ":=", 
    RowBox[{
     RowBox[{"Cases", "[", 
      RowBox[{"inds", ",", 
       RowBox[{"AnyIndices", "[", "_", "]"}]}], "]"}], "=!=", 
     RowBox[{"{", "}"}]}]}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
     "If", " ", "the", " ", "list", " ", "of", " ", "indices", " ", 
      "contains", " ", "the", " ", 
      RowBox[{"head", "'"}], 
      RowBox[{"AnyIndices", "'"}]}], ",", 
     RowBox[{
      RowBox[{"then", " ", 
       RowBox[{"AnyIndicesListQ", "[", "inds", "]"}], " ", 
       RowBox[{"returns", "'"}], 
       RowBox[{"True", "'"}]}], ";", 
      RowBox[{"otherwise", " ", "it", " ", 
       RowBox[{"returns", "'"}], 
       RowBox[{
        RowBox[{"False", "'"}], "."}]}]}]}], "*)"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"DefTensorQ", "[", "symb_", "]"}], ":=", 
    RowBox[{
     RowBox[{"Cases", "[", 
      RowBox[{"$Tensors", ",", "symb"}], "]"}], "===", 
     RowBox[{"{", "symb", "}"}]}]}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "'"}], 
      RowBox[{"symb", "'"}], " ", "has", " ", "been", " ", "defined", " ", 
      "as", " ", "a", " ", "tensor"}], ",", 
     RowBox[{
      RowBox[{"then", " ", 
       RowBox[{"DefTensorQ", "[", "symb", "]"}], " ", 
       RowBox[{"returns", "'"}], 
       RowBox[{"True", "'"}]}], ";", 
      RowBox[{"otherwise", " ", "it", " ", 
       RowBox[{"returns", "'"}], 
       RowBox[{
        RowBox[{"False", "'"}], "."}]}]}]}], "*)"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"GaugeQ", "[", "strg_", "]"}], ":=", 
    RowBox[{
     RowBox[{"Cases", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "\"\<AnyGauge\>\"", ",", "\"\<ComovingGauge\>\"", ",", 
         "\"\<FlatGauge\>\"", ",", "\"\<IsoDensityGauge\>\"", ",", 
         "\"\<NewtonGauge\>\"", ",", "\"\<SynchronousGauge\>\""}], "}"}], ",",
        "strg"}], "]"}], "===", 
     RowBox[{"{", "strg", "}"}]}]}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "'"}], 
      RowBox[{"strg", "'"}], " ", "matches", " ", "one", " ", "of", " ", 
      "the", " ", "element", " ", "in", " ", "the", " ", "list"}], ",", 
     RowBox[{
      RowBox[{"then", " ", 
       RowBox[{"GaugeQ", "[", "strg", "]"}], " ", 
       RowBox[{"returns", "'"}], 
       RowBox[{"True", "'"}]}], ";", 
      RowBox[{"otherwise", " ", "it", " ", 
       RowBox[{"returns", "'"}], 
       RowBox[{
        RowBox[{"False", "'"}], "."}]}]}]}], "*)"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"InducedMetricQ", "[", "symb_", "]"}], ":=", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"MetricQ", "[", "symb", "]"}], ",", 
      RowBox[{
       RowBox[{"InducedFrom", "[", "symb", "]"}], "=!=", "Null"}], ",", 
      "False"}], "]"}]}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "'"}], 
      RowBox[{"symb", "'"}], " ", "is", " ", "not", " ", "defined", " ", "as",
       " ", "a", " ", "metric"}], ",", 
     RowBox[{"then", " ", 
      RowBox[{"InducedMetricQ", "[", "symb", "]"}], " ", 
      RowBox[{"returns", "'"}], 
      RowBox[{
       RowBox[{"False", "'"}], ".", "Otherwise"}]}], ",", 
     RowBox[{"it", " ", "checks", " ", 
      RowBox[{"whether", "'"}], 
      RowBox[{"symb", "'"}], " ", "is", " ", "an", " ", "induced", " ", 
      RowBox[{"metric", ".", "If"}], " ", "this", " ", "is", " ", "the", " ", 
      "case"}], ",", 
     RowBox[{
      RowBox[{"then", " ", 
       RowBox[{"InducedMetricQ", "[", "symb", "]"}], " ", 
       RowBox[{"gives", "'"}], 
       RowBox[{"True", "'"}]}], ";", 
      RowBox[{"otherwise", " ", "it", " ", 
       RowBox[{"gives", "'"}], 
       RowBox[{
        RowBox[{"False", "'"}], "."}]}]}]}], "*)"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"SpaceTimeQ", "[", "strg_", "]"}], ":=", 
    RowBox[{
     RowBox[{"Cases", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "\"\<Anisotropic\>\"", ",", "\"\<BianchiB\>\"", ",", 
         "\"\<BianchiA\>\"", ",", "\"\<BianchiI\>\"", ",", "\"\<FLCurved\>\"",
          ",", "\"\<FLFlat\>\"", ",", "\"\<Minkowski\>\""}], "}"}], ",", 
       "strg"}], "]"}], "===", 
     RowBox[{"{", "strg", "}"}]}]}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "'"}], 
      RowBox[{"strg", "'"}], " ", "matches", " ", "one", " ", "of", " ", 
      "the", " ", "element", " ", "of", " ", "the", " ", "list"}], ",", 
     RowBox[{
      RowBox[{"then", " ", 
       RowBox[{"SpaceTimeQ", "[", "strg", "]"}], " ", 
       RowBox[{"returns", "'"}], 
       RowBox[{"True", "'"}]}], ";", 
      RowBox[{"otherwise", " ", "it", " ", 
       RowBox[{"returns", "'"}], 
       RowBox[{
        RowBox[{"False", "'"}], "."}]}]}]}], "*)"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"TensorNullQ", "[", "tens_", "]"}], ":=", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Cases", "[", 
        RowBox[{
         RowBox[{"SlotsOfTensor", "[", "tens", "]"}], ",", "Labels"}], "]"}], 
       "=!=", 
       RowBox[{"{", "}"}]}], ",", 
      RowBox[{"Print", "[", 
       RowBox[{
       "\"\<** Warning: the function TensorNullQ is only suited to test \
tensors defined without label-indices. \>\"", ",", "tens"}], "]"}], ",", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"inds", "=", 
          RowBox[{"DummyIn", "/@", 
           RowBox[{"SlotsOfTensor", "[", "tens", "]"}]}]}], "}"}], ",", 
        RowBox[{
         RowBox[{"tens", "@@", "inds"}], "===", "0"}]}], "]"}]}], "]"}]}], 
   "\n", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"TensorNullQ", "[", "tens", "]"}], " ", 
      RowBox[{"returns", "'"}], 
      RowBox[{"True", "'"}], " ", 
      RowBox[{"if", "'"}], 
      RowBox[{"tens", "'"}], " ", "is", " ", "a", " ", "null", " ", "tensor", 
      " ", 
      RowBox[{"and", "'"}], 
      RowBox[{"False", "'"}], " ", 
      RowBox[{"otherwise", ".", "This"}], " ", "function", " ", "is", " ", 
      "not", " ", "suited", " ", "to", " ", "test", " ", "tensors", " ", 
      "defined", " ", "with", " ", "label"}], "-", 
     RowBox[{"indices", "."}]}], "*)"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"*", "Type", " ", "of", " ", "manifolds"}], "**)"}], 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
    "Will", " ", "probably", " ", "disappear", " ", "since", " ", "we", " ", 
     "will", " ", "only", " ", "do", " ", "curved", " ", "and", " ", "flat", 
     " ", "FL"}], " ", "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"BianchiBool", "[", "Spacetype_", "]"}], ":=", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"Spacetype", "===", "\"\<BianchiB\>\""}], "||", 
      RowBox[{"Spacetype", "===", "\"\<BianchiA\>\""}], "||", 
      RowBox[{"Spacetype", "===", "\"\<BianchiI\>\""}]}], ")"}]}], "\n", 
   RowBox[{
    RowBox[{"FlatSpaceBool", "[", "Spacetype_", "]"}], ":=", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"Spacetype", "===", "\"\<BianchiI\>\""}], "||", 
      RowBox[{"Spacetype", "===", "\"\<FLFlat\>\""}], "||", 
      RowBox[{"Spacetype", "===", "\"\<Minkowski\>\""}]}], ")"}]}], "\n", 
   RowBox[{
    RowBox[{"NoAnisotropyBool", "[", "Spacetype_", "]"}], ":=", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"Spacetype", "===", "\"\<FLCurved\>\""}], "||", 
      RowBox[{"Spacetype", "===", "\"\<FLFlat\>\""}], "||", 
      RowBox[{"Spacetype", "===", "\"\<Minkowski\>\""}]}], ")"}]}], "\n", 
   RowBox[{
    RowBox[{"AnisotropyBool", "[", "Spacetype_", "]"}], ":=", 
    RowBox[{"(", 
     RowBox[{"Spacetype", "===", "\"\<Anisotropic\>\""}], ")"}]}], "\n", 
   RowBox[{"(*", 
    RowBox[{"The", " ", 
     RowBox[{"name", "'"}], 
     RowBox[{"AnisotropyBool", "'"}], " ", "should", " ", "be", " ", 
     RowBox[{"changed", "."}]}], "*)"}]}]}]], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["Slicing in 1 + 1 + (n - 2)", "Subsubsection"],

Cell["\<\
Here is my first implementation of DefScreenSpaceMetric. It assumes that you \
already define a hypersurface and a vector orthorgonal to that hypersurface\
\>", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DefScreenSpaceMetric", "[", 
    RowBox[{
     RowBox[{"metric_", "[", 
      RowBox[{"inda_", ",", " ", "indb_"}], "]"}], ",", " ", "Manifold_", ",",
      " ", "cd2_", ",", " ", 
     RowBox[{"{", 
      RowBox[{"cdpost_String", ",", " ", "cdpre_String"}], "}"}], ",", " ", 
     "InducedHypersurface_", ",", " ", "options_"}], "]"}], " ", ":=", "\n", 
   RowBox[{"(*", " ", 
    RowBox[{
    "Extracting", " ", "the", " ", "specifications", " ", "of", " ", "the", 
     " ", "problem", " ", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{
       "metric", " ", "manifold", " ", "normal", " ", "vector", " ", "etc"}], 
       "..."}], ")"}]}], "*)"}], " ", "\n", 
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"(", 
       RowBox[{"MetricQ", "[", 
        RowBox[{"First", "@", "InducedHypersurface"}], "]"}], ")"}], " ", "&&",
       " ", 
      RowBox[{"(", 
       RowBox[{"xTensorQ", "[", 
        RowBox[{"Last", "@", "InducedHypersurface"}], "]"}], ")"}]}], ",", 
     "\n", "  ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"g", " ", "=", " ", 
          RowBox[{"First", "@", 
           RowBox[{"InducedFrom", "[", 
            RowBox[{"First", "@", "InducedHypersurface"}], "]"}]}]}], ",", 
         RowBox[{"u", " ", "=", " ", 
          RowBox[{"First", "@", 
           RowBox[{"Rest", "@", 
            RowBox[{"InducedFrom", "[", 
             RowBox[{"First", "@", "InducedHypersurface"}], "]"}]}]}]}], ",", 
         "\n", "   ", 
         RowBox[{"vbundle", " ", "=", " ", 
          RowBox[{"VBundleOfIndex", "[", "inda", "]"}]}], ",", "\n", "   ", 
         RowBox[{"h", " ", "=", " ", 
          RowBox[{"First", "@", "InducedHypersurface"}]}], ",", "\n", "   ", 
         RowBox[{"n", " ", "=", " ", 
          RowBox[{"Last", "@", "InducedHypersurface"}]}], ",", "\n", "   ", 
         RowBox[{"dim", " ", "=", " ", 
          RowBox[{"DimOfManifold", "[", "Manifold", "]"}]}], ",", "\n", "   ", 
         RowBox[{"indexlist", " ", "=", " ", 
          RowBox[{"GetIndicesOfVBundle", "[", 
           RowBox[{
            RowBox[{"VBundleOfIndex", "[", "inda", "]"}], ",", " ", "3"}], 
           "]"}]}]}], "}"}], ",", " ", "\n", "\n", "\n", 
       RowBox[{"With", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"ind1", " ", "=", " ", 
            RowBox[{"DummyIn", "[", 
             RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", " ", 
           RowBox[{"ind2", " ", "=", " ", 
            RowBox[{"DummyIn", "[", 
             RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", " ", 
           RowBox[{"ind3", " ", "=", " ", 
            RowBox[{"DummyIn", "[", 
             RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", " ", 
           RowBox[{"ind4", " ", "=", " ", 
            RowBox[{"DummyIn", "[", 
             RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}]}], "}"}], ",",
          "\n", "   ", "\n", 
         RowBox[{"(*", " ", 
          RowBox[{
           RowBox[{"Definition", " ", "of", " ", "the", " ", "screen"}], "-", 
           
           RowBox[{"space", " ", 
            RowBox[{"metric", ".", " ", "Projected"}], " ", "orthogonally", 
            " ", "to", " ", "u", " ", "and", " ", 
            RowBox[{"n", "."}]}]}], "*)"}], "\n", "   ", 
         RowBox[{
          RowBox[{"DefTensor", "[", 
           RowBox[{
            RowBox[{"metric", "[", 
             RowBox[{
              RowBox[{"-", "inda"}], ",", " ", 
              RowBox[{"-", "indb"}]}], "]"}], ",", " ", "Manifold", ",", " ", 
            
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"$TorsionSign", " ", "===", " ", "1"}], ",", " ", 
              RowBox[{"Symmetric", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"-", "inda"}], ",", " ", 
                 RowBox[{"-", "indb"}]}], "}"}], "]"}], ",", " ", 
              RowBox[{"{", "}"}]}], "]"}], ",", " ", "\n", "    ", 
            RowBox[{"OrthogonalTo", " ", "->", " ", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"u", "[", "inda", "]"}], ",", " ", 
               RowBox[{"u", "[", "indb", "]"}], ",", " ", 
               RowBox[{"n", "[", "inda", "]"}], ",", " ", 
               RowBox[{"n", "[", "indb", "]"}]}], "}"}]}], ",", " ", 
            RowBox[{"ProjectedWith", " ", "->", " ", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"h", "[", 
                RowBox[{"inda", ",", " ", 
                 RowBox[{"-", "ind1"}]}], "]"}], ",", " ", 
               RowBox[{"h", "[", 
                RowBox[{"indb", ",", " ", 
                 RowBox[{"-", "ind1"}]}], "]"}]}], "}"}]}], ",", " ", 
            "options"}], "]"}], ";", "\n", "   ", "\n", 
          RowBox[{"(*", " ", 
           RowBox[{
           "We", " ", "defined", " ", "a", " ", "covariant", " ", 
            "derivative", " ", "associated", " ", "to", " ", "this", " ", 
            "screen", " ", "metric", " ", "and", " ", "we", " ", "will", " ", 
            "load", " ", "later", " ", "all", " ", "its", " ", 
            RowBox[{"properties", "."}]}], " ", "*)"}], "\n", "   ", 
          RowBox[{"DefCovD", "[", 
           RowBox[{
            RowBox[{"cd2", "[", "inda", "]"}], ",", " ", "vbundle", ",", " ", 
            
            RowBox[{"{", 
             RowBox[{"cdpost", ",", " ", "cdpre"}], "}"}], ",", " ", 
            RowBox[{"OrthogonalTo", " ", "->", " ", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"u", "[", "inda", "]"}], ",", " ", 
               RowBox[{"n", "[", "inda", "]"}]}], "}"}]}], ",", " ", 
            RowBox[{"ProjectedWith", " ", "->", " ", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"h", "[", 
                RowBox[{"inda", ",", " ", 
                 RowBox[{"-", "ind2"}]}], "]"}], ",", " ", 
               RowBox[{"metric", "[", 
                RowBox[{"inda", ",", " ", 
                 RowBox[{"-", "ind2"}]}], "]"}]}], "}"}]}]}], "]"}], ";", 
          "\n", "   ", "\n", 
          RowBox[{"(*", " ", 
           RowBox[{
           "For", " ", "other", " ", "references", " ", "we", " ", "need", 
            " ", "a", " ", "function", " ", "to", " ", "extract", " ", "the", 
            " ", "radial", " ", "vector", " ", "out", " ", "of", " ", "the", 
            " ", "screen", " ", "space", " ", "metric"}], "*)"}], "\n", "   ", 
          RowBox[{
           RowBox[{"RadialVectOrthToTheScreenSpace", "[", "metric", "]"}], 
           " ", ":=", " ", 
           RowBox[{
            RowBox[{"RadialVectOrthToTheScreenSpace", "[", "metric", "]"}], 
            " ", "=", " ", "n"}]}], ";", "\n", "   ", "\n", "\n", 
          RowBox[{"(*", " ", 
           RowBox[{"Warning", " ", "and", " ", "Error", " ", "messages"}], 
           "*)"}], "\n", "   ", 
          RowBox[{
           RowBox[{"OrthogonalVectors", "[", "x_", "]"}], " ", ":=", " ", 
           "\n", "    ", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"x", " ", "===", " ", "h"}], ",", " ", 
             RowBox[{"Rest", "@", 
              RowBox[{"InducedFrom", "[", "h", "]"}]}], ",", " ", "\n", 
             "     ", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{"x", " ", "===", " ", "metric"}], ",", " ", 
               RowBox[{"Flatten", "[", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"Rest", "@", 
                   RowBox[{"InducedFrom", "[", "h", "]"}]}], ",", " ", 
                  RowBox[{"Rest", "@", 
                   RowBox[{"{", 
                    RowBox[{"h", ",", " ", "n"}], "}"}]}]}], "}"}], "]"}], 
               ",", 
               RowBox[{"\"\<\\!\\(\>\"", " ", "<>", " ", 
                RowBox[{"ToString", "[", "x", "]"}], " ", "<>", 
                "\"\<\\&-\\) do not have orthogonal vectors \>\""}]}], 
              "]"}]}], "]"}]}], ";", "\n", "   ", "\n", "   ", 
          RowBox[{
           RowBox[{"InducedFromHyperSurface", "[", "x_", "]"}], " ", ":=", 
           RowBox[{
            RowBox[{"InducedFromHyperSurface", "[", "x", "]"}], " ", "=", " ",
             "\n", "     ", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"x", " ", "===", " ", "h"}], ",", " ", 
              RowBox[{"InducedFrom", "[", "h", "]"}], ",", " ", "\n", 
              "      ", 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{"x", " ", "===", " ", "metric"}], ",", " ", 
                RowBox[{"{", 
                 RowBox[{"h", ",", " ", "n"}], "}"}], ",", 
                RowBox[{"\"\<\\!\\(\>\"", " ", "<>", " ", 
                 RowBox[{"ToString", "[", "x", "]"}], " ", "<>", " ", 
                 "\"\<\\&-\\) is not an induced metric\>\""}]}], "]"}]}], 
             "]"}]}]}], ";", "\n", "   ", "\n", "\n", 
          RowBox[{"(*", " ", 
           RowBox[{
            RowBox[{
            "We", " ", "need", " ", "to", " ", "stecify", " ", "that", " ", 
             "the", " ", "trace", " ", "of", " ", "t", " ", "he", " ", 
             "screen", " ", "space", " ", "metric", " ", "is", " ", "not", 
             " ", "dim", " ", "but", " ", "dim"}], "-", "2."}], "*)"}], "\n", 
          
          RowBox[{"(*", " ", 
           RowBox[{
           "We", " ", "also", " ", "ensure", " ", "automatic", " ", 
            "contraction", " ", "of", " ", "the", " ", "metric", " ", "with", 
            " ", "itself"}], " ", "*)"}], "\n", 
          RowBox[{"(*", " ", 
           RowBox[{
           "Finally", " ", "we", " ", "ensure", " ", "that", " ", "the", " ", 
            "covd", " ", "d2", " ", "we", " ", "have", " ", "define", " ", 
            "is", " ", "the", " ", "Levi", " ", "Civita", " ", "derivative", 
            " ", "associated", " ", "woth", " ", "the", " ", "screen", " ", 
            "space", " ", "metric"}], "*)"}], "\n", "   ", 
          RowBox[{"AutomaticRules", "[", 
           RowBox[{"metric", ",", " ", 
            RowBox[{"MakeRule", "[", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"metric", "[", 
                 RowBox[{"inda", ",", " ", "ind1"}], "]"}], " ", 
                RowBox[{"metric", "[", 
                 RowBox[{
                  RowBox[{"-", "inda"}], ",", " ", 
                  RowBox[{"-", "ind1"}]}], "]"}]}], ",", " ", 
               RowBox[{"metric", "[", 
                RowBox[{"ind1", ",", " ", 
                 RowBox[{"-", "ind1"}]}], "]"}]}], "}"}], "]"}]}], "]"}], ";",
           "\n", "   ", 
          RowBox[{"AutomaticRules", "[", 
           RowBox[{"metric", ",", " ", 
            RowBox[{"MakeRule", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"metric", "[", 
                  RowBox[{
                   RowBox[{"-", "inda"}], ",", " ", 
                   RowBox[{"-", "indb"}]}], "]"}], " ", 
                 RowBox[{"metric", "[", 
                  RowBox[{"inda", ",", " ", "ind1"}], "]"}]}], ",", " ", 
                RowBox[{"metric", "[", 
                 RowBox[{"ind1", ",", " ", 
                  RowBox[{"-", "indb"}]}], "]"}]}], "}"}], ",", " ", 
              RowBox[{"MetricOn", " ", "->", " ", "All"}]}], "]"}]}], "]"}], 
          ";", "\n", "   ", 
          RowBox[{"AutomaticRules", "[", 
           RowBox[{"metric", ",", " ", 
            RowBox[{"MakeRule", "[", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"metric", "[", 
                RowBox[{
                 RowBox[{"-", "ind1"}], ",", " ", "ind1"}], "]"}], " ", ",", 
               " ", 
               RowBox[{"dim", "-", "2"}]}], "}"}], "]"}]}], "]"}], ";", "\n", 
          "   ", 
          RowBox[{"AutomaticRules", "[", 
           RowBox[{"metric", ",", " ", 
            RowBox[{"MakeRule", "[", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"cd2", "[", "inda", "]"}], "[", 
                RowBox[{"metric", "[", 
                 RowBox[{"ind1", ",", " ", "ind2"}], "]"}], " ", "]"}], ",", 
               " ", "0"}], "}"}], "]"}]}], "]"}], ";", "\n", "\n", "   ", 
          "\n", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{
            "This", " ", "line", " ", "assigns", " ", "further", " ", 
             "properties", " ", "to", " ", "the", " ", "metric", " ", "and", 
             " ", "the", " ", "radial", " ", "vector"}], ",", " ", 
            RowBox[{"We", " ", "are", " ", "following", " ", 
             RowBox[{"xTensor", "."}]}]}], " ", "*)"}], "\n", 
          RowBox[{"(*", " ", 
           RowBox[{
           "It", " ", "calls", " ", "a", " ", "function", " ", "which", " ", 
            "is", " ", "implemented", " ", "below"}], "*)"}], "\n", 
          RowBox[{"PropertiesOfInducedScreenSpaceMetric", "[", 
           RowBox[{
            RowBox[{"metric", "[", 
             RowBox[{"inda", ",", " ", "indb"}], "]"}], ",", " ", "Manifold", 
            ",", " ", "cd2", ",", " ", 
            RowBox[{"{", 
             RowBox[{"n", ",", " ", "h", ",", " ", 
              RowBox[{"CovDOfMetric", "[", "h", "]"}]}], "}"}]}], "]"}], ";", 
          "\n", "\n", 
          RowBox[{"(*", 
           RowBox[{
           "We", " ", "need", " ", "a", " ", "series", " ", "of", " ", 
            "obvious", " ", "uptvalues", " ", "for", " ", "the", " ", 
            "screen", " ", "space", " ", 
            RowBox[{"metric", "."}]}], " ", "*)"}], "\n", 
          RowBox[{"(*", " ", 
           RowBox[{
           "These", " ", "relations", " ", "are", " ", "to", " ", "explain", 
            " ", "that", " ", "the", " ", "screen", " ", "space", " ", 
            "metric", " ", "is", " ", "induced", " ", "from", " ", "the", " ",
             "space", " ", "and", " ", "to", " ", "say", " ", "that", " ", 
            "it", " ", "has", " ", "a", " ", "covariant", " ", "derivative", 
            " ", "cd2"}], "*)"}], "\n", 
          RowBox[{
           RowBox[{"InducedFrom", "[", "metric", "]"}], " ", "^=", " ", 
           RowBox[{"{", 
            RowBox[{"h", ",", " ", "n"}], "}"}]}], ";", "\n", 
          RowBox[{
           RowBox[{"VBundleOfMetric", "[", "metric", "]"}], " ", "^=", " ", 
           RowBox[{"VBundleOfMetric", "[", "g", "]"}]}], ";", "\n", 
          RowBox[{
           RowBox[{"MetricOfCovD", "[", "cd2", "]"}], " ", "^=", " ", 
           "metric"}], ";", "\n", 
          RowBox[{"AppendTo", "[", 
           RowBox[{"$Metrics", ",", " ", "metric"}], "]"}], ";", "\n", 
          RowBox[{
           RowBox[{"MetricQ", "[", "metric", "]"}], " ", "^=", " ", "True"}], 
          ";", "\n", 
          RowBox[{
           RowBox[{
           "xAct`xLightCone`Private`InducedMetricQ", "[", "metric", "]"}], "^=",
            " ", "True"}], ";", "\n", 
          RowBox[{
           RowBox[{"CovDOfMetric", "[", "metric", "]"}], " ", "^=", " ", 
           "cd2"}], ";", "\n", "\n", 
          RowBox[{"(*", " ", 
           RowBox[{
           "A", " ", "series", " ", "of", " ", "rules", " ", "which", " ", 
            "states", " ", "taht", " ", "the", " ", "derivative", " ", "cd2", 
            " ", "is", " ", "induced", " ", 
            RowBox[{"(", 
             RowBox[{
             "orthogonality", " ", "to", " ", "n", " ", "of", " ", "a", " ", 
              "cd2", " ", "applied", " ", "to", " ", "a", " ", "prokected", 
              " ", "tensor"}], ")"}]}], "*)"}], "\n", 
          RowBox[{"(*", " ", 
           RowBox[{
            RowBox[{
            "These", " ", "rules", " ", "are", " ", "implemented", " ", "in", 
             " ", "xTensor", " ", "and", " ", "called", " ", "when", " ", 
             "we", " ", "define", " ", "an", " ", "induced", " ", 
             RowBox[{"derivative", ".", " ", "\n", "These"}], " ", "were", 
             " ", "called", " ", "automatically", " ", "for", " ", "h"}], ",",
             " ", 
            RowBox[{
            "but", " ", "not", " ", "for", " ", "the", " ", "screen", " ", 
             "space", " ", "metric"}]}], " ", "*)"}], "\n", 
          RowBox[{"xAct`xTensor`Private`MakeOrthogonalDerivative", "[", 
           RowBox[{"cd2", ",", 
            RowBox[{"metric", "[", 
             RowBox[{"inda", ",", " ", 
              RowBox[{"-", "ind2"}]}], "]"}], ",", 
            RowBox[{"n", "[", "inda", "]"}]}], "]"}], ";", "\n", 
          RowBox[{"xAct`xTensor`Private`MakeProjectedDerivative", "[", 
           RowBox[{"cd2", ",", 
            RowBox[{"metric", "[", 
             RowBox[{"inda", ",", " ", 
              RowBox[{"-", "ind2"}]}], "]"}], ",", 
            RowBox[{"n", "[", "inda", "]"}]}], "]"}], ";"}]}], "\n", "\n", 
        "]"}]}], "]"}], ",", "\n", "\n", "  ", 
     RowBox[{
     "Print", "[", 
      "\"\<** DefMetric:: You have to ensure first that the following objects \
are defined:  metric induced from \\\nthe super metric, a hypersurface \
specifying  four vector  and a \\\nscreen space specifying vector\>\"", 
      "]"}]}], "]"}]}], ";"}]], "Code",
 Background->RGBColor[0.88, 1, 0.88]],

Cell["\<\
This defines additional  properties for the screen space tensor. I will add \
more\
\>", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "I", " ", "am", " ", "not", " ", "quite", " ", "sure", " ", "for", " ", 
     "now", " ", "about", " ", "the", " ", "sign", " ", "of", " ", 
     "ExtrinsicKSign", " ", "on", " ", 
     RowBox[{"the", " ", "\\\n", "screeen"}], " ", "space"}], ",", " ", 
    RowBox[{
    "so", " ", "i", " ", "have", " ", "defined", " ", "the", " ", "following",
      " ", "for", " ", "now"}], ",", " ", 
    RowBox[{"we", " ", "may", " ", "end", " ", 
     RowBox[{"up", " ", "\\\n", "merging"}], " ", "with", " ", "xTensor"}]}], 
   "*)"}], "\n", 
  RowBox[{
   RowBox[{
    RowBox[{"$ExtrinsicKOnSSSign", " ", "=", " ", "$ExtrinsicKSign"}], ";"}], 
   "\n", 
   RowBox[{
    RowBox[{"$AccelerationOfnSign", " ", "=", " ", "$ExtrinsicKSign"}], ";"}],
    "\n", "\n", "\n", 
   RowBox[{"(*", 
    RowBox[{
    "This", " ", "function", " ", "is", " ", "called", " ", "in", " ", 
     "DefScreenSpaceMetric", " ", "and", " ", "sets", " ", "various", " ", 
     "properties", " ", "for", " ", "the", " ", "screen", " ", "space", " ", 
     RowBox[{"metric", ".", " ", "It"}], " ", "is", " ", "adapted", " ", 
     "from", " ", "xTensor"}], "*)"}], "\n", 
   RowBox[{"(*", " ", 
    RowBox[{
    "Maybe", " ", "it", " ", "is", " ", "useless", " ", "to", " ", "copy", 
     " ", "everything", " ", 
     RowBox[{"here", "."}]}], "*)"}], "\n", 
   RowBox[{"(*", " ", 
    RowBox[{
    "Maybe", " ", "that", " ", "would", " ", "be", " ", "enough", " ", "to", 
     " ", "call", " ", 
     RowBox[{"DefInducedMetric", ".", " ", "To"}], " ", "be", " ", 
     "debated"}], "*)"}], "\n", "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"PropertiesOfInducedScreenSpaceMetric", "[", 
      RowBox[{
       RowBox[{"metric_", "[", 
        RowBox[{
         RowBox[{"-", "ind1_"}], ",", " ", 
         RowBox[{"-", "ind2_"}]}], "]"}], ",", " ", "\n", "   ", 
       "dependencies_", ",", " ", "covd_", ",", " ", 
       RowBox[{"{", 
        RowBox[{"vector_", ",", " ", "supermetric_", ",", " ", "superCD_"}], 
        "}"}]}], "]"}], " ", ":=", " ", "\n", "  ", 
     RowBox[{"With", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"vbundle", " ", "=", " ", 
         RowBox[{"VBundleOfIndex", "[", "ind1", "]"}]}], "}"}], ",", "\n", 
       "   ", 
       RowBox[{"With", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"extrinsicKname", " ", "=", " ", 
            RowBox[{"GiveSymbol", "[", 
             RowBox[{"ExtrinsicK", ",", " ", "metric"}], "]"}]}], ",", "\n", 
           "     ", 
           RowBox[{"accelerationname", " ", "=", " ", 
            RowBox[{"GiveSymbol", "[", 
             RowBox[{"Acceleration", ",", " ", "vector"}], "]"}]}], ",", "\n",
            "     ", 
           RowBox[{"projectorname", " ", "=", " ", 
            RowBox[{"GiveSymbol", "[", 
             RowBox[{"Projector", ",", " ", "metric"}], "]"}]}], ",", "\n", 
           "     ", 
           RowBox[{"epsilonname", " ", "=", " ", 
            RowBox[{"GiveSymbol", "[", 
             RowBox[{"epsilon", ",", " ", "metric"}], "]"}]}], ",", "\n", 
           "     ", 
           RowBox[{"superepsilonname", " ", "=", " ", 
            RowBox[{"GiveSymbol", "[", 
             RowBox[{"epsilon", ",", " ", "supermetric"}], "]"}]}], ",", "\n",
            "     ", 
           RowBox[{"proj", " ", "=", " ", 
            RowBox[{"ProjectWith", "[", "metric", "]"}]}], ",", " ", "\n", 
           "     ", 
           RowBox[{"norm", " ", "=", " ", 
            RowBox[{"Scalar", "@", "\n", "       ", 
             RowBox[{"Simplify", "@", "\n", "        ", 
              RowBox[{"ContractMetric", "[", "\n", "         ", 
               RowBox[{
                RowBox[{
                 RowBox[{"supermetric", "[", 
                  RowBox[{
                   RowBox[{"-", "ind1"}], ",", " ", 
                   RowBox[{"-", "ind2"}]}], "]"}], " ", 
                 RowBox[{"vector", "[", "ind1", "]"}], " ", 
                 RowBox[{"vector", "[", "ind2", "]"}]}], ",", " ", "\n", 
                "         ", "supermetric"}], "]"}]}]}]}], ",", " ", 
           RowBox[{"indexlist", " ", "=", " ", 
            RowBox[{"GetIndicesOfVBundle", "[", 
             RowBox[{"vbundle", ",", " ", "3"}], "]"}]}]}], "}"}], ",", "  ", 
         "\n", "\n", "  ", "\n", "    ", 
         RowBox[{
          RowBox[{"With", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"i1", " ", "=", " ", 
               RowBox[{"indexlist", "[", 
                RowBox[{"[", "1", "]"}], "]"}]}], ",", " ", 
              RowBox[{"i2", " ", "=", " ", 
               RowBox[{"indexlist", "[", 
                RowBox[{"[", "2", "]"}], "]"}]}], ",", " ", "\n", "      ", 
              RowBox[{"i3", " ", "=", " ", 
               RowBox[{"indexlist", "[", 
                RowBox[{"[", "3", "]"}], "]"}]}]}], "}"}], ",", 
            RowBox[{"(*", 
             RowBox[{"Register", " ", "pair", " ", 
              RowBox[{"metric", "/", "vector"}]}], "*)"}], "\n", "\n", 
            "     ", 
            RowBox[{
             RowBox[{"xUpSet", "[", 
              RowBox[{
               RowBox[{"VectorOfInducedMetric", "[", "metric", "]"}], ",", 
               " ", "vector"}], "]"}], ";", "     ", "\n", "\n", 
             RowBox[{"(*", " ", 
              RowBox[{
              "Definition", " ", "of", " ", "extrinsic", " ", "curvature"}], 
              " ", "*)"}], "     ", "\n", "     ", 
             RowBox[{"DefTensor", "[", 
              RowBox[{
               RowBox[{"extrinsicKname", "[", 
                RowBox[{"i1", ",", " ", "i2"}], "]"}], ",", " ", 
               "dependencies", ",", " ", "\n", "      ", 
               RowBox[{"Symmetric", "[", 
                RowBox[{"{", 
                 RowBox[{"1", ",", " ", "2"}], "}"}], "]"}], ",", " ", "\n", 
               "      ", 
               RowBox[{"PrintAs", " ", ":>", " ", 
                RowBox[{"GiveOutputString", "[", 
                 RowBox[{"ExtrinsicK", ",", " ", "metric"}], "]"}]}], ",", 
               " ", "\n", "      ", 
               RowBox[{"OrthogonalTo", " ", "->", " ", 
                RowBox[{"{", 
                 RowBox[{"vector", "[", 
                  RowBox[{"-", "i1"}], "]"}], "}"}]}], ",", " ", "\n", 
               "      ", 
               RowBox[{"ProjectedWith", " ", "->", " ", 
                RowBox[{"{", 
                 RowBox[{"metric", "[", 
                  RowBox[{"i3", ",", " ", 
                   RowBox[{"-", "i2"}]}], "]"}], "}"}]}], ",", " ", 
               RowBox[{"ProtectNewSymbol", " ", "->", " ", "False"}], ",", 
               " ", "\n", "      ", 
               RowBox[{"Master", " ", "->", " ", "metric"}], ",", " ", "\n", 
               "      ", 
               RowBox[{"DefInfo", " ", "->", " ", 
                RowBox[{"{", 
                 RowBox[{
                 "\"\<extrinsic curvature tensor\>\"", ",", " ", "\n", 
                  "        ", 
                  RowBox[{"\"\<Associated to vector \>\"", " ", "<>", " ", 
                   RowBox[{"ToString", "[", "vector", "]"}]}]}], "}"}]}], ",",
                " ", "\n", "      ", 
               RowBox[{"TensorID", " ", "->", " ", 
                RowBox[{"{", 
                 RowBox[{"ExtrinsicK", ",", " ", "metric"}], "}"}]}]}], "]"}],
              ";", "\n", "     ", "\n", "\n", 
             RowBox[{"(*", " ", 
              RowBox[{"Definition", " ", "of", " ", "Acceleration"}], " ", 
              "*)"}], "\n", "     ", 
             RowBox[{"DefTensor", "[", 
              RowBox[{
               RowBox[{"accelerationname", "[", "i1", "]"}], ",", " ", 
               "dependencies", ",", " ", "\n", "      ", 
               RowBox[{"PrintAs", " ", ":>", " ", 
                RowBox[{"GiveOutputString", "[", 
                 RowBox[{"Acceleration", ",", " ", "vector"}], "]"}]}], ",", 
               " ", "\n", "      ", 
               RowBox[{"OrthogonalTo", " ", "->", " ", 
                RowBox[{"{", 
                 RowBox[{"vector", "[", 
                  RowBox[{"-", "i1"}], "]"}], "}"}]}], ",", " ", "\n", 
               "      ", 
               RowBox[{"ProjectedWith", " ", "->", " ", 
                RowBox[{"{", 
                 RowBox[{"metric", "[", 
                  RowBox[{"i2", ",", " ", 
                   RowBox[{"-", "i1"}]}], "]"}], "}"}]}], ",", " ", 
               RowBox[{"ProtectNewSymbol", " ", "->", " ", "False"}], ",", 
               " ", "\n", "      ", 
               RowBox[{"Master", " ", "->", " ", "metric"}], ",", " ", "\n", 
               "      ", 
               RowBox[{"DefInfo", " ", "->", " ", 
                RowBox[{"{", 
                 RowBox[{
                 "\"\<acceleration vector\>\"", ",", " ", "\n", "        ", 
                  RowBox[{"\"\<Associated to vector \>\"", " ", "<>", " ", 
                   RowBox[{"ToString", "[", "vector", "]"}]}]}], "}"}]}], ",",
                " ", "\n", "      ", 
               RowBox[{"TensorID", " ", "->", " ", 
                RowBox[{"{", 
                 RowBox[{"Acceleration", ",", " ", "vector"}], "}"}]}]}], 
              "]"}], ";", "\n", "  ", "\n", "   ", "\n", 
             RowBox[{"(*", 
              RowBox[{
               RowBox[{
               "Relations", " ", "among", " ", "them", " ", "and", " ", "the",
                 " ", 
                RowBox[{"derivatives", ".", "Improved"}], " ", "by", " ", 
                "Thomas"}], ",", "\n", "     ", 
               RowBox[{"to", " ", "use", " ", "HasOrthogonalIndexQ"}]}], 
              "*)"}], "\n", "     ", 
             RowBox[{
              RowBox[{
              "xAct`xTensor`Private`GradNormalToExtrinsicKRules", "[", "\n", 
               "       ", "metric", "]"}], " ", "=", " ", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"superCD", "[", "a_", "]"}], "[", "\n", "         ", 
                  RowBox[{"vector", "[", "b_", "]"}], "]"}], " ", ":>", " ", 
                 RowBox[{
                  RowBox[{"$ExtrinsicKOnSSSign", " ", 
                   RowBox[{"extrinsicKname", "[", 
                    RowBox[{"a", ",", " ", "b"}], "]"}]}], "\n", "         ", 
                  "+", " ", 
                  RowBox[{"$AccelerationOfnSign", " ", 
                   RowBox[{"vector", "[", "a", "]"}], " ", 
                   RowBox[{"accelerationname", "[", "b", "]"}]}]}]}], ",", 
                " ", "\n", "       ", 
                RowBox[{
                 RowBox[{
                  RowBox[{"vector", "[", 
                   RowBox[{"-", "a_"}], "]"}], " ", 
                  RowBox[{
                   RowBox[{"superCD", "[", "b_", "]"}], "[", "\n", 
                   "          ", "expr_", "]"}]}], " ", ":>", " ", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"-", 
                    RowBox[{
                    RowBox[{"superCD", "[", "b", "]"}], "[", 
                    RowBox[{"vector", "[", 
                    RowBox[{"-", "a"}], "]"}], "]"}]}], " ", "expr"}], " ", "/;",
                   " ", "\n", "         ", 
                  RowBox[{"xAct`xTensor`Private`HasOrthogonalIndexQ", "[", 
                   RowBox[{"expr", ",", " ", 
                    RowBox[{"vector", "[", 
                    RowBox[{"-", "a"}], "]"}]}], "]"}]}]}], ",", " ", "\n", 
                "       ", 
                RowBox[{
                 RowBox[{
                  RowBox[{"vector", "[", "a_", "]"}], " ", 
                  RowBox[{
                   RowBox[{"superCD", "[", "b_", "]"}], "[", "expr_", "]"}]}],
                  " ", ":>", " ", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"-", 
                    RowBox[{
                    RowBox[{"superCD", "[", "b", "]"}], "[", 
                    RowBox[{"vector", "[", "a", "]"}], "]"}]}], " ", "expr"}],
                   " ", "/;", "\n", "          ", 
                  RowBox[{"xAct`xTensor`Private`HasOrthogonalIndexQ", "[", 
                   RowBox[{"expr", ",", " ", 
                    RowBox[{"vector", "[", "a", "]"}]}], "]"}]}]}], ",", " ", 
                "\n", "       ", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{"LieD", "[", 
                    RowBox[{"vector", "[", "_", "]"}], "]"}], "[", "\n", 
                   "          ", "expr_", "]"}], " ", 
                  RowBox[{"vector", "[", 
                   RowBox[{"-", "a_"}], "]"}]}], " ", ":>", " ", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"-", "$AccelerationOfnSign"}], " ", 
                   RowBox[{
                    RowBox[{"norm", " ", "\\\n", "accelerationname"}], "[", 
                    RowBox[{"-", "a"}], "]"}], " ", "expr"}], " ", "/;", " ", 
                  
                  RowBox[{"xAct`xTensor`Private`HasOrthogonalIndexQ", "[", 
                   RowBox[{"expr", ",", " ", 
                    RowBox[{"vector", "[", 
                    RowBox[{"-", "a"}], "]"}]}], "]"}]}]}]}], 
               RowBox[{"(*", 
                RowBox[{",", "\n", "       ", 
                 RowBox[{
                  RowBox[{
                   RowBox[{
                    RowBox[{"LieD", "[", 
                    RowBox[{"vector", "[", "_", "]"}], "]"}], "[", "expr_", 
                    "]"}], 
                   RowBox[{"vector", "[", "a_", "]"}]}], "\[RuleDelayed]", 
                  RowBox[{"0", "/;", "\n", "       ", 
                   RowBox[{"HasOrthogonalIndexQ", "[", 
                    RowBox[{"expr", ",", 
                    RowBox[{"vector", "[", "a", "]"}]}], "]"}]}]}]}], "*)"}], 
               "}"}]}], ";", "\n", "\n", "     ", "\n", "     ", 
             RowBox[{
              RowBox[{
              "xAct`xTensor`Private`ExtrinsicKToGradNormalRules", "[", 
               "metric", "]"}], " ", "=", " ", "\n", "      ", 
              RowBox[{
               RowBox[{"extrinsicKname", "[", 
                RowBox[{"a_", ",", " ", "b_"}], "]"}], " ", ":>", " ", "\n", 
               "       ", 
               RowBox[{"Module", "[", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{"c", " ", "=", " ", "\n", "          ", 
                   RowBox[{"DummyIn", "@", "vbundle"}]}], "}"}], ",", " ", 
                 RowBox[{"$ExtrinsicKOnSSSign", " ", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"supermetric", "[", 
                    RowBox[{"a", ",", " ", "\n", "             ", "c"}], 
                    "]"}], " ", 
                    RowBox[{
                    RowBox[{"superCD", "[", 
                    RowBox[{"-", "c"}], "]"}], "[", 
                    RowBox[{"vector", "[", "b", "]"}], "]"}]}], " ", "-", " ", 
                    RowBox[{"$AccelerationOfnSign", " ", 
                    RowBox[{"vector", "[", "\n", "             ", "a", "]"}], 
                    " ", 
                    RowBox[{"accelerationname", "[", "b", "]"}]}]}], 
                   ")"}]}]}], "]"}]}]}], ";", "\n", "     ", "\n", "     ", 
             "\n", 
             RowBox[{"(*", 
              RowBox[{"Projectors", " ", "and", " ", "metrics"}], "*)"}], 
             "     ", "\n", "     ", 
             RowBox[{
              RowBox[{
              "xAct`xTensor`Private`ProjectorToMetricRules", "[", "metric", 
               "]"}], " ", "=", " ", "\n", "      ", 
              RowBox[{
               RowBox[{"metric", "[", 
                RowBox[{"i1_", ",", " ", "i2_"}], "]"}], " ", "->", " ", "\n",
                "       ", 
               RowBox[{
                RowBox[{"supermetric", "[", 
                 RowBox[{"i1", ",", " ", "i2"}], "]"}], " ", "-", " ", 
                RowBox[{
                 RowBox[{"vector", "[", "i1", "]"}], " ", 
                 RowBox[{
                  RowBox[{"vector", "[", "i2", "]"}], "/", "norm"}]}]}]}]}], 
             ";", "\n", "     ", 
             RowBox[{
              RowBox[{
              "xAct`xTensor`Private`MetricToProjectorRules", "[", "metric", 
               "]"}], " ", "=", " ", "\n", "      ", 
              RowBox[{
               RowBox[{"supermetric", "[", 
                RowBox[{"i1_", ",", " ", "i2_"}], "]"}], " ", "->", " ", "\n",
                "       ", 
               RowBox[{
                RowBox[{"metric", "[", 
                 RowBox[{"i1", ",", " ", "i2"}], "]"}], " ", "+", " ", 
                RowBox[{
                 RowBox[{"vector", "[", "i1", "]"}], " ", 
                 RowBox[{
                  RowBox[{"vector", "[", "i2", "]"}], "/", "norm"}]}]}]}]}], 
             ";", "\n", "\n", 
             RowBox[{"(*", 
              RowBox[{
               RowBox[{"Define", " ", "projector", " ", "inert"}], "-", 
               "head"}], "*)"}], "     ", "\n", "     ", 
             RowBox[{"DefInertHead", "[", 
              RowBox[{"projectorname", ",", " ", 
               RowBox[{"LinearQ", " ", "->", " ", "True"}], ",", " ", 
               RowBox[{"Master", " ", "->", " ", "metric"}], ",", " ", "\n", 
               "      ", 
               RowBox[{"PrintAs", " ", ":>", " ", 
                RowBox[{"GiveOutputString", "[", 
                 RowBox[{"Projector", ",", " ", "metric"}], "]"}]}], ",", " ",
                "\n", "      ", 
               RowBox[{"ProtectNewSymbol", " ", "->", " ", "False"}], ",", 
               " ", "\n", "      ", 
               RowBox[{"DefInfo", " ", "->", " ", 
                RowBox[{"{", 
                 RowBox[{
                 "\"\<projector inert-head\>\"", ",", " ", "\"\<\>\""}], 
                 "}"}]}]}], "]"}], ";", "\n", "     ", "\n", "     ", 
             RowBox[{
              RowBox[{"projectorname", "[", 
               RowBox[{"supermetric", "[", 
                RowBox[{"a_", ",", " ", "b_"}], "]"}], "]"}], " ", ":=", " ", 
              
              RowBox[{"metric", "[", 
               RowBox[{"a", ",", " ", "b"}], "]"}]}], ";", "\n", "     ", 
             RowBox[{"(*", 
              RowBox[{
               RowBox[{"The", " ", "metric"}], ",", 
               RowBox[{"but", " ", "not", " ", "the", " ", "supermetric"}], 
               ",", "\n", "     ", 
               RowBox[{
               "can", " ", "be", " ", "contracted", " ", "through", " ", 
                "the", " ", "projector"}]}], "*)"}], "\n", "     ", "\n", 
             "     ", 
             RowBox[{"xTagSet", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"projectorname", ",", " ", 
                 RowBox[{"ContractThroughQ", "[", 
                  RowBox[{"projectorname", ",", " ", "metric"}], "]"}]}], 
                "}"}], ",", "\n", "       ", "True"}], "]"}], ";", "\n", 
             RowBox[{"(*", 
              RowBox[{
              "The", " ", "supermetric", " ", "is", " ", "converted", " ", 
               "into", " ", "metric", " ", "when", " ", "contracted", " ", 
               "with", " ", "the", " ", "projector", " ", "or", " ", "covd"}],
               "*)"}], "\n", "     ", 
             RowBox[{"xTagSetDelayed", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"projectorname", ",", " ", "\n", "       ", 
                 RowBox[{
                  RowBox[{"supermetric", "[", 
                   RowBox[{"i1_", ",", " ", "i2_"}], "]"}], " ", 
                  RowBox[{"projectorname", "[", "expr_", "]"}]}]}], "}"}], 
               ",", " ", "\n", "      ", 
               RowBox[{
                RowBox[{
                 RowBox[{"metric", "[", 
                  RowBox[{"i1", ",", " ", "i2"}], "]"}], " ", 
                 RowBox[{"projectorname", "[", "expr", "]"}]}], " ", "/;", 
                " ", "\n", "       ", 
                RowBox[{"Or", "[", 
                 RowBox[{
                  RowBox[{"IsIndexOf", "[", 
                   RowBox[{"expr", ",", " ", 
                    RowBox[{"-", "i1"}], ",", " ", "metric"}], "]"}], ",", 
                  " ", 
                  RowBox[{"IsIndexOf", "[", 
                   RowBox[{"expr", ",", " ", 
                    RowBox[{"-", "i2"}], ",", " ", "metric"}], "]"}]}], 
                 "]"}]}]}], "]"}], ";", "\n", "     ", "\n", "     ", 
             RowBox[{"xTagSetDelayed", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"covd", ",", " ", 
                 RowBox[{
                  RowBox[{"supermetric", "[", 
                   RowBox[{"i1_", ",", " ", "i2_"}], "]"}], " ", 
                  RowBox[{
                   RowBox[{"covd", "[", "i3_", "]"}], "[", "expr_", "]"}]}]}],
                 "}"}], ",", " ", "\n", "      ", 
               RowBox[{
                RowBox[{
                 RowBox[{"metric", "[", 
                  RowBox[{"i1", ",", " ", "i2"}], "]"}], " ", 
                 RowBox[{
                  RowBox[{"covd", "[", "i3", "]"}], "[", "expr", "]"}]}], " ",
                 "/;", " ", "\n", "       ", 
                RowBox[{"Or", "[", 
                 RowBox[{
                  RowBox[{"IsIndexOf", "[", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"covd", "[", "i3", "]"}], "[", "expr", "]"}], ",",
                     " ", 
                    RowBox[{"-", "i1"}], ",", " ", "metric"}], "]"}], ",", 
                  " ", "\n", "        ", 
                  RowBox[{"IsIndexOf", "[", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"covd", "[", "i3", "]"}], "[", "expr", "]"}], ",",
                     " ", 
                    RowBox[{"-", "i2"}], ",", " ", "metric"}], "]"}]}], 
                 "]"}]}]}], "]"}], ";", "\n", "     ", "\n", "\n", 
             RowBox[{"(*", 
              RowBox[{"Projection", " ", "rule", " ", "with", " ", "vector"}],
               "*)"}], "     ", "\n", "     ", 
             RowBox[{"xTagSetDelayed", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"projectorname", ",", " ", 
                 RowBox[{
                  RowBox[{"vector", "[", "i_", "]"}], " ", 
                  RowBox[{"projectorname", "[", "expr_", "]"}]}]}], "}"}], 
               ",", " ", "\n", "      ", 
               RowBox[{"0", " ", "/;", " ", 
                RowBox[{"IsIndexOf", "[", 
                 RowBox[{"expr", ",", " ", 
                  RowBox[{"-", "i"}], ",", " ", "metric"}], "]"}]}]}], "]"}], 
             ";", "\n", "\n", "     ", 
             RowBox[{"xTagSetDelayed", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"projectorname", ",", 
                 RowBox[{
                  RowBox[{"vector", "[", "i_", "]"}], 
                  RowBox[{"projectorname", "[", "expr_", "]"}]}]}], "}"}], 
               ",", 
               RowBox[{"0", "/;", 
                RowBox[{"IsIndexOf", "[", 
                 RowBox[{"expr", ",", 
                  RowBox[{"-", "i"}], ",", "metric"}], "]"}]}]}], "]"}], ";", 
             "\n", "     ", "\n", 
             RowBox[{"(*", 
              RowBox[{"Particular", " ", "cases"}], "*)"}], "\n", "     ", 
             RowBox[{
              RowBox[{"projectorname", "[", "1", "]"}], " ", ":=", " ", "1"}],
              ";", "\n", "     ", 
             RowBox[{
              RowBox[{"projectorname", "[", 
               RowBox[{"rest_.", " ", 
                RowBox[{"x_", "?", "ScalarQ"}]}], "]"}], " ", ":=", " ", 
              RowBox[{
               RowBox[{"Scalar", "[", "x", "]"}], " ", 
               RowBox[{"projectorname", "[", "rest", "]"}]}]}], ";", "\n", 
             "     ", 
             RowBox[{
              RowBox[{"projectorname", "[", 
               RowBox[{
                RowBox[{"vector", "[", "i_", "]"}], " ", "expr_."}], "]"}], 
              " ", ":=", " ", "\n", "      ", 
              RowBox[{"0", " ", "/;", " ", 
               RowBox[{"Not", "@", 
                RowBox[{"IsIndexOf", "[", 
                 RowBox[{"expr", ",", " ", 
                  RowBox[{"-", "i"}], ",", " ", "supermetric"}], "]"}]}]}]}], 
             ";", "\n", "     ", 
             RowBox[{
              RowBox[{"projectorname", "[", 
               RowBox[{"projectorname", "[", "expr_", "]"}], "]"}], " ", ":=",
               " ", 
              RowBox[{"projectorname", "[", "expr", "]"}]}], ";", "\n", 
             "     ", 
             RowBox[{
              RowBox[{"projectorname", "[", 
               RowBox[{
                RowBox[{"tensor_", "?", "xTensorQ"}], "[", "inds__", "]"}], 
               "]"}], " ", ":=", " ", "\n", "      ", 
              RowBox[{
               RowBox[{"tensor", "[", "inds", "]"}], " ", "/;", " ", 
               RowBox[{
                RowBox[{"OrthogonalToVectorQ", "[", "vector", "]"}], "[", 
                "tensor", "]"}]}]}], ";", "\n", "     ", 
             RowBox[{
              RowBox[{"projectorname", "[", 
               RowBox[{
                RowBox[{"covd", "[", "k_", "]"}], "[", "expr_", "]"}], "]"}], 
              " ", ":=", " ", 
              RowBox[{
               RowBox[{"covd", "[", "k", "]"}], "[", "expr", "]"}]}], ";", 
             "\n", "     ", "\n", "     ", 
             RowBox[{
              RowBox[{
              "xAct`xTensor`Private`ProjectDerivativeRules", "[", "\n", 
               "       ", "covd", "]"}], " ", "=", " ", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"covd", "[", "i_", "]"}], "[", "expr_", "]"}], " ", ":>",
                 " ", "\n", "        ", 
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{"IsIndexOf", "[", 
                   RowBox[{"expr", ",", " ", 
                    RowBox[{"-", "i"}]}], "]"}], ",", " ", "\n", "         ", 
                  
                  RowBox[{"With", "[", 
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{"dummy", " ", "=", " ", 
                    RowBox[{"DummyAs", "[", "i", "]"}]}], "}"}], ",", " ", 
                    "\n", "          ", 
                    RowBox[{
                    RowBox[{"metric", "[", 
                    RowBox[{"i", ",", " ", 
                    RowBox[{"-", "dummy"}]}], "]"}], " ", 
                    RowBox[{"projectorname", "[", 
                    RowBox[{
                    RowBox[{"superCD", "[", "dummy", "]"}], "[", "expr", 
                    "]"}], "]"}]}]}], "]"}], ",", " ", "\n", "         ", 
                  RowBox[{"projectorname", "[", 
                   RowBox[{
                    RowBox[{"superCD", "[", "i", "]"}], "[", "expr", "]"}], 
                   "]"}]}], "]"}]}], "}"}]}], ";", "\n", "     ", "\n", 
             "     ", 
             RowBox[{"Module", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"prot", " ", "=", " ", "\n", "        ", 
                 RowBox[{"Unprotect", "[", "covd", "]"}]}], "}"}], ",", 
               RowBox[{"(*", 
                RowBox[{"Leibnitz", " ", 
                 RowBox[{"rule", ".", "Three"}], " ", "cases", " ", 
                 "considered"}], "*)"}], "\n", "      ", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"covd", "[", "i1_", "]"}], "[", 
                  RowBox[{"x_Scalar", " ", "y_Scalar"}], "]"}], " ", ":=", 
                 " ", 
                 RowBox[{
                  RowBox[{"x", " ", 
                   RowBox[{
                    RowBox[{"covd", "[", "i1", "]"}], "[", "y", "]"}]}], " ", 
                  "+", " ", 
                  RowBox[{"y", " ", 
                   RowBox[{
                    RowBox[{"covd", "[", "i1", "]"}], "[", "x", "]"}]}]}]}], 
                ";", "\n", "      ", 
                RowBox[{"(*", 
                 RowBox[{
                 "Special", " ", "definitions", " ", "suggested", " ", "by", 
                  " ", "Cyril"}], "*)"}], "\n", "      ", 
                RowBox[{
                 RowBox[{
                  RowBox[{"covd", "[", "i1_", "]"}], "[", 
                  RowBox[{"supermetric", "[", 
                   RowBox[{
                    RowBox[{"a_", "?", "AIndexQ"}], ",", " ", 
                    RowBox[{"b_", "?", "AIndexQ"}]}], "]"}], "]"}], " ", ":=",
                  " ", "0"}], ";", "\n", "      ", 
                RowBox[{"(*", 
                 RowBox[{
                  RowBox[{
                  "Cyril", " ", "suggests", " ", "removing", " ", "the", " ", 
                   "OrthogonalToVectorQ", " ", "check", " ", "to", " ", 
                   "handle", " ", "the", " ", "many"}], "-", 
                  RowBox[{"supermetrics", " ", "case"}]}], "*)"}], "\n", 
                "      ", 
                RowBox[{
                 RowBox[{
                  RowBox[{"covd", "[", "i1_", "]"}], "[", 
                  RowBox[{"x_", " ", 
                   RowBox[{"supermetric", "[", 
                    RowBox[{
                    RowBox[{"a_", "?", "AIndexQ"}], ",", " ", 
                    RowBox[{"b_", "?", "AIndexQ"}]}], "]"}]}], "]"}], " ", ":=",
                  " ", "\n", "       ", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"metric", "[", 
                    RowBox[{"a", ",", " ", "b"}], "]"}], " ", 
                   RowBox[{
                    RowBox[{"covd", "[", "i1", "]"}], "[", "x", "]"}]}], " ", 
                  "/;", " ", 
                  RowBox[{
                   RowBox[{"OrthogonalToVectorQ", "[", "vector", "]"}], "[", 
                   "x", "]"}]}]}], ";", "\n", "      ", 
                RowBox[{
                 RowBox[{
                  RowBox[{"covd", "[", "i1_", "]"}], "[", 
                  RowBox[{"x_", " ", 
                   RowBox[{"delta", "[", 
                    RowBox[{
                    RowBox[{"a_", "?", "AIndexQ"}], ",", " ", 
                    RowBox[{"b_", "?", "AIndexQ"}]}], "]"}]}], "]"}], " ", ":=",
                  " ", "\n", "       ", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"metric", "[", 
                    RowBox[{"a", ",", " ", "b"}], "]"}], " ", 
                   RowBox[{
                    RowBox[{"covd", "[", "i1", "]"}], "[", "x", "]"}]}], " ", 
                  "/;", " ", 
                  RowBox[{
                   RowBox[{"OrthogonalToVectorQ", "[", "vector", "]"}], "[", 
                   "x", "]"}]}]}], ";", "\n", "      ", 
                RowBox[{
                 RowBox[{
                  RowBox[{"covd", "[", "i1_", "]"}], "[", 
                  RowBox[{
                   RowBox[{"vector", "[", 
                    RowBox[{"a_", "?", "AIndexQ"}], "]"}], " ", 
                   RowBox[{"vector", "[", 
                    RowBox[{"b_", "?", "AIndexQ"}], "]"}], " ", "x_."}], 
                  "]"}], " ", ":=", " ", "\n", "       ", 
                 RowBox[{"0", " ", "/;", " ", 
                  RowBox[{"And", "[", 
                   RowBox[{
                    RowBox[{"!", " ", 
                    RowBox[{"IsIndexOf", "[", 
                    RowBox[{"x", ",", " ", 
                    RowBox[{"ChangeIndex", "@", "a"}]}], "]"}]}], ",", " ", 
                    RowBox[{"!", " ", "\n", "          ", 
                    RowBox[{"IsIndexOf", "[", 
                    RowBox[{"x", ",", " ", 
                    RowBox[{"ChangeIndex", "@", "b"}]}], "]"}]}], ",", " ", 
                    RowBox[{"!", " ", 
                    RowBox[{"PairQ", "[", 
                    RowBox[{"a", ",", " ", "b"}], "]"}]}]}], "]"}]}]}], ";", 
                "\n", "\n", "      ", 
                RowBox[{"(*", 
                 RowBox[{
                  RowBox[{"Product", " ", "of", " ", "two"}], ",", 
                  RowBox[{"perhaps", " ", "contracted"}], ",", 
                  "expressions"}], "*)"}], "\n", "      ", 
                RowBox[{
                 RowBox[{
                  RowBox[{"covd", "[", "i1_", "]"}], "[", 
                  RowBox[{"x_", " ", "y_"}], "]"}], " ", ":=", " ", "\n", 
                 "       ", 
                 RowBox[{"Module", "[", 
                  RowBox[{
                   RowBox[{"{", "res", "}"}], ",", " ", 
                   RowBox[{
                    RowBox[{"res", " ", "=", " ", 
                    RowBox[{"Which", "[", 
                    RowBox[{"(*", 
                    RowBox[{
                    "Both", " ", "are", " ", "orthogonal", " ", "in", " ", 
                    "all", " ", "their", " ", 
                    RowBox[{"indices", ".", "We"}], " ", "can", " ", "use", 
                    " ", "the", " ", "Leibnitz", " ", "rule"}], "*)"}], "\n", 
                    "          ", 
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{"OrthogonalToVectorQ", "[", "vector", "]"}], "[", 
                    "x", "]"}], " ", "&&", " ", 
                    RowBox[{
                    RowBox[{"OrthogonalToVectorQ", "[", "vector", "]"}], "[", 
                    "y", "]"}]}], ",", " ", "\n", "          ", 
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{"covd", "[", "i1", "]"}], "[", "x", "]"}], " ", 
                    "y"}], " ", "+", " ", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"covd", "[", "i1", "]"}], "[", "y", "]"}], " ", 
                    "x"}]}], ",", 
                    RowBox[{"(*", 
                    RowBox[{
                    "The", " ", "expression", " ", "is", " ", "not", " ", 
                    "globally", " ", 
                    RowBox[{"orthogonal", ":", " ", 
                    RowBox[{
                    "complain", " ", "and", " ", "return", " ", 
                    "unevaluated"}]}]}], "*)"}], "\n", "         ", "\n", 
                    "          ", 
                    RowBox[{"Not", "@", 
                    RowBox[{
                    RowBox[{"OrthogonalToVectorQ", "[", "vector", "]"}], "[", 
                    
                    RowBox[{"x", " ", "y"}], "]"}]}], ",", " ", "\n", 
                    "          ", 
                    RowBox[{
                    RowBox[{"Message", "[", 
                    RowBox[{
                    RowBox[{"Validate", "::", "nonproj"}], ",", " ", 
                    RowBox[{"x", " ", "y"}]}], "]"}], ";", " ", "$Failed"}], 
                    ",", 
                    RowBox[{"(*", 
                    RowBox[{
                    RowBox[{"Expression", " ", "is", " ", "orthogonal"}], ",",
                     " ", 
                    RowBox[{"but", " ", "factors", " ", "are", " ", 
                    RowBox[{"not", ".", "Avoid"}], " ", "infinite", " ", 
                    "recursion", " ", "with", " ", "this", " ", "hack"}]}], 
                    "*)"}], "\n", "          ", "\n", "          ", 
                    RowBox[{"FreeQ", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"x", ",", " ", "y"}], "}"}], ",", " ", "vector"}],
                     "]"}], ",", " ", "\n", "          ", 
                    RowBox[{
                    RowBox[{"covd", "[", "i1", "]"}], "[", 
                    RowBox[{"Expand", "@", 
                    RowBox[{"GradNormalToExtrinsicK", "@", 
                    RowBox[{"Expand", "[", 
                    RowBox[{
                    RowBox[{"InducedDecomposition", "[", 
                    RowBox[{"x", ",", " ", 
                    RowBox[{"{", 
                    RowBox[{"metric", ",", " ", "vector"}], "}"}]}], "]"}], 
                    " ", 
                    RowBox[{"InducedDecomposition", "[", 
                    RowBox[{"y", ",", " ", 
                    RowBox[{"{", 
                    RowBox[{"metric", ",", " ", "vector"}], "}"}]}], "]"}]}], 
                    "]"}]}]}], "]"}], ",", "\n", "          ", 
                    RowBox[{"(*", 
                    RowBox[{
                    "This", " ", "should", " ", "never", " ", "happen"}], 
                    "*)"}], "True", ",", " ", "$Failed"}], "]"}]}], ";", "\n",
                     "        ", 
                    RowBox[{"res", " ", "/;", " ", 
                    RowBox[{"res", " ", "=!=", " ", "$Failed"}]}]}]}], 
                  "]"}]}], ";", "\n", "\n", "      ", 
                RowBox[{"(*", 
                 RowBox[{
                  RowBox[{
                   RowBox[{
                   "Induced", " ", "derivatives", " ", "of", " ", "non"}], 
                   "-", 
                   RowBox[{
                   "spatial", " ", "objects", " ", "are", " ", "not", " ", 
                    "accepted"}]}], ",", "\n", "      ", 
                  RowBox[{"not", " ", "even", " ", "divergencies"}]}], "*)"}],
                 "\n", "      ", 
                RowBox[{
                 RowBox[{
                  RowBox[{"covd", "[", 
                   RowBox[{"_", "?", "GIndexQ"}], "]"}], "[", "expr_", "]"}], 
                 " ", ":=", " ", 
                 RowBox[{"$Failed", " ", "/;", " ", "\n", "        ", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"Head", "[", "expr", "]"}], " ", "=!=", " ", 
                    "Times"}], " ", "&&", " ", 
                   RowBox[{"Not", "@", 
                    RowBox[{
                    RowBox[{"OrthogonalToVectorQ", "[", "vector", "]"}], "[", 
                    "expr", "]"}]}], " ", "&&", " ", 
                   RowBox[{"Message", "[", 
                    RowBox[{
                    RowBox[{"Validate", "::", "nonproj"}], ",", " ", "expr"}],
                     "]"}]}]}]}], ";", "\n", "      ", 
                RowBox[{"Protect", "[", 
                 RowBox[{"Evaluate", "[", "prot", "]"}], "]"}], ";"}]}], 
              "]"}], ";", "\n", " ", "\n", "    ", 
             RowBox[{"(*", 
              RowBox[{"Special", " ", "definitions"}], "*)"}], "\n", "     ", 
             
             RowBox[{"metric", " ", "/:", 
              RowBox[{
               RowBox[{"LieD", "[", 
                RowBox[{"vector", "[", "_", "]"}], "]"}], "[", 
               RowBox[{"metric", "[", 
                RowBox[{
                 RowBox[{"-", "a_Symbol"}], ",", " ", 
                 RowBox[{"-", "b_Symbol"}]}], "]"}], "]"}], " ", ":=", " ", 
              RowBox[{"$ExtrinsicKOnSSSign", " ", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"extrinsicKname", "[", 
                  RowBox[{
                   RowBox[{"-", "a"}], ",", " ", 
                   RowBox[{"-", "b"}]}], "]"}], " ", "+", " ", 
                 RowBox[{"extrinsicKname", "[", 
                  RowBox[{
                   RowBox[{"-", "b"}], ",", " ", 
                   RowBox[{"-", "a"}]}], "]"}]}], ")"}]}]}], ";", "\n", "\n", 
             "     ", 
             RowBox[{"metric", " ", "/:", 
              RowBox[{
               RowBox[{"LieD", "[", 
                RowBox[{"vector", "[", "_", "]"}], "]"}], "[", 
               RowBox[{"metric", "[", 
                RowBox[{"a_Symbol", ",", " ", 
                 RowBox[{"-", "b_Symbol"}]}], "]"}], "]"}], " ", ":=", " ", 
              RowBox[{
               RowBox[{"-", "$AccelerationOfnSign"}], " ", 
               RowBox[{"accelerationname", "[", 
                RowBox[{"-", "b"}], "]"}], " ", 
               RowBox[{"vector", "[", "a", "]"}]}]}], ";", "\n", " ", "\n", 
             "    ", 
             RowBox[{"metric", " ", "/:", " ", 
              RowBox[{
               RowBox[{"LieD", "[", 
                RowBox[{"vector", "[", "_", "]"}], "]"}], "[", 
               RowBox[{"metric", "[", 
                RowBox[{
                 RowBox[{"-", "a_Symbol"}], ",", "b_Symbol"}], "]"}], "]"}], 
              " ", ":=", " ", 
              RowBox[{
               RowBox[{"-", "$AccelerationOfnSign"}], " ", 
               RowBox[{"accelerationname", "[", 
                RowBox[{"-", "a"}], "]"}], " ", 
               RowBox[{"vector", "[", "b", "]"}]}]}], ";", "\n", " ", "\n", 
             "    ", 
             RowBox[{"metric", " ", "/:", " ", 
              RowBox[{
               RowBox[{"LieD", "[", 
                RowBox[{"vector", "[", "_", "]"}], "]"}], "[", 
               RowBox[{"metric", "[", 
                RowBox[{"a_Symbol", ",", "b_Symbol"}], "]"}], "]"}], " ", ":=",
               " ", 
              RowBox[{
               RowBox[{
                RowBox[{"-", "$ExtrinsicKOnSSSign"}], " ", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"extrinsicKname", "[", 
                   RowBox[{"a", ",", " ", "b"}], "]"}], " ", "+", " ", "\n", 
                  "          ", 
                  RowBox[{"extrinsicKname", "[", 
                   RowBox[{"b", ",", "a"}], "]"}]}], ")"}]}], " ", "-", " ", 
               RowBox[{"$AccelerationOfnSign", " ", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"vector", "[", "a", "]"}], " ", 
                   RowBox[{"accelerationname", "[", "b", "]"}]}], " ", "+", 
                  " ", 
                  RowBox[{
                   RowBox[{"vector", "[", "b", "]"}], " ", 
                   RowBox[{"accelerationname", "[", "a", "]"}]}]}], 
                 ")"}]}]}]}], ";", "\n", "     ", "\n", "    ", 
             RowBox[{"vector", " ", "/:", 
              RowBox[{
               RowBox[{"LieD", "[", 
                RowBox[{"vector", "[", "_", "]"}], "]"}], "[", 
               RowBox[{"vector", "[", "a_Symbol", "]"}], "]"}], " ", ":=", 
              " ", "0"}], ";", "\n", "     ", "\n", "    ", 
             RowBox[{"vector", " ", "/:", 
              RowBox[{
               RowBox[{"LieD", "[", 
                RowBox[{"vector", "[", "_", "]"}], "]"}], "[", 
               RowBox[{"vector", "[", 
                RowBox[{"-", "a_Symbol"}], "]"}], "]"}], " ", ":=", " ", 
              RowBox[{"$AccelerationOfnSign", " ", "norm", " ", 
               RowBox[{"accelerationname", "[", 
                RowBox[{"-", "a"}], "]"}]}]}], ";", "\n", "\n", "\n", "     ", 
             RowBox[{"Module", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"prot", " ", "=", " ", 
                 RowBox[{"Unprotect", "[", 
                  RowBox[{"{", 
                   RowBox[{"superepsilonname", ",", " ", "epsilonname"}], 
                   "}"}], "]"}]}], "}"}], ",", " ", "\n", "      ", 
               RowBox[{
                RowBox[{"superepsilonname", " ", "/:", " ", "\n", "       ", 
                 RowBox[{
                  RowBox[{"LieD", "[", 
                   RowBox[{"vector", "[", "_", "]"}], "]"}], "[", 
                  RowBox[{"superepsilonname", "[", 
                   RowBox[{"inds__", "?", "DownIndexQ"}], "]"}], "]"}], " ", ":=",
                  " ", "\n", "       ", 
                 RowBox[{"Module", "[", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{"dummy", " ", "=", " ", 
                    RowBox[{"DummyIn", "[", "vbundle", "]"}]}], "}"}], ",", 
                   " ", 
                   RowBox[{"$ExtrinsicKOnSSSign", " ", 
                    RowBox[{"extrinsicKname", "[", 
                    RowBox[{"dummy", ",", " ", 
                    RowBox[{"-", "dummy"}]}], "]"}], " ", 
                    RowBox[{"superepsilonname", "[", "inds", "]"}]}]}], 
                  "]"}]}], ";", "\n", "     ", "\n", "     ", 
                RowBox[{"superepsilonname", " ", "/:", " ", "\n", "       ", 
                 RowBox[{
                  RowBox[{"LieD", "[", 
                   RowBox[{"vector", "[", "_", "]"}], "]"}], "[", 
                  RowBox[{"superepsilonname", "[", 
                   RowBox[{"inds__", "?", "UpIndexQ"}], "]"}], "]"}], " ", ":=",
                  " ", "\n", "       ", 
                 RowBox[{"Module", "[", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{
                    RowBox[{"dummy", " ", "=", " ", 
                    RowBox[{"DummyIn", "[", "vbundle", "]"}]}], ",", 
                    RowBox[{"first", " ", "=", " ", 
                    RowBox[{"First", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}]}], "}"}], ",", " ", 
                   RowBox[{
                    RowBox[{"-", "$ExtrinsicKOnSSSign"}], " ", 
                    RowBox[{"extrinsicKname", "[", 
                    RowBox[{"dummy", ",", " ", 
                    RowBox[{"-", "dummy"}]}], "]"}], " ", 
                    RowBox[{"superepsilonname", "[", "inds", "]"}]}]}], 
                  "]"}]}], ";", "\n", "      ", "\n", "     ", 
                RowBox[{"epsilonname", " ", "/:", " ", 
                 RowBox[{
                  RowBox[{"LieD", "[", 
                   RowBox[{"vector", "[", "_", "]"}], "]"}], "[", 
                  RowBox[{"epsilonname", "[", 
                   RowBox[{"inds__", "?", "DownIndexQ"}], "]"}], "]"}], " ", ":=",
                  "\n", "      ", 
                 RowBox[{"Module", "[", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{"dummy", " ", "=", " ", 
                    RowBox[{"DummyIn", "[", "vbundle", "]"}]}], "}"}], ",", 
                   " ", 
                   RowBox[{"$ExtrinsicKOnSSSign", " ", 
                    RowBox[{"extrinsicKname", "[", 
                    RowBox[{"dummy", ",", " ", 
                    RowBox[{"-", "dummy"}]}], "]"}], " ", 
                    RowBox[{"epsilonname", "[", "inds", "]"}]}]}], "]"}]}], 
                ";", "\n", "    ", "\n", "     ", 
                RowBox[{"epsilonname", " ", "/:", " ", 
                 RowBox[{
                  RowBox[{"LieD", "[", 
                   RowBox[{"vector", "[", "_", "]"}], "]"}], "[", 
                  RowBox[{"epsilonname", "[", 
                   RowBox[{"inds__", "?", "UpIndexQ"}], "]"}], "]"}], " ", ":=",
                  " ", "\n", "       ", 
                 RowBox[{"Module", "[", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{
                    RowBox[{"dummy", " ", "=", " ", 
                    RowBox[{"DummyIn", "[", "vbundle", "]"}]}], ",", " ", 
                    "\n", "         ", 
                    RowBox[{"first", " ", "=", " ", 
                    RowBox[{"First", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}]}], "}"}], ",", " ", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"-", "$ExtrinsicKOnSSSign"}], " ", 
                    RowBox[{"extrinsicKname", "[", 
                    RowBox[{"dummy", ",", " ", 
                    RowBox[{"-", "dummy"}]}], "]"}], " ", 
                    RowBox[{"epsilonname", "[", "inds", "]"}]}], " ", "\n", 
                    "                                 ", "+", " ", 
                    RowBox[{"$AccelerationOfnSign", " ", "norm", " ", 
                    RowBox[{"accelerationname", "[", 
                    RowBox[{"-", "dummy"}], "]"}], " ", 
                    RowBox[{"superepsilonname", "[", 
                    RowBox[{"dummy", ",", " ", "inds"}], "]"}]}]}]}], "]"}]}],
                 ";", "\n", "      ", 
                RowBox[{"Protect", "[", 
                 RowBox[{"Evaluate", "[", "prot", "]"}], "]"}]}]}], "]"}], 
             ";"}]}], "]"}], ";", "\n", "\n", "\n", "    ", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{"Gauss", " ", "Codazzi", " ", "Rules"}], ",", "\n", 
            "    ", 
            RowBox[{"for", " ", "abstract", " ", 
             RowBox[{"indices", ".", "Only"}], " ", "for", " ", 
             RowBox[{"Riemann", ".", "Norms"}], " ", "are", " ", "wrong"}]}], 
           "*)"}], "\n", "    ", 
          RowBox[{"With", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"riemann", " ", "=", " ", 
               RowBox[{"Riemann", "[", "covd", "]"}]}], ",", " ", 
              RowBox[{"superRiemann", " ", "=", " ", 
               RowBox[{"Riemann", "[", "superCD", "]"}]}], ",", " ", "\n", 
              "      ", 
              RowBox[{"superRicci", " ", "=", " ", 
               RowBox[{"Ricci", "[", "superCD", "]"}]}], ",", " ", "\n", 
              "      ", 
              RowBox[{"superRicciScalar", " ", "=", " ", 
               RowBox[{"RicciScalar", "[", "superCD", "]"}]}], ",", " ", 
              RowBox[{"K", " ", "=", " ", "extrinsicKname"}], ",", " ", "\n", 
              "      ", 
              RowBox[{"AA", " ", "=", " ", "accelerationname"}]}], "}"}], ",",
             " ", "\n", "      ", 
            RowBox[{
             RowBox[{
             "xAct`xTensor`Private`GaussCodazziRules", "[", "metric", "]"}], 
             " ", ":=", " ", "\n", "      ", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"superRiemann", "[", 
                 RowBox[{
                  RowBox[{"a_", "?", "AIndexQ"}], ",", " ", 
                  RowBox[{"b_", "?", "AIndexQ"}], ",", " ", 
                  RowBox[{"c_", "?", "AIndexQ"}], ",", " ", "\n", "         ", 
                  RowBox[{"d_", "?", "AIndexQ"}]}], "]"}], " ", ":>", " ", 
                "\n", "        ", 
                RowBox[{"Module", "[", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"e", " ", "=", " ", 
                    RowBox[{"DummyIn", "@", "vbundle"}]}], ",", " ", "PDK"}], 
                   "}"}], ",", " ", "\n", "         ", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"PDK", "[", 
                    RowBox[{"x_", ",", " ", "y_"}], "]"}], " ", ":=", " ", 
                    RowBox[{"projectorname", "[", 
                    RowBox[{
                    RowBox[{"vector", "[", "e", "]"}], " ", 
                    RowBox[{
                    RowBox[{"superCD", "[", 
                    RowBox[{"-", "e"}], "]"}], "@", 
                    RowBox[{"K", "[", 
                    RowBox[{"x", ",", " ", "y"}], "]"}]}]}], "]"}]}], ";", 
                   "\n", "         ", 
                   RowBox[{
                    RowBox[{"riemann", "[", 
                    RowBox[{
                    "a", ",", " ", "b", ",", " ", "c", ",", " ", "\n", 
                    "           ", "d"}], "]"}], " ", "+", " ", 
                    RowBox[{"$RiemannSign", " ", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"-", 
                    RowBox[{"K", "[", 
                    RowBox[{"a", ",", " ", "c"}], "]"}]}], " ", 
                    RowBox[{
                    RowBox[{"K", "[", 
                    RowBox[{"b", ",", " ", "d"}], "]"}], "/", "norm"}]}], " ",
                     "+", " ", 
                    RowBox[{
                    RowBox[{"K", "[", 
                    RowBox[{"a", ",", " ", "d"}], "]"}], " ", 
                    RowBox[{
                    RowBox[{"K", "[", 
                    RowBox[{"b", ",", " ", "c"}], "]"}], "/", "norm"}]}], " ",
                     "-", " ", "\n", "             ", 
                    RowBox[{
                    RowBox[{"AA", "[", "b", "]"}], " ", 
                    RowBox[{"AA", "[", "d", "]"}], " ", 
                    RowBox[{"vector", "[", "a", "]"}], " ", 
                    RowBox[{
                    RowBox[{"vector", "[", "c", "]"}], "/", "norm"}]}], " ", 
                    "-", " ", 
                    RowBox[{
                    RowBox[{"K", "[", 
                    RowBox[{"b", ",", " ", "e"}], "]"}], " ", 
                    RowBox[{"K", "[", 
                    RowBox[{"d", ",", " ", 
                    RowBox[{"-", "e"}]}], "]"}], " ", 
                    RowBox[{"vector", "[", "a", "]"}], " ", 
                    RowBox[{
                    RowBox[{"vector", "[", "c", "]"}], "/", 
                    RowBox[{"norm", "^", "2"}]}]}], " ", "+", " ", "\n", 
                    "             ", 
                    RowBox[{
                    RowBox[{"AA", "[", "a", "]"}], " ", 
                    RowBox[{"AA", "[", "d", "]"}], " ", 
                    RowBox[{"vector", "[", "b", "]"}], " ", 
                    RowBox[{
                    RowBox[{"vector", "[", "c", "]"}], "/", "norm"}]}], " ", 
                    "+", " ", 
                    RowBox[{
                    RowBox[{"K", "[", 
                    RowBox[{"a", ",", " ", "e"}], "]"}], " ", 
                    RowBox[{"K", "[", 
                    RowBox[{"d", ",", " ", 
                    RowBox[{"-", "e"}]}], "]"}], " ", 
                    RowBox[{"vector", "[", "b", "]"}], " ", 
                    RowBox[{
                    RowBox[{"vector", "[", "c", "]"}], "/", 
                    RowBox[{"norm", "^", "2"}]}]}], " ", "+", " ", "\n", 
                    "             ", 
                    RowBox[{
                    RowBox[{"AA", "[", "b", "]"}], " ", 
                    RowBox[{"AA", "[", "c", "]"}], " ", 
                    RowBox[{"vector", "[", "a", "]"}], " ", 
                    RowBox[{
                    RowBox[{"vector", "[", "d", "]"}], "/", "norm"}]}], " ", 
                    "+", " ", 
                    RowBox[{
                    RowBox[{"K", "[", 
                    RowBox[{"b", ",", " ", "e"}], "]"}], " ", 
                    RowBox[{"K", "[", 
                    RowBox[{"c", ",", " ", 
                    RowBox[{"-", "e"}]}], "]"}], " ", 
                    RowBox[{"vector", "[", "a", "]"}], " ", 
                    RowBox[{
                    RowBox[{"vector", "[", "d", "]"}], "/", 
                    RowBox[{"norm", "^", "2"}]}]}], " ", "-", " ", "\n", 
                    "             ", 
                    RowBox[{
                    RowBox[{"AA", "[", "a", "]"}], " ", 
                    RowBox[{"AA", "[", "c", "]"}], " ", 
                    RowBox[{"vector", "[", "b", "]"}], " ", 
                    RowBox[{
                    RowBox[{"vector", "[", "d", "]"}], "/", "norm"}]}], " ", 
                    "-", " ", 
                    RowBox[{
                    RowBox[{"K", "[", 
                    RowBox[{"a", ",", " ", "e"}], "]"}], " ", 
                    RowBox[{"K", "[", 
                    RowBox[{"c", ",", " ", 
                    RowBox[{"-", "e"}]}], "]"}], " ", 
                    RowBox[{"vector", "[", "b", "]"}], " ", 
                    RowBox[{
                    RowBox[{"vector", "[", "d", "]"}], "/", "\n", 
                    "               ", 
                    RowBox[{"norm", "^", "2"}]}]}], " ", "+", " ", 
                    RowBox[{"$ExtrinsicKOnSSSign", " ", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"vector", "[", "b", "]"}], " ", 
                    RowBox[{"vector", "[", "c", "]"}], " ", 
                    RowBox[{
                    RowBox[{"PDK", "[", 
                    RowBox[{"a", ",", " ", "d"}], "]"}], "/", 
                    RowBox[{"norm", "^", "2"}]}]}], " ", "+", " ", "\n", 
                    "                ", 
                    RowBox[{
                    RowBox[{"vector", "[", "a", "]"}], " ", 
                    RowBox[{"vector", "[", "d", "]"}], " ", 
                    RowBox[{
                    RowBox[{"PDK", "[", 
                    RowBox[{"b", ",", " ", "c"}], "]"}], "/", 
                    RowBox[{"norm", "^", "2"}]}]}], " ", "-", " ", 
                    RowBox[{
                    RowBox[{"vector", "[", "a", "]"}], " ", 
                    RowBox[{"vector", "[", "c", "]"}], " ", 
                    RowBox[{
                    RowBox[{"PDK", "[", 
                    RowBox[{"b", ",", " ", "d"}], "]"}], "/", 
                    RowBox[{"norm", "^", "2"}]}]}], " ", "-", " ", "\n", 
                    "                ", 
                    RowBox[{
                    RowBox[{"vector", "[", "b", "]"}], " ", 
                    RowBox[{"vector", "[", "d", "]"}], " ", 
                    RowBox[{
                    RowBox[{"PDK", "[", 
                    RowBox[{"a", ",", " ", "c"}], "]"}], "/", 
                    RowBox[{"norm", "^", "2"}]}]}], " ", "+", " ", 
                    RowBox[{
                    RowBox[{"vector", "[", "d", "]"}], " ", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"covd", "[", "a", "]"}], "@", 
                    RowBox[{"K", "[", 
                    RowBox[{"b", ",", " ", "c"}], "]"}]}], "/", "norm"}]}], 
                    " ", "-", " ", "\n", "                ", 
                    RowBox[{
                    RowBox[{"vector", "[", "c", "]"}], " ", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"covd", "[", "a", "]"}], "@", 
                    RowBox[{"K", "[", 
                    RowBox[{"b", ",", " ", "d"}], "]"}]}], "/", "norm"}]}], 
                    " ", "-", " ", 
                    RowBox[{
                    RowBox[{"vector", "[", "d", "]"}], " ", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"covd", "[", "b", "]"}], "@", 
                    RowBox[{"K", "[", 
                    RowBox[{"a", ",", " ", "c"}], "]"}]}], "/", "norm"}]}], 
                    " ", "+", " ", "\n", "                ", 
                    RowBox[{
                    RowBox[{"vector", "[", "c", "]"}], " ", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"covd", "[", "b", "]"}], "@", 
                    RowBox[{"K", "[", 
                    RowBox[{"a", ",", " ", "d"}], "]"}]}], "/", "norm"}]}], 
                    " ", "+", " ", 
                    RowBox[{
                    RowBox[{"vector", "[", "b", "]"}], " ", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"covd", "[", "c", "]"}], "@", 
                    RowBox[{"K", "[", 
                    RowBox[{"a", ",", " ", "d"}], "]"}]}], "/", "norm"}]}], 
                    " ", "-", " ", "\n", "                ", 
                    RowBox[{
                    RowBox[{"vector", "[", "a", "]"}], " ", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"covd", "[", "c", "]"}], "@", 
                    RowBox[{"K", "[", 
                    RowBox[{"b", ",", " ", "d"}], "]"}]}], "/", "norm"}]}], 
                    " ", "-", " ", 
                    RowBox[{
                    RowBox[{"vector", "[", "b", "]"}], " ", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"covd", "[", "d", "]"}], "@", 
                    RowBox[{"K", "[", 
                    RowBox[{"a", ",", " ", "c"}], "]"}]}], "/", "norm"}]}], 
                    " ", "+", " ", "\n", "                ", 
                    RowBox[{
                    RowBox[{"vector", "[", "a", "]"}], " ", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"covd", "[", "d", "]"}], "@", 
                    RowBox[{"K", "[", 
                    RowBox[{"b", ",", " ", "c"}], "]"}]}], "/", "norm"}]}]}], 
                    ")"}]}], " ", "+", " ", 
                    RowBox[{"$AccelerationOfnSign", " ", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"vector", "[", "b", "]"}], " ", 
                    RowBox[{
                    "vector", "[", "\n", "                  ", "d", "]"}], 
                    " ", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"covd", "[", "c", "]"}], "@", 
                    RowBox[{"AA", "[", "a", "]"}]}], "/", "norm"}]}], " ", 
                    "-", " ", 
                    RowBox[{
                    RowBox[{"vector", "[", "a", "]"}], " ", 
                    RowBox[{"vector", "[", "d", "]"}], " ", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"covd", "[", "c", "]"}], "@", 
                    RowBox[{"AA", "[", "b", "]"}]}], "/", "norm"}]}], " ", 
                    "-", " ", "\n", "                ", 
                    RowBox[{
                    RowBox[{"vector", "[", "b", "]"}], " ", 
                    RowBox[{"vector", "[", "c", "]"}], " ", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"covd", "[", "d", "]"}], "@", 
                    RowBox[{"AA", "[", "a", "]"}]}], "/", "norm"}]}], " ", 
                    "+", " ", 
                    RowBox[{
                    RowBox[{"vector", "[", "a", "]"}], " ", 
                    RowBox[{"vector", "[", "c", "]"}], " ", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"covd", "[", "d", "]"}], "@", 
                    RowBox[{"AA", "[", "b", "]"}]}], "/", "norm"}]}]}], 
                    ")"}]}]}], ")"}]}]}]}]}], "]"}]}], ",", " ", "\n", "\n", 
               "        ", 
               RowBox[{
                RowBox[{"superRicci", "[", 
                 RowBox[{
                  RowBox[{"a_", "?", "AIndexQ"}], ",", " ", 
                  RowBox[{"b_", "?", "AIndexQ"}]}], "]"}], " ", ":>", " ", 
                "\n", "        ", 
                RowBox[{"Module", "[", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"c", " ", "=", " ", 
                    RowBox[{"DummyIn", "@", "vbundle"}]}], "}"}], ",", " ", 
                  "\n", "         ", 
                  RowBox[{"ReleaseHold", "[", 
                   RowBox[{
                    RowBox[{"Hold", "[", 
                    RowBox[{"superRiemann", "[", 
                    RowBox[{"a", ",", " ", 
                    RowBox[{"-", "c"}], ",", " ", "b", ",", " ", "c"}], "]"}],
                     "]"}], " ", "/.", 
                    RowBox[{
                    "xAct`xTensor`Private`GaussCodazziRules", "[", "metric", 
                    "]"}]}], "]"}]}], "]"}]}], ",", " ", "\n", "\n", 
               "       ", 
               RowBox[{
                RowBox[{"superRicciScalar", "[", "]"}], " ", ":>", 
                RowBox[{"Module", "[", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"a", " ", "=", " ", 
                    RowBox[{"DummyIn", "@", "vbundle"}]}], ",", " ", 
                    RowBox[{"b", " ", "=", " ", 
                    RowBox[{"DummyIn", "@", "vbundle"}]}]}], "}"}], ",", " ", 
                  "\n", "         ", 
                  RowBox[{"Expand", "[", 
                   RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"metric", "[", 
                    RowBox[{"a", ",", " ", "b"}], "]"}], " ", "+", " ", 
                    RowBox[{
                    RowBox[{"vector", "[", "a", "]"}], " ", 
                    RowBox[{
                    RowBox[{"vector", "[", "b", "]"}], "/", "norm"}]}]}], 
                    ")"}], " ", 
                    RowBox[{"ReleaseHold", "[", 
                    RowBox[{
                    RowBox[{"Hold", "[", 
                    RowBox[{"superRicci", "[", 
                    RowBox[{
                    RowBox[{"-", "a"}], ",", " ", 
                    RowBox[{"-", "b"}]}], "]"}], "]"}], " ", "/.", " ", 
                    RowBox[{
                    "xAct`xTensor`Private`GaussCodazziRules", "[", "metric", 
                    "]"}]}], "]"}]}], "]"}]}], "]"}]}]}], "}"}]}]}], "]"}], 
          ";", "\n", "\n", "    ", 
          RowBox[{"If", "[", 
           RowBox[{"$ProtectNewSymbols", ",", " ", "\n", "     ", 
            RowBox[{"Protect", "[", 
             RowBox[{
             "extrinsicKname", ",", " ", "accelerationname", ",", " ", 
              "projectorname"}], "]"}]}], "]"}], ";"}]}], "]"}]}], "]"}]}], 
    ";"}]}]}]], "Code"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"DirectionVectorQ", "[", "expr_", "]"}], ":=", "False"}], ";"}], 
  "\n"}], "\n", 
 RowBox[{
  RowBox[{"SetSlicingUpToScreenSpaceObinna", "[", 
   RowBox[{
    RowBox[{"g_", "?", "MetricQ"}], ",", " ", "u_", ",", " ", 
    RowBox[{"normu_:", " ", "-", " ", "1"}], ",", " ", "h_", ",", " ", "\n", 
    "  ", "cd_", ",", " ", 
    RowBox[{"{", 
     RowBox[{"cdpost_String", ",", " ", "cdpre_String"}], "}"}], ",", " ", 
    "n_", ",", " ", 
    RowBox[{"normn_:", " ", "1"}], ",", " ", "NSS_", ",", " ", "\n", "  ", 
    "cd2_", ",", " ", 
    RowBox[{"{", 
     RowBox[{"cd2post_String", ",", " ", "cd2pre_String"}], "}"}], ",", " ", 
    "options_"}], "]"}], " ", ":=", " ", "\n", " ", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "m", ",", " ", "p", ",", " ", "q", ",", " ", "DummyS", ",", " ", 
      "DummyV", ",", " ", "DummyT", ",", " ", "ui", ",", " ", 
      "indsdimminustwo", ",", " ", "\n", "   ", "indsdim", ",", " ", "dim", 
      ",", " ", "prot", ",", " ", "Silenth"}], "}"}], ",", "\n", "  ", 
    RowBox[{"With", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Manifold", " ", "=", " ", 
         RowBox[{"ManifoldOfCovD", "@", 
          RowBox[{"CovDOfMetric", "[", "g", "]"}]}]}], ",", " ", "\n", "    ", 
        RowBox[{"CD", " ", "=", " ", 
         RowBox[{"CovDOfMetric", "[", "g", "]"}]}]}], "}"}], ",", "\n", "   ", 
      RowBox[{
       RowBox[{"dim", " ", "=", " ", 
        RowBox[{"DimOfManifold", "[", "Manifold", "]"}]}], ";", "\n", "   ", 
       "\n", "\n", "   ", 
       RowBox[{"With", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"ind1", " ", "=", " ", 
            RowBox[{"DummyIn", "[", 
             RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
           RowBox[{"ind2", " ", "=", " ", 
            RowBox[{"DummyIn", "[", 
             RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
           RowBox[{"ind3", " ", "=", " ", 
            RowBox[{"DummyIn", "[", 
             RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", " ", 
           "\n", "     ", 
           RowBox[{"ind4", " ", "=", " ", 
            RowBox[{"DummyIn", "[", 
             RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", " ", 
           RowBox[{"ind5", " ", "=", " ", 
            RowBox[{"DummyIn", "[", 
             RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", " ", 
           RowBox[{"ind6", " ", "=", " ", 
            RowBox[{"DummyIn", "[", 
             RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", " ", 
           RowBox[{"ind7", " ", "=", " ", 
            RowBox[{"DummyIn", "[", 
             RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", " ", 
           "\n", "     ", 
           RowBox[{"i1", " ", "=", " ", 
            RowBox[{"DummyIn", "[", 
             RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", " ", 
           RowBox[{"i2", " ", "=", " ", 
            RowBox[{"DummyIn", "[", 
             RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", " ", 
           RowBox[{"i3", " ", "=", " ", 
            RowBox[{"DummyIn", "[", 
             RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", " ", 
           RowBox[{"i4", " ", "=", " ", 
            RowBox[{"DummyIn", "[", 
             RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", " ", 
           RowBox[{"i5", " ", "=", " ", 
            RowBox[{"DummyIn", "[", 
             RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", "\n", 
           "      ", 
           RowBox[{"dummy", " ", "=", " ", 
            RowBox[{"DummyIn", "[", 
             RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}]}], "}"}], ",",
          "\n", "\n", "\n", "    ", 
         RowBox[{
          RowBox[{
           RowBox[{"DefTensor", "[", 
            RowBox[{
             RowBox[{"u", "[", 
              RowBox[{"-", "ind1"}], "]"}], ",", " ", 
             RowBox[{"{", "Manifold", "}"}], ",", 
             RowBox[{"PrintAs", " ", "->", " ", 
              RowBox[{"\"\<\\!\\(\>\"", " ", "<>", " ", 
               RowBox[{"ToString", "[", "u", "]"}], " ", "<>", " ", 
               "\"\<\\&-\\)\>\""}]}]}], "]"}], "\n", "         ", "\n", 
           "    ", "\n", "    ", 
           RowBox[{"Off", "[", 
            RowBox[{"DefMetric", "::", "old"}], "]"}]}], ";", "\n", "    ", 
          RowBox[{"(*", " ", 
           RowBox[{
           "Definition", " ", "of", " ", "the", " ", "space", " ", "induced", 
            " ", 
            RowBox[{"metric", ".", " ", "Standard"}], " ", "in", " ", 
            RowBox[{"xTensor", "."}]}], "*)"}], "\n", "    ", 
          RowBox[{"DefMetric", "[", 
           RowBox[{"1", ",", " ", 
            RowBox[{"h", "[", 
             RowBox[{
              RowBox[{"-", "ind1"}], ",", " ", 
              RowBox[{"-", "ind2"}]}], "]"}], ",", " ", "cd", ",", " ", 
            RowBox[{"{", 
             RowBox[{"cdpost", ",", " ", "cdpre"}], "}"}], ",", 
            RowBox[{"InducedFrom", " ", "->", " ", 
             RowBox[{"{", 
              RowBox[{"g", ",", " ", "u"}], "}"}]}], ",", 
            RowBox[{"PrintAs", " ", "->", " ", 
             RowBox[{"\"\<\\!\\(\>\"", " ", "<>", " ", 
              RowBox[{"ToString", "[", "h", "]"}], " ", "<>", " ", 
              "\"\<\\&-\\)\>\""}]}]}], "]"}], ";", "\n", "    ", 
          RowBox[{"On", "[", 
           RowBox[{"DefMetric", "::", "old"}], "]"}], ";", "    ", "\n", "\n",
           "    ", 
          RowBox[{"(*", " ", 
           RowBox[{
           "Definition", " ", "of", " ", "the", " ", "direction", " ", 
            "vector"}], " ", "*)"}], "\n", "    ", 
          RowBox[{"DefTensor", "[", 
           RowBox[{
            RowBox[{"n", "[", 
             RowBox[{"-", "ind1"}], "]"}], ",", " ", 
            RowBox[{"{", "Manifold", "}"}], ",", " ", 
            RowBox[{"OrthogonalTo", " ", "->", " ", 
             RowBox[{"{", 
              RowBox[{"u", "[", "ind1", "]"}], "}"}]}], ",", 
            RowBox[{"ProjectedWith", " ", "->", " ", 
             RowBox[{"{", 
              RowBox[{"h", "[", 
               RowBox[{"ind1", ",", " ", 
                RowBox[{"-", "ind2"}]}], "]"}], "}"}]}], ",", 
            RowBox[{"PrintAs", " ", "->", " ", 
             RowBox[{"\"\<\\!\\(\>\"", " ", "<>", " ", 
              RowBox[{"ToString", "[", "n", "]"}], " ", "<>", " ", 
              "\"\<\\&-\\)\>\""}]}]}], "]"}], ";", "\n", "     ", "\n", 
          RowBox[{"(*", 
           RowBox[{
           "A", " ", "boolean", " ", "value", " ", "which", " ", "is", " ", 
            "used", " ", "for", " ", "furtehr", " ", "checks", " ", "and", 
            " ", "avoids", " ", "the", " ", "user", " ", "to", " ", "create", 
            " ", "problems", " ", "if", " ", "the", " ", "screen", " ", 
            "space", " ", "splitting", " ", "had", " ", "not", " ", "been", 
            " ", 
            RowBox[{"defined", "."}]}], "*)"}], "\n", "    ", 
          RowBox[{
           RowBox[{"DirectionVectorQ", "[", "n", "]"}], "^=", "True"}], ";", 
          "\n", "\n", "    ", 
          RowBox[{"(*", " ", 
           RowBox[{"The", " ", "Screen", " ", "space", " ", "metric", " ", 
            RowBox[{"definition", ".", " ", "We"}], " ", "call", " ", "the", 
            " ", "function", " ", "defined", " ", "above"}], "*)"}], "  ", 
          "\n", "    ", 
          RowBox[{
           RowBox[{
            RowBox[{"DefScreenSpaceMetric", "[", 
             RowBox[{
              RowBox[{"NSS", "[", 
               RowBox[{
                RowBox[{"-", "ind1"}], ",", " ", 
                RowBox[{"-", "ind2"}]}], "]"}], ",", " ", "Manifold", ",", 
              "cd2", ",", " ", 
              RowBox[{"{", 
               RowBox[{"cd2post", ",", " ", "cd2pre"}], "}"}], ",", " ", 
              RowBox[{"{", 
               RowBox[{"h", ",", " ", "n"}], "}"}], ",", " ", "options"}], 
             "]"}], "\n", "     ", "\n", "     ", "\n", "    ", 
            RowBox[{"(*", 
             RowBox[{
             "We", " ", "remove", " ", "automatic", " ", "Leibniz", " ", 
              "rule", " ", "when", " ", "there", " ", "is", " ", "a", " ", 
              "Scalar", " ", 
              RowBox[{"Head", ".", "This"}], " ", "is", " ", "to", " ", 
              "ensure", " ", "that", " ", "the", " ", "induced", " ", 
              "derivative", " ", "does", " ", "not", " ", "spoil", " ", 
              RowBox[{"an", "'"}], 
              RowBox[{"InducedDecomposition", "'"}]}], "*)"}], "\n", "    ", 
            "prot"}], " ", "=", " ", 
           RowBox[{"Unprotect", "[", "cd", "]"}]}], ";", "\n", "    ", 
          RowBox[{
           RowBox[{
            RowBox[{"cd", "[", "a_", "]"}], "[", 
            RowBox[{"Scalar", "[", "expr_", "]"}], "]"}], " ", "=."}], ";", 
          "\n", "    ", 
          RowBox[{
           RowBox[{
            RowBox[{"cd2", "[", "a_", "]"}], "[", 
            RowBox[{"Scalar", "[", "expr_", "]"}], "]"}], " ", "=."}], ";", 
          "\n", "    ", 
          RowBox[{"Protect", "[", "prot", "]"}], ";", "\n", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{
           "Functions", " ", "used", " ", "in", " ", "the", " ", "post", " ", 
            "processing", " ", "of", " ", "the", " ", "SplitPerturbations"}], 
           "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"$Rulecdh", "[", "h1_", "]"}], ":=", 
           RowBox[{"{", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"h1", "[", 
                RowBox[{
                 RowBox[{"-", "a_"}], ",", "b_"}], "]"}], " ", 
               RowBox[{
                RowBox[{"cd", "[", "a_", "]"}], "[", "expr1_", "]"}]}], 
              "\[RuleDelayed]", 
              RowBox[{
               RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"h1", "[", 
                RowBox[{"a_", ",", "b_"}], "]"}], " ", 
               RowBox[{
                RowBox[{"cd", "[", 
                 RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}], 
              "\[RuleDelayed]", 
              RowBox[{
               RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"h1", "[", 
                RowBox[{"b_", ",", 
                 RowBox[{"-", "a_"}]}], "]"}], " ", 
               RowBox[{
                RowBox[{"cd", "[", "a_", "]"}], "[", "expr1_", "]"}]}], 
              "\[RuleDelayed]", 
              RowBox[{
               RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"h1", "[", 
                RowBox[{"b_", ",", "a_"}], "]"}], " ", 
               RowBox[{
                RowBox[{"cd", "[", 
                 RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}], 
              "\[RuleDelayed]", 
              RowBox[{
               RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"h1", "[", 
                RowBox[{
                 RowBox[{"-", "a_"}], ",", "b_"}], "]"}], " ", 
               RowBox[{
                RowBox[{"cd", "[", "c_", "]"}], "@", 
                RowBox[{
                 RowBox[{"cd", "[", "a_", "]"}], "[", "expr1_", "]"}]}]}], 
              "\[RuleDelayed]", 
              RowBox[{
               RowBox[{"cd", "[", "c", "]"}], "@", 
               RowBox[{
                RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}]}], ",", 
             RowBox[{
              RowBox[{
               RowBox[{"h1", "[", 
                RowBox[{"a_", ",", "b_"}], "]"}], " ", 
               RowBox[{
                RowBox[{"cd", "[", "c_", "]"}], "@", 
                RowBox[{
                 RowBox[{"cd", "[", 
                  RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}]}], 
              "\[RuleDelayed]", 
              RowBox[{
               RowBox[{"cd", "[", "c", "]"}], "@", 
               RowBox[{
                RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"h1", "[", 
                RowBox[{"b_", ",", 
                 RowBox[{"-", "a_"}]}], "]"}], " ", 
               RowBox[{
                RowBox[{"cd", "[", "c_", "]"}], "@", 
                RowBox[{
                 RowBox[{"cd", "[", "a_", "]"}], "[", "expr1_", "]"}]}]}], 
              "\[RuleDelayed]", 
              RowBox[{
               RowBox[{"cd", "[", "c", "]"}], "@", 
               RowBox[{
                RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}]}], ",", 
             RowBox[{
              RowBox[{
               RowBox[{"h1", "[", 
                RowBox[{"b_", ",", "a_"}], "]"}], " ", 
               RowBox[{
                RowBox[{"cd", "[", "c_", "]"}], "@", 
                RowBox[{
                 RowBox[{"cd", "[", 
                  RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}]}], 
              "\[RuleDelayed]", 
              RowBox[{
               RowBox[{"cd", "[", "c", "]"}], "@", 
               RowBox[{
                RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}]}]}], 
            "}"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"$RulecdNSS", "[", "NSS1_", "]"}], ":=", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"NSS1", "[", 
                RowBox[{
                 RowBox[{"-", "a_"}], ",", "b_"}], "]"}], " ", 
               RowBox[{
                RowBox[{"cd2", "[", "a_", "]"}], "[", "expr1_", "]"}]}], 
              "\[RuleDelayed]", 
              RowBox[{
               RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"NSS1", "[", 
                RowBox[{"a_", ",", "b_"}], "]"}], " ", 
               RowBox[{
                RowBox[{"cd2", "[", 
                 RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}], 
              "\[RuleDelayed]", 
              RowBox[{
               RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"NSS1", "[", 
                RowBox[{"b_", ",", 
                 RowBox[{"-", "a_"}]}], "]"}], " ", 
               RowBox[{
                RowBox[{"cd2", "[", "a_", "]"}], "[", "expr1_", "]"}]}], 
              "\[RuleDelayed]", 
              RowBox[{
               RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"NSS1", "[", 
                RowBox[{"b_", ",", "a_"}], "]"}], " ", 
               RowBox[{
                RowBox[{"cd2", "[", 
                 RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}], 
              "\[RuleDelayed]", 
              RowBox[{
               RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"NSS1", "[", 
                RowBox[{
                 RowBox[{"-", "a_"}], ",", "b_"}], "]"}], " ", 
               RowBox[{
                RowBox[{"cd2", "[", "c_", "]"}], "@", 
                RowBox[{
                 RowBox[{"cd2", "[", "a_", "]"}], "[", "expr1_", "]"}]}]}], 
              "\[RuleDelayed]", 
              RowBox[{
               RowBox[{"cd2", "[", "c", "]"}], "@", 
               RowBox[{
                RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}]}], ",", 
             "\n", 
             RowBox[{
              RowBox[{
               RowBox[{"NSS1", "[", 
                RowBox[{"a_", ",", "b_"}], "]"}], " ", 
               RowBox[{
                RowBox[{"cd2", "[", "c_", "]"}], "@", 
                RowBox[{
                 RowBox[{"cd2", "[", 
                  RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}]}], 
              "\[RuleDelayed]", 
              RowBox[{
               RowBox[{"cd2", "[", "c", "]"}], "@", 
               RowBox[{
                RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}]}], ",", 
             "\n", 
             RowBox[{
              RowBox[{
               RowBox[{"NSS1", "[", 
                RowBox[{"b_", ",", 
                 RowBox[{"-", "a_"}]}], "]"}], " ", 
               RowBox[{
                RowBox[{"cd2", "[", "c_", "]"}], "@", 
                RowBox[{
                 RowBox[{"cd2", "[", "a_", "]"}], "[", "expr1_", "]"}]}]}], 
              "\[RuleDelayed]", 
              RowBox[{
               RowBox[{"cd2", "[", "c", "]"}], "@", 
               RowBox[{
                RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}]}], ",", 
             "\n", 
             RowBox[{
              RowBox[{
               RowBox[{"NSS1", "[", 
                RowBox[{"b_", ",", "a_"}], "]"}], " ", 
               RowBox[{
                RowBox[{"cd2", "[", "c_", "]"}], "@", 
                RowBox[{
                 RowBox[{"cd2", "[", 
                  RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}]}], 
              "\[RuleDelayed]", 
              RowBox[{
               RowBox[{"cd2", "[", "c", "]"}], "@", 
               RowBox[{
                RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}]}]}], 
            "}"}]}], ";", "\[IndentingNewLine]", "\n", "    ", "\n", "    ", 
          "\n", "    ", "\n", "    ", 
          RowBox[{"(*", 
           RowBox[{
           "The", " ", "default", " ", "positionof", " ", "indices", " ", 
            "for", " ", "the", " ", "extrinsic", " ", "curvature", " ", "and",
             " ", "the", " ", "acceleration", " ", "is", " ", "down"}], 
           "*)"}], "\n", "    ", 
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"SlotsOfTensor", "[", "#", "]"}], " ", "^:=", " ", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"-", 
                 RowBox[{"Tangent", "[", "Manifold", "]"}]}], ",", " ", 
                RowBox[{"-", 
                 RowBox[{"Tangent", "[", "Manifold", "]"}]}]}], "}"}]}], 
             ")"}], " ", "&"}], " ", "/@", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"ExtrinsicK", "[", "h", "]"}], ",", 
             RowBox[{"ExtrinsicK", "[", "NSS", "]"}]}], "}"}]}], ";", "\n", 
          "    ", 
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"SlotsOfTensor", "[", "#", "]"}], " ", "^:=", " ", 
              RowBox[{"{", 
               RowBox[{"-", 
                RowBox[{"Tangent", "[", "Manifold", "]"}]}], "}"}]}], ")"}], 
            " ", "&"}], " ", "/@", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"Acceleration", "[", "u", "]"}], ",", 
             RowBox[{"Acceleration", "[", "n", "]"}]}], "}"}]}], ";", "\n", 
          "    ", "\n", "    ", 
          RowBox[{"(*", 
           RowBox[{
           "The", " ", "acceleration", " ", "of", " ", "ushould", " ", 
            "vanish", " ", "for", " ", "homogeneous", " ", 
            RowBox[{"spacetimes", "."}]}], "*)"}], "\n", "    ", 
          RowBox[{
           RowBox[{
            RowBox[{"Acceleration", "[", "u", "]"}], "[", "ind1_", "]"}], " ",
            "=", " ", "0"}], ";", "\n", "\n", "    ", 
          RowBox[{"(*", " ", 
           RowBox[{
           "And", " ", "it", " ", "should", " ", "be", " ", "of", " ", "unit",
             " ", "norm", " ", "or", " ", "at", " ", "least", " ", "the", " ",
             "norm", " ", "specified", " ", "by", " ", "the", " ", "user"}], 
           " ", "*)"}], "\n", "    ", 
          RowBox[{"AutomaticRules", "[", 
           RowBox[{"u", ",", " ", 
            RowBox[{"MakeRule", "[", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"u", "[", "ind1", "]"}], " ", 
                RowBox[{"u", "[", 
                 RowBox[{"-", "ind1"}], "]"}]}], ",", " ", "normu"}], "}"}], 
             "]"}]}], "]"}], ";", "\n", "    ", 
          RowBox[{"AutomaticRules", "[", 
           RowBox[{"u", ",", " ", 
            RowBox[{"MakeRule", "[", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"u", "[", 
                 RowBox[{"-", "ind1"}], "]"}], " ", 
                RowBox[{"g", "[", 
                 RowBox[{"ind1", ",", " ", "ind2"}], "]"}]}], ",", " ", 
               RowBox[{"u", "[", "ind2", "]"}]}], "}"}], "]"}]}], "]"}], ";", 
          "\n", "   ", "\n", "    ", "\n", "    ", 
          RowBox[{"(*", " ", 
           RowBox[{
           "And", " ", "similarly", " ", "for", " ", "n", " ", "where", " ", 
            "the", " ", "norm", " ", "should", " ", "also", " ", "be", " ", 
            "unity", " ", "or", " ", "the", " ", "one", " ", 
            RowBox[{"specified", "."}]}], "*)"}], "\n", "    ", 
          RowBox[{
           RowBox[{
            RowBox[{"Acceleration", "[", "n", "]"}], "[", "ind1_", "]"}], " ",
            "=", " ", "0"}], ";", "\n", "    ", 
          RowBox[{"AutomaticRules", "[", 
           RowBox[{"n", ",", " ", 
            RowBox[{"MakeRule", "[", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"n", "[", "ind1", "]"}], " ", 
                RowBox[{"n", "[", 
                 RowBox[{"-", "ind1"}], "]"}]}], ",", " ", "normn"}], "}"}], 
             "]"}]}], "]"}], ";", "\n", "    ", 
          RowBox[{"AutomaticRules", "[", 
           RowBox[{"n", ",", " ", 
            RowBox[{"MakeRule", "[", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"n", "[", 
                 RowBox[{"-", "ind1"}], "]"}], " ", 
                RowBox[{"g", "[", 
                 RowBox[{"ind1", ",", " ", "ind2"}], "]"}]}], ",", " ", 
               RowBox[{"n", "[", "ind2", "]"}]}], "}"}], "]"}]}], "]"}], ";", 
          "\n", "   ", "\n", "    ", 
          RowBox[{"(*", 
           RowBox[{
           "Rules", " ", "for", " ", "the", " ", "antisymmetric", " ", 
            "tensor", " ", "and", " ", "its", " ", "projected", " ", 
            "version"}], " ", "*)"}], "\n", "    ", 
          RowBox[{"(*", " ", 
           RowBox[{
            RowBox[{
            "Currently", " ", "not", " ", "implemented", " ", "on", " ", 
             "the", " ", "sphere"}], ",", " ", 
            RowBox[{"but", " ", "we", " ", 
             RowBox[{"should", " ", "!"}], " ", "TODO"}]}], "*)"}], "  ", 
          "\n", "    ", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"IntegerQ", "@", "dim"}], " ", "&&", " ", 
             RowBox[{"dim", " ", ">=", " ", "2"}]}], ",", " ", "\n", "      ", 
            RowBox[{
             RowBox[{"indsdim", " ", "=", " ", 
              RowBox[{"GetIndicesOfVBundle", "[", 
               RowBox[{
                RowBox[{"Tangent", "@", "Manifold"}], ",", " ", "dim", ",", 
                " ", 
                RowBox[{"{", "ind5", "}"}]}], "]"}]}], ";", "\n", "      ", 
             RowBox[{"AutomaticRules", "[", 
              RowBox[{
               RowBox[{"epsilon", "[", "g", "]"}], ",", " ", 
               RowBox[{"MakeRule", "[", "\n", "        ", 
                RowBox[{"Evaluate", "[", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{
                    RowBox[{
                    RowBox[{"epsilon", "[", "g", "]"}], "@@", "indsdim"}], 
                    " ", 
                    RowBox[{"u", "[", 
                    RowBox[{"-", 
                    RowBox[{"indsdim", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "]"}], " ", 
                    RowBox[{"h", "[", 
                    RowBox[{
                    RowBox[{"-", 
                    RowBox[{"indsdim", "[", 
                    RowBox[{"[", "2", "]"}], "]"}]}], ",", " ", "ind5"}], 
                    "]"}]}], ",", "\n", "                  ", 
                   RowBox[{
                    RowBox[{"ReplaceIndex", "[", 
                    RowBox[{
                    RowBox[{"Evaluate", "[", 
                    RowBox[{
                    RowBox[{"epsilon", "[", "g", "]"}], " ", "@@", " ", 
                    "indsdim"}], "]"}], ",", 
                    RowBox[{
                    RowBox[{"indsdim", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], " ", "->", " ", 
                    "ind5"}]}], "]"}], " ", 
                    RowBox[{"u", "[", 
                    RowBox[{"-", 
                    RowBox[{"indsdim", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "]"}]}]}], "}"}], "]"}],
                 "\n", "     ", "]"}]}], "]"}], ";"}]}], "]"}], ";"}]}], "\n",
         "]"}]}]}], "]"}]}], "]"}]}]}], "Code"],

Cell["Old implementation. Commented.", "Text"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
   RowBox[{
    RowBox[{"SetSlicingUpToScreenSpace", "[", 
     RowBox[{
      RowBox[{"g_", "?", "MetricQ"}], ",", "u_", ",", 
      RowBox[{"normu_:", "-", "1"}], ",", "h_", ",", "cd_", ",", 
      RowBox[{"{", 
       RowBox[{"cdpost_String", ",", "cdpre_String"}], "}"}], ",", "n_", ",", 
      
      RowBox[{"normn_:", "1"}], ",", "NSS_", ",", "cd2_", ",", 
      RowBox[{"{", 
       RowBox[{"cd2post_String", ",", "cd2pre_String"}], "}"}]}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "m", ",", "p", ",", "q", ",", "DummyS", ",", "DummyV", ",", "DummyT", 
        ",", "ui", ",", "indsdimminustwo", ",", "indsdim", ",", "dim", ",", 
        "prot", ",", "Silenth"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"Manifold", "=", 
           RowBox[{"ManifoldOfCovD", "@", 
            RowBox[{"CovDOfMetric", "[", "g", "]"}]}]}], ",", 
          RowBox[{"CD", "=", 
           RowBox[{"CovDOfMetric", "[", "g", "]"}]}]}], "}"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"dim", "=", 
          RowBox[{"DimOfManifold", "[", "Manifold", "]"}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"With", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"ind1", "=", 
              RowBox[{"DummyIn", "[", 
               RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
             RowBox[{"ind2", "=", 
              RowBox[{"DummyIn", "[", 
               RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
             RowBox[{"ind3", "=", 
              RowBox[{"DummyIn", "[", 
               RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
             RowBox[{"ind4", "=", 
              RowBox[{"DummyIn", "[", 
               RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
             RowBox[{"ind5", "=", 
              RowBox[{"DummyIn", "[", 
               RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
             RowBox[{"ind6", "=", 
              RowBox[{"DummyIn", "[", 
               RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
             RowBox[{"ind7", "=", 
              RowBox[{"DummyIn", "[", 
               RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
             RowBox[{"i1", "=", 
              RowBox[{"DummyIn", "[", 
               RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
             RowBox[{"i2", "=", 
              RowBox[{"DummyIn", "[", 
               RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
             RowBox[{"i3", "=", 
              RowBox[{"DummyIn", "[", 
               RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
             RowBox[{"i4", "=", 
              RowBox[{"DummyIn", "[", 
               RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
             RowBox[{"i5", "=", 
              RowBox[{"DummyIn", "[", 
               RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
             RowBox[{"dummy", "=", 
              RowBox[{"DummyIn", "[", 
               RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}]}], "}"}], 
           ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"DefTensor", "[", 
              RowBox[{
               RowBox[{"u", "[", 
                RowBox[{"-", "ind1"}], "]"}], ",", 
               RowBox[{"{", "Manifold", "}"}], ",", 
               RowBox[{"PrintAs", "\[Rule]", 
                RowBox[{"\"\<\\!\\(\>\"", "<>", 
                 RowBox[{"ToString", "[", "ind1", "]"}], "<>", 
                 "\"\<\\&-\\)\>\""}]}]}], "]"}], "\n", "        ", 
             "\[IndentingNewLine]", 
             RowBox[{"(*", 
              RowBox[{"Induced", " ", "Metric"}], " ", "*)"}], 
             "\[IndentingNewLine]", 
             RowBox[{"Off", "[", 
              RowBox[{"DefMetric", "::", "old"}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"DefMetric", "[", 
             RowBox[{"1", ",", 
              RowBox[{"h", "[", 
               RowBox[{
                RowBox[{"-", "ind1"}], ",", 
                RowBox[{"-", "ind2"}]}], "]"}], ",", "cd", ",", 
              RowBox[{"{", 
               RowBox[{"cdpost", ",", "cdpre"}], "}"}], ",", 
              RowBox[{"InducedFrom", "\[Rule]", 
               RowBox[{"{", 
                RowBox[{"g", ",", "u"}], "}"}]}], ",", 
              RowBox[{"PrintAs", "\[Rule]", 
               RowBox[{"\"\<\\!\\(\>\"", "<>", 
                RowBox[{"ToString", "[", "h", "]"}], "<>", 
                "\"\<\\&-\\)\>\""}]}]}], "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{
              RowBox[{"Another", " ", "induced", " ", "metric"}], ",", " ", 
              RowBox[{
              "I", " ", "used", " ", "the", " ", "cd", " ", "for", " ", "the",
                " ", "angular", " ", "derivative"}], ",", " ", 
              RowBox[{
              "it", " ", "is", " ", "cheating", " ", "I", " ", "will", " ", 
               "sort", " ", "it", " ", "later"}]}], "*)"}], 
            "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{"DefTensor", "[", 
             RowBox[{
              RowBox[{"n", "[", 
               RowBox[{"-", "ind1"}], "]"}], ",", 
              RowBox[{"{", "Manifold", "}"}], ",", 
              RowBox[{"OrthogonalTo", "\[Rule]", 
               RowBox[{"{", 
                RowBox[{"u", "[", "ind1", "]"}], "}"}]}], ",", 
              RowBox[{"ProjectedWith", "\[Rule]", 
               RowBox[{"{", 
                RowBox[{"h", "[", 
                 RowBox[{"ind1", ",", 
                  RowBox[{"-", "ind2"}]}], "]"}], "}"}]}], ",", 
              RowBox[{"PrintAs", "\[Rule]", 
               RowBox[{"\"\<\\!\\(\>\"", "<>", 
                RowBox[{"ToString", "[", "n", "]"}], "<>", 
                "\"\<\\&-\\)\>\""}]}]}], "]"}], ";", "\[IndentingNewLine]", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"DirectionVectorQ", "[", "n", "]"}], "=", "True"}], ";", 
            "\[IndentingNewLine]", "\[IndentingNewLine]", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
              RowBox[{
               RowBox[{
               "I", " ", "use", " ", "NSS", " ", "as", " ", "the", " ", 
                "screen", " ", "space", " ", "metric", " ", "because", " ", 
                "the", " ", "Silent", " ", "metric", " ", "is", " ", "3"}], 
               "-", "D"}], ",", " ", 
              RowBox[{
              "I", " ", "will", " ", "clean", " ", "up", " ", "these", " ", 
               "later"}]}], "*)"}], "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{"CP", ":", " ", 
              RowBox[{
              "OK", " ", "Obinna", " ", "I", " ", "see", " ", "what", " ", 
               "you", " ", 
               RowBox[{"do", " ", "!"}]}]}], "*)"}], "\[IndentingNewLine]", 
            RowBox[{"DefTensor", "[", 
             RowBox[{
              RowBox[{"NSS", "[", 
               RowBox[{
                RowBox[{"-", "ind1"}], ",", 
                RowBox[{"-", "ind2"}]}], "]"}], ",", 
              RowBox[{"{", "Manifold", "}"}], ",", 
              RowBox[{"Symmetric", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"-", "ind1"}], ",", 
                 RowBox[{"-", "ind2"}]}], "}"}], "]"}], ",", 
              RowBox[{"OrthogonalTo", "\[Rule]", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"u", "[", "ind1", "]"}], ",", 
                 RowBox[{"u", "[", "ind2", "]"}], ",", 
                 RowBox[{"n", "[", "ind1", "]"}], ",", 
                 RowBox[{"n", "[", "ind2", "]"}]}], "}"}]}], ",", 
              RowBox[{"ProjectedWith", "\[Rule]", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"h", "[", 
                  RowBox[{"ind1", ",", 
                   RowBox[{"-", "ind4"}]}], "]"}], ",", 
                 RowBox[{"h", "[", 
                  RowBox[{"ind2", ",", 
                   RowBox[{"-", "ind5"}]}], "]"}]}], 
                RowBox[{"(*", 
                 RowBox[{",", 
                  RowBox[{"NSS", "[", 
                   RowBox[{"ind1", ",", 
                    RowBox[{"-", "ind4"}]}], "]"}], ",", 
                  RowBox[{"NSS", "[", 
                   RowBox[{"ind2", ",", 
                    RowBox[{"-", "ind5"}]}], "]"}]}], "*)"}], "}"}]}], ",", 
              RowBox[{"PrintAs", "\[Rule]", 
               RowBox[{"\"\<\\!\\(\>\"", "<>", 
                RowBox[{"ToString", "[", "NSS", "]"}], "<>", 
                "\"\<\\&-\\)\>\""}]}]}], "]"}], ";", "\[IndentingNewLine]", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
              RowBox[{
              "So", " ", "let", " ", "me", " ", "try", " ", "to", " ", 
               "define", " ", "separately", " ", "the", " ", "CovD"}], ",", 
              " ", 
              RowBox[{
              "So", " ", "That", " ", "I", " ", "suppress", " ", "this", " ", 
               "definition"}]}], " ", "*)"}], "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{
              RowBox[{"DefMetric", "[", 
               RowBox[{"1", ",", 
                RowBox[{"Silenth", "[", 
                 RowBox[{
                  RowBox[{"-", "ind1"}], ",", 
                  RowBox[{"-", "ind2"}]}], "]"}], ",", "cd2", ",", 
                RowBox[{"{", 
                 RowBox[{"cd2post", ",", "cd2pre"}], "}"}], ",", 
                RowBox[{"InducedFrom", "\[Rule]", 
                 RowBox[{"{", 
                  RowBox[{"g", ",", "n"}], "}"}]}], ",", 
                RowBox[{"PrintAs", "\[Rule]", 
                 RowBox[{"\"\<\\!\\(\>\"", "<>", 
                  RowBox[{"ToString", "[", "h", "]"}], "<>", 
                  "\"\<\\&-\\)\>\""}]}]}], "]"}], ";"}], "*)"}], 
            "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{"CP", ":", " ", 
              RowBox[{
              "Let", " ", "me", " ", "try", " ", "this", " ", 
               "implementation", " ", "for", " ", "the", " ", "CovD", " ", 
               "twice", " ", "projected"}]}], "*)"}], "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
             "This", " ", "seems", " ", "cleaner", " ", "than", " ", "to", 
              " ", "define", " ", "a", " ", "Silent", " ", 
              RowBox[{"Metric", "."}]}], "*)"}], "\[IndentingNewLine]", 
            "\[IndentingNewLine]", 
            RowBox[{"DefCovD", "[", 
             RowBox[{
              RowBox[{"cd2", "[", 
               RowBox[{"-", "ind1"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"cd2post", ",", "cd2pre"}], "}"}]}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"cd2", "[", "ind1_", "]"}], "[", 
              RowBox[{"NSS", "[", 
               RowBox[{"ind2_", ",", "ind3_"}], "]"}], "]"}], ":=", "0"}], 
            ";", "\[IndentingNewLine]", 
            RowBox[{"AutomaticRules", "[", 
             RowBox[{"NSS", ",", 
              RowBox[{"BuildRule", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{
                  RowBox[{"NSS", "[", 
                   RowBox[{"ind1", ",", "ind2"}], "]"}], " ", 
                  RowBox[{"n", "[", 
                   RowBox[{"-", "ind2"}], "]"}]}], ",", "0"}], "}"}], "]"}]}],
              "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{"AutomaticRules", "[", 
             RowBox[{"NSS", ",", 
              RowBox[{"BuildRule", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{
                  RowBox[{"NSS", "[", 
                   RowBox[{"ind1", ",", "ind2"}], "]"}], " ", 
                  RowBox[{"u", "[", 
                   RowBox[{"-", "ind2"}], "]"}]}], ",", "0"}], "}"}], "]"}]}],
              "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{
              RowBox[{
              "I", " ", "used", " ", "AutomaticRule", " ", "to", " ", 
               "assign", " ", "rules", " ", "to", " ", "NSS"}], "..."}], 
             "*)"}], "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{"Well", " ", "it", " ", 
              RowBox[{"doesn", "'"}], "t", " ", "work", " ", "well"}], "*)"}],
             "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{
              RowBox[{
               RowBox[{"NSS", "[", 
                RowBox[{
                 RowBox[{"-", "ind1"}], ",", 
                 RowBox[{"-", "ind2"}]}], "]"}], "^:=", 
               RowBox[{"2", "/;", 
                RowBox[{
                 RowBox[{"ind1", "+", "ind2"}], "\[Equal]", "0"}]}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{
                RowBox[{"NSS", "[", 
                 RowBox[{
                  RowBox[{"-", "ind1"}], ",", 
                  RowBox[{"-", "ind2"}]}], "]"}], 
                RowBox[{"NSS", "[", 
                 RowBox[{"ind1", ",", "ind2"}], "]"}]}], "^:=", "2"}], ";"}], 
             "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{"AutomaticRules", "[", 
              RowBox[{"NSS", ",", 
               RowBox[{"BuildRule", "[", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"NSS", "[", 
                   RowBox[{
                    RowBox[{"-", "ind1"}], ",", 
                    RowBox[{"-", "ind2"}]}], "]"}], ",", 
                  RowBox[{
                   RowBox[{"h", "[", 
                    RowBox[{
                    RowBox[{"-", "ind1"}], ",", 
                    RowBox[{"-", "ind2"}]}], "]"}], "-", 
                   RowBox[{
                    RowBox[{"n", "[", 
                    RowBox[{"-", "ind1"}], "]"}], 
                    RowBox[{"n", "[", 
                    RowBox[{"-", "ind2"}], "]"}]}]}]}], "}"}], "]"}]}], "]"}],
              "*)"}], 
            RowBox[{"AutomaticRules", "[", 
             RowBox[{"NSS", ",", 
              RowBox[{"BuildRule", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{
                  RowBox[{"NSS", "[", 
                   RowBox[{"ind1", ",", "ind2"}], "]"}], " ", 
                  RowBox[{"NSS", "[", 
                   RowBox[{
                    RowBox[{"-", "ind2"}], ",", 
                    RowBox[{"-", "ind3"}]}], "]"}]}], ",", 
                 RowBox[{"NSS", "[", 
                  RowBox[{"ind1", ",", 
                   RowBox[{"-", "ind3"}]}], "]"}]}], "}"}], "]"}]}], "]"}], 
            ";", "\[IndentingNewLine]", 
            RowBox[{"AutomaticRules", "[", 
             RowBox[{"NSS", ",", 
              RowBox[{"BuildRule", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{
                  RowBox[{"NSS", "[", 
                   RowBox[{
                    RowBox[{"-", "ind1"}], ",", 
                    RowBox[{"-", "ind2"}]}], "]"}], " ", 
                  RowBox[{"NSS", "[", 
                   RowBox[{"ind2", ",", "ind3"}], "]"}]}], ",", 
                 RowBox[{"NSS", "[", 
                  RowBox[{
                   RowBox[{"-", "ind1"}], ",", "ind3"}], "]"}]}], "}"}], 
               "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{"AutomaticRules", "[", 
             RowBox[{"NSS", ",", 
              RowBox[{"BuildRule", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"NSS", "[", 
                  RowBox[{
                   RowBox[{"-", "ind1"}], ",", "ind1"}], "]"}], " ", ",", 
                 RowBox[{"dim", "-", "2"}]}], "}"}], "]"}]}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
              RowBox[{
              "Who", " ", "knows", " ", "we", " ", "might", " ", "allow", " ",
                "for", " ", "1"}], "+", "1", "+", 
              RowBox[{
              "n", " ", "splitting", " ", "so", " ", "here", " ", "that", " ",
                "should", " ", "be", " ", "n"}], "-", "2."}], "*)"}], 
            "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{"On", "[", 
             RowBox[{"DefMetric", "::", "old"}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{
             "We", " ", "remove", " ", "automatic", " ", "Leibniz", " ", 
              "rule", " ", "when", " ", "there", " ", "is", " ", "a", " ", 
              "Scalar", " ", 
              RowBox[{"Head", ".", "This"}], " ", "is", " ", "to", " ", 
              "ensure", " ", "that", " ", "the", " ", "induced", " ", 
              "derivative", " ", "does", " ", "not", " ", "spoil", " ", 
              RowBox[{"an", "'"}], 
              RowBox[{"InducedDecomposition", "'"}]}], "*)"}], 
            "\[IndentingNewLine]", 
            RowBox[{"prot", "=", 
             RowBox[{"Unprotect", "[", "cd", "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"cd", "[", "a_", "]"}], "[", 
              RowBox[{"Scalar", "[", "expr_", "]"}], "]"}], "=."}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"cd2", "[", "a_", "]"}], "[", 
              RowBox[{"Scalar", "[", "expr_", "]"}], "]"}], "=."}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"Protect", "[", "prot", "]"}], ";", "\[IndentingNewLine]",
             "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
              RowBox[{"CP", ".", " ", "Do"}], " ", "you", " ", "remember", 
              " ", "why", " ", "we", " ", "had", " ", 
              RowBox[{"this", "?"}]}], " ", "*)"}], "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{"OU", ":", " ", 
              RowBox[{
               RowBox[{
               "Yes", " ", "it", " ", "is", " ", "used", " ", "in", " ", 
                "DefTensorProperties", " ", "for", " ", "Post"}], "-", 
               "Processing"}]}], "*)"}], "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"$Rulecdh", "[", "h1_", "]"}], ":=", 
             RowBox[{"{", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"h1", "[", 
                  RowBox[{
                   RowBox[{"-", "a_"}], ",", "b_"}], "]"}], " ", 
                 RowBox[{
                  RowBox[{"cd", "[", "a_", "]"}], "[", "expr1_", "]"}]}], 
                "\[RuleDelayed]", 
                RowBox[{
                 RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{
                 RowBox[{"h1", "[", 
                  RowBox[{"a_", ",", "b_"}], "]"}], " ", 
                 RowBox[{
                  RowBox[{"cd", "[", 
                   RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}], 
                "\[RuleDelayed]", 
                RowBox[{
                 RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{
                 RowBox[{"h1", "[", 
                  RowBox[{"b_", ",", 
                   RowBox[{"-", "a_"}]}], "]"}], " ", 
                 RowBox[{
                  RowBox[{"cd", "[", "a_", "]"}], "[", "expr1_", "]"}]}], 
                "\[RuleDelayed]", 
                RowBox[{
                 RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{
                 RowBox[{"h1", "[", 
                  RowBox[{"b_", ",", "a_"}], "]"}], " ", 
                 RowBox[{
                  RowBox[{"cd", "[", 
                   RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}], 
                "\[RuleDelayed]", 
                RowBox[{
                 RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{
                 RowBox[{"h1", "[", 
                  RowBox[{
                   RowBox[{"-", "a_"}], ",", "b_"}], "]"}], " ", 
                 RowBox[{
                  RowBox[{"cd", "[", "c_", "]"}], "@", 
                  RowBox[{
                   RowBox[{"cd", "[", "a_", "]"}], "[", "expr1_", "]"}]}]}], 
                "\[RuleDelayed]", 
                RowBox[{
                 RowBox[{"cd", "[", "c", "]"}], "@", 
                 RowBox[{
                  RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}]}], ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"h1", "[", 
                  RowBox[{"a_", ",", "b_"}], "]"}], " ", 
                 RowBox[{
                  RowBox[{"cd", "[", "c_", "]"}], "@", 
                  RowBox[{
                   RowBox[{"cd", "[", 
                    RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}]}], 
                "\[RuleDelayed]", 
                RowBox[{
                 RowBox[{"cd", "[", "c", "]"}], "@", 
                 RowBox[{
                  RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}]}], ",",
                "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{
                 RowBox[{"h1", "[", 
                  RowBox[{"b_", ",", 
                   RowBox[{"-", "a_"}]}], "]"}], " ", 
                 RowBox[{
                  RowBox[{"cd", "[", "c_", "]"}], "@", 
                  RowBox[{
                   RowBox[{"cd", "[", "a_", "]"}], "[", "expr1_", "]"}]}]}], 
                "\[RuleDelayed]", 
                RowBox[{
                 RowBox[{"cd", "[", "c", "]"}], "@", 
                 RowBox[{
                  RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}]}], ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"h1", "[", 
                  RowBox[{"b_", ",", "a_"}], "]"}], " ", 
                 RowBox[{
                  RowBox[{"cd", "[", "c_", "]"}], "@", 
                  RowBox[{
                   RowBox[{"cd", "[", 
                    RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}]}], 
                "\[RuleDelayed]", 
                RowBox[{
                 RowBox[{"cd", "[", "c", "]"}], "@", 
                 RowBox[{
                  RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}]}]}], 
              "}"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"$RulecdNSS", "[", "NSS1_", "]"}], ":=", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"NSS1", "[", 
                  RowBox[{
                   RowBox[{"-", "a_"}], ",", "b_"}], "]"}], " ", 
                 RowBox[{
                  RowBox[{"cd2", "[", "a_", "]"}], "[", "expr1_", "]"}]}], 
                "\[RuleDelayed]", 
                RowBox[{
                 RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{
                 RowBox[{"NSS1", "[", 
                  RowBox[{"a_", ",", "b_"}], "]"}], " ", 
                 RowBox[{
                  RowBox[{"cd2", "[", 
                   RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}], 
                "\[RuleDelayed]", 
                RowBox[{
                 RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{
                 RowBox[{"NSS1", "[", 
                  RowBox[{"b_", ",", 
                   RowBox[{"-", "a_"}]}], "]"}], " ", 
                 RowBox[{
                  RowBox[{"cd2", "[", "a_", "]"}], "[", "expr1_", "]"}]}], 
                "\[RuleDelayed]", 
                RowBox[{
                 RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{
                 RowBox[{"NSS1", "[", 
                  RowBox[{"b_", ",", "a_"}], "]"}], " ", 
                 RowBox[{
                  RowBox[{"cd2", "[", 
                   RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}], 
                "\[RuleDelayed]", 
                RowBox[{
                 RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{
                 RowBox[{"NSS1", "[", 
                  RowBox[{
                   RowBox[{"-", "a_"}], ",", "b_"}], "]"}], " ", 
                 RowBox[{
                  RowBox[{"cd2", "[", "c_", "]"}], "@", 
                  RowBox[{
                   RowBox[{"cd2", "[", "a_", "]"}], "[", "expr1_", "]"}]}]}], 
                "\[RuleDelayed]", 
                RowBox[{
                 RowBox[{"cd2", "[", "c", "]"}], "@", 
                 RowBox[{
                  RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}]}], 
               ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"NSS1", "[", 
                  RowBox[{"a_", ",", "b_"}], "]"}], " ", 
                 RowBox[{
                  RowBox[{"cd2", "[", "c_", "]"}], "@", 
                  RowBox[{
                   RowBox[{"cd2", "[", 
                    RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}]}], 
                "\[RuleDelayed]", 
                RowBox[{
                 RowBox[{"cd2", "[", "c", "]"}], "@", 
                 RowBox[{
                  RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}]}], 
               ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"NSS1", "[", 
                  RowBox[{"b_", ",", 
                   RowBox[{"-", "a_"}]}], "]"}], " ", 
                 RowBox[{
                  RowBox[{"cd2", "[", "c_", "]"}], "@", 
                  RowBox[{
                   RowBox[{"cd2", "[", "a_", "]"}], "[", "expr1_", "]"}]}]}], 
                "\[RuleDelayed]", 
                RowBox[{
                 RowBox[{"cd2", "[", "c", "]"}], "@", 
                 RowBox[{
                  RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}]}], 
               ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"NSS1", "[", 
                  RowBox[{"b_", ",", "a_"}], "]"}], " ", 
                 RowBox[{
                  RowBox[{"cd2", "[", "c_", "]"}], "@", 
                  RowBox[{
                   RowBox[{"cd2", "[", 
                    RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}]}], 
                "\[RuleDelayed]", 
                RowBox[{
                 RowBox[{"cd2", "[", "c", "]"}], "@", 
                 RowBox[{
                  RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}]}]}], 
              "}"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
            "\n", "\[IndentingNewLine]", "\[IndentingNewLine]", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{
              RowBox[{
               RowBox[{"SpaceType", "[", "h", "]"}], "^=", "SpaceTimeType"}], 
              ";"}], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{
             "The", " ", "default", " ", "positionof", " ", "indices", " ", 
              "for", " ", "the", " ", "extrinsic", " ", "curvature", " ", 
              "and", " ", "the", " ", "acceleration", " ", "is", " ", 
              "down"}], "*)"}], "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
              RowBox[{
              "CP", " ", "This", " ", "could", " ", "be", " ", "rewritten", 
               " ", "in", " ", "a", " ", "more", " ", "compact", " ", "form", 
               " ", "gathering", " ", "n", " ", "and", " ", "u"}], ",", " ", 
              RowBox[{"h", " ", "and", " ", "silenth"}]}], "*)"}], 
            "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"(", 
               RowBox[{
                RowBox[{"SlotsOfTensor", "[", "#", "]"}], "^:=", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"-", 
                   RowBox[{"Tangent", "[", "Manifold", "]"}]}], ",", 
                  RowBox[{"-", 
                   RowBox[{"Tangent", "[", "Manifold", "]"}]}]}], "}"}]}], 
               ")"}], "&"}], "/@", 
             RowBox[{"{", 
              RowBox[{"ExtrinsicK", "[", "h", "]"}], "}"}]}], ";", "\n", 
            RowBox[{
             RowBox[{
              RowBox[{"(", 
               RowBox[{
                RowBox[{"SlotsOfTensor", "[", "#", "]"}], "^:=", 
                RowBox[{"{", 
                 RowBox[{"-", 
                  RowBox[{"Tangent", "[", "Manifold", "]"}]}], "}"}]}], ")"}],
               "&"}], "/@", 
             RowBox[{"{", 
              RowBox[{"Acceleration", "[", "u", "]"}], "}"}]}], ";", 
            "\[IndentingNewLine]", "\[IndentingNewLine]", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"(", 
               RowBox[{
                RowBox[{"SlotsOfTensor", "[", "#", "]"}], "^:=", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"-", 
                   RowBox[{"Tangent", "[", "Manifold", "]"}]}], ",", 
                  RowBox[{"-", 
                   RowBox[{"Tangent", "[", "Manifold", "]"}]}]}], "}"}]}], 
               ")"}], "&"}], "/@", 
             RowBox[{"{", 
              RowBox[{"ExtrinsicK", "[", "Silenth", "]"}], "}"}]}], ";", "\n", 
            RowBox[{
             RowBox[{
              RowBox[{"(", 
               RowBox[{
                RowBox[{"SlotsOfTensor", "[", "#", "]"}], "^:=", 
                RowBox[{"{", 
                 RowBox[{"-", 
                  RowBox[{"Tangent", "[", "Manifold", "]"}]}], "}"}]}], ")"}],
               "&"}], "/@", 
             RowBox[{"{", 
              RowBox[{"Acceleration", "[", "n", "]"}], "}"}]}], ";", 
            "\[IndentingNewLine]", "\n", 
            RowBox[{"(*", 
             RowBox[{
             "The", " ", "acceleration", " ", "should", " ", "vanish", " ", 
              "for", " ", "homogeneous", " ", 
              RowBox[{"spacetimes", "."}]}], "*)"}], "\[IndentingNewLine]", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"Acceleration", "[", "u", "]"}], "[", "ind1_", "]"}], 
             "=", "0"}], ";", "\n", 
            RowBox[{"AutomaticRules", "[", 
             RowBox[{"u", ",", 
              RowBox[{"BuildRule", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{
                  RowBox[{"u", "[", "ind1", "]"}], " ", 
                  RowBox[{"u", "[", 
                   RowBox[{"-", "ind1"}], "]"}]}], ",", "normu"}], "}"}], 
               "]"}]}], "]"}], ";", "\n", 
            RowBox[{"AutomaticRules", "[", 
             RowBox[{"u", ",", 
              RowBox[{"BuildRule", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{
                  RowBox[{"u", "[", 
                   RowBox[{"-", "ind1"}], "]"}], " ", 
                  RowBox[{"g", "[", 
                   RowBox[{"ind1", ",", "ind2"}], "]"}]}], ",", 
                 RowBox[{"u", "[", "ind2", "]"}]}], "}"}], "]"}]}], "]"}], 
            ";", "\n", 
            RowBox[{"(*", 
             RowBox[{
              RowBox[{"AutomaticRules", "[", 
               RowBox[{"u", ",", 
                RowBox[{"BuildRule", "[", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"g", "[", 
                    RowBox[{"ind1", ",", "ind2"}], "]"}], " ", 
                    RowBox[{"u", "[", 
                    RowBox[{"-", "ind2"}], "]"}], " ", 
                    RowBox[{"u", "[", 
                    RowBox[{"-", "ind1"}], "]"}]}], ",", "normu"}], "}"}], 
                 "]"}]}], "]"}], ";"}], "*)"}], "\[IndentingNewLine]", 
            "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
              RowBox[{
              "CP", " ", "Here", " ", "it", " ", "is", " ", "because", " ", 
               "we", " ", "assume", " ", "non", " ", "Binachi", " ", "for", 
               " ", 
               RowBox[{"n", ".", " ", "Otherwise"}], " ", "this", " ", "is", 
               " ", "more", " ", "general", " ", 
               RowBox[{"probably", ".", " ", "Even"}], " ", "if", " ", "we", 
               " ", "now", " ", "we", " ", "specialize", " ", "to", " ", 
               "FL"}], ",", " ", 
              RowBox[{
               RowBox[{"the", " ", "1"}], "+", "1", "+", 
               RowBox[{
               "2", " ", "splitting", " ", "would", " ", "be", " ", "great", 
                " ", "if", " ", "it", " ", "could", " ", "be", " ", "as", " ",
                 "general", " ", "as", " ", 
                RowBox[{"possible", ".", " ", "So"}], " ", "here", " ", "we", 
                " ", "should", " ", "extend", " ", "this", " ", "definition", 
                " ", "and", " ", "have", " ", "it", " ", "restricted", " ", 
                "to", " ", "0", " ", "only", " ", "if", " ", "the", " ", 
                "TypeOfPScaetime", " ", "is", " ", "non", " ", 
                RowBox[{"Bianchi", "."}]}]}]}], "*)"}], "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"Acceleration", "[", "n", "]"}], "[", "ind1_", "]"}], 
             "=", "0"}], ";", "\n", 
            RowBox[{"AutomaticRules", "[", 
             RowBox[{"n", ",", 
              RowBox[{"BuildRule", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{
                  RowBox[{"n", "[", "ind1", "]"}], " ", 
                  RowBox[{"n", "[", 
                   RowBox[{"-", "ind1"}], "]"}]}], ",", "normn"}], "}"}], 
               "]"}]}], "]"}], ";", "\n", 
            RowBox[{"AutomaticRules", "[", 
             RowBox[{"n", ",", 
              RowBox[{"BuildRule", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{
                  RowBox[{"n", "[", 
                   RowBox[{"-", "ind1"}], "]"}], " ", 
                  RowBox[{"g", "[", 
                   RowBox[{"ind1", ",", "ind2"}], "]"}]}], ",", 
                 RowBox[{"n", "[", "ind2", "]"}]}], "}"}], "]"}]}], "]"}], 
            ";", "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{
              RowBox[{"AutomaticRules", "[", 
               RowBox[{"n", ",", 
                RowBox[{"BuildRule", "[", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"g", "[", 
                    RowBox[{"ind1", ",", "ind2"}], "]"}], " ", 
                    RowBox[{"n", "[", 
                    RowBox[{"-", "ind2"}], "]"}], " ", 
                    RowBox[{"n", "[", 
                    RowBox[{"-", "ind1"}], "]"}]}], ",", "normn"}], "}"}], 
                 "]"}]}], "]"}], ";"}], "*)"}], "\n", "\[IndentingNewLine]", 
            "\n", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"IntegerQ", "@", "dim"}], "&&", 
               RowBox[{"dim", "\[GreaterEqual]", "2"}]}], ",", 
              RowBox[{
               RowBox[{"indsdim", "=", 
                RowBox[{"GetIndicesOfVBundle", "[", 
                 RowBox[{
                  RowBox[{"Tangent", "@", "Manifold"}], ",", "dim", ",", 
                  RowBox[{"{", "ind5", "}"}]}], "]"}]}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"AutomaticRules", "[", 
                RowBox[{
                 RowBox[{"epsilon", "[", "g", "]"}], ",", 
                 RowBox[{"BuildRule", "[", 
                  RowBox[{"Evaluate", "[", 
                   RowBox[{"{", 
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{"epsilon", "[", "g", "]"}], "@@", "indsdim"}], 
                    " ", 
                    RowBox[{"u", "[", 
                    RowBox[{"-", 
                    RowBox[{"indsdim", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "]"}], " ", 
                    RowBox[{"h", "[", 
                    RowBox[{
                    RowBox[{"-", 
                    RowBox[{"indsdim", "[", 
                    RowBox[{"[", "2", "]"}], "]"}]}], ",", "ind5"}], "]"}]}], 
                    ",", 
                    RowBox[{
                    RowBox[{"ReplaceIndex", "[", 
                    RowBox[{
                    RowBox[{"Evaluate", "[", 
                    RowBox[{
                    RowBox[{"epsilon", "[", "g", "]"}], "@@", "indsdim"}], 
                    "]"}], ",", 
                    RowBox[{
                    RowBox[{"indsdim", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], "\[Rule]", "ind5"}]}], 
                    "]"}], " ", 
                    RowBox[{"u", "[", 
                    RowBox[{"-", 
                    RowBox[{"indsdim", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "]"}]}]}], "}"}], "]"}],
                   "]"}]}], "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], 
            ";"}]}], "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
       "]"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "*)"}]], "Input",
 InitializationCell->True],

Cell["\<\
This is an ad-hoc form of induced decomposition, TODO: optimize. But at leats \
it works for the moment.\
\>", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"ToInducedDerivativeScreenSpace", "[", 
    RowBox[{"expr_", ",", "supercd_", ",", "cd_"}], "]"}], ":=", 
   RowBox[{"ToInducedDerivative", "[", 
    RowBox[{"expr", ",", "supercd", ",", "cd"}], "]"}]}], 
  "\[IndentingNewLine]"}], "\n", 
 RowBox[{
  RowBox[{"ToInducedDerivativeScreenSpace", "[", 
   RowBox[{"expr_", ",", "supercd_", ",", "cd_", ",", "cd2_"}], "]"}], ":=", 
  RowBox[{"expr", "/.", 
   RowBox[{
    RowBox[{
     RowBox[{"supercd", "[", "ind_", "]"}], "[", 
     RowBox[{"expr1", ":", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{
         RowBox[{"_", "?", "xTensorQ"}], "[", "___", "]"}], "|", 
        RowBox[{
         RowBox[{"_", "?", "InertHeadQ"}], "[", "___", "]"}], "|", 
        RowBox[{
         RowBox[{"cd", "[", "_", "]"}], "[", "_", "]"}], "|", 
        RowBox[{
         RowBox[{"LieD", "[", "_", "]"}], "[", "_", "]"}]}], ")"}]}], "]"}], 
    "\[RuleDelayed]", 
    RowBox[{
     RowBox[{"-", 
      RowBox[{
       RowBox[{"cd", "[", "ind", "]"}], "[", "expr1", "]"}]}], "+", 
     "\[IndentingNewLine]", 
     RowBox[{"With", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"frees", "=", 
          RowBox[{"FindFreeIndices", "[", "expr1", "]"}]}], ",", 
         RowBox[{"n", "=", 
          RowBox[{"Last", "@", 
           RowBox[{"InducedFrom", "[", 
            RowBox[{"MetricOfCovD", "[", "cd2", "]"}], "]"}]}]}]}], "}"}], 
       ",", 
       RowBox[{
        RowBox[{
         RowBox[{"ToInducedDerivative", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"supercd", "[", "ind", "]"}], "[", "expr1", "]"}], ",", 
           "supercd", ",", "cd"}], "]"}], "+", 
         RowBox[{"ToInducedDerivative", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"cd", "[", "ind", "]"}], "[", "expr1", "]"}], ",", "cd", 
           ",", "cd2"}], "]"}]}], "\[IndentingNewLine]", "/.", 
        RowBox[{
         RowBox[{
          RowBox[{"LieD", "[", 
           RowBox[{"n", "[", "a_", "]"}], "]"}], "[", "expr1", "]"}], 
         "\[RuleDelayed]", 
         RowBox[{"LieDToCovD", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"LieD", "[", 
             RowBox[{"n", "[", "a", "]"}], "]"}], "[", "expr1", "]"}], ",", 
           "cd"}], "]"}]}]}]}], "\[IndentingNewLine]", 
      "]"}]}]}]}]}]}], "Input",
 InitializationCell->True]
}, Open  ]],

Cell[CellGroupData[{

Cell["Defining twice projected tensors.", "Subsubsection"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "DefScreenProjectedTensor", "]"}], "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"PrintAs", "\[Rule]", "Identity"}], ",", 
      RowBox[{"TensorProperties", "\[Rule]", 
       RowBox[{"{", 
        RowBox[{
        "\"\<SymmetricTensor\>\"", ",", "\"\<Traceless\>\"", ",", 
         "\"\<Transverse\>\""}], "}"}]}], ",", 
      RowBox[{"SpaceTimesOfDefinition", "\[Rule]", 
       RowBox[{"{", 
        RowBox[{"\"\<Background\>\"", ",", "\"\<Perturbed\>\""}], "}"}]}]}], 
     "}"}]}], ";"}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"DefScreenProjectedTensorQ", "[", 
    RowBox[{"Name_", ",", "N___"}], "]"}], ":=", "False"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"PropertiesList", "[", "Name_", "]"}], ":=", 
   RowBox[{"{", "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"InducedMetricOf", "[", "Name_", "]"}], ":=", 
    RowBox[{"{", "}"}]}], ";"}], "\[IndentingNewLine]", "\n", 
  RowBox[{"(*", 
   RowBox[{"Review", " ", "all", " ", "these", " ", 
    RowBox[{"properties", "."}]}], "*)"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"DefScreenProjectedTensor", "[", 
    RowBox[{
     RowBox[{"Name_", "[", "inds___", "]"}], ",", 
     RowBox[{"N_", "?", "xAct`xLightCone`Private`InducedMetricQ"}], ",", 
     RowBox[{"options___", "?", "OptionQ"}]}], "]"}], ":=", 
   RowBox[{"Catch", "@", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "IndsNoLI", ",", "p", ",", "q", ",", "r", ",", "PrAs", ",", 
        "SpaTimeDef", ",", "TensProp"}], "}"}], ",", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"M", "=", 
           RowBox[{"ManifoldOfCovD", "@", 
            RowBox[{"CovDOfMetric", "[", 
             RowBox[{"First", "@", 
              RowBox[{"InducedFrom", "@", 
               RowBox[{"First", "@", 
                RowBox[{"InducedFrom", "[", "N", "]"}]}]}]}], "]"}]}]}], ",", 
          
          RowBox[{"n", "=", 
           RowBox[{"Last", "@", 
            RowBox[{"InducedFrom", "[", "N", "]"}]}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"u", "=", 
           RowBox[{"Last", "@", 
            RowBox[{"InducedFrom", "@", 
             RowBox[{"First", "@", 
              RowBox[{"InducedFrom", "@", "N"}]}]}]}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"h", "=", 
           RowBox[{"First", "@", 
            RowBox[{"InducedFrom", "@", "N"}]}]}]}], "}"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"With", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"Dummy1", "=", 
             RowBox[{"DummyIn", "[", 
              RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ",", 
            RowBox[{"Dummy2", "=", 
             RowBox[{"DummyIn", "[", 
              RowBox[{"Tangent", "[", "M", "]"}], "]"}]}]}], "}"}], ",", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"(*", " ", "Messages", " ", "*)"}], "\[IndentingNewLine]", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"DefScreenProjectedTensorQ", "[", 
               RowBox[{"Name", ",", "N"}], "]"}], ",", 
              RowBox[{
               RowBox[{"If", "[", 
                RowBox[{"$DefInfoQ", ",", 
                 RowBox[{"Throw", "@", 
                  RowBox[{"Print", "[", 
                   RowBox[{
                   "\"\<** DefScreenProjectedTensor: The projection \
properties on the Screen space associated with the induced metric \>\"", ",", 
                    "N", ",", "\"\< and direction vector\>\"", ",", "n", ",", 
                    "\"\< have already been defined for the tensor \>\"", ",",
                     "Name", ",", "\"\<.\>\""}], "]"}]}], ",", 
                 RowBox[{"Throw", "[", "Null", "]"}]}], "]"}], ";"}]}], "]"}],
             ";", "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"DefScreenProjectedTensorQ", "[", "Name", "]"}], ",", 
              RowBox[{
               RowBox[{"If", "[", 
                RowBox[{"$DefInfoQ", ",", 
                 RowBox[{"Print", "[", 
                  RowBox[{
                  "\"\<** DefScreenProjectedTensor: Projection properties for \
the tensor \>\"", ",", "Name", ",", 
                   "\"\< have been defined for another slicing. New \
projection properties on the hypersurfaces associated with the induced metric\
\>\"", ",", "N", ",", "\"\< and direction vector\>\"", ",", "n", ",", 
                   "\"\< are now added.\>\""}], "]"}]}], "]"}], ";"}]}], 
             "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{"IndsNoLI", "=", 
             RowBox[{"Select", "[", 
              RowBox[{
               RowBox[{"{", "inds", "}"}], ",", 
               RowBox[{
                RowBox[{"Not", "@", 
                 RowBox[{"LIndexQ", "[", "#", "]"}]}], "&"}]}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{
             "And", " ", "here", " ", "we", " ", "should", " ", "put", " ", 
              "all", " ", "the", " ", "rules", " ", "of", " ", "splitting"}], 
             "*)"}], 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"Length", "[", "IndsNoLI", "]"}], "\[GreaterEqual]", 
                 "1"}], ")"}], "&&", 
               RowBox[{"(", 
                RowBox[{"Not", "@", 
                 RowBox[{"AnyIndicesListQ", "[", "IndsNoLI", "]"}]}], ")"}], "&&", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"Select", "[", 
                  RowBox[{"IndsNoLI", ",", "UpIndexQ"}], "]"}], "=!=", 
                 RowBox[{"{", "}"}]}], ")"}]}], ",", 
              RowBox[{"Throw", "[", 
               RowBox[{"Message", "[", 
                RowBox[{
                 RowBox[{"DefScreenProjecteTensor", "::", "notdownindices"}], 
                 ",", "Name"}], "]"}], "]"}]}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{
              RowBox[{"**", "**", "**", "**"}], "*", "The", " ", "following", 
              " ", "Message", " ", "is", " ", "not", " ", "yet", " ", 
              RowBox[{"defined", "."}]}], "**********)"}], 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"Length", "[", "IndsNoLI", "]"}], "\[GreaterEqual]", 
                 "2"}], ")"}], "&&", 
               RowBox[{"(", 
                RowBox[{"AnyIndicesListQ", "[", "IndsNoLI", "]"}], ")"}]}], 
              ",", 
              RowBox[{"Throw", "[", 
               RowBox[{"Message", "[", 
                RowBox[{
                 RowBox[{
                 "DefScreenProjectedTensor", "::", "invalidanyindices"}], ",",
                  "Name"}], "]"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{"PrAs", "=", 
             RowBox[{
              RowBox[{"PrintAs", "/.", 
               RowBox[{"CheckOptions", "[", "options", "]"}]}], "/.", 
              RowBox[{"Options", "[", "DefScreenProjectedTensorQ", "]"}]}]}], 
            ";", "\[IndentingNewLine]", 
            RowBox[{"SpaTimeDef", "=", 
             RowBox[{
              RowBox[{"SpaceTimesOfDefinition", "/.", 
               RowBox[{"CheckOptions", "[", "options", "]"}]}], "/.", 
              RowBox[{"Options", "[", "DefScreenProjectedTensor", "]"}]}]}], 
            ";", "\[IndentingNewLine]", 
            RowBox[{"TensProp", "=", 
             RowBox[{
              RowBox[{"TensorProperties", "/.", 
               RowBox[{"CheckOptions", "[", "options", "]"}]}], "/.", 
              RowBox[{"Options", "[", "DefScreenProjectedTensor", "]"}]}]}], 
            ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"DefScreenProjectedTensorQ", "[", "Name", "]"}], "||", 
               
               RowBox[{"DefTensorQ", "[", "Name", "]"}]}], ",", 
              RowBox[{"If", "[", 
               RowBox[{"$DefInfoQ", ",", 
                RowBox[{"Print", "[", 
                 RowBox[{
                 "\"\<** DefScreenProjectedTensor: The tensor \>\"", ",", 
                  "Name", ",", 
                  
                  "\"\< already exists. The projection properties on the \
hypersurfaces associated with the induced metric \>\"", ",", "N", ",", 
                  "\"\< are now defined.\>\""}], "]"}]}], "]"}], ",", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"(*", " ", 
               RowBox[{
               "Actual", " ", "definition", " ", "of", " ", "the", " ", 
                "projected", " ", "tensor"}], " ", "*)"}], 
              "\[IndentingNewLine]", 
              RowBox[{"DefTensor", "[", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", "p", "]"}], ",", 
                  RowBox[{"LI", "[", "q", "]"}], ",", 
                  RowBox[{"LI", "[", "r", "]"}], ",", 
                  RowBox[{"IndsNoLI", "/.", 
                   RowBox[{"List", "\[Rule]", "Sequence"}]}]}], "]"}], ",", 
                "M", ",", 
                RowBox[{"Symmetric", "[", "IndsNoLI", "]"}], ",", 
                RowBox[{"PrintAs", "\[Rule]", "PrAs"}]}], "]"}]}], 
             "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
            "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{
             "Definition", " ", "of", " ", "the", " ", "projection", " ", 
              "properties", " ", "for", " ", "the", " ", 
              RowBox[{"tensor", "'"}], 
              RowBox[{
               RowBox[{"Name", "'"}], "."}]}], "*)"}], "\[IndentingNewLine]", 
            
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"Not", "@", 
               RowBox[{"AnyIndicesListQ", "[", "IndsNoLI", "]"}]}], ",", 
              RowBox[{"DefProjectedTensorProperties", "[", 
               RowBox[{"Name", ",", 
                RowBox[{"IndsNoLI", "/.", 
                 RowBox[{"List", "\[Rule]", "Sequence"}]}], ",", "N", ",", 
                "TensProp", ",", "SpaTimeDef"}], "]"}], ",", 
              RowBox[{"{", "}"}]}], 
             RowBox[{"(*", 
              RowBox[{"DefProjectedTensorPropertiesAnyIndices", "[", 
               RowBox[{"Name", ",", "N", ",", "TensProp", ",", "SpaTimeDef"}],
                "]"}], "*)"}], "\[IndentingNewLine]", 
             RowBox[{"(*", " ", 
              RowBox[{
              "TODO", " ", "implement", " ", "in", " ", "the", " ", "case", 
               " ", "of", " ", "tensor", " ", "with", " ", "non", " ", 
               "fixed", " ", "number", " ", "of", " ", 
               RowBox[{"indices", "."}]}], "*)"}], "\[IndentingNewLine]", 
             "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{"Name", "/:", 
             RowBox[{
              RowBox[{"OrthogonalToVectorQ", "[", "n", "]"}], "[", "Name", 
              "]"}], "=", "True"}], ";", "\[IndentingNewLine]", 
            RowBox[{"Name", "/:", 
             RowBox[{
              RowBox[{"OrthogonalToVectorQ", "[", "u", "]"}], "[", "Name", 
              "]"}], "=", "True"}], ";"}], "\[IndentingNewLine]", ")"}]}], 
         "]"}]}], "]"}]}], "]"}]}]}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{"SetNumberOfArguments", "[", 
  RowBox[{"DefScreenProjectedTensor", ",", 
   RowBox[{"{", 
    RowBox[{"3", ",", "Infinity"}], "}"}]}], "]"}], "\n", 
 RowBox[{
  RowBox[{"Protect", "[", "DefScreenProjectedTensor", "]"}], ";"}]}], "Input",
 
 InitializationCell->True],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{"**", 
    RowBox[{"MODULE", ":", "DefProjectedTensorProperties"}]}], "***)"}], 
  RowBox[{
   RowBox[{"DefProjectedTensorProperties", "[", 
    RowBox[{"Name_", ",", 
     RowBox[{"inds___", "?", "DownIndexQ"}], ",", 
     RowBox[{"N_", "?", "InducedMetricQ"}], ",", "Properties_List", ",", 
     "Spacetimes_List"}], "]"}], ":=", 
   RowBox[{"Catch", "@", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"prot", ",", "Lengthindices"}], "}"}], ",", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"h", "=", 
           RowBox[{"First", "@", 
            RowBox[{"InducedFrom", "@", "N"}]}]}], ",", 
          RowBox[{"g", "=", 
           RowBox[{"First", "@", 
            RowBox[{"InducedFrom", "@", 
             RowBox[{"First", "@", 
              RowBox[{"InducedFrom", "@", "N"}]}]}]}]}], ",", 
          RowBox[{"u", "=", 
           RowBox[{"Last", "@", 
            RowBox[{"InducedFrom", "@", 
             RowBox[{"First", "@", 
              RowBox[{"InducedFrom", "@", "N"}]}]}]}]}], ",", 
          RowBox[{"n", "=", 
           RowBox[{"Last", "@", 
            RowBox[{"InducedFrom", "@", "N"}]}]}]}], "}"}], ",", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"With", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"cd1", "=", 
             RowBox[{"CovDOfMetric", "[", "h", "]"}]}], ",", 
            RowBox[{"cd2", "=", 
             RowBox[{"CovDOfMetric", "[", "N", "]"}]}], ",", 
            RowBox[{"M", "=", 
             RowBox[{"ManifoldOfCovD", "[", 
              RowBox[{"CovDOfMetric", "[", "g", "]"}], "]"}]}], ",", 
            RowBox[{"SymmetricBool", "=", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"Cases", "[", 
                RowBox[{"Properties", ",", "\"\<SymmetricTensor\>\""}], "]"}],
                "===", 
               RowBox[{"{", "\"\<SymmetricTensor\>\"", "}"}]}], ")"}]}], ",", 
            
            RowBox[{"TracelessBool", "=", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"Cases", "[", 
                RowBox[{"Properties", ",", "\"\<Traceless\>\""}], "]"}], "===", 
               RowBox[{"{", "\"\<Traceless\>\"", "}"}]}], ")"}]}], ",", 
            RowBox[{"TransverseBool", "=", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"Cases", "[", 
                RowBox[{"Properties", ",", "\"\<Transverse\>\""}], "]"}], "===", 
               RowBox[{"{", "\"\<Transverse\>\"", "}"}]}], ")"}]}], ",", 
            RowBox[{"BackgroundBool", "=", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"Cases", "[", 
                RowBox[{"Spacetimes", ",", "\"\<Background\>\""}], "]"}], "===", 
               RowBox[{"{", "\"\<Background\>\"", "}"}]}], ")"}]}], ",", 
            RowBox[{"PerturbedBool", "=", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"Cases", "[", 
                RowBox[{"Spacetimes", ",", "\"\<Perturbed\>\""}], "]"}], "===", 
               RowBox[{"{", "\"\<Perturbed\>\"", "}"}]}], ")"}]}], ",", 
            RowBox[{"ToCan", "=", 
             RowBox[{
              RowBox[{"ToCanonical", "[", 
               RowBox[{"#", ",", 
                RowBox[{"UseMetricOnVBundle", "\[Rule]", "None"}]}], "]"}], 
              "&"}]}]}], "}"}], ",", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{"$DebugInfoQ", ",", "\[IndentingNewLine]", 
             RowBox[{
             "Print", "[", "\"\<Calling DefProjectedTensorProperties\>\"", 
              "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Not", "[", "SymmetricBool", "]"}], "&&", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"Length", "[", 
                 RowBox[{"{", "inds", "}"}], "]"}], "\[GreaterEqual]", "2"}], 
               ")"}]}], ",", 
             RowBox[{"Throw", "@", 
              RowBox[{"Message", "[", 
               RowBox[{
               "DefProjectedTensorProperties", "::", "symmetrictensors"}], 
               "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"DefScreenProjectedTensorQ", "[", 
             RowBox[{"Name", ",", "N"}], "]"}], "^=", "True"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"InducedMetricOf", "[", "Name", "]"}], "^=", "N"}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"DefScreenProjectedTensorQ", "[", "Name", "]"}], "===", 
              "False"}], ",", 
             RowBox[{
              RowBox[{
               RowBox[{"PropertiesList", "[", "Name", "]"}], "^=", 
               RowBox[{"Join", "[", 
                RowBox[{"Properties", ",", 
                 RowBox[{"Which", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}], "===", "0"}], ",", 
                   RowBox[{"{", "\"\<Scalar\>\"", "}"}], ",", 
                   RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}], "===", "1"}], ",", 
                   RowBox[{"{", "\"\<Vector\>\"", "}"}], ",", 
                   RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}], "\[GreaterEqual]", 
                    "2"}], ",", 
                   RowBox[{"{", "\"\<Tensor\>\"", "}"}]}], "]"}]}], "]"}]}], 
              ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"Name", "[", 
                RowBox[{"indices___", "?", "AIndexQ"}], "]"}], ":=", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", "0", "]"}], ",", 
                  RowBox[{"LI", "[", "0", "]"}], ",", 
                  RowBox[{"LI", "[", "0", "]"}], ",", "indices"}], "]"}], "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "indices", "}"}], "]"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"Name", "[", 
                RowBox[{
                 RowBox[{"LI", "[", 
                  RowBox[{"p_", "?", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                 RowBox[{"indices___", "?", "AIndexQ"}]}], "]"}], ":=", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", "p", "]"}], ",", 
                  RowBox[{"LI", "[", "0", "]"}], ",", 
                  RowBox[{"LI", "[", "0", "]"}], ",", "indices"}], "]"}], "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "indices", "}"}], "]"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{
                RowBox[{
                "For", " ", "tensors", " ", "of", " ", "rank", " ", "larger", 
                 " ", "than", " ", "or", " ", "equal", " ", "to", " ", "2"}], 
                ",", 
                RowBox[{
                "the", " ", "following", " ", "rules", " ", "provide", " ", 
                 "the", " ", "traceless", " ", 
                 RowBox[{"property", "."}]}]}], "*)"}], 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}], "\[GreaterEqual]", 
                   "2"}], ")"}], "&&", "TracelessBool"}], ",", 
                RowBox[{
                 RowBox[{"Name", "/:", 
                  RowBox[{"Name", "[", 
                   RowBox[{
                    RowBox[{"LI", "[", 
                    RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", "indices1___", ",", 
                    "Dum_", ",", "indices2___", ",", 
                    RowBox[{"-", "Dum_"}], ",", "indices3___"}], "]"}], ":=", 
                  
                  RowBox[{"0", "/;", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}], ",", 
                    RowBox[{"{", "indices3", "}"}]}], "]"}], "]"}], "+", 
                    "2"}], "===", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
                 "\[IndentingNewLine]", "\[IndentingNewLine]", 
                 RowBox[{"Name", "/:", 
                  RowBox[{"Name", "[", 
                   RowBox[{
                    RowBox[{"LI", "[", 
                    RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", "indices1___", ",", 
                    RowBox[{"-", "Dum_"}], ",", "indices2___", ",", "Dum_", 
                    ",", "indices3___"}], "]"}], ":=", 
                  RowBox[{"0", "/;", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}], ",", 
                    RowBox[{"{", "indices3", "}"}]}], "]"}], "]"}], "+", 
                    "2"}], "===", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
                 "\[IndentingNewLine]", "\[IndentingNewLine]", 
                 RowBox[{"(*", 
                  RowBox[{
                  "Then", " ", "the", " ", "trace", " ", "of", " ", "a", " ", 
                   "derivative", " ", "is", " ", "not", " ", "the", " ", 
                   "derivative", " ", "of", " ", "the", " ", "trace", " ", 
                   "and", " ", "there", " ", "are", " ", "commutation", " ", 
                   RowBox[{"rules", ".", " ", "TODO"}], " ", "check", " ", 
                   "that", " ", "it", " ", "is", " ", 
                   RowBox[{"correct", "."}]}], "*)"}], 
                 RowBox[{"(*", 
                  RowBox[{"Up", " ", "down", " ", "case"}], "*)"}], 
                 "\[IndentingNewLine]", 
                 RowBox[{"Name", "/:", 
                  RowBox[{"Name", "[", 
                   RowBox[{
                    RowBox[{"LI", "[", 
                    RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", "Dum_", ",", 
                    "indices2___", ",", 
                    RowBox[{"-", "Dum_"}], ",", "indices3___"}], "]"}], ":=", 
                  "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{"Module", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"Dummy1", ",", "Dummy2"}], "}"}], ",", 
                    RowBox[{
                    RowBox[{"Dummy1", "=", 
                    RowBox[{"DummyIn", "[", 
                    RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ";", 
                    RowBox[{"Dummy2", "=", 
                    RowBox[{"DummyIn", "[", 
                    RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ";", 
                    "\[IndentingNewLine]", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{"$ConformalTime", ",", "1", ",", 
                    RowBox[{"1", "/", 
                    RowBox[{
                    RowBox[{"a", "[", "h", "]"}], "[", "]"}]}]}], "]"}], "*", 
                    
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"LieD", "[", 
                    RowBox[{"u", "[", "Dummy1", "]"}], "]"}], "[", 
                    RowBox[{"ToCan", "[", 
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"q", "-", "1"}], "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", "indices1", ",", 
                    "Dum", ",", "indices2", ",", 
                    RowBox[{"-", "Dum"}], ",", "indices3"}], "]"}], "]"}], 
                    "]"}], "+", 
                    RowBox[{"2", "*", 
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"q", "-", "1"}], "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", "indices1", ",", 
                    RowBox[{"-", "Dummy1"}], ",", "indices2", ",", 
                    RowBox[{"-", "Dummy2"}], ",", "indices3"}], "]"}], " ", 
                    RowBox[{
                    RowBox[{"ExtrinsicK", "[", "h", "]"}], "[", 
                    RowBox[{"Dummy1", ",", "Dummy2"}], "]"}]}]}], ")"}]}]}]}],
                     "]"}], "/;", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}], ",", 
                    RowBox[{"{", "indices3", "}"}]}], "]"}], "]"}], "+", 
                    "2"}], "===", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
                 "\[IndentingNewLine]", "\[IndentingNewLine]", 
                 RowBox[{"(*", " ", 
                  RowBox[{
                  "Down", " ", "up", " ", "case", " ", "is", " ", "the", " ", 
                   "same", " ", "but", " ", "we", " ", "need", " ", "to", " ",
                    "give", " ", "the", " ", "two", " ", "cases"}], "*)"}], 
                 "\[IndentingNewLine]", 
                 RowBox[{"Name", "/:", 
                  RowBox[{"Name", "[", 
                   RowBox[{
                    RowBox[{"LI", "[", 
                    RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{
                    RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], ",", 
                    RowBox[{"LI", "[", "0", "]"}]}], "]"}], ",", 
                    "indices1___", ",", 
                    RowBox[{"-", "Dum_"}], ",", "indices2___", ",", "Dum_", 
                    ",", "indices3___"}], "]"}], ":=", 
                  RowBox[{
                   RowBox[{"Module", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"Dummy1", ",", "Dummy2"}], "}"}], ",", 
                    RowBox[{
                    RowBox[{"Dummy1", "=", 
                    RowBox[{"DummyIn", "[", 
                    RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ";", 
                    RowBox[{"Dummy2", "=", 
                    RowBox[{"DummyIn", "[", 
                    RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ";", 
                    "\[IndentingNewLine]", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{"$ConformalTime", ",", "1", ",", 
                    RowBox[{"1", "/", 
                    RowBox[{
                    RowBox[{"a", "[", "h", "]"}], "[", "]"}]}]}], "]"}], "*", 
                    
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"LieD", "[", 
                    RowBox[{"u", "[", "Dummy1", "]"}], "]"}], "[", 
                    RowBox[{"ToCan", "[", 
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"q", "-", "1"}], "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", "indices1", ",", 
                    "Dum", ",", "indices2", ",", 
                    RowBox[{"-", "Dum"}], ",", "indices3"}], "]"}], "]"}], 
                    "]"}], "+", 
                    RowBox[{"2", "*", 
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"q", "-", "1"}], "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", "indices1", ",", 
                    RowBox[{"-", "Dummy1"}], ",", "indices2", ",", 
                    RowBox[{"-", "Dummy2"}], ",", "indices3"}], "]"}], " ", 
                    RowBox[{
                    RowBox[{"ExtrinsicK", "[", "h", "]"}], "[", 
                    RowBox[{"Dummy1", ",", "Dummy2"}], "]"}]}]}], ")"}]}]}]}],
                     "]"}], "/;", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}], ",", 
                    RowBox[{"{", "indices3", "}"}]}], "]"}], "]"}], "+", 
                    "2"}], "===", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";"}]}], 
               "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"PerturbationOrder", "[", 
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", "0", "]"}], ",", 
                  RowBox[{"LI", "[", "q_", "]"}], ",", 
                  RowBox[{"LI", "[", "r_", "]"}], ",", "indices___"}], "]"}], 
                "]"}], "^:=", 
               RowBox[{"Catch", "@", 
                RowBox[{"Module", "[", 
                 RowBox[{
                  RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "indices", "}"}], "]"}], "=!=", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ",", 
                    RowBox[{"Throw", "[", 
                    RowBox[{"Print", "[", 
                    RowBox[{
                    "\"\<** Warning: The number of indices for the tensor \
\>\"", ",", "Name", ",", "\"\< is incorrect.\>\""}], "]"}], "]"}]}], "]"}], 
                   ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
                   RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Cases", "[", 
                    RowBox[{
                    RowBox[{"AIndexQ", "/@", 
                    RowBox[{"{", "indices", "}"}]}], ",", "False"}], "]"}], "=!=", 
                    RowBox[{"{", "}"}]}], ",", 
                    RowBox[{"Throw", "[", 
                    RowBox[{"Print", "[", 
                    RowBox[{
                    "\"\<** Warning: The indices of the tensor \>\"", ",", 
                    "Name", ",", "\"\< have to be abstract indices.\>\""}], 
                    "]"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
                   "\[IndentingNewLine]", 
                   RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "q", "]"}], "&&", 
                    RowBox[{"q", "\[GreaterEqual]", "0"}]}], ")"}], ",", "0", 
                    ",", 
                    RowBox[{"(*", 
                    RowBox[{
                    RowBox[{"Throw", "[", 
                    RowBox[{
                    "Print", "[", 
                    "\"\<** Warning: The second label-index has to be a \
positive integer.\>\"", "]"}], "]"}], "]"}], "*)"}], 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"NumericQ", "[", "q", "]"}], ",", 
                    RowBox[{"Throw", "[", 
                    RowBox[{
                    "Print", "[", 
                    "\"\<** Warning: The second label-index has to be a \
positive integer.\>\"", "]"}], "]"}]}], "]"}]}], "]"}], ";", 
                   "\[IndentingNewLine]", "\[IndentingNewLine]", 
                   RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "r", "]"}], "&&", 
                    RowBox[{"r", "\[GreaterEqual]", "0"}]}], ")"}], ",", "0", 
                    ",", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"NumericQ", "[", "r", "]"}], ",", 
                    RowBox[{"Throw", "[", 
                    RowBox[{
                    "Print", "[", 
                    "\"\<** Warning: The Third label-index has to be a \
positive integer.\>\"", "]"}], "]"}]}], "]"}]}], "]"}]}]}], "]"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{
                RowBox[{"TO", " ", 
                 RowBox[{"DO", ":", "Here"}]}], ",", 
                RowBox[{
                "we", " ", "have", " ", "to", " ", "comment", " ", "on", " ", 
                 "the", " ", "commutation", " ", "between", " ", "perturbing",
                  " ", "and", " ", "Lie", " ", 
                 RowBox[{"deriving", ".", "This"}], " ", "commutation", " ", 
                 "stems", " ", "from", " ", "the", " ", "fact", " ", "that", 
                 " ", "the", " ", "Lie", " ", "derivative", " ", "is", " ", 
                 "a", " ", "background", " ", "Lie", " ", 
                 RowBox[{"derivative", "."}]}]}], "*)"}], 
              RowBox[{"If", "[", 
               RowBox[{"PerturbedBool", ",", 
                RowBox[{"(*", 
                 RowBox[{
                  RowBox[{
                  "For", " ", "any", " ", "perturbed", " ", "tensors"}], ",", 
                  
                  RowBox[{"we", " ", 
                   RowBox[{"have", ":"}]}]}], "*)"}], 
                RowBox[{
                 RowBox[{
                  RowBox[{"PerturbationOrder", "[", 
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p_", "]"}], ",", 
                    RowBox[{"LI", "[", "q_", "]"}], ",", 
                    RowBox[{"LI", "[", "r_", "]"}], ",", "indices___"}], 
                    "]"}], "]"}], "^:=", 
                  RowBox[{"Catch", "@", 
                   RowBox[{"Module", "[", 
                    RowBox[{
                    RowBox[{"{", "}"}], ",", 
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "indices", "}"}], "]"}], "=!=", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ",", 
                    RowBox[{"Throw", "[", 
                    RowBox[{"Print", "[", 
                    RowBox[{
                    "\"\<** Warning: The number of indices for the tensor \
\>\"", ",", "Name", ",", "\"\< is incorrect.\>\""}], "]"}], "]"}]}], "]"}], 
                    ";", "\[IndentingNewLine]", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Cases", "[", 
                    RowBox[{
                    RowBox[{"AIndexQ", "/@", 
                    RowBox[{"{", "indices", "}"}]}], ",", "False"}], "]"}], "=!=", 
                    RowBox[{"{", "}"}]}], ",", 
                    RowBox[{"Throw", "[", 
                    RowBox[{"Print", "[", 
                    RowBox[{
                    "\"\<** Warning: The indices of the tensor \>\"", ",", 
                    "Name", ",", "\"\< have to be abstract indices.\>\""}], 
                    "]"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "p", "]"}], "&&", 
                    RowBox[{"p", "\[GreaterEqual]", "1"}]}], ")"}], "&&", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "q", "]"}], "&&", 
                    RowBox[{"q", "\[GreaterEqual]", "0"}]}], ")"}]}], ",", 
                    "p", ",", 
                    RowBox[{"(*", 
                    RowBox[{
                    RowBox[{"Throw", "[", 
                    RowBox[{
                    "Print", "[", 
                    "\"\<** Warning: The label-indices have to be positive \
integers.\>\"", "]"}], "]"}], "]"}], "*)"}], 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"NumericQ", "[", "p", "]"}], "&&", 
                    RowBox[{"NumericQ", "[", "q", "]"}]}], ",", 
                    RowBox[{"Throw", "[", 
                    RowBox[{"Print", "[", 
                    "\"\<** Warning: The label-indices have to be positive \
integers.\>\"", "]"}], "]"}]}], "]"}]}], "]"}]}]}], "]"}]}]}], ";", 
                 "\[IndentingNewLine]", "\[IndentingNewLine]", 
                 RowBox[{"(*", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"the", " ", "rule", " ", 
                    RowBox[{"for", "'"}], "p"}], "=", 
                    RowBox[{
                    RowBox[{"0", "'"}], " ", "is", " ", "defined", " ", 
                    "above"}]}], ")"}], "*)"}], 
                 RowBox[{"(*", 
                  RowBox[{
                   RowBox[{
                   "and", " ", "for", " ", "perturbed", " ", "scalar", " ", 
                    "quantities"}], ",", 
                   RowBox[{"we", " ", 
                    RowBox[{"have", ":"}]}]}], "*)"}], 
                 RowBox[{
                  RowBox[{"Perturbation", "[", 
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p_", "]"}], ",", 
                    RowBox[{"LI", "[", "q_", "]"}], ",", 
                    RowBox[{"LI", "[", "r_", "]"}]}], "]"}], "]"}], "^:=", 
                  RowBox[{"Catch", "@", 
                   RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "p", "]"}], "&&", 
                    RowBox[{"p", "\[GreaterEqual]", "0"}]}], ")"}], "&&", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "q", "]"}], "&&", 
                    RowBox[{"q", "\[GreaterEqual]", "0"}]}], ")"}], "&&", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "r", "]"}], "&&", 
                    RowBox[{"r", "\[GreaterEqual]", "0"}]}], ")"}]}], ",", 
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", 
                    RowBox[{"p", "+", "1"}], "]"}], ",", 
                    RowBox[{"LI", "[", "q", "]"}], ",", 
                    RowBox[{"LI", "[", "r", "]"}]}], "]"}], ",", 
                    RowBox[{"Throw", "[", 
                    RowBox[{
                    "Print", "[", 
                    "\"\<** Warning: The label-indices have to be positive \
integers.\>\"", "]"}], "]"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
                 "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"Perturbation", "[", 
                   RowBox[{
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p_", "]"}], ",", 
                    RowBox[{"LI", "[", "q_", "]"}], ",", 
                    RowBox[{"LI", "[", "r_", "]"}]}], "]"}], ",", 
                    "PertOrder_"}], "]"}], "^:=", 
                  RowBox[{"Catch", "@", 
                   RowBox[{"Module", "[", 
                    RowBox[{
                    RowBox[{"{", "}"}], ",", 
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"Not", "[", 
                    RowBox[{"IntegerQ", "[", "PertOrder", "]"}], "]"}], ",", 
                    RowBox[{"Throw", "[", 
                    RowBox[{
                    "Print", "[", 
                    "\"\<** Warning: The order of the perturbation has to be \
an integer.\>\"", "]"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "p", "]"}], "&&", 
                    RowBox[{"p", "\[GreaterEqual]", "0"}]}], ")"}], "&&", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "q", "]"}], "&&", 
                    RowBox[{"q", "\[GreaterEqual]", "0"}]}], ")"}], "&&", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "r", "]"}], "&&", 
                    RowBox[{"r", "\[GreaterEqual]", "0"}]}], ")"}]}], ",", 
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", 
                    RowBox[{"p", "+", "PertOrder"}], "]"}], ",", 
                    RowBox[{"LI", "[", "q", "]"}], ",", 
                    RowBox[{"LI", "[", "r", "]"}]}], "]"}], ",", 
                    RowBox[{"Throw", "[", 
                    RowBox[{
                    "Print", "[", 
                    "\"\<** Warning: The label-indices have to be positive \
integers.\>\"", "]"}], "]"}]}], "]"}]}]}], "]"}]}]}], ";"}]}], "]"}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{
                RowBox[{
                "For", " ", "tensors", " ", "living", " ", "on", " ", "the", 
                 " ", "background", " ", "only"}], ",", " ", 
                RowBox[{"we", " ", 
                 RowBox[{"have", ":"}]}]}], "*)"}], 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{"BackgroundBool", "&&", 
                 RowBox[{"Not", "[", "PerturbedBool", "]"}]}], ",", 
                RowBox[{
                 RowBox[{
                  RowBox[{"Perturbation", "[", 
                   RowBox[{
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "0", "]"}], ",", 
                    RowBox[{"LI", "[", "q_", "]"}], ",", 
                    RowBox[{"LI", "[", "r_", "]"}], ",", "indices___"}], 
                    "]"}], ",", "PertOrder_"}], "]"}], "^:=", 
                  RowBox[{"Catch", "@", 
                   RowBox[{"Module", "[", 
                    RowBox[{
                    RowBox[{"{", "}"}], ",", 
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "indices", "}"}], "]"}], "=!=", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ",", 
                    RowBox[{"Throw", "[", 
                    RowBox[{"Print", "[", 
                    RowBox[{
                    "\"\<** Warning: The number of indices for the tensor \
\>\"", ",", "Name", ",", "\"\< is incorrect.\>\""}], "]"}], "]"}]}], "]"}], 
                    ";", "\[IndentingNewLine]", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Cases", "[", 
                    RowBox[{
                    RowBox[{"AIndexQ", "/@", 
                    RowBox[{"{", "indices", "}"}]}], ",", "False"}], "]"}], "=!=", 
                    RowBox[{"{", "}"}]}], ",", 
                    RowBox[{"Throw", "[", 
                    RowBox[{"Print", "[", 
                    RowBox[{
                    "\"\<** Warning: The indices of the tensor \>\"", ",", 
                    "Name", ",", "\"\< have to be abstract indices.\>\""}], 
                    "]"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
                    "\[IndentingNewLine]", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"Not", "[", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "q", "]"}], "&&", 
                    RowBox[{"q", "\[GreaterEqual]", "0"}]}], "]"}], ",", 
                    RowBox[{"Throw", "[", 
                    RowBox[{
                    "Print", "[", 
                    "\"\<** Warning: The second label-index has to be a \
positive integer.\>\"", "]"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"PertOrder", "===", "0"}], ",", 
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "0", "]"}], ",", 
                    RowBox[{"LI", "[", "q", "]"}], ",", 
                    RowBox[{"LI", "[", "r", "]"}], ",", "indices"}], "]"}], 
                    ",", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "PertOrder", "]"}], "&&", 
                    RowBox[{"PertOrder", "\[GreaterEqual]", "1"}]}], ")"}], 
                    ",", "0", ",", 
                    RowBox[{"Throw", "[", 
                    RowBox[{
                    "Print", "[", 
                    "\"\<** Warning: The order of the perturbation has to be \
a positive integer.\>\"", "]"}], "]"}]}], "]"}]}], "]"}]}]}], "]"}]}]}], ";", 
                 "\[IndentingNewLine]", "\[IndentingNewLine]", 
                 "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"Perturbation", "[", 
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "0", "]"}], ",", 
                    RowBox[{"LI", "[", "q_", "]"}], ",", 
                    RowBox[{"LI", "[", "r_", "]"}], ",", "indices___"}], 
                    "]"}], "]"}], "^:=", 
                  RowBox[{"Catch", "@", 
                   RowBox[{"Module", "[", 
                    RowBox[{
                    RowBox[{"{", "}"}], ",", 
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "indices", "}"}], "]"}], "=!=", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ",", 
                    RowBox[{"Throw", "[", 
                    RowBox[{"Print", "[", 
                    RowBox[{
                    "\"\<** Warning: The number of indices for the tensor \
\>\"", ",", "Name", ",", "\"\< is incorrect.\>\""}], "]"}], "]"}]}], "]"}], 
                    ";", "\[IndentingNewLine]", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Cases", "[", 
                    RowBox[{
                    RowBox[{"AIndexQ", "/@", 
                    RowBox[{"{", "indices", "}"}]}], ",", "False"}], "]"}], "=!=", 
                    RowBox[{"{", "}"}]}], ",", 
                    RowBox[{"Throw", "[", 
                    RowBox[{"Print", "[", 
                    RowBox[{
                    "\"\<** Warning: The indices of the tensor \>\"", ",", 
                    "Name", ",", "\"\< have to be abstract indices.\>\""}], 
                    "]"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "q", "]"}], "&&", 
                    RowBox[{"q", "\[GreaterEqual]", "0"}]}], ",", "0", ",", 
                    RowBox[{"Throw", "[", 
                    RowBox[{
                    "Print", "[", 
                    "\"\<** Warning: The second label-index has to be a \
positive integer.\>\"", "]"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "r", "]"}], "&&", 
                    RowBox[{"r", "\[GreaterEqual]", "0"}]}], ",", "0", ",", 
                    RowBox[{"Throw", "[", 
                    RowBox[{
                    "Print", "[", 
                    "\"\<** Warning: The second label-index has to be a \
positive integer.\>\"", "]"}], "]"}]}], "]"}]}]}], "]"}]}]}], ";"}]}], "]"}], 
              ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{
                RowBox[{"For", " ", "pure", " ", "perturbations", " ", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"i", ".", "e", ".", "for"}], " ", "tensors", " ", 
                   "without", " ", "background", " ", "values"}], ")"}]}], 
                ",", 
                RowBox[{"we", " ", 
                 RowBox[{"have", ":"}]}]}], "*)"}], 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"Not", "[", "BackgroundBool", "]"}], "&&", 
                 "PerturbedBool"}], ",", 
                RowBox[{"(*", 
                 RowBox[{
                 "This", " ", "is", " ", "the", " ", "0.4", ".0", " ", 
                  "version", " ", "way", " ", "to", " ", "do", " ", 
                  RowBox[{"it", ".", "We"}], " ", "define", " ", "a", " ", 
                  "delayed", " ", "0", " ", "value", " ", "for", " ", "the", 
                  " ", "background"}], "*)"}], 
                RowBox[{"(*", 
                 RowBox[{
                 "However", " ", "this", " ", "is", " ", "problematic", " ", 
                  "when", " ", "we", " ", "want", " ", "to", " ", 
                  RowBox[{"perturb", ".", "Because"}], " ", "then", " ", 
                  "when", " ", "we", " ", "perturb", " ", "this", " ", 
                  "quantity"}], "*)"}], 
                RowBox[{"(*", 
                 RowBox[{
                  RowBox[{"we", " ", "write", " ", 
                   RowBox[{"Perturbed", "[", "quantity", "]"}], " ", "but", 
                   " ", "Mathematica", " ", "will", " ", "read", " ", 
                   RowBox[{"Perturbed", "[", "0", "]"}]}], ",", 
                  RowBox[{
                  "and", " ", "so", " ", "this", " ", "leads", " ", "to", " ",
                    "0."}]}], "*)"}], 
                RowBox[{"(*", 
                 RowBox[{
                  RowBox[{
                  "Instead", " ", "we", " ", "should", " ", "append", " ", 
                   "this", " ", "to", " ", "a", " ", "list", " ", "of", " ", 
                   "rules"}], ",", 
                  RowBox[{
                  "that", " ", "should", " ", "be", " ", "applied", " ", "in",
                    " ", "SplitPerturbations"}]}], "*)"}], 
                RowBox[{"(*", 
                 RowBox[{
                 "The", " ", "easiest", " ", "way", " ", "is", " ", "to", " ",
                   "define", " ", "a", " ", "set", " ", "of", " ", "global", 
                  " ", "rules", " ", "and", " ", "to", " ", "append", " ", 
                  "a", " ", "new", " ", "rule", " ", "each", " ", "time", " ",
                   "there", " ", "is", " ", "a", " ", "tensor", " ", 
                  "vanishing", " ", "on", " ", "the", " ", "background"}], 
                 "*)"}], 
                RowBox[{"(*", 
                 RowBox[{"Old", " ", "implementation"}], "*)"}], 
                RowBox[{"(*", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "0", "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"indices___", "?", "AIndexQ"}]}], "]"}], ":=", 
                   RowBox[{"0", "/;", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "indices", "}"}], "]"}], "===", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";"}], 
                 "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
                RowBox[{"(*", 
                 RowBox[{"New", " ", "implementation"}], "*)"}], 
                "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"Lengthindices", "=", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ";", 
                 "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"$RulesVanishingBackgroundFields", "[", "N", "]"}], 
                  "=", 
                  RowBox[{"Append", "[", 
                   RowBox[{
                    RowBox[{
                    "$RulesVanishingBackgroundFields", "[", "N", "]"}], ",", 
                    RowBox[{
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "0", "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"indices___", "?", "AIndexQ"}]}], "]"}], 
                    "\[RuleDelayed]", 
                    RowBox[{"0", "/;", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "indices", "}"}], "]"}], "===", 
                    "Lengthindices"}], ")"}]}]}]}], "]"}]}], ";"}]}], "]"}], 
              ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"DefScreenProjectedTensorQ", "[", "Name", "]"}], "^=", 
               "True"}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"PropertiesList", "[", "Name", "]"}], "^=", 
            RowBox[{"Join", "[", 
             RowBox[{
              RowBox[{"PropertiesList", "[", "Name", "]"}], ",", 
              RowBox[{"Which", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}], "===", "1"}], "&&", 
                 "TransverseBool"}], ",", 
                RowBox[{"{", 
                 RowBox[{
                 "\"\<SVT-Vector associated with the induced metric \>\"", 
                  " ", "N", " ", "\"\<\>\""}], "}"}], ",", 
                RowBox[{
                 RowBox[{
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}], "\[GreaterEqual]", 
                  "2"}], "&&", "SymmetricBool", "&&", "TracelessBool", "&&", 
                 "TransverseBool"}], ",", 
                RowBox[{"{", 
                 RowBox[{
                 "\"\<SVT-Tensor associated with the induced metric \>\"", 
                  " ", "N", " ", "\"\<\>\""}], "}"}], ",", 
                RowBox[{
                 RowBox[{"Length", "[", 
                  RowBox[{"{", "inds", "}"}], "]"}], "\[GreaterEqual]", "0"}],
                 ",", 
                RowBox[{"{", "}"}]}], "]"}]}], "]"}]}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{"'", "SVT"}], "-", 
             RowBox[{
              RowBox[{"Vector", "'"}], " ", "is", " ", "a", " ", "vector", 
              " ", "satisfying", " ", "the", " ", "SVT"}], "-", 
             RowBox[{"decomposition", " ", "properties", " ", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{"hence", " ", "it", " ", "is", " ", "transverse"}], 
                ")"}], ".", "'"}], "SVT"}], "-", 
             RowBox[{
              RowBox[{"Tensor", "'"}], " ", "is", " ", "a", " ", "tensor", 
              " ", "satisfying", " ", "the", " ", "SVT"}], "-", 
             RowBox[{"decomposition", " ", "properties", " ", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"hence", " ", "it", " ", "is", " ", "symmetric"}], 
                 ",", 
                 RowBox[{"traceless", " ", "and", " ", "transverse"}]}], 
                ")"}], "."}]}]}], "*)"}], "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{
             "The", " ", "Lie", " ", "derivative", " ", "for", " ", "tensors",
               " ", "with", " ", "indices", " ", "down", " ", "is", " ", 
              "represented", " ", "by", " ", "the", " ", "second", " ", 
              "label"}], "-", 
             RowBox[{"index", "."}]}], "*)"}], 
           RowBox[{"Name", "/:", 
            RowBox[{
             RowBox[{"LieD", "[", 
              RowBox[{"u", "[", "Dum_", "]"}], "]"}], "[", 
             RowBox[{"Name", "[", 
              RowBox[{
               RowBox[{"LI", "[", 
                RowBox[{"p_", "?", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                  ")"}]}], "]"}], ",", 
               RowBox[{"LI", "[", 
                RowBox[{
                 RowBox[{"q_", "?", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                   ")"}]}], ",", 
                 RowBox[{"LI", "[", 
                  RowBox[{"r_", "?", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}]}], "]"}], ",", 
               RowBox[{"indices___", "?", "DownIndexQ"}]}], "]"}], "]"}], ":=", 
            RowBox[{
             RowBox[{
              RowBox[{"If", "[", 
               RowBox[{"$ConformalTime", ",", "1", ",", 
                RowBox[{
                 RowBox[{"a", "[", "h", "]"}], "[", "]"}]}], "]"}], "*", 
              RowBox[{"Name", "[", 
               RowBox[{
                RowBox[{"LI", "[", "p", "]"}], ",", 
                RowBox[{"LI", "[", 
                 RowBox[{"q", "+", "1"}], "]"}], ",", 
                RowBox[{"LI", "[", "r", "]"}], ",", "indices"}], "]"}]}], "/;", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"Length", "[", 
                RowBox[{"{", "indices", "}"}], "]"}], "===", 
               RowBox[{"Length", "[", 
                RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{
             "For", " ", "tensors", " ", "of", " ", "rank", " ", "larger", 
              " ", "than", " ", "or", " ", "equal", " ", "to", " ", "1"}], 
             ","}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Length", "[", 
               RowBox[{"{", "inds", "}"}], "]"}], "\[GreaterEqual]", "1"}], 
             ",", 
             RowBox[{
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"OrthogonalToVectorQ", "[", "u", "]"}], "[", "Name", 
                "]"}], "=", "True"}], ";", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{"Projection", " ", "conditions"}], "*)"}], 
              RowBox[{"(*", 
               RowBox[{
                RowBox[{
                "The", " ", "contraction", " ", "with", " ", "the", " ", 
                 "vector", " ", "normal", " ", "to", " ", "the", " ", 
                 "hypersurfaces", " ", "gives", " ", 
                 RowBox[{"(", 
                  RowBox[{
                  "since", " ", "the", " ", "tensor", " ", "is", " ", 
                   "projected"}], ")"}]}], ":"}], "*)"}], 
              "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{"Projection", " ", "orthogonal", " ", "to", " ", "u"}],
                "*)"}], "\[IndentingNewLine]", 
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", 
                   RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", "Dum_", ",", 
                  "indices2___"}], "]"}], " ", 
                RowBox[{"u", "[", 
                 RowBox[{"-", "Dum_"}], "]"}]}], ":=", 
               RowBox[{"0", "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                   "1"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", 
                   RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", 
                  RowBox[{"-", "Dum_"}], ",", "indices2___"}], "]"}], " ", 
                RowBox[{"u", "[", "Dum_", "]"}]}], ":=", 
               RowBox[{"0", "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                   "1"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{"Projection", " ", "orthogonal", " ", "to", " ", "n"}],
                "*)"}], "\[IndentingNewLine]", 
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", 
                   RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", "Dum_", ",", 
                  "indices2___"}], "]"}], " ", 
                RowBox[{"n", "[", 
                 RowBox[{"-", "Dum_"}], "]"}]}], ":=", 
               RowBox[{"0", "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                   "1"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", 
                   RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", 
                  RowBox[{"-", "Dum_"}], ",", "indices2___"}], "]"}], " ", 
                RowBox[{"n", "[", "Dum_", "]"}]}], ":=", 
               RowBox[{"0", "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                   "1"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{
               "And", " ", "the", " ", "action", " ", "of", " ", "the", " ", 
                "projector", " ", "onto", " ", "the", " ", "hypersurfaces", 
                " ", "is", " ", "an", " ", "invariant", " ", 
                RowBox[{"operation", ":"}]}], "*)"}], 
              RowBox[{"(*", 
               RowBox[{
               "However", " ", "this", " ", "is", " ", "left", " ", "to", " ",
                 "post", " ", "processing", " ", 
                RowBox[{"that", "'"}], "s", " ", "why", " ", "we", " ", 
                "load", " ", "this", " ", "rule", " ", "into", " ", 
                "$Rulecdh", " ", "and", " ", "$RulecdNSS"}], "*)"}], 
              RowBox[{
               RowBox[{"$Rulecdh", "[", "h", "]"}], "=", 
               RowBox[{"Append", "[", 
                RowBox[{
                 RowBox[{"$Rulecdh", "[", "h", "]"}], ",", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", 
                    RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", "indices1___", ",", 
                    "Dum1_", ",", "indices2___"}], "]"}], " ", 
                   RowBox[{"h", "[", 
                    RowBox[{
                    RowBox[{"-", "Dum1_"}], ",", 
                    RowBox[{"-", "Dum2_"}]}], "]"}]}], "\[RuleDelayed]", 
                  RowBox[{
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", "indices1", ",", 
                    RowBox[{"-", "Dum2"}], ",", "indices2"}], "]"}], "/;", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                    "1"}], "===", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}]}], "]"}]}],
               ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"$Rulecdh", "[", "h", "]"}], "=", 
               RowBox[{"Append", "[", 
                RowBox[{
                 RowBox[{"$Rulecdh", "[", "h", "]"}], ",", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", 
                    RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", "indices1___", ",", 
                    RowBox[{"-", "Dum1_"}], ",", "indices2___"}], "]"}], " ", 
                   
                   RowBox[{"h", "[", 
                    RowBox[{
                    RowBox[{"Dum1_", "?", "UpIndexQ"}], ",", 
                    RowBox[{"Dum2_", "?", "UpIndexQ"}]}], "]"}]}], 
                  "\[RuleDelayed]", 
                  RowBox[{
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", "indices1", ",", 
                    "Dum2", ",", "indices2"}], "]"}], "/;", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                    "1"}], "===", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}]}], "]"}]}],
               ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{"OU", ":", 
                RowBox[{
                "I", " ", "think", " ", "some", " ", "of", " ", "these", " ", 
                 "had", " ", "been", " ", "implemeted", " ", "in", " ", "the",
                  " ", "DefScreenSpaceMetric"}]}], "*)"}], 
              RowBox[{
               RowBox[{"$RulecdNSS", "[", "N", "]"}], "=", 
               RowBox[{"Append", "[", 
                RowBox[{
                 RowBox[{"$RulecdNSS", "[", "h", "]"}], ",", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", 
                    RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", "indices1___", ",", 
                    "Dum1_", ",", "indices2___"}], "]"}], " ", 
                   RowBox[{"N", "[", 
                    RowBox[{
                    RowBox[{"-", "Dum1_"}], ",", 
                    RowBox[{"-", "Dum2_"}]}], "]"}]}], "\[RuleDelayed]", 
                  RowBox[{
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", "indices1", ",", 
                    RowBox[{"-", "Dum2"}], ",", "indices2"}], "]"}], "/;", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                    "1"}], "===", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}]}], "]"}]}],
               ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"$RulecdNSS", "[", "N", "]"}], "=", 
               RowBox[{"Append", "[", 
                RowBox[{
                 RowBox[{"$RulecdNSS", "[", "N", "]"}], ",", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", 
                    RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", "indices1___", ",", 
                    RowBox[{"-", "Dum1_"}], ",", "indices2___"}], "]"}], " ", 
                   
                   RowBox[{"N", "[", 
                    RowBox[{
                    RowBox[{"Dum1_", "?", "UpIndexQ"}], ",", 
                    RowBox[{"Dum2_", "?", "UpIndexQ"}]}], "]"}]}], 
                  "\[RuleDelayed]", 
                  RowBox[{
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", "indices1", ",", 
                    "Dum2", ",", "indices2"}], "]"}], "/;", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                    "1"}], "===", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}]}], "]"}]}],
               ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"(*", " ", 
               RowBox[{
               "Projection", " ", "rules", " ", "with", " ", "respect", " ", 
                "to", " ", "the", " ", "screen", " ", "space", " ", "met"}], 
               "*)"}], "\[IndentingNewLine]", 
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", 
                   RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", "0", "]"}], ",", 
                  RowBox[{"LI", "[", "0", "]"}], ",", "indices1___", ",", 
                  "Dum1_", ",", "indices2___"}], "]"}], " ", 
                RowBox[{"N", "[", 
                 RowBox[{
                  RowBox[{"-", "Dum1_"}], ",", 
                  RowBox[{"Dum2_", "?", "UpIndexQ"}]}], "]"}]}], ":=", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", "p", "]"}], ",", 
                  RowBox[{"LI", "[", "0", "]"}], ",", 
                  RowBox[{"LI", "[", "0", "]"}], ",", "indices1", ",", "Dum2",
                   ",", "indices2"}], "]"}], "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                   "1"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", 
                   RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", "0", "]"}], ",", 
                  RowBox[{"LI", "[", "0", "]"}], ",", "indices1___", ",", 
                  "Dum1_", ",", "indices2___"}], "]"}], " ", 
                RowBox[{"N", "[", 
                 RowBox[{
                  RowBox[{"Dum2_", "?", "UpIndexQ"}], ",", 
                  RowBox[{"-", "Dum1_"}]}], "]"}]}], ":=", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", "p", "]"}], ",", 
                  RowBox[{"LI", "[", "0", "]"}], ",", 
                  RowBox[{"LI", "[", "0", "]"}], ",", "indices1", ",", "Dum2",
                   ",", "indices2"}], "]"}], "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                   "1"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", 
                   RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", "0", "]"}], ",", 
                  RowBox[{"LI", "[", "0", "]"}], ",", "indices1___", ",", 
                  RowBox[{"-", "Dum1_"}], ",", "indices2___"}], "]"}], " ", 
                RowBox[{"N", "[", 
                 RowBox[{"Dum1_", ",", 
                  RowBox[{"-", "Dum2_"}]}], "]"}]}], ":=", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", "p", "]"}], ",", 
                  RowBox[{"LI", "[", "0", "]"}], ",", 
                  RowBox[{"LI", "[", "0", "]"}], ",", "indices1", ",", 
                  RowBox[{"-", "Dum2"}], ",", "indices2"}], "]"}], "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                   "1"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", 
                   RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", "0", "]"}], ",", 
                  RowBox[{"LI", "[", "0", "]"}], ",", "indices1___", ",", 
                  RowBox[{"-", "Dum1_"}], ",", "indices2___"}], "]"}], " ", 
                RowBox[{"N", "[", 
                 RowBox[{
                  RowBox[{"-", "Dum2_"}], ",", "Dum1_"}], "]"}]}], ":=", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", "p", "]"}], ",", 
                  RowBox[{"LI", "[", "0", "]"}], ",", 
                  RowBox[{"LI", "[", "0", "]"}], ",", "indices1", ",", 
                  RowBox[{"-", "Dum2"}], ",", "indices2"}], "]"}], "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                   "1"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{
                RowBox[{
                "When", " ", "there", " ", "are", " ", "Lie", " ", 
                 "derivatives"}], ",", " ", 
                RowBox[{
                "N", " ", "contracted", " ", "automatically", " ", "only", 
                 " ", "when", " ", "the", " ", "free", " ", "index", " ", 
                 "is", " ", 
                 RowBox[{"down", ".", "Otherwise"}], " ", "it", " ", 
                 "requires", " ", "ContractMetric", " ", "to", " ", "perform",
                  " ", "contraction"}]}], "*)"}], "\[IndentingNewLine]", 
              RowBox[{"(*", " ", 
               RowBox[{
               "Is", " ", "it", " ", "correct", " ", "in", " ", "general", 
                " ", "or", " ", "just", " ", "because", " ", "we", " ", 
                "know", " ", "that", " ", "the", " ", "background", " ", "is",
                 " ", 
                RowBox[{"FL", "?"}]}], "*)"}], "\[IndentingNewLine]", 
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", 
                   RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", "Dum1_", ",", 
                  "indices2___"}], "]"}], " ", 
                RowBox[{"N", "[", 
                 RowBox[{
                  RowBox[{"-", "Dum1_"}], ",", 
                  RowBox[{"-", "Dum2_"}]}], "]"}]}], ":=", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", "p", "]"}], ",", 
                  RowBox[{"LI", "[", "q", "]"}], ",", 
                  RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                  RowBox[{"-", "Dum2"}], ",", "indices2"}], "]"}], "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                   "1"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", 
                   RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", "Dum1_", ",", 
                  "indices2___"}], "]"}], " ", 
                RowBox[{"N", "[", 
                 RowBox[{
                  RowBox[{"-", "Dum2_"}], ",", 
                  RowBox[{"-", "Dum1_"}]}], "]"}]}], ":=", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", "p", "]"}], ",", 
                  RowBox[{"LI", "[", "q", "]"}], ",", 
                  RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                  RowBox[{"-", "Dum2"}], ",", "indices2"}], "]"}], "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                   "1"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", 
                   RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", 
                  RowBox[{"-", "Dum1_"}], ",", "indices2___"}], "]"}], " ", 
                RowBox[{"N", "[", 
                 RowBox[{"Dum1_", ",", 
                  RowBox[{"-", "Dum2_"}]}], "]"}]}], ":=", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", "p", "]"}], ",", 
                  RowBox[{"LI", "[", "q", "]"}], ",", 
                  RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                  RowBox[{"-", "Dum2"}], ",", "indices2"}], "]"}], "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                   "1"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", 
                   RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", 
                  RowBox[{"-", "Dum1_"}], ",", "indices2___"}], "]"}], " ", 
                RowBox[{"N", "[", 
                 RowBox[{
                  RowBox[{"-", "Dum2_"}], ",", "Dum1_"}], "]"}]}], ":=", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", "p", "]"}], ",", 
                  RowBox[{"LI", "[", "q", "]"}], ",", 
                  RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                  RowBox[{"-", "Dum2"}], ",", "indices2"}], "]"}], "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                   "1"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{
                RowBox[{
                "When", " ", "there", " ", "are", " ", "Lie", " ", 
                 "derivatives"}], ",", 
                RowBox[{
                "h", " ", "contracted", " ", "automatically", " ", "only", 
                 " ", "when", " ", "the", " ", "free", " ", "index", " ", 
                 "is", " ", 
                 RowBox[{"down", ".", "Otherwise"}], " ", "it", " ", 
                 "requires", " ", "ContractMetric", " ", "to", " ", "perform",
                  " ", "contraction"}]}], "*)"}], 
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", 
                   RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", "Dum1_", ",", 
                  "indices2___"}], "]"}], " ", 
                RowBox[{"h", "[", 
                 RowBox[{
                  RowBox[{"-", "Dum1_"}], ",", 
                  RowBox[{"-", "Dum2_"}]}], "]"}]}], ":=", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", "p", "]"}], ",", 
                  RowBox[{"LI", "[", "q", "]"}], ",", 
                  RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                  RowBox[{"-", "Dum2"}], ",", "indices2"}], "]"}], "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                   "1"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", 
                   RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", "Dum1_", ",", 
                  "indices2___"}], "]"}], " ", 
                RowBox[{"h", "[", 
                 RowBox[{
                  RowBox[{"-", "Dum2_"}], ",", 
                  RowBox[{"-", "Dum1_"}]}], "]"}]}], ":=", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", "p", "]"}], ",", 
                  RowBox[{"LI", "[", "q", "]"}], ",", 
                  RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                  RowBox[{"-", "Dum2"}], ",", "indices2"}], "]"}], "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                   "1"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", 
                   RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", 
                  RowBox[{"-", "Dum1_"}], ",", "indices2___"}], "]"}], " ", 
                RowBox[{"h", "[", 
                 RowBox[{"Dum1_", ",", 
                  RowBox[{"-", "Dum2_"}]}], "]"}]}], ":=", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", "p", "]"}], ",", 
                  RowBox[{"LI", "[", "q", "]"}], ",", 
                  RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                  RowBox[{"-", "Dum2"}], ",", "indices2"}], "]"}], "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                   "1"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", 
                   RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", 
                  RowBox[{"-", "Dum1_"}], ",", "indices2___"}], "]"}], " ", 
                RowBox[{"h", "[", 
                 RowBox[{
                  RowBox[{"-", "Dum2_"}], ",", "Dum1_"}], "]"}]}], ":=", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", "p", "]"}], ",", 
                  RowBox[{"LI", "[", "q", "]"}], ",", 
                  RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                  RowBox[{"-", "Dum2"}], ",", "indices2"}], "]"}], "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                   "1"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{
               "g", " ", "converted", " ", "to", " ", "h", " ", "when", " ", 
                "contracted", " ", "with", " ", "a", " ", "projected", " ", 
                RowBox[{"tensor", ".", "It"}], " ", "is", " ", "made", " ", 
                "automatic"}], "*)"}], "\[IndentingNewLine]", 
              RowBox[{"(*", " ", 
               RowBox[{"CP", ":", " ", "TODO", ":", " ", 
                RowBox[{
                "And", " ", "why", " ", "not", " ", "to", " ", "the", " ", 
                 "screen", " ", "space", " ", "metric", " ", "directly", 
                 RowBox[{"??", "?"}]}]}], "*)"}], "\[IndentingNewLine]", 
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", 
                   RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", "Dum1_", ",", 
                  "indices2___"}], "]"}], " ", 
                RowBox[{"g", "[", 
                 RowBox[{
                  RowBox[{"-", "Dum1_"}], ",", "Dum2_"}], "]"}]}], ":=", 
               RowBox[{
                RowBox[{
                 RowBox[{"Name", "[", 
                  RowBox[{
                   RowBox[{"LI", "[", "p", "]"}], ",", 
                   RowBox[{"LI", "[", "q", "]"}], ",", 
                   RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                   "Dum1", ",", "indices2"}], "]"}], " ", 
                 RowBox[{"h", "[", 
                  RowBox[{
                   RowBox[{"-", "Dum1"}], ",", "Dum2"}], "]"}]}], "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                   "1"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", 
                   RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", "Dum1_", ",", 
                  "indices2___"}], "]"}], " ", 
                RowBox[{"g", "[", 
                 RowBox[{"Dum2_", ",", 
                  RowBox[{"-", "Dum1_"}]}], "]"}]}], ":=", 
               RowBox[{
                RowBox[{
                 RowBox[{"Name", "[", 
                  RowBox[{
                   RowBox[{"LI", "[", "p", "]"}], ",", 
                   RowBox[{"LI", "[", "q", "]"}], ",", 
                   RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                   "Dum1", ",", "indices2"}], "]"}], " ", 
                 RowBox[{"h", "[", 
                  RowBox[{"Dum2", ",", 
                   RowBox[{"-", "Dum1"}]}], "]"}]}], "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                   "1"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", 
                   RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", 
                  RowBox[{"-", "Dum1_"}], ",", "indices2___"}], "]"}], " ", 
                RowBox[{"g", "[", 
                 RowBox[{"Dum1_", ",", "Dum2_"}], "]"}]}], ":=", 
               RowBox[{
                RowBox[{
                 RowBox[{"Name", "[", 
                  RowBox[{
                   RowBox[{"LI", "[", "p", "]"}], ",", 
                   RowBox[{"LI", "[", "q", "]"}], ",", 
                   RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                   RowBox[{"-", "Dum1"}], ",", "indices2"}], "]"}], " ", 
                 RowBox[{"h", "[", 
                  RowBox[{"Dum1", ",", "Dum2"}], "]"}]}], "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                   "1"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"Name", "/:", 
               RowBox[{
                RowBox[{"Name", "[", 
                 RowBox[{
                  RowBox[{"LI", "[", 
                   RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                  RowBox[{"LI", "[", 
                   RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", 
                  RowBox[{"-", "Dum1_"}], ",", "indices2___"}], "]"}], " ", 
                RowBox[{"g", "[", 
                 RowBox[{"Dum2_", ",", "Dum1_"}], "]"}]}], ":=", 
               RowBox[{
                RowBox[{
                 RowBox[{"Name", "[", 
                  RowBox[{
                   RowBox[{"LI", "[", "p", "]"}], ",", 
                   RowBox[{"LI", "[", "q", "]"}], ",", 
                   RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                   RowBox[{"-", "Dum1"}], ",", "indices2"}], "]"}], " ", 
                 RowBox[{"h", "[", 
                  RowBox[{"Dum2", ",", "Dum1"}], "]"}]}], "/;", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                   "1"}], "===", 
                  RowBox[{"Length", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{
                RowBox[{
                "If", " ", "the", " ", "tensor", " ", "belongs", " ", 
                 RowBox[{"(", 
                  RowBox[{"at", " ", "least"}], ")"}], " ", "to", " ", "the", 
                 " ", "perturbed", " ", "manifold"}], ",", 
                RowBox[{
                "and", " ", "if", " ", "it", " ", "is", " ", "tranverse"}], 
                ","}], "*)"}], 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{"PerturbedBool", "&&", "TransverseBool"}], ",", 
                RowBox[{"(*", 
                 RowBox[{"(", 
                  RowBox[{"transverse", " ", "property"}], ")"}], "*)"}], 
                RowBox[{
                 RowBox[{"Name", "/:", 
                  RowBox[{
                   RowBox[{"cd2", "[", "Dum_", "]"}], "[", 
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", 
                    RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", "indices1___", ",", 
                    RowBox[{"-", "Dum_"}], ",", "indices2___"}], "]"}], "]"}],
                   ":=", 
                  RowBox[{"0", "/;", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                    "1"}], "===", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
                 "\[IndentingNewLine]", "\[IndentingNewLine]", 
                 RowBox[{"Name", "/:", 
                  RowBox[{
                   RowBox[{"cd2", "[", 
                    RowBox[{"-", "Dum_"}], "]"}], "[", 
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", 
                    RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}], ",", "indices1___", ",", 
                    "Dum_", ",", "indices2___"}], "]"}], "]"}], ":=", 
                  RowBox[{"0", "/;", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                    "1"}], "===", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
                 "\[IndentingNewLine]", "\[IndentingNewLine]", 
                 "\[IndentingNewLine]", 
                 RowBox[{"(*", 
                  RowBox[{
                   RowBox[{"then", " ", "the", " ", "first", " ", 
                    RowBox[{"rule", ":", 
                    RowBox[{
                    RowBox[{"D", "^", 
                    RowBox[{"aSubscript", "[", 
                    RowBox[{"\[ScriptCapitalL]", ",", "n"}], "]"}]}], " ", 
                    RowBox[{"Subscript", "[", 
                    RowBox[{"T", ",", 
                    RowBox[{"a", "..."}]}], "]"}]}]}]}], "=", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"Subscript", "[", 
                    RowBox[{"\[ScriptCapitalL]", ",", "n"}], "]"}], 
                    RowBox[{"(", 
                    RowBox[{"D", "^", 
                    RowBox[{"aSubscript", "[", 
                    RowBox[{"T", ",", 
                    RowBox[{"a", "..."}]}], "]"}]}], ")"}]}], "-", 
                    RowBox[{
                    RowBox[{"Subscript", "[", 
                    RowBox[{"\[ScriptCapitalL]", ",", "n"}], "]"}], 
                    RowBox[{"(", 
                    RowBox[{"g", "^", "ab"}], ")"}], 
                    RowBox[{"Subscript", "[", 
                    RowBox[{"D", ",", "b"}], "]"}], 
                    RowBox[{"Subscript", "[", 
                    RowBox[{
                    RowBox[{"Subscript", "[", 
                    RowBox[{"T", ",", "a"}], "]"}], ",", "..."}], "]"}]}], 
                    "+", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{"g", "^", "ab"}], ")"}], "[", 
                    RowBox[{
                    RowBox[{"Subscript", "[", 
                    RowBox[{"D", ",", "b"}], "]"}], ",", 
                    RowBox[{"Subscript", "[", 
                    RowBox[{"\[ScriptCapitalL]", ",", "n"}], "]"}]}], "]"}], 
                    RowBox[{"Subscript", "[", 
                    RowBox[{"T", ",", 
                    RowBox[{"a", "..."}]}], "]"}]}]}]}], "*)"}], 
                 "\[IndentingNewLine]", "\[IndentingNewLine]", 
                 RowBox[{"Name", "/:", 
                  RowBox[{
                   RowBox[{"cd2", "[", "Dum_", "]"}], "[", 
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", 
                    RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"indices1___", "?", "DownIndexQ"}], ",", 
                    RowBox[{"-", "Dum_"}], ",", 
                    RowBox[{"indices2___", "?", "DownIndexQ"}]}], "]"}], 
                   "]"}], ":=", 
                  RowBox[{
                   RowBox[{"Module", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"Dummy1", ",", "Dummy2"}], "}"}], ",", 
                    RowBox[{
                    RowBox[{"Dummy1", "=", 
                    RowBox[{"DummyIn", "[", 
                    RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ";", 
                    RowBox[{"Dummy2", "=", 
                    RowBox[{"DummyIn", "[", 
                    RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ";", 
                    "\[IndentingNewLine]", "\[IndentingNewLine]", 
                    RowBox[{"ToCan", "@", 
                    RowBox[{"ContractMetric", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{"$ConformalTime", ",", "1", ",", 
                    RowBox[{"1", "/", 
                    RowBox[{
                    RowBox[{"a", "[", "h", "]"}], "[", "]"}]}]}], "]"}], "*", 
                    
                    RowBox[{
                    RowBox[{"LieD", "[", 
                    RowBox[{"u", "[", "Dummy1", "]"}], "]"}], "[", 
                    RowBox[{
                    RowBox[{"cd2", "[", "Dum", "]"}], "[", 
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"q", "-", "1"}], "]"}], ",", 
                    RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                    RowBox[{"-", "Dum"}], ",", "indices2"}], "]"}], "]"}], 
                    "]"}]}], "-", 
                    RowBox[{"ToCan", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{"$ConformalTime", ",", "1", ",", 
                    RowBox[{"1", "/", 
                    RowBox[{
                    RowBox[{"a", "[", "h", "]"}], "[", "]"}]}]}], "]"}], "*", 
                    
                    RowBox[{
                    RowBox[{"LieD", "[", 
                    RowBox[{"u", "[", "Dummy1", "]"}], "]"}], "[", 
                    RowBox[{"g", "[", 
                    RowBox[{"Dum", ",", "Dummy2"}], "]"}], "]"}], " ", 
                    RowBox[{
                    RowBox[{"cd2", "[", 
                    RowBox[{"-", "Dummy2"}], "]"}], "[", 
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"q", "-", "1"}], "]"}], ",", 
                    RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                    RowBox[{"-", "Dum"}], ",", "indices2"}], "]"}], "]"}]}], "//", 
                    RowBox[{
                    RowBox[{"MetricToProjector", "[", 
                    RowBox[{"#", ",", "h"}], "]"}], "&"}]}], "]"}], "+", 
                    RowBox[{
                    RowBox[{"g", "[", 
                    RowBox[{"Dum", ",", "Dummy2"}], "]"}], " ", 
                    RowBox[{"ToCan", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"cd2", "[", 
                    RowBox[{"-", "Dummy2"}], "]"}], "[", 
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", "q", "]"}], ",", 
                    RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                    RowBox[{"-", "Dum"}], ",", "indices2"}], "]"}], "]"}], 
                    "-", 
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{"$ConformalTime", ",", "1", ",", 
                    RowBox[{"1", "/", 
                    RowBox[{
                    RowBox[{"a", "[", "h", "]"}], "[", "]"}]}]}], "]"}], "*", 
                    
                    RowBox[{
                    RowBox[{"LieD", "[", 
                    RowBox[{"u", "[", "Dummy1", "]"}], "]"}], "[", 
                    RowBox[{
                    RowBox[{"cd2", "[", 
                    RowBox[{"-", "Dummy2"}], "]"}], "[", 
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"q", "-", "1"}], "]"}], ",", 
                    RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                    RowBox[{"-", "Dum"}], ",", "indices2"}], "]"}], "]"}], 
                    "]"}]}]}], "]"}]}]}], "]"}]}]}]}], "]"}], "/;", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                    "1"}], "===", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
                 "\[IndentingNewLine]", "\[IndentingNewLine]", 
                 "\[IndentingNewLine]", 
                 RowBox[{"(*", 
                  RowBox[{
                   RowBox[{"and", " ", "the", " ", "second", " ", 
                    RowBox[{"rule", ":", 
                    RowBox[{
                    RowBox[{"Subscript", "[", 
                    RowBox[{"D", ",", "a"}], "]"}], " ", 
                    RowBox[{"Subscript", "[", 
                    RowBox[{"\[ScriptCapitalL]", ",", "n"}], "]"}], 
                    RowBox[{"Subscript", "[", 
                    RowBox[{
                    RowBox[{"T", "^", "a"}], ",", "..."}], "]"}]}]}]}], "=", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"Subscript", "[", 
                    RowBox[{"\[ScriptCapitalL]", ",", "n"}], "]"}], 
                    RowBox[{"(", 
                    RowBox[{"D", "^", 
                    RowBox[{"aSubscript", "[", 
                    RowBox[{"T", ",", 
                    RowBox[{"a", "..."}]}], "]"}]}], ")"}]}], "-", 
                    RowBox[{
                    RowBox[{"Subscript", "[", 
                    RowBox[{"\[ScriptCapitalL]", ",", "n"}], "]"}], 
                    RowBox[{"(", 
                    RowBox[{"g", "^", "ab"}], ")"}], 
                    RowBox[{"Subscript", "[", 
                    RowBox[{"D", ",", "b"}], "]"}], 
                    RowBox[{"Subscript", "[", 
                    RowBox[{
                    RowBox[{"Subscript", "[", 
                    RowBox[{"T", ",", "a"}], "]"}], ",", "..."}], "]"}]}], 
                    "+", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{"g", "^", "ab"}], ")"}], "[", 
                    RowBox[{
                    RowBox[{"Subscript", "[", 
                    RowBox[{"D", ",", "b"}], "]"}], ",", 
                    RowBox[{"Subscript", "[", 
                    RowBox[{"\[ScriptCapitalL]", ",", "n"}], "]"}]}], "]"}], 
                    RowBox[{"Subscript", "[", 
                    RowBox[{"T", ",", 
                    RowBox[{"a", "..."}]}], "]"}]}]}]}], "*)"}], 
                 RowBox[{"Name", "/:", 
                  RowBox[{
                   RowBox[{"cd2", "[", 
                    RowBox[{"-", "Dum_"}], "]"}], "[", 
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", 
                    RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"indices1___", "?", "DownIndexQ"}], ",", "Dum_", 
                    ",", 
                    RowBox[{"indices2___", "?", "DownIndexQ"}]}], "]"}], 
                   "]"}], ":=", 
                  RowBox[{
                   RowBox[{"Module", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"Dummy1", ",", "Dummy2"}], "}"}], ",", 
                    RowBox[{
                    RowBox[{"Dummy1", "=", 
                    RowBox[{"DummyIn", "[", 
                    RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"Dummy2", "=", 
                    RowBox[{"DummyIn", "[", 
                    RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"ToCan", "@", 
                    RowBox[{"ContractMetric", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{"$ConformalTime", ",", "1", ",", 
                    RowBox[{"1", "/", 
                    RowBox[{
                    RowBox[{"a", "[", "h", "]"}], "[", "]"}]}]}], "]"}], "*", 
                    
                    RowBox[{
                    RowBox[{"LieD", "[", 
                    RowBox[{"u", "[", "Dummy1", "]"}], "]"}], "[", 
                    RowBox[{
                    RowBox[{"cd2", "[", "Dum", "]"}], "[", 
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"q", "-", "1"}], "]"}], ",", 
                    RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                    RowBox[{"-", "Dum"}], ",", "indices2"}], "]"}], "]"}], 
                    "]"}]}], "-", 
                    RowBox[{"ToCan", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{"$ConformalTime", ",", "1", ",", 
                    RowBox[{"1", "/", 
                    RowBox[{
                    RowBox[{"a", "[", "h", "]"}], "[", "]"}]}]}], "]"}], "*", 
                    
                    RowBox[{
                    RowBox[{"LieD", "[", 
                    RowBox[{"u", "[", "Dummy1", "]"}], "]"}], "[", 
                    RowBox[{"g", "[", 
                    RowBox[{"Dum", ",", "Dummy2"}], "]"}], "]"}], " ", 
                    RowBox[{
                    RowBox[{"cd2", "[", 
                    RowBox[{"-", "Dummy2"}], "]"}], "[", 
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"q", "-", "1"}], "]"}], ",", 
                    RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                    RowBox[{"-", "Dum"}], ",", "indices2"}], "]"}], "]"}]}], "//", 
                    RowBox[{
                    RowBox[{"MetricToProjector", "[", 
                    RowBox[{"#", ",", "h"}], "]"}], "&"}]}], "]"}], "+", 
                    RowBox[{
                    RowBox[{"g", "[", 
                    RowBox[{"Dum", ",", "Dummy2"}], "]"}], " ", 
                    RowBox[{"ToCan", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"cd2", "[", 
                    RowBox[{"-", "Dummy2"}], "]"}], "[", 
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", "q", "]"}], ",", 
                    RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                    RowBox[{"-", "Dum"}], ",", "indices2"}], "]"}], "]"}], 
                    "-", 
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{"$ConformalTime", ",", "1", ",", 
                    RowBox[{"1", "/", 
                    RowBox[{
                    RowBox[{"a", "[", "h", "]"}], "[", "]"}]}]}], "]"}], "*", 
                    
                    RowBox[{
                    RowBox[{"LieD", "[", 
                    RowBox[{"u", "[", "Dummy1", "]"}], "]"}], "[", 
                    RowBox[{
                    RowBox[{"cd2", "[", 
                    RowBox[{"-", "Dummy2"}], "]"}], "[", 
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"q", "-", "1"}], "]"}], ",", 
                    RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                    RowBox[{"-", "Dum"}], ",", "indices2"}], "]"}], "]"}], 
                    "]"}]}]}], "]"}]}]}], "]"}]}]}]}], "]"}], "/;", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", 
                    "1"}], "===", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
                 "\[IndentingNewLine]", "\[IndentingNewLine]", 
                 "\[IndentingNewLine]", 
                 RowBox[{"(*", 
                  RowBox[{
                   RowBox[{
                   "If", " ", "the", " ", "indices", " ", "are", " ", "not", 
                    " ", "down"}], ",", 
                   RowBox[{
                    RowBox[{"we", " ", "separate", " ", 
                    RowBox[{"them", ".", "In"}], " ", "practice", " ", "this",
                     " ", "happens", " ", "almost", " ", "never"}], "..."}]}],
                   "*)"}], 
                 RowBox[{"(*", 
                  RowBox[{
                   RowBox[{
                   "This", " ", "is", " ", "for", " ", "the", " ", "case", 
                    " ", "where", " ", "we", " ", "have", " ", "at", " ", 
                    "least", " ", "one", " ", "derivative"}], ",", 
                   RowBox[{
                   "for", " ", "which", " ", "the", " ", "meaning", " ", "is",
                     " ", "only", " ", "when", " ", "the", " ", "index", " ", 
                    "is", " ", 
                    RowBox[{"down", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
                 "\[IndentingNewLine]", 
                 RowBox[{"Name", "/:", 
                  RowBox[{
                   RowBox[{"cd2", "[", "Dum_", "]"}], "[", 
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", 
                    RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", 
                    RowBox[{"indup_", "?", "UpIndexQ"}], ",", "indices3___", 
                    ",", 
                    RowBox[{"-", "Dum_"}], ",", "indices2___"}], "]"}], "]"}],
                   ":=", 
                  RowBox[{
                   RowBox[{"Module", "[", 
                    RowBox[{
                    RowBox[{"{", "Dummy", "}"}], ",", 
                    RowBox[{
                    RowBox[{"Dummy", "=", 
                    RowBox[{"DummyIn", "[", 
                    RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"g", "[", 
                    RowBox[{"indup", ",", "Dummy"}], "]"}], " ", 
                    RowBox[{
                    RowBox[{"cd2", "[", "Dum", "]"}], "[", 
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", "q", "]"}], ",", 
                    RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                    RowBox[{"-", "Dummy"}], ",", "indices3", ",", 
                    RowBox[{"-", "Dum"}], ",", "indices2"}], "]"}], 
                    "]"}]}]}]}], "]"}], "/;", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}], ",", 
                    RowBox[{"{", "indices3", "}"}]}], "]"}], "]"}], "+", 
                    "2"}], "===", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
                 "\[IndentingNewLine]", 
                 RowBox[{"Name", "/:", 
                  RowBox[{
                   RowBox[{"cd2", "[", "Dum_", "]"}], "[", 
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", 
                    RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", 
                    RowBox[{"-", "Dum_"}], ",", "indices3___", ",", 
                    RowBox[{"indup_", "?", "UpIndexQ"}], ",", "indices2___"}],
                     "]"}], "]"}], ":=", 
                  RowBox[{
                   RowBox[{"Module", "[", 
                    RowBox[{
                    RowBox[{"{", "Dummy", "}"}], ",", 
                    RowBox[{
                    RowBox[{"Dummy", "=", 
                    RowBox[{"DummyIn", "[", 
                    RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"g", "[", 
                    RowBox[{"indup", ",", "Dummy"}], "]"}], " ", 
                    RowBox[{
                    RowBox[{"cd2", "[", "Dum", "]"}], "[", 
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", "q", "]"}], ",", 
                    RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                    RowBox[{"-", "Dum"}], ",", "indices3", ",", 
                    RowBox[{"-", "Dummy"}], ",", "indices2"}], "]"}], 
                    "]"}]}]}]}], "]"}], "/;", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}], ",", 
                    RowBox[{"{", "indices3", "}"}]}], "]"}], "]"}], "+", 
                    "2"}], "===", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
                 "\[IndentingNewLine]", 
                 RowBox[{"Name", "/:", 
                  RowBox[{
                   RowBox[{"cd2", "[", 
                    RowBox[{"-", "Dum_"}], "]"}], "[", 
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", 
                    RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", 
                    RowBox[{"indup_", "?", "UpIndexQ"}], ",", "indices3___", 
                    ",", "Dum_", ",", "indices2___"}], "]"}], "]"}], ":=", 
                  RowBox[{
                   RowBox[{"Module", "[", 
                    RowBox[{
                    RowBox[{"{", "Dummy", "}"}], ",", 
                    RowBox[{
                    RowBox[{"Dummy", "=", 
                    RowBox[{"DummyIn", "[", 
                    RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"g", "[", 
                    RowBox[{"indup", ",", "Dummy"}], "]"}], " ", 
                    RowBox[{
                    RowBox[{"cd2", "[", 
                    RowBox[{"-", "Dum"}], "]"}], "[", 
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", "q", "]"}], ",", 
                    RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                    RowBox[{"-", "Dummy"}], ",", "indices3", ",", "Dum", ",", 
                    "indices2"}], "]"}], "]"}]}]}]}], "]"}], "/;", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}], ",", 
                    RowBox[{"{", "indices3", "}"}]}], "]"}], "]"}], "+", 
                    "2"}], "===", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";", 
                 "\[IndentingNewLine]", 
                 RowBox[{"Name", "/:", 
                  RowBox[{
                   RowBox[{"cd2", "[", 
                    RowBox[{"-", "Dum_"}], "]"}], "[", 
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", 
                    RowBox[{"p_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"r_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "1"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices1___", ",", "Dum_", ",", 
                    "indices3___", ",", 
                    RowBox[{"indup_", "?", "UpIndexQ"}], ",", "indices2___"}],
                     "]"}], "]"}], ":=", 
                  RowBox[{
                   RowBox[{"Module", "[", 
                    RowBox[{
                    RowBox[{"{", "Dummy", "}"}], ",", 
                    RowBox[{
                    RowBox[{"Dummy", "=", 
                    RowBox[{"DummyIn", "[", 
                    RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"g", "[", 
                    RowBox[{"indup", ",", "Dummy"}], "]"}], " ", 
                    RowBox[{
                    RowBox[{"cd2", "[", 
                    RowBox[{"-", "Dum"}], "]"}], "[", 
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", "q", "]"}], ",", 
                    RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                    "Dum", ",", "indices3", ",", 
                    RowBox[{"-", "Dummy"}], ",", "indices2"}], "]"}], 
                    "]"}]}]}]}], "]"}], "/;", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"Join", "[", 
                    RowBox[{
                    RowBox[{"{", "indices1", "}"}], ",", 
                    RowBox[{"{", "indices2", "}"}], ",", 
                    RowBox[{"{", "indices3", "}"}]}], "]"}], "]"}], "+", 
                    "2"}], "===", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";"}]}], 
               "]"}], ";"}]}], "]"}], ";", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{
              RowBox[{
              "The", " ", "following", " ", "rule", " ", "serves", " ", "to", 
               " ", "express", " ", "the", " ", "three"}], "-", 
              RowBox[{"covariant", " ", "derivative", " ", "of", " ", 
               RowBox[{"(", "homogeneous", ")"}], " ", "background", " ", 
               "quantities", " ", "in", " ", "terms", " ", "of", " ", "the", 
               " ", "connection", " ", 
               RowBox[{"components", ".", "For"}], " ", "instance"}]}], ",", 
             RowBox[{"'", 
              RowBox[{"Subscript", "[", 
               RowBox[{"D", ",", "i"}], "]"}], " ", 
              RowBox[{
               RowBox[{"Subscript", "[", 
                RowBox[{"\[Omega]", ",", "j"}], "]"}], "'"}], " ", "is", " ", 
              "replaced", " ", 
              RowBox[{"by", ":", 
               RowBox[{"'", "-", 
                RowBox[{
                 RowBox[{"Subscript", "[", 
                  RowBox[{
                   RowBox[{"\[CapitalGamma]", "^", "a"}], ",", "ij"}], "]"}], 
                 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Subscript", "[", 
                    RowBox[{"\[Omega]", ",", "a"}], "]"}], "'"}], 
                  "."}]}]}]}]}]}], "*)"}], 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{"BackgroundBool", ",", 
               RowBox[{
                RowBox[{"Name", "/:", 
                 RowBox[{
                  RowBox[{"cd2", "[", "Dummy2_", "]"}], "[", 
                  RowBox[{"Name", "[", 
                   RowBox[{
                    RowBox[{"LI", "[", "0", "]"}], ",", 
                    RowBox[{"LI", "[", 
                    RowBox[{"q_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                    ")"}]}], "]"}], ",", "indices___"}], "]"}], "]"}], ":=", 
                 RowBox[{
                  RowBox[{"Module", "[", 
                   RowBox[{
                    RowBox[{"{", "Dummy1", "}"}], ",", 
                    RowBox[{
                    RowBox[{"Dummy1", "=", 
                    RowBox[{"DummyIn", "[", 
                    RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"ToCan", "[", 
                    RowBox[{"Plus", "@@", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", 
                    RowBox[{
                    RowBox[{"Connection", "[", "h", "]"}], "[", 
                    RowBox[{"Dummy1", ",", "Dummy2", ",", "#"}], "]"}]}], 
                    RowBox[{"ReplaceIndex", "[", 
                    RowBox[{
                    RowBox[{"Evaluate", "[", 
                    RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "0", "]"}], ",", 
                    RowBox[{"LI", "[", "q", "]"}], ",", "indices"}], "]"}], 
                    "]"}], ",", 
                    RowBox[{"#", "\[Rule]", 
                    RowBox[{"-", "Dummy1"}]}]}], "]"}]}], ")"}], "&"}], "/@", 
                    
                    RowBox[{"{", "indices", "}"}]}], ")"}]}], "]"}]}]}], 
                   "]"}], "/;", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "indices", "}"}], "]"}], "===", 
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";"}]}], 
              "]"}], ";"}], "*)"}], 
           RowBox[{"(*", 
            RowBox[{
            "Confer", " ", "the", " ", "function", " ", "SetSlicing", " ", 
             "for", " ", "the", " ", "definition", " ", 
             RowBox[{"of", "'"}], 
             RowBox[{"Connection", "'"}], " ", "and", " ", "its", " ", 
             RowBox[{"properties", "."}]}], "*)"}], 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{
             "Is", " ", "the", " ", "above", " ", "relation", " ", "correct", 
              " ", "for", " ", "space"}], "-", 
             RowBox[{"time", " ", 
              RowBox[{"indices", "?", "To"}], " ", 
              RowBox[{"check", "!"}]}]}], "*)"}], 
           RowBox[{"(*", 
            RowBox[{"What", " ", "is", " ", "the", " ", "need", " ", 
             RowBox[{"for", "'"}], 
             RowBox[{
              RowBox[{"Evaluate", "'"}], "?", "I"}], " ", 
             RowBox[{"forgot", "."}]}], "*)"}], "\[IndentingNewLine]", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{"In", " ", "principle"}], ",", 
             RowBox[{
             "the", " ", "following", " ", "rule", " ", "needs", " ", "not", 
              " ", "to", " ", "be", " ", 
              RowBox[{"used", "."}]}]}], "*)"}], 
           RowBox[{"(*", 
            RowBox[{"However", ",", 
             RowBox[{"it", " ", "makes", " ", "sure", " ", "that"}], ",", 
             RowBox[{
             "if", " ", "something", " ", "went", " ", "wrong", " ", "in", 
              " ", "our", " ", "algorithm"}], ",", 
             RowBox[{
             "and", " ", "the", " ", "Lie", " ", "derivatives", " ", "acts", 
              " ", "on", " ", "a", " ", "tensor", " ", "with", " ", "up", " ",
               "indices"}], ",", 
             RowBox[{
             "then", " ", "this", " ", "converted", " ", "to", " ", "down", 
              " ", 
              RowBox[{"indices", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
            "This", " ", "ensures", " ", "that", " ", "the", " ", "algorithm",
              " ", "for", " ", "splitting", " ", "the", " ", "covariant", " ",
              "derivatives", " ", "into", " ", "induced", " ", "derivatives", 
             " ", "and", " ", "Lie", " ", "derivative", " ", "always", " ", 
             RowBox[{"works", "."}]}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
            "It", " ", "puts", " ", "down", " ", "indices", " ", "whenever", 
             " ", "it", " ", "is", " ", 
             RowBox[{"up", "."}]}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{"Name", "/:", 
            RowBox[{
             RowBox[{"LieD", "[", 
              RowBox[{"u", "[", "Dummy1_", "]"}], "]"}], "[", 
             RowBox[{"Name", "[", 
              RowBox[{
               RowBox[{"LI", "[", 
                RowBox[{"p_", "?", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                  ")"}]}], "]"}], ",", 
               RowBox[{"LI", "[", 
                RowBox[{"q_", "?", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                  ")"}]}], "]"}], ",", 
               RowBox[{"LI", "[", 
                RowBox[{"r_", "?", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IntegerQ", "[", "#", "]"}], "&&", 
                    RowBox[{"#", "\[GreaterEqual]", "0"}]}], ")"}], "&"}], 
                  ")"}]}], "]"}], ",", 
               RowBox[{"indices1___", "?", "AIndexQ"}], ",", 
               RowBox[{"IndexUp_", "?", "UpIndexQ"}], ",", 
               RowBox[{"indices2___", "?", "AIndexQ"}]}], "]"}], "]"}], ":=", 
            
            RowBox[{
             RowBox[{"Module", "[", 
              RowBox[{
               RowBox[{"{", "Dum", "}"}], ",", 
               RowBox[{
                RowBox[{"Dum", "=", 
                 RowBox[{"DummyIn", "[", 
                  RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{
                  RowBox[{"g", "[", 
                   RowBox[{"IndexUp", ",", "Dum"}], "]"}], " ", 
                  RowBox[{
                   RowBox[{"LieD", "[", 
                    RowBox[{"u", "[", "Dummy1", "]"}], "]"}], "[", 
                   RowBox[{"Name", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", "q", "]"}], ",", 
                    RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                    RowBox[{"-", "Dum"}], ",", "indices2"}], "]"}], "]"}]}], 
                 "+", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"LieD", "[", 
                    RowBox[{"u", "[", "Dummy1", "]"}], "]"}], "[", 
                   RowBox[{"g", "[", 
                    RowBox[{"IndexUp", ",", "Dum"}], "]"}], "]"}], " ", 
                  RowBox[{"Name", "[", 
                   RowBox[{
                    RowBox[{"LI", "[", "p", "]"}], ",", 
                    RowBox[{"LI", "[", "q", "]"}], ",", 
                    RowBox[{"LI", "[", "r", "]"}], ",", "indices1", ",", 
                    RowBox[{"-", "Dum"}], ",", "indices2"}], "]"}]}]}]}]}], 
              "]"}], "/;", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{
                RowBox[{"Length", "[", 
                 RowBox[{"Join", "[", 
                  RowBox[{
                   RowBox[{"{", "indices1", "}"}], ",", 
                   RowBox[{"{", "indices2", "}"}]}], "]"}], "]"}], "+", "1"}],
                "===", 
               RowBox[{"Length", "[", 
                RowBox[{"{", "inds", "}"}], "]"}]}], ")"}]}]}], ";"}]}], 
         "]"}]}], "]"}]}], "]"}]}]}]}]], "Input",
 InitializationCell->True]
}, Open  ]],

Cell[CellGroupData[{

Cell["Defining standard perturbations for matter and metric", "Subsubsection"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DefinedPerturbationParameter", "[", "x_", "]"}], ":=", "False"}], 
  ";"}]], "Input",
 InitializationCell->True],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"**", "BUILDING"}], " ", 
    RowBox[{"SYMBOLS", ":", 
     RowBox[{"Geometrical", " ", "quantities"}]}]}], "***)"}], 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"a", "[", "symb_", "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"a", ",", "symb"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"H", "[", "symb_", "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"H", ",", "symb"}], "]"}]}], ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Connection", "[", "symb_", "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"Connection", ",", "symb"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"CS", "[", "symb_", "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"CS", ",", "symb"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"nt", "[", "symb_", "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"nt", ",", "symb"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"av", "[", "symb_", "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"av", ",", "symb"}], "]"}]}], ";"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"K", "[", "symb_", "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"K", ",", "symb"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"\[ScriptK]", "[", "symb_", "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"\[ScriptK]", ",", "symb"}], "]"}]}], ";"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"**", "BUILDING"}], " ", 
     RowBox[{"SYMBOLS", ":", 
      RowBox[{"Fluid", " ", "quantities"}]}]}], "***)"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"\[Rho]", "[", "symb_", "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"\[Rho]", ",", "symb"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"P", "[", "symb_", "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"P", ",", "symb"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"\[CapitalPi]", "[", "symb_", "]"}], ":=", 
      RowBox[{"SymbolJoin", "[", 
       RowBox[{"\[CapitalPi]", ",", "symb"}], "]"}]}], ";"}], "*)"}], 
   "\[IndentingNewLine]", "\n", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"**", "BUILDING"}], " ", 
     RowBox[{"SYMBOLS", ":", 
      RowBox[{
       RowBox[{"Perturbed", " ", "fluid", " ", "four"}], "-", 
       "velocity"}]}]}], "***)"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"V0", "[", 
      RowBox[{
       RowBox[{"N_", "?", "InducedMetricQ"}], ",", "velocity_"}], "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"V0", ",", "N", ",", "velocity"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"Vspat", "[", 
      RowBox[{
       RowBox[{"N_", "?", "InducedMetricQ"}], ",", "velocity_"}], "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"Vspat", ",", "N", ",", "velocity"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"Vs", "[", 
      RowBox[{
       RowBox[{"N_", "?", "InducedMetricQ"}], ",", "velocity_"}], "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"Vs", ",", "N", ",", "velocity"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"Vv", "[", 
      RowBox[{
       RowBox[{"N_", "?", "InducedMetricQ"}], ",", "velocity_"}], "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"Vv", ",", "N", ",", "velocity"}], "]"}]}], ";"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"**", "BUILDING"}], " ", 
     RowBox[{"SYMBOLS", ":", 
      RowBox[{"Perturbation", " ", "of", " ", "the", " ", "metric"}]}]}], 
    "***)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"\[Phi]", "[", 
      RowBox[{"N_", "?", "InducedMetricQ"}], "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"\[Phi]", ",", "N"}], "]"}]}], ";"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Bs", "[", 
      RowBox[{"N_", "?", "InducedMetricQ"}], "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"Bs", ",", "N"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"Bvp", "[", 
      RowBox[{"N_", "?", "InducedMetricQ"}], "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"Bv", ",", "N"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"Bvt", "[", 
      RowBox[{"N_", "?", "InducedMetricQ"}], "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"Bv", ",", "N"}], "]"}]}], ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"\[Psi]", "[", 
      RowBox[{"N_", "?", "InducedMetricQ"}], "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"\[Psi]", ",", "N"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"Es", "[", 
      RowBox[{"N_", "?", "InducedMetricQ"}], "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"Es", ",", "N"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"Ev", "[", 
      RowBox[{"N_", "?", "InducedMetricQ"}], "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"Ev", ",", "N"}], "]"}]}], ";"}], "\n", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{
        RowBox[{"Evp", "[", 
         RowBox[{"N_", "?", "InducedMetricQ"}], "]"}], ":=", 
        RowBox[{"SymbolJoin", "[", 
         RowBox[{"Evp", ",", "N"}], "]"}]}], ";"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{
        RowBox[{"Evt", "[", 
         RowBox[{"N_", "?", "InducedMetricQ"}], "]"}], ":=", 
        RowBox[{"SymbolJoin", "[", 
         RowBox[{"Evt", ",", "N"}], "]"}]}], ";"}], "}"}]}], "}"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"Etp", "[", 
      RowBox[{"N_", "?", "InducedMetricQ"}], "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"Etp", ",", "N"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"Etpt", "[", 
      RowBox[{"N_", "?", "InducedMetricQ"}], "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"Ett", ",", "N"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"Ett", "[", 
      RowBox[{"N_", "?", "InducedMetricQ"}], "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"Ett", ",", "N"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", "\n", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"**", "BUILDING"}], " ", 
     RowBox[{"SYMBOLS", ":", 
      RowBox[{"Gauge", " ", "vector", " ", "and", " ", "decomposition"}]}]}], 
    "***)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"\[Xi]", "[", 
      RowBox[{"N_", "?", "InducedMetricQ"}], "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"\[Xi]", ",", "N"}], "]"}]}], ";"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"T", "[", 
      RowBox[{"N_", "?", "InducedMetricQ"}], "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"T", ",", "N"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"Ls", "[", 
      RowBox[{"N_", "?", "InducedMetricQ"}], "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"Ls", ",", "N"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"Lvp", "[", 
      RowBox[{"N_", "?", "InducedMetricQ"}], "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"Lvp", ",", "N"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"Lvt", "[", 
      RowBox[{"N_", "?", "InducedMetricQ"}], "]"}], ":=", 
     RowBox[{"SymbolJoin", "[", 
      RowBox[{"Lvt", ",", "N"}], "]"}]}], ";"}], "\[IndentingNewLine]", "\n", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"$ListFieldsBackgroundOnly", "[", 
      RowBox[{"N_", "?", "InducedMetricQ"}], "]"}], ":=", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"a", "[", "h", "]"}], "[", "]"}], ",", "\"\<a\>\""}], "}"}],
        ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"H", "[", "h", "]"}], "[", "]"}], ",", 
         "\"\<\[ScriptCapitalH]\>\""}], "}"}]}], "}"}]}], ";"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"$ListFieldsPerturbedOnly", "[", 
      RowBox[{"N_", "?", "InducedMetricQ"}], "]"}], ":=", 
     RowBox[{"With", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"M", "=", 
         RowBox[{"ManifoldOfCovD", "@", 
          RowBox[{"CovDOfMetric", "@", 
           RowBox[{"First", "@", 
            RowBox[{"InducedFrom", "@", "N"}]}]}]}]}], "}"}], ",", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"\[Mu]", ",", "\[Nu]"}], "}"}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\[Mu]", ",", "\[Nu]"}], "}"}], "=", 
           RowBox[{"GetIndicesOfVBundle", "[", 
            RowBox[{
             RowBox[{"Tangent", "@", "M"}], ",", "2"}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"\[Phi]", "[", "N", "]"}], "[", "]"}], ",", 
              "\"\<\[Phi]\>\""}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"Bs", "[", "N", "]"}], "[", "]"}], ",", 
              "\"\<\\!\\(\\*SubscriptBox[\\(B\\), \\(s\\)]\\)\>\""}], "}"}], 
            ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"Bvt", "[", "N", "]"}], "[", 
               RowBox[{"-", "\[Mu]"}], "]"}], ",", 
              "\"\<\\!\\(\\*SubscriptBox[\\(B\\), \
\\(\\(v\\)\\(\[UpTee]\\)\\)]\\)\>\""}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"Bvp", "[", "N", "]"}], "[", "]"}], ",", 
              "\"\<\!\(\*SubscriptBox[\(B\), \(||\)]\)\>\""}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"\[Psi]", "[", "N", "]"}], "[", "]"}], ",", 
              "\"\<\[Psi]\>\""}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"Es", "[", "N", "]"}], "[", "]"}], ",", 
              "\"\<\!\(\*SubscriptBox[\(E\), \(s\)]\)\>\""}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"Evp", "[", "N", "]"}], "[", "]"}], ",", 
              "\"\<\!\(\*SubscriptBox[SubscriptBox[\(E\), \(v\)], \(||\)]\)\>\
\""}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"Evt", "[", "N", "]"}], "[", 
               RowBox[{"-", "\[Mu]"}], "]"}], ",", 
              "\"\<\\!\\(\\*SubscriptBox[\\(E\\), \
\\(\\(v\\)\\(\[UpTee]\\)\\)]\\)\>\""}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"Etp", "[", "N", "]"}], "[", "]"}], ",", 
              "\"\<\\!\\(\\*SubscriptBox[\\(E\\), \\(\\(t\\)\\(||\\)\\)]\\)\>\
\""}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"Etpt", "[", "N", "]"}], "[", 
               RowBox[{"-", "\[Mu]"}], "]"}], ",", 
              "\"\<\\!\\(\\*SubscriptBox[\\(E\\), \\(t ||  \[UpTee] \\)]\\)\>\
\""}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"Ett", "[", "N", "]"}], "[", 
               RowBox[{
                RowBox[{"-", "\[Mu]"}], ",", 
                RowBox[{"-", "\[Nu]"}]}], "]"}], ",", 
              "\"\<\\!\\(\\*SubscriptBox[\\(E\\), \\(t\\)]\\)\[UpTee]\>\""}], 
             "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"T", "[", "N", "]"}], "[", "]"}], ",", "\"\<T\>\""}], 
             "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"Ls", "[", "N", "]"}], "[", "]"}], ",", "\"\<L\>\""}], 
             "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"Lvp", "[", "N", "]"}], "[", "]"}], ",", 
              "\"\<\\!\\(\\*SubscriptBox[\\(L\\), \\(||\\)]\\)\>\""}], "}"}], 
            ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"Lvt", "[", "N", "]"}], "[", 
               RowBox[{"-", "\[Mu]"}], "]"}], ",", 
              "\"\<\\!\\(\\*SubscriptBox[\\(L\\), \
\\(\\(v\\)\\(\[UpTee]\\)\\)]\\)\>\""}], "}"}]}], "}"}]}]}], "]"}]}], "]"}]}], 
    ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", "\n", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"$ListFieldsBackgroundAndPerturbed", "[", 
      RowBox[{
       RowBox[{"N_", "?", "InducedMetricQ"}], ",", "velocity_"}], "]"}], ":=", 
     RowBox[{"With", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"M", "=", 
         RowBox[{"ManifoldOfCovD", "@", 
          RowBox[{"CovDOfMetric", "@", 
           RowBox[{"First", "@", 
            RowBox[{"InducedFrom", "@", "N"}]}]}]}]}], "}"}], ",", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"\[Mu]", ",", "\[Nu]"}], "}"}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\[Mu]", ",", "\[Nu]"}], "}"}], "=", 
           RowBox[{"GetIndicesOfVBundle", "[", 
            RowBox[{
             RowBox[{"Tangent", "@", "M"}], ",", "2"}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"\[CurlyPhi]", "[", "]"}], ",", "\"\<\[CurlyPhi]\>\""}],
              "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"\[Rho]", "[", "velocity", "]"}], "[", "]"}], ",", 
              RowBox[{"ToString", "@", 
               RowBox[{"StringJoin", "[", 
                RowBox[{
                 RowBox[{"{", "\"\<\[Rho]\>\"", "}"}], ",", 
                 RowBox[{"ToString", "[", "velocity", "]"}]}], "]"}]}]}], 
             "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"P", "[", "velocity", "]"}], "[", "]"}], ",", 
              RowBox[{"ToString", "@", 
               RowBox[{"StringJoin", "[", 
                RowBox[{
                 RowBox[{"{", "\"\<P\>\"", "}"}], ",", 
                 RowBox[{"ToString", "[", "velocity", "]"}]}], "]"}]}]}], 
             "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"Vspat", "[", 
                RowBox[{"N", ",", "velocity"}], "]"}], "[", 
               RowBox[{"-", "\[Mu]"}], "]"}], ",", 
              RowBox[{"ToString", "@", 
               RowBox[{"StringJoin", "[", 
                RowBox[{"{", 
                 RowBox[{"\"\<\[ScriptCapitalV]\>\"", ",", 
                  RowBox[{"ToString", "[", "velocity", "]"}]}], "}"}], 
                "]"}]}]}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"V0", "[", 
                RowBox[{"N", ",", "velocity"}], "]"}], "[", "]"}], ",", 
              RowBox[{"ToString", "@", 
               RowBox[{"StringJoin", "[", 
                RowBox[{"{", 
                 RowBox[{"\"\<V0\>\"", ",", 
                  RowBox[{"ToString", "[", "velocity", "]"}]}], "}"}], 
                "]"}]}]}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"Vs", "[", 
                RowBox[{"N", ",", "velocity"}], "]"}], "[", "]"}], ",", 
              RowBox[{"ToString", "@", 
               RowBox[{"StringJoin", "[", 
                RowBox[{"{", 
                 RowBox[{"\"\<V\>\"", ",", 
                  RowBox[{"ToString", "[", "velocity", "]"}]}], "}"}], 
                "]"}]}]}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"Vvp", "[", 
                RowBox[{"N", ",", "velocity"}], "]"}], "[", 
               RowBox[{"-", "\[Mu]"}], "]"}], ",", 
              RowBox[{"ToString", "@", 
               RowBox[{"StringJoin", "[", 
                RowBox[{"{", 
                 RowBox[{"\"\<V\>\"", ",", 
                  RowBox[{"ToString", "[", "velocity", "]"}]}], "}"}], 
                "]"}]}]}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"Vvt", "[", 
                RowBox[{"N", ",", "velocity"}], "]"}], "[", 
               RowBox[{"-", "\[Mu]"}], "]"}], ",", 
              RowBox[{"ToString", "@", 
               RowBox[{"StringJoin", "[", 
                RowBox[{"{", 
                 RowBox[{"\"\<V\>\"", ",", 
                  RowBox[{"ToString", "[", "velocity", "]"}]}], "}"}], 
                "]"}]}]}], "}"}]}], "}"}]}]}], "]"}]}], "]"}]}], 
    ";"}]}]}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"DefMetricFields", "[", 
      RowBox[{
       RowBox[{"g_", "?", "MetricQ"}], ",", "dg_", ",", 
       RowBox[{"h_", "?", "InducedMetricQ"}], ",", 
       RowBox[{"n_", "?", "DirectionVectorQ"}], ",", 
       RowBox[{"PerturbParameter_:", "\[Epsilon]"}]}], "]"}], ":=", 
     RowBox[{"Print", "[", "\"\<Dobidoouah\>\"", "]"}]}], ";"}], "*)"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"DefMetricFields", "[", 
     RowBox[{
      RowBox[{"g_", "?", "MetricQ"}], ",", " ", "dg_", ",", " ", 
      RowBox[{"N_", "?", "InducedMetricQ"}], ",", 
      RowBox[{"n_", "?", "DirectionVectorQ"}], ",", " ", "\n", "  ", 
      RowBox[{"PerturbParameter_:", " ", "\[Epsilon]"}]}], "]"}], " ", ":=", 
    " ", "\n", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "Zn", "}"}], ",", " ", "\n", "  ", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"M", " ", "=", " ", 
           RowBox[{"ManifoldOfCovD", "@", 
            RowBox[{"CovDOfMetric", "@", "g"}]}]}], ",", " ", 
          RowBox[{"cd", " ", "=", " ", 
           RowBox[{"CovDOfMetric", "@", "N"}]}]}], "}"}], ",", " ", "\n", 
        "   ", 
        RowBox[{"Block", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\[Mu]", ",", " ", "\[Nu]"}], "}"}], ",", " ", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\[Mu]", ",", " ", "\[Nu]"}], "}"}], " ", "=", "  ", 
            RowBox[{"GetIndicesOfVBundle", "[", 
             RowBox[{
              RowBox[{"Tangent", "@", "M"}], ",", " ", "2"}], "]"}]}], ";", 
           "\n", "    ", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"Not", "[", 
              RowBox[{"DefTensorQ", "[", "dg", "]"}], "]"}], ",", " ", 
             RowBox[{
              RowBox[{"DefMetricPerturbation", "[", 
               RowBox[{"g", ",", " ", "dg", ",", " ", 
                RowBox[{"Evaluate", "[", 
                 RowBox[{"If", "[", 
                  RowBox[{
                   RowBox[{
                   "DefinedPerturbationParameter", "[", 
                    "$PerturbationParameter", "]"}], ",", 
                   "$PerturbationParameter", ",", " ", "PerturbParameter"}], 
                  "]"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", "\n", 
              "     ", 
              RowBox[{
               RowBox[{
               "DefinedPerturbationParameter", "[", "$PerturbationParameter", 
                "]"}], " ", "=", " ", "True"}], ";", "\n", "     ", 
              RowBox[{
               RowBox[{"PrintAs", "[", "dg", "]"}], " ", "^=", " ", 
               RowBox[{"\"\<\[Delta]\>\"", " ", "<>", " ", 
                RowBox[{"ToString", "[", "g", "]"}]}]}], ";", "\n", "     ", 
              RowBox[{
               RowBox[{"dg", "[", 
                RowBox[{
                 RowBox[{"LI", "[", "Zn_", "]"}], ",", " ", "\[Mu]_", ",", 
                 " ", "\[Nu]_"}], "]"}], " ", ":=", 
               RowBox[{"0", " ", "/;", " ", 
                RowBox[{
                 RowBox[{"Zn", " ", ">", " ", "1"}], " ", "&&", " ", 
                 "BackgroundFieldMethod"}]}]}], ";", "\n", "     ", 
              RowBox[{
               RowBox[{"dg", "[", 
                RowBox[{
                 RowBox[{"\[Mu]_", "?", "AIndexQ"}], ",", " ", 
                 RowBox[{"\[Nu]_", "?", "AIndexQ"}]}], "]"}], " ", ":=", " ", 
               
               RowBox[{"dg", "[", 
                RowBox[{
                 RowBox[{"LI", "[", "0", "]"}], ",", " ", "\[Mu]", ",", " ", 
                 "\[Nu]"}], "]"}]}], ";"}], ",", " ", "\n", "      ", 
             RowBox[{
              RowBox[{"If", "[", 
               RowBox[{"$DefInfoQ", ",", " ", "\n", "       ", 
                RowBox[{
                 RowBox[{
                 "Print", "[", 
                  "\"\<** Warning: Metric perturbation already defined. \
Thiscannot be redefined without undefining it. **\>\"", "]"}], ";"}]}], "]"}],
               ";"}]}], "\[IndentingNewLine]", "]"}], ";", "\n", "    ", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
            "Defining", " ", "some", " ", "tensors", " ", "we", " ", "shall", 
             " ", "need", " ", "anyway"}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"DefScreenProjectedTensor", "[", 
               RowBox[{
                RowBox[{"#", "[", 
                 RowBox[{"[", "1", "]"}], "]"}], ",", " ", "h", ",", 
                RowBox[{"TensorProperties", " ", "->", " ", 
                 RowBox[{"{", 
                  RowBox[{
                  "\"\<Traceless\>\"", ",", " ", "\"\<Transverse\>\"", ",", 
                   " ", "\n", "          ", "\"\<SymmetricTensor\>\""}], 
                  "}"}]}], ",", " ", 
                RowBox[{"SpaceTimesOfDefinition", " ", "->", " ", 
                 RowBox[{"{", "\"\<Perturbed\>\"", "}"}]}], ",", 
                RowBox[{"PrintAs", " ", "->", " ", 
                 RowBox[{"#", "[", 
                  RowBox[{"[", "2", "]"}], "]"}]}]}], "]"}], ")"}], " ", 
             "&"}], " ", "/@", " ", 
            RowBox[{"$ListFieldsPerturbedOnly", "[", "N", "]"}]}], ";", 
           "\[IndentingNewLine]", "\n", "    ", 
           RowBox[{
            RowBox[{
             RowBox[{"Evaluate", "[", 
              RowBox[{"\[Phi]", "[", "N", "]"}], "]"}], "::", "usage"}], " ", 
            "=", " ", 
            RowBox[{"\[Phi]", "::", "usage"}]}], ";", "\n", "    ", 
           RowBox[{
            RowBox[{
             RowBox[{"Evaluate", "[", 
              RowBox[{"Bs", "[", "N", "]"}], "]"}], "::", "usage"}], " ", "=",
             " ", 
            RowBox[{"Bs", "::", "usage"}]}], ";", "\n", "    ", 
           RowBox[{
            RowBox[{
             RowBox[{"Evaluate", "[", 
              RowBox[{"Bvp", "[", "N", "]"}], "]"}], "::", "usage"}], " ", 
            "=", 
            RowBox[{"Bvp", "::", "usage"}]}], ";", "\n", "    ", 
           RowBox[{
            RowBox[{
             RowBox[{"Evaluate", "[", 
              RowBox[{"Bvt", "[", "N", "]"}], "]"}], "::", "usage"}], " ", 
            "=", 
            RowBox[{"Bvt", "::", "usage"}]}], ";", "\n", "    ", 
           RowBox[{
            RowBox[{
             RowBox[{"Evaluate", "[", 
              RowBox[{"\[Psi]", "[", "N", "]"}], "]"}], "::", "usage"}], " ", 
            "=", " ", 
            RowBox[{"\[Psi]", "::", "usage"}]}], ";", "\n", "    ", 
           RowBox[{
            RowBox[{
             RowBox[{"Evaluate", "[", 
              RowBox[{"Es", "[", "N", "]"}], "]"}], "::", "usage"}], " ", "=",
             " ", 
            RowBox[{"Es", "::", "usage"}]}], ";", "\n", "    ", 
           RowBox[{
            RowBox[{
             RowBox[{"Evaluate", "[", 
              RowBox[{"Evp", "[", "N", "]"}], "]"}], "::", "usage"}], " ", 
            "=", " ", 
            RowBox[{"Evp", "::", "usage"}]}], ";", "\n", "    ", 
           RowBox[{
            RowBox[{
             RowBox[{"Evaluate", "[", 
              RowBox[{"Evt", "[", "N", "]"}], "]"}], "::", "usage"}], " ", 
            "=", " ", 
            RowBox[{"Evt", "::", "usage"}]}], ";", "\n", "    ", 
           RowBox[{
            RowBox[{
             RowBox[{"Evaluate", "[", 
              RowBox[{"Etp", "[", "N", "]"}], "]"}], "::", "usage"}], " ", 
            "=", " ", 
            RowBox[{
             SubscriptBox["Et", "p"], "::", "usage"}]}], ";", "\n", "    ", 
           RowBox[{
            RowBox[{
             RowBox[{"Evaluate", "[", 
              RowBox[{"Etpt", "[", "N", "]"}], "]"}], "::", "usage"}], " ", 
            "=", " ", 
            RowBox[{"Etpt", "::", "usage"}]}], ";", "\n", "    ", 
           RowBox[{
            RowBox[{
             RowBox[{"Evaluate", "[", 
              RowBox[{"Ett", "[", "N", "]"}], "]"}], "::", "usage"}], " ", 
            "=", " ", 
            RowBox[{"Ett", "::", "usage"}]}], ";", "\n", "    ", "\n", "    ", 
           RowBox[{
            RowBox[{
             RowBox[{"Evaluate", "[", 
              RowBox[{"T", "[", "N", "]"}], "]"}], "::", "usage"}], " ", "=", 
            " ", 
            RowBox[{"T", "::", "usage"}]}], ";", "\n", "    ", 
           RowBox[{
            RowBox[{
             RowBox[{"Evaluate", "[", 
              RowBox[{"Ls", "[", "N", "]"}], "]"}], "::", "usage"}], " ", "=",
             " ", 
            RowBox[{"Ls", "::", "usage"}]}], ";", "\n", "    ", 
           RowBox[{
            RowBox[{
             RowBox[{"Evaluate", "[", 
              RowBox[{"Lv", "[", "N", "]"}], "]"}], "::", "usage"}], " ", "=",
             " ", 
            RowBox[{"Lvp", "::", "usage"}]}], ";", "\n", "    ", 
           RowBox[{
            RowBox[{
             RowBox[{"Evaluate", "[", 
              RowBox[{"Lvt", "[", "N", "]"}], "]"}], "::", "usage"}], " ", 
            "=", " ", 
            RowBox[{"Lvt", "::", "usage"}]}], ";", "\[IndentingNewLine]", 
           "\n", "    ", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{
             "If", " ", "we", " ", "want", " ", "a", " ", "nice", " ", 
              "output", " ", "for", " ", "the", " ", "perturbation", " ", 
              "parameter"}], ",", ","}], "*)"}], "\n", "    ", 
           RowBox[{
            RowBox[{"MakeBoxes", "[", 
             RowBox[{"PerturbParameter", ",", " ", "StandardForm"}], "]"}], 
            " ", ":=", 
            RowBox[{"StyleBox", "[", 
             RowBox[{
              RowBox[{"ToString", "[", "$PerturbationParameter", "]"}], ",", 
              RowBox[{"FontColor", " ", "->", " ", 
               RowBox[{"RGBColor", "[", 
                RowBox[{"0.3", ",", " ", "0.8", ",", " ", "0.8"}], "]"}]}]}], 
             "]"}]}]}]}], "]"}]}], "]"}]}], "]"}]}], "\n", "\n", 
   RowBox[{
    RowBox[{"SetNumberOfArguments", "[", 
     RowBox[{"DefMetricFields", ",", " ", 
      RowBox[{"{", 
       RowBox[{"3", ",", " ", "4"}], "}"}]}], "]"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"Protect", "[", "DefMetricFields", "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"SetNumberOfArguments", "[", 
     RowBox[{"DefMetricFields", ",", 
      RowBox[{"{", 
       RowBox[{"4", ",", "5"}], "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
   
   RowBox[{
    RowBox[{"Protect", "[", "DefMetricFields", "]"}], ";"}]}]}]], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"DefMatterFields", "[", 
     RowBox[{"uf_", ",", "duf_", ",", 
      RowBox[{"h_", "?", "InducedMetricQ"}], ",", 
      RowBox[{"n_", "?", "DirectionVectorQ"}], ",", " ", 
      RowBox[{"PerturbParameter_:", "\[Epsilon]"}]}], "]"}], ":=", 
    RowBox[{"Print", "[", "\"\<Dobidoouah\>\"", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetNumberOfArguments", "[", 
   RowBox[{"DefMatterFields", ",", 
    RowBox[{"{", 
     RowBox[{"4", ",", "5"}], "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "DefMatterFields", "]"}], ";"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[
 RowBox[{"SetNumberOfArguments", "[", 
  RowBox[{"DefMatterFields", ",", 
   RowBox[{"{", 
    RowBox[{"4", ",", "5"}], "}"}]}], "]"}]], "Output"]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"SplitMetric", "[", 
    RowBox[{
     RowBox[{"g_", "?", "MetricQ"}], ",", "dg_", ",", 
     RowBox[{"h_", "?", "InducedMetricQ"}], ",", 
     RowBox[{"n_", "?", "DirectionVectorQ"}], ",", 
     RowBox[{"gauge_", "?", "GaugeQ"}]}], "]"}], ":=", 
   RowBox[{"Print", "[", "\"\<Dobidoouah\>\"", "]"}]}], ";"}]], "Input",
 InitializationCell->True]
}, Open  ]],

Cell[CellGroupData[{

Cell["Conformal Transformation Tools (from xPand)", "Subsubsection"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"IndicesDown", "[", "expr_", "]"}], ":=", " ", 
  RowBox[{"Fold", "[", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"SeparateMetric", "[", 
       RowBox[{"First", "@", "$Metrics"}], "]"}], "[", 
      RowBox[{"#1", ",", "#2"}], "]"}], "&"}], ",", "expr", ",", 
    RowBox[{"Select", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"IndicesOf", "[", "Up", "]"}], "[", "expr", "]"}], ",", 
      RowBox[{
       RowBox[{"Not", "@", 
        RowBox[{"LIndexQ", "[", "#", "]"}]}], "&"}]}], "]"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"IndicesUp", "[", "expr_", "]"}], ":=", " ", 
   RowBox[{"Fold", "[", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"SeparateMetric", "[", 
        RowBox[{"First", "@", "$Metrics"}], "]"}], "[", 
       RowBox[{"#1", ",", "#2"}], "]"}], "&"}], ",", "expr", ",", 
     RowBox[{"Select", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"IndicesOf", "[", "Down", "]"}], "[", "expr", "]"}], ",", 
       RowBox[{
        RowBox[{"Not", "@", 
         RowBox[{"LIndexQ", "[", "#", "]"}]}], "&"}]}], "]"}]}], "]"}]}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"IndicesDown", "[", "0", "]"}], ":=", "0"}], " ", ";"}], 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"This", " ", "is", " ", "to", " ", "avoid", " ", "bugs"}], 
    "..."}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"IndicesUp", "[", "0", "]"}], ":=", "0"}], " ", ";"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"ConformalMetricName", "[", 
    RowBox[{
     RowBox[{"g_", "?", "MetricQ"}], ",", "1"}], "]"}], ":=", "g"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ConformalMetricName", "[", 
    RowBox[{
     RowBox[{"g_", "?", "MetricQ"}], ",", "conffactor_"}], "]"}], ":=", 
   RowBox[{"SymbolJoin", "[", 
    RowBox[{"g", ",", "conffactor", ",", "2"}], "]"}]}], ";"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"DefConformalMetric", "[", 
    RowBox[{
     RowBox[{"g_", "?", "MetricQ"}], ",", "conffactor_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"n", ",", "q"}], "}"}], ",", 
     RowBox[{"Catch", "@", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"M", "=", 
           RowBox[{"ManifoldOfCovD", "@", 
            RowBox[{"CovDOfMetric", "@", "g"}]}]}], ",", 
          RowBox[{"CD", "=", 
           RowBox[{"CovDOfMetric", "@", "g"}]}]}], "}"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"With", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"i1", "=", 
             RowBox[{"DummyIn", "[", 
              RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ",", 
            RowBox[{"i2", "=", 
             RowBox[{"DummyIn", "[", 
              RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ",", 
            RowBox[{"sy1", "=", 
             RowBox[{
              RowBox[{"SymbolOfCovD", "[", "CD", "]"}], "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], ",", 
            RowBox[{"sy2", "=", 
             RowBox[{
              RowBox[{"SymbolOfCovD", "[", "CD", "]"}], "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], ",", 
            RowBox[{"metlist", "=", 
             RowBox[{"Select", "[", 
              RowBox[{"$Metrics", ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"InducedFrom", "[", "#", "]"}], "===", "Null"}], 
                "&"}]}], "]"}]}]}], "}"}], ",", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"Not", "@", 
              RowBox[{"DefTensorQ", "[", "conffactor", "]"}]}], ",", 
             RowBox[{"DefTensor", "[", 
              RowBox[{
               RowBox[{"conffactor", "[", 
                RowBox[{
                 RowBox[{"LI", "[", "n", "]"}], ",", 
                 RowBox[{"LI", "[", "q", "]"}]}], "]"}], ",", 
               RowBox[{"{", "M", "}"}], ",", 
               RowBox[{"PrintAs", "->", 
                RowBox[{"ToString", "[", "conffactor", "]"}]}]}], "]"}]}], 
            "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"Off", "[", 
            StyleBox[
             RowBox[{"DefMetric", "::", "old"}], "MessageName"], "]"}], ";", 
           RowBox[{"(*", " ", 
            RowBox[{"Annoying", " ", "message", " ", "turned", " ", "off"}], 
            "*)"}], "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"Not", "[", 
              RowBox[{"DefTensorQ", "[", 
               RowBox[{"ConformalMetricName", "[", 
                RowBox[{"g", ",", "conffactor"}], "]"}], "]"}], "]"}], ",", 
             "\[IndentingNewLine]", "\[IndentingNewLine]", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"DefMetric", "[", 
               RowBox[{
                RowBox[{"-", "1"}], ",", 
                RowBox[{
                 RowBox[{"ConformalMetricName", "[", 
                  RowBox[{"g", ",", "conffactor"}], "]"}], "[", 
                 RowBox[{
                  RowBox[{"-", "i1"}], ",", 
                  RowBox[{"-", "i2"}]}], "]"}], ",", 
                RowBox[{"SymbolJoin", "[", 
                 RowBox[{"CD", ",", "conffactor", ",", "2"}], "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"\"\<:\>\"", ",", 
                  RowBox[{"StringJoin", "[", 
                   RowBox[{"sy2", ",", 
                    RowBox[{"ToString", "[", "conffactor", "]"}], ",", 
                    RowBox[{"ToString", "[", "2", "]"}]}], "]"}]}], "}"}], 
                ",", 
                RowBox[{"PrintAs", "\[Rule]", 
                 RowBox[{"StringJoin", "[", 
                  RowBox[{"\"\<[\>\"", ",", 
                   RowBox[{"PrintAs", "[", "g", "]"}], ",", 
                   RowBox[{"\"\<\\!\\(\>\"", "<>", 
                    RowBox[{"PrintAs", "[", "conffactor", "]"}], "<>", 
                    "\"\<\\^2\\)\>\""}], ",", "\"\<]\>\""}], 
                  RowBox[{"(*", 
                   RowBox[{
                    RowBox[{"ToString", "[", "conffactor", "]"}], ",", 
                    RowBox[{"ToString", "[", "2", "]"}]}], "*)"}], "]"}]}], 
                ",", 
                RowBox[{"ConformalTo", "\[Rule]", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"g", "[", 
                    RowBox[{
                    RowBox[{"-", "i1"}], ",", 
                    RowBox[{"-", "i2"}]}], "]"}], ",", 
                   RowBox[{
                    RowBox[{"conffactor", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "0", "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}]}], "]"}], "^", "2"}]}], 
                  "}"}]}]}], "]"}], ";"}]}], "\[IndentingNewLine]", 
            "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
           RowBox[{"On", "[", 
            StyleBox[
             RowBox[{"DefMetric", "::", "old"}], "MessageName"], "]"}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
            "We", " ", "have", " ", "to", " ", "ensure", " ", "it", " ", "is",
              " ", "safe"}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Perturbation", "[", 
             RowBox[{
              RowBox[{"conffactor", "[", 
               RowBox[{
                RowBox[{"LI", "[", "0", "]"}], ",", 
                RowBox[{"LI", "[", "q_", "]"}], ",", "indices___"}], "]"}], 
              ",", "n_"}], "]"}], "^:=", 
            RowBox[{"0", "/;", 
             RowBox[{"n", "\[GreaterEqual]", "1"}]}]}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"Off", "[", 
            StyleBox[
             RowBox[{"ConformalRules", "::", "unknown"}], "MessageName"], 
            "]"}], ";", "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
            "We", " ", "use", " ", "the", " ", "error", " ", "sent", " ", 
             "by", " ", "ConformalRules", " ", "to", " ", "chekc", " ", 
             "whether", " ", "or", " ", "not", " ", "the", " ", "metric", " ",
              "in", " ", "the", " ", "list", " ", "metlist", " ", "is", " ", 
             "conformallyr", " ", "elated", " ", "to", " ", "the", " ", 
             "metric", " ", 
             RowBox[{"g", ".", "\[IndentingNewLine]", "If"}], " ", "it", " ", 
             "is", " ", "the", " ", "case", " ", "we", " ", "enforce", " ", 
             "transitivity", " ", "of", " ", "the", " ", "conformal", " ", 
             RowBox[{"relations", "."}]}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"Catch", "@", 
                 RowBox[{"ConformalRules", "[", 
                  RowBox[{"g", ",", "#"}], "]"}]}], "=!=", "Null"}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{"SetConformalTo", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"SymbolJoin", "[", 
                   RowBox[{"g", ",", "conffactor", ",", "2"}], "]"}], "[", 
                  RowBox[{
                   RowBox[{"-", "i1"}], ",", 
                   RowBox[{"-", "i2"}]}], "]"}], ",", " ", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"#", "[", 
                    RowBox[{
                    RowBox[{"-", "i1"}], ",", " ", 
                    RowBox[{"-", "i2"}]}], "]"}], ",", 
                   RowBox[{
                    RowBox[{"ConformalFactor", "[", 
                    RowBox[{"g", ",", "#"}], "]"}], "*", " ", 
                    RowBox[{
                    RowBox[{"conffactor", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "0", "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}]}], "]"}], "^", "2"}]}]}], 
                  "}"}]}], "]"}]}], "]"}], "&"}], "/@", "metlist"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"On", "[", 
            StyleBox[
             RowBox[{"ConformalRules", "::", "unknown"}], "MessageName"], 
            "]"}], ";"}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
         "]"}]}], "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"SetNumberOfArguments", "[", 
  RowBox[{"DefConformalMetric", ",", "2"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "DefConformalMetric", "]"}], ";"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ConfHead", "[", 
     RowBox[{"_", ",", "_"}], "]"}], "[", 
    RowBox[{"delta", "[", 
     RowBox[{"\[Mu]_", ",", "\[Nu]_"}], "]"}], "]"}], ":=", 
   RowBox[{"delta", "[", 
    RowBox[{"\[Mu]", ",", "\[Nu]"}], "]"}]}], 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
    "Because", " ", "I", " ", "know", " ", "that", " ", "when", " ", "there", 
     " ", "is", " ", "delta", " ", "function", " ", "in", " ", "an", " ", 
     "expression"}], ",", " ", 
    RowBox[{
     RowBox[{
      RowBox[{
      "it", " ", "is", " ", "always", " ", "with", " ", "one", " ", "index", 
       " ", "up", " ", "and", " ", "one", " ", "down"}], "..."}], "so", " ", 
     "this", " ", "should", " ", "be", " ", 
     RowBox[{"fine", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", " "}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ConfHead", "[", 
     RowBox[{
      RowBox[{"metric1_", "?", "MetricQ"}], ",", 
      RowBox[{"metric2_", "?", "MetricQ"}]}], "]"}], "[", 
    RowBox[{
     RowBox[{"ConfHead", "[", 
      RowBox[{
       RowBox[{"metric2_", "?", "MetricQ"}], ",", 
       RowBox[{"metric1_", "?", "MetricQ"}]}], "]"}], "[", "expr_", "]"}], 
    "]"}], ":=", "expr"}], " ", 
  RowBox[{"(*", " ", 
   RowBox[{"Not", " ", "necessary"}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ConfHead", "[", 
    RowBox[{
     RowBox[{"metric1_", "?", "MetricQ"}], ",", 
     RowBox[{"metric1_", "?", "MetricQ"}]}], "]"}], "[", "expr_", "]"}], ":=",
   "expr"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ConfHead", "[", 
     RowBox[{
      RowBox[{"metric2_", "?", "MetricQ"}], ",", 
      RowBox[{"metric3_", "?", "MetricQ"}]}], "]"}], "[", 
    RowBox[{
     RowBox[{"ConfHead", "[", 
      RowBox[{
       RowBox[{"metric1_", "?", "MetricQ"}], ",", 
       RowBox[{"metric2_", "?", "MetricQ"}]}], "]"}], "[", "expr_", "]"}], 
    "]"}], ":=", 
   RowBox[{
    RowBox[{"ConfHead", "[", 
     RowBox[{"metric1", ",", "metric3"}], "]"}], "[", "expr", "]"}]}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
    "Thanks", " ", "to", " ", "Jolyon", " ", "and", " ", "Leo", " ", 
     "Stein"}], ",", " ", 
    RowBox[{
    "the", " ", "definition", " ", "below", " ", "should", " ", "be", " ", 
     "much", " ", "more", " ", 
     RowBox[{"general", "."}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "The", " ", "main", " ", "reason", " ", "is", " ", "that", " ", "the", " ",
     "delta", " ", "tensor", " ", "is", " ", "greedy", " ", "and", " ", 
    "wants", " ", "to", " ", "contract", " ", "through", " ", "expressions", 
    " ", "like", "\n", 
    RowBox[{
     RowBox[{
      RowBox[{"ConfHead", "[", "...", "]"}], "[", 
      RowBox[{"f", "[", 
       RowBox[{"Scalar", "[", 
        RowBox[{"phi", "[", "]"}], "]"}], "]"}], "]"}], "."}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ConfHead", "/:", 
   RowBox[{"IsIndexOf", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"ConfHead", "[", 
       RowBox[{"_", ",", "_"}], "]"}], "[", "_", "]"}], ",", "_", ",", 
     "delta"}], "]"}], ":=", "False"}], ";"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"$BoolBasicConformalWeight", "=", "True"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"WeightOfIndicesList", "[", "indices_List", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"aindex", "=", 
       RowBox[{"Select", "[", 
        RowBox[{"indices", ",", 
         RowBox[{
          RowBox[{"Not", "[", 
           RowBox[{"LIndexQ", "[", "#", "]"}], "]"}], "&"}]}], "]"}]}], "}"}],
      ",", 
     RowBox[{
      RowBox[{"Length", "@", 
       RowBox[{"Select", "[", 
        RowBox[{"aindex", ",", "DownIndexQ"}], "]"}]}], "-", 
      RowBox[{"Length", "@", 
       RowBox[{"Select", "[", 
        RowBox[{"aindex", ",", "UpIndexQ"}], "]"}]}]}]}], "]"}]}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"Conformal", " ", "weight", " ", "of", " ", "a", " ", "tensor"}], 
   " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ConformalWeight", "[", 
    RowBox[{"tens_", "?", "xTensorQ"}], "]"}], ":=", "0"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ConformalWeight", "[", 
    RowBox[{
     RowBox[{"tens_", "?", "xTensorQ"}], "[", "indices___", "]"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"ConformalWeight", "[", "tens", "]"}], "+", 
    RowBox[{"WeightOfIndicesList", "[", 
     RowBox[{"{", "indices", "}"}], "]"}]}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ConformalWeight", "[", 
     RowBox[{"f_", "?", "ScalarFunctionQ"}], "]"}], ":=", "0"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MyChangeChristoffel", "[", 
    RowBox[{"expr_", ",", "cd_", ",", "cd_"}], "]"}], ":=", "expr"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MyChangeChristoffel", "[", 
    RowBox[{"expr_", ",", "cd2list_List", ",", "cd1_"}], "]"}], ":=", 
   RowBox[{"Fold", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"MyChangeChristoffel", "[", 
       RowBox[{"#1", ",", "#2", ",", "cd1"}], "]"}], "&"}], ",", "expr", ",", 
     "cd2list"}], "]"}]}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MyChangeChristoffel", "[", 
   RowBox[{"expr_", ",", "cd2_", ",", "cd1_"}], "]"}], ":=", 
  RowBox[{"With", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"vb", "=", 
      RowBox[{"Tangent", "[", 
       RowBox[{"ManifoldOfCovD", "[", "cd1", "]"}], "]"}]}], "}"}], ",", 
    RowBox[{"With", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"chr1", "=", 
         RowBox[{"Head", "[", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"Christoffel", "[", "cd1", "]"}], ")"}], "[", 
           RowBox[{
            RowBox[{"DummyIn", "[", "vb", "]"}], ",", 
            RowBox[{"-", 
             RowBox[{"DummyIn", "[", "vb", "]"}]}], ",", 
            RowBox[{"-", 
             RowBox[{"DummyIn", "[", "vb", "]"}]}]}], "]"}], "]"}]}], ",", 
        RowBox[{"chr2", "=", 
         RowBox[{"Head", "[", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"Christoffel", "[", "cd2", "]"}], ")"}], "[", 
           RowBox[{
            RowBox[{"DummyIn", "[", "vb", "]"}], ",", 
            RowBox[{"-", 
             RowBox[{"DummyIn", "[", "vb", "]"}]}], ",", 
            RowBox[{"-", 
             RowBox[{"DummyIn", "[", "vb", "]"}]}]}], "]"}], "]"}]}], ",", 
        RowBox[{"chr21", "=", 
         RowBox[{"Head", "[", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"Christoffel", "@@", 
             RowBox[{"Sort", "[", 
              RowBox[{"{", 
               RowBox[{"cd2", ",", "cd1"}], "}"}], "]"}]}], ")"}], "[", 
           RowBox[{
            RowBox[{"DummyIn", "[", "vb", "]"}], ",", 
            RowBox[{"-", 
             RowBox[{"DummyIn", "[", "vb", "]"}]}], ",", 
            RowBox[{"-", 
             RowBox[{"DummyIn", "[", "vb", "]"}]}]}], "]"}], "]"}]}], ",", 
        RowBox[{"sign", "=", 
         RowBox[{"Order", "[", 
          RowBox[{"cd2", ",", "cd1"}], "]"}]}]}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"expr", "/.", 
       RowBox[{
        RowBox[{"chr2", "[", 
         RowBox[{"i1_", ",", "i2_", ",", "i3_"}], "]"}], "\[RuleDelayed]", 
        RowBox[{
         RowBox[{"chr1", "[", 
          RowBox[{"i1", ",", "i2", ",", "i3"}], "]"}], "+", 
         RowBox[{"sign", "*", 
          RowBox[{"chr21", "[", 
           RowBox[{"i1", ",", "i2", ",", "i3"}], "]"}]}]}]}]}]}], 
     "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"ExistInertHead", "[", "head_", "]"}], ":=", 
   RowBox[{
    RowBox[{"Length", "@", 
     RowBox[{"Cases", "[", 
      RowBox[{"$InertHeads", ",", "head"}], "]"}]}], ">", "0"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"RulesConf", "[", 
   RowBox[{
    RowBox[{"metric1_", "?", "MetricQ"}], ",", 
    RowBox[{"metric2_", "?", "MetricQ"}]}], "]"}], ":=", 
  RowBox[{"(", "\[IndentingNewLine]", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "cd1", ",", "cd2", ",", "confa2", ",", "confa", ",", "M", ",", "res", 
       ",", "inds"}], "}"}], ",", 
     RowBox[{
      RowBox[{"cd1", "=", 
       RowBox[{"CovDOfMetric", "[", "metric1", "]"}]}], ";", 
      RowBox[{"cd2", "=", 
       RowBox[{"CovDOfMetric", "[", "metric2", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"confa2", "=", 
       RowBox[{"ConformalFactor", "[", 
        RowBox[{"metric2", ",", "metric1"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"confa", "=", 
       RowBox[{
        RowBox[{"Sqrt", "[", 
         RowBox[{"ConformalFactor", "[", 
          RowBox[{"metric2", ",", "metric1"}], "]"}], "]"}], "/.", 
        RowBox[{
         RowBox[{"Sqrt", "[", 
          RowBox[{"x_", "^", 
           RowBox[{"n_", "?", "EvenQ"}]}], "]"}], ":>", 
         RowBox[{"x", "^", 
          RowBox[{"(", 
           RowBox[{"n", "/", "2"}], ")"}]}]}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "In", " ", "principle", " ", "this", " ", "should", " ", "give", " ", 
        "a", " ", "or", " ", 
        RowBox[{"1", "/", "a"}], " ", "depending", " ", "if", " ", "we", " ", 
        "go", " ", "from", " ", "metric1", " ", "to", " ", "metric2", " ", 
        "or", " ", "metric2", " ", "to", " ", "metric1"}], "*)"}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"M", "=", 
       RowBox[{"ManifoldOfCovD", "[", "cd1", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"inds", "=", 
       RowBox[{"DummyIn", "/@", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"Tangent", "[", "M", "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"Range", "[", "4", "]"}], "}"}]}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"i1", "=", 
           RowBox[{"inds", "[", 
            RowBox[{"[", "1", "]"}], "]"}]}], ",", 
          RowBox[{"i2", "=", 
           RowBox[{"inds", "[", 
            RowBox[{"[", "2", "]"}], "]"}]}], ",", 
          RowBox[{"i3", "=", 
           RowBox[{"inds", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}], ",", 
          RowBox[{"i4", "=", 
           RowBox[{"inds", "[", 
            RowBox[{"[", "4", "]"}], "]"}]}]}], "}"}], ",", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "Once", " ", "confheads", " ", "are", " ", "put", " ", "on", " ", 
          "expression", " ", 
          RowBox[{"(", 
           RowBox[{
           "as", " ", "a", " ", "result", " ", "of", " ", "a", " ", "formal", 
            " ", "conformal", " ", "transformation"}], ")"}], " ", "then", 
          " ", "we", " ", "remove", " ", "them", " ", "by", " ", "expressing",
           " ", "what", " ", "they", " ", "mean", " ", "in", " ", "function", 
          " ", "of", " ", "the", " ", "original", " ", "tensors", " ", "and", 
          " ", "the", " ", "scale", " ", "factor"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"res", "=", "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"RuleDelayed", "@@", 
             RowBox[{"Hold", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"ConfHead", "[", 
                 RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"Riemann", "@", "cd1"}], ")"}], "[", 
                 RowBox[{"i1_", ",", "i2_", ",", "i3_", ",", "i4_"}], "]"}], 
                "]"}], ",", 
               RowBox[{
                RowBox[{"confa", "^", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"WeightOfIndicesList", "[", 
                    RowBox[{"{", 
                    RowBox[{"i1", ",", "i2", ",", "i3", ",", "i4"}], "}"}], 
                    "]"}], "-", "2"}], ")"}]}], 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"Riemann", "@", "cd2"}], ")"}], "[", 
                 RowBox[{"i1", ",", "i2", ",", "i3", ",", "i4"}], "]"}]}]}], 
              "]"}]}], ",", "\[IndentingNewLine]", 
            RowBox[{"RuleDelayed", "@@", 
             RowBox[{"Hold", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"ConfHead", "[", 
                 RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"Ricci", "@", "cd1"}], ")"}], "[", 
                 RowBox[{"i1_", ",", "i2_"}], "]"}], "]"}], ",", 
               RowBox[{
                RowBox[{"confa", "^", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"WeightOfIndicesList", "[", 
                    RowBox[{"{", 
                    RowBox[{"i1", ",", "i2"}], "}"}], "]"}], "-", "2"}], 
                  ")"}]}], 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"Ricci", "@", "cd2"}], ")"}], "[", 
                 RowBox[{"i1", ",", "i2"}], "]"}]}]}], "]"}]}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"RuleDelayed", "@@", 
             RowBox[{"Hold", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"ConfHead", "[", 
                 RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"RicciScalar", "@", "cd1"}], ")"}], "[", "]"}], 
                "]"}], ",", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"RicciScalar", "@", "cd2"}], ")"}], "[", "]"}]}], 
              "]"}]}], ",", "\[IndentingNewLine]", 
            RowBox[{"RuleDelayed", "@@", 
             RowBox[{"Hold", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"ConfHead", "[", 
                 RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"Christoffel", "@", "cd1"}], ")"}], "[", 
                 RowBox[{"i1_", ",", "i2_", ",", "i3_"}], "]"}], "]"}], ",", 
               RowBox[{
                RowBox[{"confa", "^", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"WeightOfIndicesList", "[", 
                    RowBox[{"{", 
                    RowBox[{"i1", ",", "i2", ",", "i3"}], "}"}], "]"}], "-", 
                   "1"}], ")"}]}], "*", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"Christoffel", "@", "cd2"}], ")"}], "[", 
                 RowBox[{"i1", ",", "i2", ",", "i3"}], "]"}]}]}], "]"}]}], 
            ",", "\[IndentingNewLine]", 
            RowBox[{"RuleDelayed", "@@", 
             RowBox[{"Hold", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"ConfHead", "[", 
                 RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"Determinant", "[", 
                   RowBox[{"metric1", ",", "AIndex"}], "]"}], ")"}], "[", 
                 "]"}], "]"}], ",", 
               RowBox[{"(*", " ", 
                RowBox[{
                "This", " ", "is", " ", "removed", " ", "because", " ", "now",
                  " ", "xTensor", " ", "is", " ", "patched", " ", 
                 RowBox[{
                  RowBox[{"confa2", "^", 
                   RowBox[{"DimOfManifold", "[", "M", "]"}]}], ".", " ", 
                  "Thanks"}], " ", "to", " ", "Leo", " ", 
                 RowBox[{"Stein", "."}]}], "*)"}], 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"Determinant", "[", 
                  RowBox[{"metric2", ",", "AIndex"}], "]"}], ")"}], "[", 
                "]"}]}], "]"}]}], ",", "\[IndentingNewLine]", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
              RowBox[{
              "This", " ", "line", " ", "below", " ", "is", " ", "not", " ", 
               "working", " ", 
               RowBox[{"well", ".", "  ", "The"}], " ", "problem", " ", 
               "should", " ", "be", " ", "considered", " ", "later", " ", 
               "when", " ", "xTensor", " ", "knows", " ", "how", " ", "to", 
               " ", "handle", " ", "the", " ", "epsilon", " ", "of", " ", "a",
                " ", "frozen", " ", 
               RowBox[{"metric", ".", " ", "So"}], " ", "this", " ", "really",
                " ", "works", " ", "only", " ", "when", " ", "metric1", " ", 
               "is", " ", "the", " ", "ambient", " ", "metric"}], "..."}], 
             " ", "*)"}], "\[IndentingNewLine]", 
            RowBox[{"RuleDelayed", "@@", 
             RowBox[{"Hold", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"ConfHead", "[", 
                 RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"epsilon", "@", "metric1"}], ")"}], "[", 
                 RowBox[{"inds__", "?", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "#", "}"}], "]"}], "===", 
                    RowBox[{"DimOfManifold", "[", "M", "]"}]}], "&"}], 
                   ")"}]}], "]"}], "]"}], ",", 
               RowBox[{"(*", 
                RowBox[{"confa2", "^", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"DimOfManifold", "[", "M", "]"}], "/", "2"}], 
                  ")"}]}], "*)"}], 
               RowBox[{
                RowBox[{"confa", "^", 
                 RowBox[{"(", 
                  RowBox[{"WeightOfIndicesList", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}], ")"}]}], 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"epsilon", "@", "metric1"}], ")"}], "[", "inds", 
                 "]"}]}]}], "]"}]}], ",", "\[IndentingNewLine]", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
             "Not", " ", "really", " ", "satisfactory", " ", "but", " ", 
              "minimalist", " ", "for", " ", "scalar", " ", "functions"}], 
             " ", "*)"}], "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
              RowBox[{
              "Following", " ", "Leo", " ", "Stein", " ", "suggestion"}], ",",
               " ", 
              RowBox[{
              "we", " ", "allow", " ", "the", " ", "scalar", " ", "function", 
               " ", "to", " ", "have", " ", "several", " ", "arguments"}]}], 
             " ", "*)"}], "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"ConfHead", "[", 
               RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
              RowBox[{
               RowBox[{"f_", "?", "ScalarFunctionQ"}], "[", "arg___", "]"}], 
              "]"}], ":>", 
             RowBox[{
              RowBox[{"Simplify", "[", 
               RowBox[{
                RowBox[{"confa2", "^", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{"ConformalWeight", "[", "f", "]"}], ")"}], "/", 
                   "2"}], ")"}]}], ",", 
                RowBox[{"Assumptions", "\[Rule]", 
                 RowBox[{"confa", ">", "0"}]}]}], "]"}], 
              RowBox[{"f", "[", "arg", "]"}]}]}], ",", "\[IndentingNewLine]", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"ConfHead", "[", 
               RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
              RowBox[{
               RowBox[{"tens_", "?", "xTensorQ"}], "[", "indss___", "]"}], 
              "]"}], "\[RuleDelayed]", 
             RowBox[{
              RowBox[{"Simplify", "[", 
               RowBox[{
                RowBox[{"confa2", "^", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"ConformalWeight", "[", 
                    RowBox[{"tens", "[", "indss", "]"}], "]"}], "/", "2"}], 
                  ")"}]}], ",", 
                RowBox[{"Assumptions", "\[Rule]", 
                 RowBox[{"confa", ">", "0"}]}]}], "]"}], 
              RowBox[{"tens", "[", "indss", "]"}]}]}]}], 
           "\[IndentingNewLine]", "}"}]}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", "res"}]}], "\[IndentingNewLine]", "]"}]}]}], 
    "\[IndentingNewLine]", "]"}], "\[IndentingNewLine]", ")"}]}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RemoveInducedDerivative", "[", 
     RowBox[{"expr_", ",", "cd_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "res", "}"}], ",", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"h", "=", 
          RowBox[{"MetricOfCovD", "@", "cd"}]}], "}"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"InducedFrom", "@", "h"}], "===", "Null"}], ",", "expr", 
          ",", "\[IndentingNewLine]", 
          RowBox[{"With", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"g", "=", 
              RowBox[{"First", "@", 
               RowBox[{"InducedFrom", "@", "h"}]}]}], "}"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"With", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"CD", "=", 
                RowBox[{"CovDOfMetric", "@", "g"}]}], "}"}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"res", "=", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"expr", "//.", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"cd", "[", "ind_", "]"}], "[", "Expr___", "]"}], ":>", 
                    RowBox[{
                    RowBox[{"Projector", "[", "h", "]"}], "[", 
                    RowBox[{
                    RowBox[{"CD", "[", "ind", "]"}], "[", "Expr", "]"}], 
                    "]"}]}]}], ")"}], "/.", 
                 RowBox[{
                  RowBox[{"Projector", "[", "h", "]"}], "\[Rule]", 
                  RowBox[{"ProjectWith", "[", "h", "]"}]}]}]}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{"res", "=!=", "expr"}], ",", 
                 RowBox[{
                  RowBox[{
                  "Print", "[", 
                   "\"\<** Warning: you are using ToMetric or Conformal with \
induced covariant derivatives. \\nThese induced derivatives are first \
expressed in function of the covariant derivative form which they are induced \
since we do not know very well how to handle that. **\>\"", "]"}], ";"}]}], 
                "]"}], ";", "\[IndentingNewLine]", "res"}]}], 
             "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}], 
         "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RemoveAllInducedDerivatives", "[", "expr_", "]"}], ":=", 
    RowBox[{"With", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"InducedMetrics", "=", 
        RowBox[{"Select", "[", 
         RowBox[{"$Metrics", ",", 
          RowBox[{
           RowBox[{
            RowBox[{"InducedFrom", "[", "#", "]"}], "=!=", "Null"}], "&"}]}], 
         "]"}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"Fold", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"RemoveInducedDerivative", "[", 
          RowBox[{"#1", ",", 
           RowBox[{"CovDOfMetric", "[", "#2", "]"}]}], "]"}], "&"}], ",", 
        "expr", ",", "InducedMetrics"}], "]"}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ToMetric", "[", 
     RowBox[{"expr_", ",", 
      RowBox[{"metric1_", "?", "MetricQ"}]}], "]"}], ":=", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"InducedFrom", "@", "metric1"}], "=!=", "Null"}], ",", "expr", 
      ",", "\[IndentingNewLine]", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"res", ",", "preexpression"}], "}"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Off", "[", 
          StyleBox[
           RowBox[{"ConformalRules", "::", "unknown"}], "MessageName"], 
          StyleBox["]", "MessageName"]}], 
         StyleBox[";", "MessageName"], "\[IndentingNewLine]", 
         RowBox[{"With", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"cd1", "=", 
              RowBox[{"CovDOfMetric", "[", "metric1", "]"}]}], ",", 
             RowBox[{"$CovDsNotInduced", "=", 
              RowBox[{"Select", "[", 
               RowBox[{
                RowBox[{"Rest", "@", "$CovDs"}], ",", 
                RowBox[{
                 RowBox[{
                  RowBox[{"InducedFrom", "[", 
                   RowBox[{"MetricOfCovD", "[", "#", "]"}], "]"}], "===", 
                  "Null"}], "&"}]}], "]"}]}]}], "}"}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"With", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"$CovDsNotInducedRelatedTocd1", "=", 
               RowBox[{"Select", "[", 
                RowBox[{"$CovDsNotInduced", ",", 
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"Catch", "@", 
                    RowBox[{"ConformalRules", "[", 
                    RowBox[{"metric1", ",", 
                    RowBox[{"MetricOfCovD", "[", "#", "]"}]}], "]"}]}], "=!=",
                     "Null"}], ")"}], "&"}]}], "]"}]}], "}"}], ",", 
             "\[IndentingNewLine]", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"preexpression", "=", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{
                    RowBox[{
                    RowBox[{"RemoveAllInducedDerivatives", "[", "expr", "]"}],
                     "//", "ProjectorToMetric"}], "//", "EinsteinToRicci"}], "//",
                    "WeylToRiemann"}], "//", "ContractMetric"}], "//", 
                 "ToCanonical"}], ")"}]}], ";", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"res", "=", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{"ChangeCovD", "[", 
                    RowBox[{"#", ",", "$CovDsNotInduced", ",", "cd1"}], "]"}],
                     "&"}], "@", "\[IndentingNewLine]", 
                    RowBox[{"ChristoffelToGradConformal", "[", 
                    RowBox[{
                    "#", ",", "$CovDsNotInducedRelatedTocd1", ",", "cd1"}], 
                    "]"}]}], "&"}], "@", "\[IndentingNewLine]", 
                    RowBox[{"MyChangeChristoffel", "[", 
                    RowBox[{
                    "#", ",", "$CovDsNotInducedRelatedTocd1", ",", "cd1"}], 
                    "]"}]}], "&"}], "@", "\[IndentingNewLine]", 
                    RowBox[{"ChangeCovD", "[", 
                    RowBox[{"#", ",", "$CovDsNotInduced", ",", "cd1"}], 
                    "]"}]}], "&"}], "@", "\[IndentingNewLine]", 
                  RowBox[{"ChangeCurvature", "[", 
                   RowBox[{"#", ",", "$CovDsNotInduced", ",", "cd1"}], 
                   "]"}]}], "&"}], "@", "preexpression"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"Off", "[", 
               StyleBox[
                RowBox[{"ConformalRules", "::", "unknown"}], "MessageName"], 
               StyleBox["]", "MessageName"]}], 
              StyleBox[";", "MessageName"], 
              StyleBox["\[IndentingNewLine]", "MessageName"], 
              StyleBox["\[IndentingNewLine]", "MessageName"], 
              RowBox[{
               StyleBox["Fold", "MessageName"], 
               StyleBox["[", "MessageName"], 
               StyleBox[
                RowBox[{
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{"#1", "/.", 
                    RowBox[{"ConformalRules", "[", 
                    RowBox[{
                    RowBox[{"MetricOfCovD", "[", "#2", "]"}], ",", 
                    "metric1"}], "]"}]}], ")"}], "&"}], ",", "res", ",", 
                 "$CovDsNotInducedRelatedTocd1"}], "MessageName"], "]"}]}]}], 
            "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}]}], 
       "\[IndentingNewLine]", "]"}]}], 
     StyleBox["\[IndentingNewLine]", "MessageName"], 
     StyleBox["]", "MessageName"]}]}], 
   StyleBox[";", "MessageName"]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ToMetric", "[", "expr_", "]"}], ":=", 
    RowBox[{"ToMetric", "[", 
     RowBox[{"expr", ",", 
      RowBox[{"First", "@", "$Metrics"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"SetNumberOfArguments", "[", 
  RowBox[{"ToMetric", ",", 
   RowBox[{"{", 
    RowBox[{"1", ",", "2"}], "}"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "ToMetric", "]"}], ";"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{"InverseMetricQ", "[", 
   RowBox[{"x_", "?", "xTensorQ"}], "]"}], ":=", 
  RowBox[{"With", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"tid", "=", 
      RowBox[{"TensorID", "@", "x"}]}], "}"}], ",", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{
       RowBox[{"Length", "@", "tid"}], ">", "0"}], ")"}], "&&", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"tid", "[", 
        RowBox[{"[", "1", "]"}], "]"}], "===", 
       "xAct`xTensor`Private`InvMetric"}], ")"}]}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"InverseMetricQ", "[", "_", "]"}], ":=", "False"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"SeparateIndicesDownOfInverseMetric", "[", 
     RowBox[{"invmetric_", "?", "InverseMetricQ"}], "]"}], "[", "expr_", 
    "]"}], ":=", 
   RowBox[{"Fold", "[", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"SeparateMetric", "[", 
        RowBox[{"First", "@", "$Metrics"}], "]"}], "[", 
       RowBox[{"#1", ",", "#2"}], "]"}], "&"}], ",", "expr", ",", 
     RowBox[{
      RowBox[{"IndicesOf", "[", 
       RowBox[{"Down", ",", "invmetric"}], "]"}], "[", "expr", "]"}]}], 
    "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SeparateIndicesDownOfInverseMetric", "[", "_", "]"}], "[", 
   "expr_", "]"}], ":=", "expr"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"Conformal", "[", 
      RowBox[{"metricbase_", "?", "MetricQ"}], "]"}], "[", 
     RowBox[{
      RowBox[{"metric1_", "?", "MetricQ"}], ",", 
      RowBox[{"metric2_", "?", "MetricQ"}]}], "]"}], "[", "expr_", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"cdb", ",", "cd1", ",", "cd2", ",", "res", ",", "res2", ",", 
       RowBox[{"(*", 
        RowBox[{"oldpre", ","}], "*)"}], "resbis", ",", "exprnoproj", ",", 
       "M", ",", "i1", ",", "i2", ",", "beforeputtingconfheads", ",", 
       "IDInvMetric"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "The", " ", "conflict", " ", "with", " ", "CreenDollarIndicea", " ", 
       "has", " ", "now", " ", "been", " ", 
       RowBox[{"solved", ".", " ", "So"}], " ", "there", " ", "is", " ", "no",
        " ", "need", " ", "to", " ", "redefine", " ", "tempararoly", " ", 
       "$PrePrint"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"oldpre", "=", "$PrePrint"}], ";", 
       RowBox[{"$PrePrint", "=", "Identity"}], ";"}], "*)"}], 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
       "we", " ", "define", " ", "the", " ", "Covds", " ", "associated", " ", 
        "with", " ", "the", " ", 
        RowBox[{"metric", ".", " ", "The"}], " ", "starting", " ", "metric", 
        " ", "is", " ", "metric1"}], ",", " ", 
       RowBox[{
       "the", " ", "conformally", " ", "transformed", " ", "metric", " ", 
        "is", " ", "metric2"}], ",", " ", 
       RowBox[{
       "and", " ", "metricbase", " ", "i", " ", "the", " ", "base", " ", 
        "metric", " ", "for", " ", "raising", " ", "and", " ", "lowering", 
        " ", 
        RowBox[{"indiced", ".", " ", "It"}], " ", "might", " ", "be", " ", 
        "one", " ", "of", " ", "the", " ", "other", " ", "two"}], ",", " ", 
       RowBox[{
        RowBox[{"but", " ", "it", " ", "might", " ", "not", " ", "be"}], 
        "..."}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"cdb", "=", 
       RowBox[{"CovDOfMetric", "[", "metricbase", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"cd1", "=", 
       RowBox[{"CovDOfMetric", "[", "metric1", "]"}]}], ";", 
      RowBox[{"Off", "[", 
       RowBox[{"ConformalFactor", "::", "\"\<unknown\>\""}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"cd2", "=", 
       RowBox[{"CovDOfMetric", "[", "metric2", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"exprnoproj", "=", 
       RowBox[{"expr", "//", "ProjectorToMetric"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"M", "=", 
       RowBox[{"ManifoldOfCovD", "[", "cd1", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"i1", "=", 
       RowBox[{"DummyIn", "[", 
        RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"i2", "=", 
       RowBox[{"DummyIn", "[", 
        RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"IDInvMetric", "=", 
       RowBox[{"SeparateIndicesDownOfInverseMetric", "[", 
        RowBox[{"Inv", "[", "metric1", "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"beforeputtingconfheads", "=", 
       RowBox[{
        RowBox[{"IDInvMetric", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"IndicesDown", "@", 
             RowBox[{"ToMetric", "[", 
              RowBox[{"exprnoproj", ",", "metric1"}], "]"}]}], ")"}], 
           "\[IndentingNewLine]", "/.", 
           RowBox[{
            RowBox[{"Scalar", "[", "ex_", "]"}], "\[RuleDelayed]", 
            RowBox[{"Scalar", "[", 
             RowBox[{"IndicesDown", "[", "ex", "]"}], "]"}]}]}], "/.", 
          RowBox[{
           RowBox[{
            RowBox[{"sf_", "?", "ScalarFunctionQ"}], "[", "args___", "]"}], 
           "\[RuleDelayed]", 
           RowBox[{"sf", "@@", 
            RowBox[{"IndicesDown", "/@", 
             RowBox[{"{", "args", "}"}]}]}]}]}], "]"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"/.", 
          RowBox[{
           RowBox[{"Scalar", "[", "ex_", "]"}], "\[RuleDelayed]", 
           RowBox[{"Scalar", "[", 
            RowBox[{"IDInvMetric", "[", "ex", "]"}], "]"}]}]}], "/.", 
         RowBox[{
          RowBox[{
           RowBox[{"sf_", "?", "ScalarFunctionQ"}], "[", "args___", "]"}], 
          "\[RuleDelayed]", 
          RowBox[{"sf", "@@", 
           RowBox[{"IDInvMetric", "/@", 
            RowBox[{"{", "args", "}"}]}]}]}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Above", " ", "we", " ", "make", " ", "sure", " ", "that", " ", 
        "IndicesDown", " ", "and", " ", "SeparateIndicesDownOfInverseMetric", 
        " ", "goes", " ", "inside", " ", "the", " ", "scalar", " ", "Head"}], 
       "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "We", " ", "use", " ", "ToMetric", " ", "to", " ", "have", " ", "only",
         " ", "references", " ", "to", " ", "the", " ", "metric1", " ", "and",
         " ", "its", " ", "associated", " ", "CovD", " ", "and", " ", 
        "curvature", " ", "tensors"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Print", "[", 
         RowBox[{
         "\"\<beforeputtingconfheads \>\"", ",", "beforeputtingconfheads"}], 
         "]"}], ";"}], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Then", " ", "we", " ", "place", " ", "the", " ", "ConfHead", " ", 
        "on", " ", "every", " ", "expression", " ", "to", " ", "perform", " ",
         "formally", " ", "the", " ", "conformal", " ", 
        RowBox[{"transformation", "."}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"res", "=", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"beforeputtingconfheads", "\[IndentingNewLine]", 
             RowBox[{"(*", " ", 
              RowBox[{
              "Dirty", " ", "case", " ", "of", " ", "scalar", " ", 
               "functions"}], " ", "*)"}], "\[IndentingNewLine]", "/.", 
             RowBox[{
              RowBox[{
               RowBox[{"f_", "?", "ScalarFunctionQ"}], "[", "ex___", "]"}], 
              "\[RuleDelayed]", 
              RowBox[{
               RowBox[{"ConfHead", "[", 
                RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
               RowBox[{"f", "[", "ex", "]"}], "]"}]}]}], 
            "\[IndentingNewLine]", 
            RowBox[{"(*", " ", "tensors", " ", "*)"}], "\[IndentingNewLine]", 
            "/.", 
            RowBox[{
             RowBox[{
              RowBox[{"tens_", "?", "xTensorQ"}], "[", "inds___", "]"}], ":>", 
             RowBox[{
              RowBox[{"ConfHead", "[", 
               RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
              RowBox[{"tens", "[", "inds", "]"}], "]"}]}]}], 
           "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{"Covariant", " ", "derivatives"}], " ", "*)"}], 
           "\[IndentingNewLine]", "/.", 
           RowBox[{
            RowBox[{"cd1", "[", 
             RowBox[{"i1_", "?", "DownIndexQ"}], "]"}], ":>", 
            RowBox[{"cd2", "[", "i1", "]"}]}]}], "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{
           "Now", " ", "that", " ", "we", " ", "have", " ", "ConfHead", " ", 
            "everywhere", " ", "we", " ", "need", " ", "to", " ", "remove", 
            " ", "the", " ", "head", " ", "by", " ", "specifying", " ", "the",
             " ", "change"}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{
           "First", " ", "Obvious", " ", "rules", " ", "for", " ", "metric", 
            " ", "and", " ", "inverse", " ", "metric"}], "*)"}], 
          "\[IndentingNewLine]", "/.", 
          RowBox[{
           RowBox[{
            RowBox[{"ConfHead", "[", 
             RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
            RowBox[{"metric1", "[", 
             RowBox[{
              RowBox[{"i1_", "?", "DownIndexQ"}], ",", 
              RowBox[{"i2_", "?", "DownIndexQ"}]}], "]"}], "]"}], ":>", 
           RowBox[{"metric2", "[", 
            RowBox[{"i1", ",", "i2"}], "]"}]}]}], "\[IndentingNewLine]", "/.", 
         RowBox[{
          RowBox[{
           RowBox[{"ConfHead", "[", 
            RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
           RowBox[{
            RowBox[{"Inv", "[", "metric1", "]"}], "[", 
            RowBox[{
             RowBox[{"i1_", "?", "UpIndexQ"}], ",", 
             RowBox[{"i2_", "?", "UpIndexQ"}]}], "]"}], "]"}], ":>", 
          RowBox[{
           RowBox[{"Inv", "[", "metric2", "]"}], "[", 
           RowBox[{"i1", ",", "i2"}], "]"}]}]}], ")"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "And", " ", "then", " ", "all", " ", "other", " ", "rules", " ", "to", 
        " ", "remove", " ", "the", " ", "ConfHead"}], "*)"}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"resbis", "=", 
       RowBox[{"res", "//.", 
        RowBox[{"RulesConf", "[", 
         RowBox[{"metric1", ",", "metric2"}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
        "So", " ", "here", " ", "we", " ", "have", " ", "conformally", " ", 
         "transformed", " ", "the", " ", "expression"}], ",", " ", 
        RowBox[{
         RowBox[{
          RowBox[{
          "but", " ", "now", " ", "we", " ", "want", " ", "to", " ", 
           "express", " ", "it", " ", "in", " ", "function", " ", "of", " ", 
           "the", " ", "original", " ", "metric", " ", "and", " ", "orginal", 
           " ", "covD", " ", "etc"}], "..."}], "\[IndentingNewLine]", 
         "Indeed", " ", "at", " ", "that", " ", "point"}], ",", " ", 
        RowBox[{
        "we", " ", "still", " ", "have", " ", "the", " ", "second", " ", 
         "metric"}], ",", " ", 
        RowBox[{
        "and", " ", "the", " ", "Riemann", " ", "of", " ", "the", " ", 
         "second", " ", "metric", " ", "for", " ", 
         RowBox[{"instance", ".", " ", "SO"}], " ", "we", " ", "use", " ", 
         "again", " ", "ToMetric"}]}], "*)"}], "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"$PrePrint", "=", "oldpre"}], ";"}], "*)"}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"On", "[", 
       RowBox[{"ConformalFactor", "::", "\"\<unknown\>\""}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Off", "[", 
       RowBox[{"ToCanonical", "::", "\"\<cmods\>\""}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"res2", "=", 
       RowBox[{"ToCanonical", "@", 
        RowBox[{"ContractMetric", "@", 
         RowBox[{"NoScalar", "[", 
          RowBox[{"ToMetric", "[", 
           RowBox[{"resbis", ",", "metricbase"}], "]"}], "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"On", "[", 
       RowBox[{"ToCanonical", "::", "\"\<cmods\>\""}], "]"}], ";", 
      "\[IndentingNewLine]", "res2"}]}], "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
    "In", " ", "case", " ", "the", " ", "base", " ", "metric", " ", "is", " ",
      "unspecified"}], ",", " ", 
    RowBox[{
     RowBox[{
     "it", " ", "is", " ", "the", " ", "base", " ", "metric", " ", "of", " ", 
      "course"}], "..."}]}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Conformal", "[", 
    RowBox[{
     RowBox[{"metric1_", "?", "MetricQ"}], ",", 
     RowBox[{"metric2_", "?", "MetricQ"}]}], "]"}], "[", "expr_", "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{"Conformal", "[", 
     RowBox[{"First", "@", "$Metrics"}], "]"}], "[", 
    RowBox[{"metric1", ",", "metric2"}], "]"}], "[", "expr", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 EmphasizeSyntaxErrors->True]
}, Closed]],

Cell[CellGroupData[{

Cell["Splitting in 1 + 1 + (n - 2) of covariant derivatives", "Subsubsection"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SplitPerturbations", "[", 
    RowBox[{"expr_", ",", "ListPairs_List", ",", 
     RowBox[{"h_", "?", "InducedMetricQ"}], ",", 
     RowBox[{"n_", "?", "DirectionVectorQ"}]}], "]"}], ":=", 
   RowBox[{"Print", "[", "\"\<Dobidoouah\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SplitPerturbations", "[", 
   RowBox[{"expr_", ",", 
    RowBox[{"h_", "?", "InducedMetricQ"}], ",", 
    RowBox[{"n_", "?", "DirectionVectorQ"}]}], "]"}], ":=", 
  RowBox[{"SplitPerturbations", "[", 
   RowBox[{"expr", ",", 
    RowBox[{"{", "}"}], ",", "h", ",", "n"}], "]"}]}], "\n", 
 RowBox[{
  RowBox[{"SetNumberOfArguments", "[", 
   RowBox[{"SplitPerturbations", ",", 
    RowBox[{"{", 
     RowBox[{"3", ",", "4"}], "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "SplitPerturbations", "]"}], ";"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[
 RowBox[{"SetNumberOfArguments", "[", 
  RowBox[{"SplitPerturbations", ",", 
   RowBox[{"{", 
    RowBox[{"3", ",", "4"}], "}"}]}], "]"}]], "Output"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Automatization of the whole process", "Subsubsection"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ToLightConeFromRules", "[", 
     RowBox[{"expr_", ",", "RulesList_List", ",", 
      RowBox[{"h_", "?", "InducedMetricQ"}], ",", 
      RowBox[{"n_", "?", "DirectionVectorQ"}], ",", "order_"}], 
     RowBox[{"(*", 
      RowBox[{"?", "IntegerQ"}], "*)"}], "]"}], ":=", 
    RowBox[{"Print", "[", "\"\<Dobidoouah\>\"", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetNumberOfArguments", "[", 
   RowBox[{"ToLightConeFromRules", ",", 
    RowBox[{"{", 
     RowBox[{"4", ",", "5"}], "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "ToLightConeFromRules", "]"}], ";"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[
 RowBox[{"SetNumberOfArguments", "[", 
  RowBox[{"ToLightConeFromRules", ",", 
   RowBox[{"{", 
    RowBox[{"4", ",", "5"}], "}"}]}], "]"}]], "Output"],

Cell[BoxData[
 RowBox[{"{", "\<\"ToLightConeFromRules\"\>", "}"}]], "Output"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Vizualization of the results", "Subsubsection"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ExtractComponents", "[", 
     RowBox[{"expr_", ",", 
      RowBox[{"h_", "?", "InducedMetricQ"}], ",", 
      RowBox[{"n_", "?", "DirectionVectorQ"}], ",", "roj_List", ",", 
      "ListIndsToContract_List"}], "]"}], ":=", 
    RowBox[{"Print", "[", "\"\<Dobidoouah\>\"", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetNumberOfArguments", "[", 
   RowBox[{"ExtractComponents", ",", 
    RowBox[{"{", 
     RowBox[{"3", ",", "5"}], "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Protect", "[", "ExtractComponents", "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"VisualizeTensor", "[", 
     RowBox[{"expr_", ",", 
      RowBox[{"h_", "?", "InducedMetricQ"}], ",", 
      RowBox[{"n_", "?", "DirectionVectorQ"}]}], "]"}], ":=", 
    RowBox[{"Print", "[", "\"\<Dobidoouah\>\"", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetNumberOfArguments", "[", 
   RowBox[{"VisualizeTensor", ",", "3"}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "VisualizeTensor", "]"}], ";"}]}], "Input",
 InitializationCell->True]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["End private and package",
 FontColor->RGBColor[0, 0, 1]]], "Subsubsection"],

Cell[BoxData[
 RowBox[{
  RowBox[{"On", "[", 
   RowBox[{"RuleDelayed", "::", "rhs"}], "]"}], ";"}]], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{"End", "[", "]"}], "\[IndentingNewLine]", 
 RowBox[{"EndPackage", "[", "]"}]}], "Input",
 InitializationCell->True],

Cell[BoxData["\<\"xAct`xLightCone`Private`\"\>"], "Output"]
}, Open  ]]
}, Closed]]
}, Open  ]]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
WindowSize->{1227, 756},
WindowMargins->{{Automatic, -84}, {Automatic, 0}},
PrivateNotebookOptions->{"FileOutlineCache"->False},
ShowSelection->True,
TrackCellChangeTimes->False,
Magnification->1,
FrontEndVersion->"9.0 for Mac OS X x86 (32-bit, 64-bit Kernel) (November 20, \
2012)",
StyleDefinitions->FrontEnd`FileName[{"Creative"}, "PastelColor.nb", 
  CharacterEncoding -> "UTF-8"]
]

