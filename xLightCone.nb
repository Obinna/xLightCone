Notebook[{

Cell[CellGroupData[{
Cell[TextData[{
 "       ",
 StyleBox["xLightCone",
  FontSize->36],
 StyleBox["    ",
  FontSize->24]
}], "Title",
 InitializationCell->True,
 FontSize->48],

Cell[CellGroupData[{

Cell["Authors", "Subsection",
 InitializationCell->True,
 FontSize->18],

Cell["\<\
Obinna Umeh & Cyril Pitrou
umeobinna@gmail.com
cyril.pitrou@ens-lyon.org
\
\>", "Text"],

Cell[CellGroupData[{

Cell["Dates and versions", "Subsubsection"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Date", "[", "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
  "2014", ",", "9", ",", "26", ",", "11", ",", "23", ",", 
   "43.964404`8.395676167486464"}], "}"}]], "Output"]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"xAct`xLightCone`$Version", "=", 
   RowBox[{"{", 
    RowBox[{"\"\<0.0.1\>\"", ",", 
     RowBox[{"{", 
      RowBox[{"2014", ",", "09", ",", "29"}], "}"}]}], "}"}]}], 
  ";"}]], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{"xAct`xLightCone`$xTensorVersionExpected", "=", 
   RowBox[{"{", 
    RowBox[{"\"\<1.1.1\>\"", ",", 
     RowBox[{"{", 
      RowBox[{"2014", ",", "9", ",", "28"}], "}"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"xAct`xLightCone`$xPertVersionExpected", "=", 
   RowBox[{"{", 
    RowBox[{"\"\<1.0.5\>\"", ",", 
     RowBox[{"{", 
      RowBox[{"2014", ",", "9", ",", "28"}], "}"}]}], "}"}]}], 
  ";"}]}], "Input",
 InitializationCell->True],

Cell["", "Text"]
}, Closed]]
}, Open  ]],

Cell[CellGroupData[{

Cell["1. Initialization", "Subsection",
 InitializationCell->True,
 FontColor->RGBColor[
  0.20389105058365758`, 0.38530556191348136`, 0.9685969329365988]],

Cell[CellGroupData[{

Cell["1.1. GPL", "Subsubsection"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{"xLightCone", ":"}], "  ", "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{"Copyright", " ", 
      RowBox[{"(", "C", ")"}], " ", "2015"}], "-", " ", 
     RowBox[{"Obinna", " ", "Umeh"}]}], ",", " ", 
    RowBox[{"Cyril", " ", "Pitrou"}]}], " ", "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{
     "This", " ", "program", " ", "is", " ", "free", " ", "software"}], ";", 
     " ", 
     RowBox[{"you", " ", "can", " ", "redistribute", " ", "it", " ", 
      RowBox[{"and", "/", "or"}], "\[IndentingNewLine]", " ", "modify", " ", 
      "it", " ", "under", " ", "the", " ", "terms", " ", "of", " ", "the", 
      " ", "GNU", " ", "General", " ", "Public", " ", "License", " ", "as", 
      "\[IndentingNewLine]", " ", "published", " ", "by", " ", "the", " ", 
      "Free", " ", "Software", " ", "Foundation"}], ";", " ", 
     RowBox[{
     "either", " ", "version", " ", "2", " ", "of", "\[IndentingNewLine]", 
      " ", "the", " ", "License"}]}], ",", 
    RowBox[{"or", " ", 
     RowBox[{"(", 
      RowBox[{"at", " ", "your", " ", "option"}], ")"}], " ", "any", " ", 
     "later", " ", 
     RowBox[{
     "version", ".", "\[IndentingNewLine]", "\[IndentingNewLine]", "This"}], 
     " ", "program", " ", "is", " ", "distributed", " ", "in", " ", "the", 
     " ", "hope", " ", "that", " ", "it", " ", "will", " ", "be", " ", 
     "useful"}], ",", "\[IndentingNewLine]", "  ", 
    RowBox[{
     RowBox[{"but", " ", "WITHOUT", " ", "ANY", " ", "WARRANTY"}], ";", " ", 
     RowBox[{
     "without", " ", "even", " ", "the", " ", "implied", " ", "warranty", " ",
       "of", "\[IndentingNewLine]", " ", "MERCHANTABILITY", " ", "or", " ", 
      "FITNESS", " ", "FOR", " ", "A", " ", "PARTICULAR", " ", 
      RowBox[{"PURPOSE", ".", " ", "See"}], " ", "the", " ", "GNU", 
      "\[IndentingNewLine]", " ", "General", " ", "Public", " ", "License", 
      " ", "for", " ", "more", " ", 
      RowBox[{
      "details", ".", "\[IndentingNewLine]", "\[IndentingNewLine]", "You"}], 
      " ", "should", " ", "have", " ", "received", " ", "a", " ", "copy", " ",
       "of", " ", "the", " ", "GNU", " ", "General", " ", "Public", " ", 
      "License", "\[IndentingNewLine]", " ", "along", " ", "with", " ", 
      "this", " ", "program"}], ";", " ", 
     RowBox[{"if", " ", "not"}]}], ",", " ", 
    RowBox[{
    "write", " ", "to", " ", "the", " ", "Free", " ", "Software", 
     "\[IndentingNewLine]", " ", "Foundation"}], ",", " ", 
    RowBox[{"Inc", "."}], ",", " ", 
    RowBox[{
     RowBox[{"59", " ", "Temple", " ", "Place"}], "-", 
     RowBox[{"Suite", " ", "330"}]}], ",", " ", "Boston", ",", " ", 
    RowBox[{
     RowBox[{"MA", " ", "02111"}], "-", "1307"}], ",", "\[IndentingNewLine]", 
    "  ", 
    RowBox[{"USA", "."}]}], " ", "\[IndentingNewLine]", "*)"}]}]], "Input",
 InitializationCell->True],

Cell["", "Text"]
}, Closed]],

Cell[CellGroupData[{

Cell["1.2. Info package", "Subsubsection"],

Cell["\<\
(* :Title: xLightCone *)

(* :Author: Obinna Umeh & Cyril Pitrou*)

(* :Context: xAct`xLightCone` *)

(* :Copyright: Obinna Umeh & Cyril Pitrou (2015-) *)

(* :Keywords: *)

(* :Source: xLightCone.nb *)

(* :Warning: *)

(* :Mathematica Version: 9.0 and later *)

(* :Limitations: *)\
\>", "Input",
 PageWidth->PaperWidth,
 CellMargins->{{60, -272}, {Inherited, Inherited}},
 InitializationCell->True],

Cell["", "Text"]
}, Closed]],

Cell[CellGroupData[{

Cell["1.3. Begin package", "Subsubsection"],

Cell["\<\

Decide what is the last package being read:\
\>", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"Unevaluated", "[", "xAct`xCore`Private`$LastPackage", "]"}], "===",
      "xAct`xCore`Private`$LastPackage"}], ",", 
    RowBox[{
    "xAct`xCore`Private`$LastPackage", "=", "\"\<xAct`xLightCone`\>\""}]}], 
   "]"}], ";"}]], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell[BoxData["xAct`xCore`Private`$LastPackage"], "Input"],

Cell[BoxData["\<\"xAct`xLightCone`\"\>"], "Output"]
}, Open  ]],

Cell["\<\

Explicit (not hidden) import of other packages:\
\>", "Text"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{"Off", "[", 
  StyleBox[
   RowBox[{"General", "::", "nostdvar"}], "MessageName"], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{"Off", "[", 
  StyleBox[
   RowBox[{"General", "::", "nostdopt"}], "MessageName"], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{"BeginPackage", "[", 
  RowBox[{"\"\<xAct`xLightCone`\>\"", ",", 
   RowBox[{"{", 
    RowBox[{
    "\"\<xAct`xPert`\>\"", ",", "\"\<xAct`xTensor`\>\"", ",", 
     "\"\<xAct`xPerm`\>\"", ",", "\"\<xAct`xCore`\>\"", ",", 
     "\"\<xAct`ExpressionManipulation`\>\""}], "}"}]}], "]"}]}], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell[BoxData["\<\"------------------------------------------------------------\
\"\>"], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"Package xAct`xPerm`  version \"\>", 
   "\[InvisibleSpace]", "\<\"1.2.1\"\>", "\[InvisibleSpace]", "\<\", \"\>", 
   "\[InvisibleSpace]", 
   RowBox[{"{", 
    RowBox[{"2014", ",", "2", ",", "15"}], "}"}]}],
  SequenceForm["Package xAct`xPerm`  version ", "1.2.1", ", ", {2014, 2, 15}],
  
  Editable->False]], "Print"],

Cell[BoxData["\<\"CopyRight (C) 2003-2014, Jose M. Martin-Garcia, under the \
General Public License.\"\>"], "Print"],

Cell[BoxData["\<\"Connecting to external linux executable...\"\>"], "Print"],

Cell[BoxData["\<\"Connection established.\"\>"], "Print"],

Cell[BoxData["\<\"------------------------------------------------------------\
\"\>"], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"Package xAct`xTensor`  version \"\>", 
   "\[InvisibleSpace]", "\<\"1.1.0\"\>", "\[InvisibleSpace]", "\<\", \"\>", 
   "\[InvisibleSpace]", 
   RowBox[{"{", 
    RowBox[{"2014", ",", "2", ",", "23"}], "}"}]}],
  SequenceForm[
  "Package xAct`xTensor`  version ", "1.1.0", ", ", {2014, 2, 23}],
  Editable->False]], "Print"],

Cell[BoxData["\<\"CopyRight (C) 2002-2014, Jose M. Martin-Garcia, under the \
General Public License.\"\>"], "Print"],

Cell[BoxData["\<\"------------------------------------------------------------\
\"\>"], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"Package xAct`xPert`  version \"\>", 
   "\[InvisibleSpace]", "\<\"1.0.4\"\>", "\[InvisibleSpace]", "\<\", \"\>", 
   "\[InvisibleSpace]", 
   RowBox[{"{", 
    RowBox[{"2014", ",", "2", ",", "15"}], "}"}]}],
  SequenceForm["Package xAct`xPert`  version ", "1.0.4", ", ", {2014, 2, 15}],
  
  Editable->False]], "Print"],

Cell[BoxData["\<\"CopyRight (C) 2005-2014, David Brizuela, Jose M. \
Martin-Garcia and Guillermo A. Mena Marugan, under the General Public \
License.\"\>"], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"** Variable \"\>", "\[InvisibleSpace]", "$PrePrint", 
   "\[InvisibleSpace]", "\<\" assigned value \"\>", "\[InvisibleSpace]", 
   "ScreenDollarIndices"}],
  SequenceForm[
  "** Variable ", $PrePrint, " assigned value ", 
   xAct`xTensor`ScreenDollarIndices],
  Editable->False]], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"** Variable \"\>", "\[InvisibleSpace]", "$CovDFormat", 
   "\[InvisibleSpace]", "\<\" changed from \"\>", 
   "\[InvisibleSpace]", "\<\"Prefix\"\>", "\[InvisibleSpace]", "\<\" to \"\>",
    "\[InvisibleSpace]", "\<\"Postfix\"\>"}],
  SequenceForm[
  "** Variable ", xAct`xTensor`$CovDFormat, " changed from ", "Prefix", 
   " to ", "Postfix"],
  Editable->False]], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"** Option \"\>", "\[InvisibleSpace]", "AllowUpperDerivatives", 
   "\[InvisibleSpace]", "\<\" of \"\>", "\[InvisibleSpace]", "ContractMetric",
    "\[InvisibleSpace]", "\<\" changed from \"\>", "\[InvisibleSpace]", 
   "False", "\[InvisibleSpace]", "\<\" to \"\>", "\[InvisibleSpace]", "True"}],
  SequenceForm[
  "** Option ", xAct`xTensor`AllowUpperDerivatives, " of ", 
   xAct`xTensor`ContractMetric, " changed from ", False, " to ", True],
  Editable->False]], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"** Option \"\>", "\[InvisibleSpace]", "MetricOn", 
   "\[InvisibleSpace]", "\<\" of \"\>", "\[InvisibleSpace]", "MakeRule", 
   "\[InvisibleSpace]", "\<\" changed from \"\>", "\[InvisibleSpace]", "None",
    "\[InvisibleSpace]", "\<\" to \"\>", "\[InvisibleSpace]", "All"}],
  SequenceForm[
  "** Option ", xAct`xTensor`MetricOn, " of ", xAct`xTensor`MakeRule, 
   " changed from ", None, " to ", All],
  Editable->False]], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"** Option \"\>", "\[InvisibleSpace]", "ContractMetrics", 
   "\[InvisibleSpace]", "\<\" of \"\>", "\[InvisibleSpace]", "MakeRule", 
   "\[InvisibleSpace]", "\<\" changed from \"\>", "\[InvisibleSpace]", 
   "False", "\[InvisibleSpace]", "\<\" to \"\>", "\[InvisibleSpace]", "True"}],
  SequenceForm[
  "** Option ", xAct`xTensor`ContractMetrics, " of ", xAct`xTensor`MakeRule, 
   " changed from ", False, " to ", True],
  Editable->False]], "Print"]
}, Open  ]],

Cell[BoxData["\<\"xAct`xLightCone`\"\>"], "Output"]
}, Open  ]],

Cell[TextData[{
 "\nCheck version of ",
 StyleBox["xTensor",
  FontSlant->"Italic"],
 ". We simply compare dates:"
}], "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{"Not", "@", 
     RowBox[{"OrderedQ", "@", 
      RowBox[{"Map", "[", 
       RowBox[{"Last", ",", 
        RowBox[{"{", 
         RowBox[{"$xTensorVersionExpected", ",", "xAct`xTensor`$Version"}], 
         "}"}]}], "]"}]}]}], ",", 
    RowBox[{"Throw", "@", 
     RowBox[{"Message", "[", 
      RowBox[{
       RowBox[{"General", "::", "versions"}], ",", "\"\<xTensor\>\"", ",", 
       "xAct`xTensor`$Version", ",", "$xTensorVersionExpected"}], "]"}]}]}], 
   "]"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"If", "[", 
  RowBox[{
   RowBox[{"Not", "@", 
    RowBox[{"OrderedQ", "@", 
     RowBox[{"Map", "[", 
      RowBox[{"Last", ",", 
       RowBox[{"{", 
        RowBox[{"$xPertVersionExpected", ",", "xAct`xPert`$Version"}], 
        "}"}]}], "]"}]}]}], ",", 
   RowBox[{"Throw", "@", 
    RowBox[{"Message", "[", 
     RowBox[{
      RowBox[{"General", "::", "versions"}], ",", "\"\<xPert\>\"", ",", 
      "xAct`xPert`$Version", ",", "$xPertVersionExpected"}], "]"}]}]}], 
  "]"}]}], "Input",
 InitializationCell->True],

Cell["\<\

Welcome message:\
\>", "Text"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"Print", "[", "xAct`xCore`Private`bars", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Print", "[", 
   RowBox[{"\"\<Package xAct`xLight`  version \>\"", ",", 
    RowBox[{"$Version", "[", 
     RowBox[{"[", "1", "]"}], "]"}], ",", "\"\<, \>\"", ",", 
    RowBox[{"$Version", "[", 
     RowBox[{"[", "2", "]"}], "]"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<CopyRight (C) 2015-, Obinna Umeh under the General Public \
License.\>\"", "]"}], ";"}]}], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell[BoxData["\<\"------------------------------------------------------------\
\"\>"], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"Package xAct`xLight`  version \"\>", 
   "\[InvisibleSpace]", "\<\"0.0.1\"\>", "\[InvisibleSpace]", "\<\", \"\>", 
   "\[InvisibleSpace]", 
   RowBox[{"{", 
    RowBox[{"2014", ",", "9", ",", "25"}], "}"}]}],
  SequenceForm["Package xAct`xLight`  version ", "0.0.1", ", ", {2014, 9, 25}],
  Editable->False]], "Print"],

Cell[BoxData["\<\"CopyRight (C) 2015-, Obinna Umeh under the General Public \
License.\"\>"], "Print"]
}, Open  ]]
}, Open  ]],

Cell["\<\

We specify the context xAct`xLightConce` to avoid overriding the Disclaimer \
of the other packages. However, we need to turn off the message General:shdw \
temporarily:\
\>", "Text"],

Cell[BoxData[{
 RowBox[{"Off", "[", 
  RowBox[{"General", "::", "shdw"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"xAct`xLightCone`Disclaimer", "[", "]"}], ":=", 
  RowBox[{
  "Print", "[", 
   "\"\<These are points 11 and 12 of the General Public \
License:\\n\\nBECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO \
WARRANTY FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW. EXCEPT \
WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES \
PROVIDE THE PROGRAM `AS IS\.b4 WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED \
OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF \
MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE ENTIRE RISK AS TO \
THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU. SHOULD THE PROGRAM \
PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING, REPAIR OR \
CORRECTION.\\n\\nIN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO \
IN WRITING WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY \
AND/OR REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR \
DAMAGES, INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES \
ARISING OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT \
LIMITED TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED \
BY YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER \
PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE \
POSSIBILITY OF SUCH DAMAGES.\>\"", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{"On", "[", 
  RowBox[{"General", "::", "shdw"}], "]"}]}], "Input",
 InitializationCell->True],

Cell["\<\

If this is the last package show the GPL short disclaimer:\
\>", "Text"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
    "xAct`xCore`Private`$LastPackage", "===", "\"\<xAct`xLightCone`\>\""}], 
    ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Unset", "[", "xAct`xCore`Private`$LastPackage", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "xAct`xCore`Private`bars", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
     "Print", "[", 
      "\"\<These packages come with ABSOLUTELY NO WARRANTY; for details type \
Disclaimer[]. This is free software, and you are welcome to redistribute it \
under certain conditions. See the General Public License for details.\>\"", 
      "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "xAct`xCore`Private`bars", "]"}]}]}], "]"}], 
  ";"}]], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell[BoxData["\<\"------------------------------------------------------------\
\"\>"], "Print"],

Cell[BoxData["\<\"These packages come with ABSOLUTELY NO WARRANTY; for \
details type Disclaimer[]. This is free software, and you are welcome to \
redistribute it under certain conditions. See the General Public License for \
details.\"\>"], "Print"],

Cell[BoxData["\<\"------------------------------------------------------------\
\"\>"], "Print"]
}, Open  ]]
}, Open  ]],

Cell["\<\

Note that symbols in the Global` context cannot be accessed while building \
the package:\
\>", "Text"],

Cell[CellGroupData[{

Cell[BoxData["$ContextPath"], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"\<\"xAct`xLightCone`\"\>", ",", "\<\"xAct`xPert`\"\>", 
   ",", "\<\"xAct`xTensor`\"\>", ",", "\<\"xAct`xPerm`\"\>", 
   ",", "\<\"xAct`xCore`\"\>", ",", "\<\"xAct`ExpressionManipulation`\"\>", 
   ",", "\<\"System`\"\>"}], "}"}]], "Output"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData["$Context"], "Input"],

Cell[BoxData["\<\"xAct`xLightCone`\"\>"], "Output"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["1.4. Set up", "Subsubsection"],

Cell["\<\

Prefix format for derivatives:\
\>", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"$CovDFormat", "=", "\"\<Prefix\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Message", "[", 
   RowBox[{
    RowBox[{"General", "::", "nostdvar"}], ",", "\"\<$CovDFormat\>\"", ",", 
    "\"\<Prefix\>\""}], "]"}], ";"}]}], "Input",
 InitializationCell->True],

Cell["\<\

We do not modify the option MathLink of CanonicalPerm:\
\>", "Text"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Options", "[", "CanonicalPerm", "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"MathLink", "\[RuleDelayed]", "$xpermQ"}], ",", 
   RowBox[{"TimeVerbose", "\[Rule]", "False"}], ",", 
   RowBox[{"xPermVerbose", "\[Rule]", "False"}], ",", 
   RowBox[{"OrderedBase", "\[Rule]", "True"}]}], "}"}]], "Output"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData["$xpermQ"], "Input"],

Cell[BoxData["True"], "Output"]
}, Open  ]],

Cell["", "Text"]
}, Closed]],

Cell[CellGroupData[{

Cell["1.5. Usage and error messages", "Subsubsection"],

Cell["\<\

Versions:\
\>", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{"**", " ", "VERSIONS"}], " ", "***)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"$Version", "::", "usage"}], "=", 
     "\"\<$Version is a global variable giving the version of the package \
xLightCone in use.\>\""}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"$xTensorVersionExpected", "::", "usage"}], "=", 
     "\"\<$xTensorVersionExpected is a global variable giving the oldest \
possible version of the package xTensor which is required by the version of \
the package xLightCone in use.\>\""}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"$xPertVersionExpected", "::", "usage"}], "=", 
     "\"\<$xPertVersionExpected is a global variable giving the oldest \
possible version of the package xPert which is required by the version of the \
package xLightCone in use.\>\""}], ";"}]}]}]], "Input",
 InitializationCell->True],

Cell["Usage Messages in Alphabetic order", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"DefMatterFields", "::", "usage"}], "  ", "=", " ", "\"\<\>\""}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"DefMetricFields", "::", "usage"}], " ", "=", " ", "\"\<\>\""}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"DefScreenProjecteTensor", "::", "usage"}], " ", "=", " ", 
    "\"\<\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"SetSlicingUpToScreenSpace", "::", "usage"}], " ", "=", " ", 
    "\"\<\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"SplitMetric", " ", "::", "usage"}], " ", "=", " ", "\"\<\>\""}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ToLightConeFromRules", "::", "usage"}], " ", "=", " ", 
   "\"\<\>\""}], ";"}]}], "Input",
 InitializationCell->True]
}, Open  ]],

Cell[CellGroupData[{

Cell["1.6. Begin private", "Subsubsection"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Begin", "[", "\"\<xAct`xLightCone`Private`\>\"", "]"}]], "Input",
 InitializationCell->True],

Cell[BoxData["\<\"xAct`xLightCone`Private`\"\>"], "Output"]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "*", "Why", " ", "a", " ", "scalar", " ", "head", " ", "inside", " ", "a", 
    " ", "scalar", " ", 
    RowBox[{"function", "?"}]}], "**)"}], 
  RowBox[{"(*", 
   RowBox[{
   "*", "We", " ", "choose", " ", "that", " ", "the", " ", "Scalar", " ", 
    "head", " ", "should", " ", "be", " ", "removed"}], "**)"}], 
  RowBox[{
   RowBox[{
    RowBox[{"Unprotect", "[", "xAct`xTensor`NoScalar", "]"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"xAct`xTensor`NoScalar", "[", 
     RowBox[{
      RowBox[{"f_", "?", "ScalarFunctionQ"}], "[", "expr_", "]"}], "]"}], ":=", 
    RowBox[{"f", "[", 
     RowBox[{"NoScalar", "@", "expr"}], "]"}]}], "\n", 
   RowBox[{
    RowBox[{"Protect", "[", "xAct`xTensor`NoScalar", "]"}], ";"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
    "*", "To", " ", "avoid", " ", "complaints", " ", "from", " ", "MakeRule", 
     " ", "when", " ", "the", " ", "rule", " ", "has", " ", "already", " ", 
     "been", " ", "defined", " ", "and", " ", "the", " ", "lhs", " ", "is", 
     " ", 
     RowBox[{"zero", "."}]}], "**)"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"xAct`xTensor`MakeRule", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"lhs_", "?", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{
              RowBox[{"Evaluate", "[", "#", "]"}], "===", "0"}], "&"}], 
            ")"}]}], ",", "rhs_", ",", "conditions___"}], "}"}], ",", 
        RowBox[{"options", ":", 
         RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
      RowBox[{"{", "}"}]}], ";"}], "*)"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
     "We", " ", "create", " ", "our", " ", "own", " ", "function", " ", 
      "based", " ", "on", " ", "MakeRule"}], ",", 
     RowBox[{
     "but", " ", "separating", " ", "the", " ", "special", " ", "problematic",
       " ", 
      RowBox[{"case", ".", "This"}], " ", "avoids", " ", "overloading", " ", 
      "a", " ", "definition", " ", "from", " ", 
      RowBox[{"xTensor", ".", "It"}], " ", "does", " ", "not", " ", "change", 
      " ", "the", " ", "way", " ", "xLightCone", " ", "works"}], ",", 
     RowBox[{"but", " ", "that", " ", "way"}], ",", 
     RowBox[{
     "the", " ", "code", " ", "is", " ", "clearly", " ", "separated", " ", 
      "from", " ", 
      RowBox[{"xTensor", ".", "This"}], " ", "is", " ", "a", " ", "much", " ",
       "more", " ", "polite", " ", "way", " ", "to", " ", "modify", " ", 
      "the", " ", "behaviour", " ", "of", " ", 
      RowBox[{"xTensor", ".", "This"}], " ", "method", " ", "was", " ", 
      "advised", " ", "by", " ", "Leo", " ", "Stein"}]}], "**)"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"SetAttributes", "[", 
    RowBox[{"BuildRule", ",", "HoldFirst"}], "]"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"BuildRule", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"lhs_", "?", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{
             RowBox[{"Evaluate", "[", "#", "]"}], "===", "0"}], "&"}], 
           ")"}]}], ",", "rhs_", ",", "conditions___"}], "}"}], ",", 
       RowBox[{"options", ":", 
        RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
     RowBox[{"{", "}"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"BuildRule", "[", 
      RowBox[{"{", 
       RowBox[{"lhs_", ",", "rhs_", ",", "conditions___"}], "}"}], "]"}], ":=", 
     RowBox[{"MakeRule", "[", 
      RowBox[{"{", 
       RowBox[{"lhs", ",", "rhs", ",", "conditions"}], "}"}], "]"}]}], ";"}], 
   "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"BuildRule", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"lhs_", ",", "rhs_", ",", "conditions___"}], "}"}], ",", 
       RowBox[{"options", ":", 
        RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
     RowBox[{"MakeRule", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"lhs", ",", "rhs", ",", "conditions"}], "}"}], ",", 
       "options"}], "]"}]}], ";"}]}]}]], "Input"],

Cell["Default options and protected names", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"**", "DEFAULT"}], " ", "OPTIONS", " ", "AND", " ", "PROTECTED", 
    " ", "NAMES"}], "***)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "We", " ", "should", " ", "clean", " ", "that", " ", "to", " ", "make", 
    " ", "sure", " ", "there", " ", "are", " ", "no", " ", "usueless", " ", 
    "definitions"}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"BackgroundFieldMethod", "=", "False"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"$DebugInfoQ", "=", "False"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"$CommutecdRules", "=", 
     RowBox[{"{", "}"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"$ConformalTime", "=", "True"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"$FirstOrderVectorPerturbations", "=", "True"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"$FirstOrderTensorPerturbations", "=", "True"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"$OpenConstantsOfStructure", "=", "True"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"$PrePrint", "=", "ScreenDollarIndices"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"$SortCovDAutomatic", "=", "True"}], ";"}], "\[IndentingNewLine]",
    "\n", 
   RowBox[{
    RowBox[{"Off", "[", 
     RowBox[{"RuleDelayed", "::", "rhs"}], "]"}], ";"}]}]}]], "Input"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Implementation", "Subsection"],

Cell[CellGroupData[{

Cell["Miscellaneous tools ", "Subsubsection"],

Cell["Private Boolean function inherited from xPand", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"**", "PRIVATE"}], " ", "BOOLEAN", " ", "FUNCTIONS"}], "***)"}], 
  RowBox[{"(*", 
   RowBox[{"*", "Miscellaneous"}], "**)"}], 
  RowBox[{
   RowBox[{
    RowBox[{"$DefInfoQ", "=", "True"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"If", " ", "set", " ", 
      RowBox[{"to", "'"}], 
      RowBox[{"False", "'"}]}], ",", 
     RowBox[{
     "the", " ", "information", " ", "messages", " ", "are", " ", "not", " ", 
      
      RowBox[{"printed", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"*", "Testing", " ", "expressions"}], "**)"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"AnyIndicesListQ", "[", "inds_List", "]"}], ":=", 
    RowBox[{
     RowBox[{"Cases", "[", 
      RowBox[{"inds", ",", 
       RowBox[{"AnyIndices", "[", "_", "]"}]}], "]"}], "=!=", 
     RowBox[{"{", "}"}]}]}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
     "If", " ", "the", " ", "list", " ", "of", " ", "indices", " ", 
      "contains", " ", "the", " ", 
      RowBox[{"head", "'"}], 
      RowBox[{"AnyIndices", "'"}]}], ",", 
     RowBox[{
      RowBox[{"then", " ", 
       RowBox[{"AnyIndicesListQ", "[", "inds", "]"}], " ", 
       RowBox[{"returns", "'"}], 
       RowBox[{"True", "'"}]}], ";", 
      RowBox[{"otherwise", " ", "it", " ", 
       RowBox[{"returns", "'"}], 
       RowBox[{
        RowBox[{"False", "'"}], "."}]}]}]}], "*)"}], "\[IndentingNewLine]", 
   "\n", 
   RowBox[{
    RowBox[{"DefTensorQ", "[", "symb_", "]"}], ":=", 
    RowBox[{
     RowBox[{"Cases", "[", 
      RowBox[{"$Tensors", ",", "symb"}], "]"}], "===", 
     RowBox[{"{", "symb", "}"}]}]}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "'"}], 
      RowBox[{"symb", "'"}], " ", "has", " ", "been", " ", "defined", " ", 
      "as", " ", "a", " ", "tensor"}], ",", 
     RowBox[{
      RowBox[{"then", " ", 
       RowBox[{"DefTensorQ", "[", "symb", "]"}], " ", 
       RowBox[{"returns", "'"}], 
       RowBox[{"True", "'"}]}], ";", 
      RowBox[{"otherwise", " ", "it", " ", 
       RowBox[{"returns", "'"}], 
       RowBox[{
        RowBox[{"False", "'"}], "."}]}]}]}], "*)"}], "\[IndentingNewLine]", 
   "\n", 
   RowBox[{
    RowBox[{"GaugeQ", "[", "strg_", "]"}], ":=", 
    RowBox[{
     RowBox[{"Cases", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "\"\<AnyGauge\>\"", ",", "\"\<ComovingGauge\>\"", ",", 
         "\"\<FlatGauge\>\"", ",", "\"\<IsoDensityGauge\>\"", ",", 
         "\"\<NewtonGauge\>\"", ",", "\"\<SynchronousGauge\>\""}], "}"}], ",",
        "strg"}], "]"}], "===", 
     RowBox[{"{", "strg", "}"}]}]}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "'"}], 
      RowBox[{"strg", "'"}], " ", "matches", " ", "one", " ", "of", " ", 
      "the", " ", "element", " ", "in", " ", "the", " ", "list"}], ",", 
     RowBox[{
      RowBox[{"then", " ", 
       RowBox[{"GaugeQ", "[", "strg", "]"}], " ", 
       RowBox[{"returns", "'"}], 
       RowBox[{"True", "'"}]}], ";", 
      RowBox[{"otherwise", " ", "it", " ", 
       RowBox[{"returns", "'"}], 
       RowBox[{
        RowBox[{"False", "'"}], "."}]}]}]}], "*)"}], "\[IndentingNewLine]", 
   "\n", 
   RowBox[{
    RowBox[{"InducedMetricQ", "[", "symb_", "]"}], ":=", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"MetricQ", "[", "symb", "]"}], ",", 
      RowBox[{
       RowBox[{"InducedFrom", "[", "symb", "]"}], "=!=", "Null"}], ",", 
      "False"}], "]"}]}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "'"}], 
      RowBox[{"symb", "'"}], " ", "is", " ", "not", " ", "defined", " ", "as",
       " ", "a", " ", "metric"}], ",", 
     RowBox[{"then", " ", 
      RowBox[{"InducedMetricQ", "[", "symb", "]"}], " ", 
      RowBox[{"returns", "'"}], 
      RowBox[{
       RowBox[{"False", "'"}], ".", "Otherwise"}]}], ",", 
     RowBox[{"it", " ", "checks", " ", 
      RowBox[{"whether", "'"}], 
      RowBox[{"symb", "'"}], " ", "is", " ", "an", " ", "induced", " ", 
      RowBox[{"metric", ".", "If"}], " ", "this", " ", "is", " ", "the", " ", 
      "case"}], ",", 
     RowBox[{
      RowBox[{"then", " ", 
       RowBox[{"InducedMetricQ", "[", "symb", "]"}], " ", 
       RowBox[{"gives", "'"}], 
       RowBox[{"True", "'"}]}], ";", 
      RowBox[{"otherwise", " ", "it", " ", 
       RowBox[{"gives", "'"}], 
       RowBox[{
        RowBox[{"False", "'"}], "."}]}]}]}], "*)"}], "\[IndentingNewLine]", 
   "\n", 
   RowBox[{
    RowBox[{"SpaceTimeQ", "[", "strg_", "]"}], ":=", 
    RowBox[{
     RowBox[{"Cases", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "\"\<Anisotropic\>\"", ",", "\"\<BianchiB\>\"", ",", 
         "\"\<BianchiA\>\"", ",", "\"\<BianchiI\>\"", ",", "\"\<FLCurved\>\"",
          ",", "\"\<FLFlat\>\"", ",", "\"\<Minkowski\>\""}], "}"}], ",", 
       "strg"}], "]"}], "===", 
     RowBox[{"{", "strg", "}"}]}]}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"If", "'"}], 
      RowBox[{"strg", "'"}], " ", "matches", " ", "one", " ", "of", " ", 
      "the", " ", "element", " ", "of", " ", "the", " ", "list"}], ",", 
     RowBox[{
      RowBox[{"then", " ", 
       RowBox[{"SpaceTimeQ", "[", "strg", "]"}], " ", 
       RowBox[{"returns", "'"}], 
       RowBox[{"True", "'"}]}], ";", 
      RowBox[{"otherwise", " ", "it", " ", 
       RowBox[{"returns", "'"}], 
       RowBox[{
        RowBox[{"False", "'"}], "."}]}]}]}], "*)"}], "\[IndentingNewLine]", 
   "\n", 
   RowBox[{
    RowBox[{"TensorNullQ", "[", "tens_", "]"}], ":=", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Cases", "[", 
        RowBox[{
         RowBox[{"SlotsOfTensor", "[", "tens", "]"}], ",", "Labels"}], "]"}], 
       "=!=", 
       RowBox[{"{", "}"}]}], ",", 
      RowBox[{"Print", "[", 
       RowBox[{
       "\"\<** Warning: the function TensorNullQ is only suited to test \
tensors defined without label-indices. \>\"", ",", "tens"}], "]"}], ",", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"inds", "=", 
          RowBox[{"DummyIn", "/@", 
           RowBox[{"SlotsOfTensor", "[", "tens", "]"}]}]}], "}"}], ",", 
        RowBox[{
         RowBox[{"tens", "@@", "inds"}], "===", "0"}]}], "]"}]}], "]"}]}], 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"TensorNullQ", "[", "tens", "]"}], " ", 
      RowBox[{"returns", "'"}], 
      RowBox[{"True", "'"}], " ", 
      RowBox[{"if", "'"}], 
      RowBox[{"tens", "'"}], " ", "is", " ", "a", " ", "null", " ", "tensor", 
      " ", 
      RowBox[{"and", "'"}], 
      RowBox[{"False", "'"}], " ", 
      RowBox[{"otherwise", ".", "This"}], " ", "function", " ", "is", " ", 
      "not", " ", "suited", " ", "to", " ", "test", " ", "tensors", " ", 
      "defined", " ", "with", " ", "label"}], "-", 
     RowBox[{"indices", "."}]}], "*)"}], "\n", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"*", "Type", " ", "of", " ", "manifolds"}], "**)"}], 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
    "Will", " ", "probably", " ", "disappear", " ", "since", " ", "we", " ", 
     "will", " ", "only", " ", "do", " ", "curved", " ", "and", " ", "flat", 
     " ", "FL"}], " ", "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"BianchiBool", "[", "Spacetype_", "]"}], ":=", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"Spacetype", "===", "\"\<BianchiB\>\""}], "||", 
      RowBox[{"Spacetype", "===", "\"\<BianchiA\>\""}], "||", 
      RowBox[{"Spacetype", "===", "\"\<BianchiI\>\""}]}], ")"}]}], "\n", 
   RowBox[{
    RowBox[{"FlatSpaceBool", "[", "Spacetype_", "]"}], ":=", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"Spacetype", "===", "\"\<BianchiI\>\""}], "||", 
      RowBox[{"Spacetype", "===", "\"\<FLFlat\>\""}], "||", 
      RowBox[{"Spacetype", "===", "\"\<Minkowski\>\""}]}], ")"}]}], "\n", 
   RowBox[{
    RowBox[{"NoAnisotropyBool", "[", "Spacetype_", "]"}], ":=", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"Spacetype", "===", "\"\<FLCurved\>\""}], "||", 
      RowBox[{"Spacetype", "===", "\"\<FLFlat\>\""}], "||", 
      RowBox[{"Spacetype", "===", "\"\<Minkowski\>\""}]}], ")"}]}], "\n", 
   RowBox[{
    RowBox[{"AnisotropyBool", "[", "Spacetype_", "]"}], ":=", 
    RowBox[{"(", 
     RowBox[{"Spacetype", "===", "\"\<Anisotropic\>\""}], ")"}]}], "\n", 
   RowBox[{"(*", 
    RowBox[{"The", " ", 
     RowBox[{"name", "'"}], 
     RowBox[{"AnisotropyBool", "'"}], " ", "should", " ", "be", " ", 
     RowBox[{"changed", "."}]}], "*)"}]}]}]], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["Slicing in 1 + 1 + (n - 2)", "Subsubsection"],

Cell["\<\
I am trying to modify SetSlicing to include decomposition on the ScreenSpace. \
I have changed the name but it is mainly composed on 
SetSlicing functionalities. \
\>", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"DirectionVectorQ", "[", "expr_", "]"}], ":=", "False"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SetSlicingUpToScreenSpace", "[", 
    RowBox[{
     RowBox[{"g_", "?", "MetricQ"}], ",", "u_", ",", 
     RowBox[{"normu_:", "-", "1"}], ",", "h_", ",", "cd_", ",", 
     RowBox[{"{", 
      RowBox[{"cdpost_String", ",", "cdpre_String"}], "}"}], ",", "n_", ",", 
     RowBox[{"normn_:", "1"}], ",", "NSS_", ",", "cd2_", ",", 
     RowBox[{"{", 
      RowBox[{"cd2post_String", ",", "cd2pre_String"}], "}"}]}], "]"}], ":=", 
   
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "m", ",", "p", ",", "q", ",", "DummyS", ",", "DummyV", ",", "DummyT", 
       ",", "ui", ",", "indsdimminustwo", ",", "indsdim", ",", "dim", ",", 
       "prot", ",", "Silenth"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"With", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"Manifold", "=", 
          RowBox[{"ManifoldOfCovD", "@", 
           RowBox[{"CovDOfMetric", "[", "g", "]"}]}]}], ",", 
         RowBox[{"CD", "=", 
          RowBox[{"CovDOfMetric", "[", "g", "]"}]}]}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"dim", "=", 
         RowBox[{"DimOfManifold", "[", "Manifold", "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"With", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"ind1", "=", 
             RowBox[{"DummyIn", "[", 
              RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
            RowBox[{"ind2", "=", 
             RowBox[{"DummyIn", "[", 
              RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
            RowBox[{"ind3", "=", 
             RowBox[{"DummyIn", "[", 
              RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
            RowBox[{"ind4", "=", 
             RowBox[{"DummyIn", "[", 
              RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
            RowBox[{"ind5", "=", 
             RowBox[{"DummyIn", "[", 
              RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
            RowBox[{"ind6", "=", 
             RowBox[{"DummyIn", "[", 
              RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
            RowBox[{"ind7", "=", 
             RowBox[{"DummyIn", "[", 
              RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
            RowBox[{"i1", "=", 
             RowBox[{"DummyIn", "[", 
              RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
            RowBox[{"i2", "=", 
             RowBox[{"DummyIn", "[", 
              RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
            RowBox[{"i3", "=", 
             RowBox[{"DummyIn", "[", 
              RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
            RowBox[{"i4", "=", 
             RowBox[{"DummyIn", "[", 
              RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
            RowBox[{"i5", "=", 
             RowBox[{"DummyIn", "[", 
              RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}], ",", 
            RowBox[{"dummy", "=", 
             RowBox[{"DummyIn", "[", 
              RowBox[{"Tangent", "[", "Manifold", "]"}], "]"}]}]}], "}"}], 
          ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"DefTensor", "[", 
             RowBox[{
              RowBox[{"u", "[", 
               RowBox[{"-", "ind1"}], "]"}], ",", 
              RowBox[{"{", "Manifold", "}"}], ",", 
              RowBox[{"PrintAs", "\[Rule]", 
               RowBox[{"\"\<\\!\\(\>\"", "<>", 
                RowBox[{"ToString", "[", "ind1", "]"}], "<>", 
                "\"\<\\&-\\)\>\""}]}]}], "]"}], "\n", "        ", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{"Induced", " ", "Metric"}], " ", "*)"}], 
            "\[IndentingNewLine]", 
            RowBox[{"Off", "[", 
             RowBox[{"DefMetric", "::", "old"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"DefMetric", "[", 
            RowBox[{"1", ",", 
             RowBox[{"h", "[", 
              RowBox[{
               RowBox[{"-", "ind1"}], ",", 
               RowBox[{"-", "ind2"}]}], "]"}], ",", "cd", ",", 
             RowBox[{"{", 
              RowBox[{"cdpost", ",", "cdpre"}], "}"}], ",", 
             RowBox[{"InducedFrom", "\[Rule]", 
              RowBox[{"{", 
               RowBox[{"g", ",", "u"}], "}"}]}], ",", 
             RowBox[{"PrintAs", "\[Rule]", 
              RowBox[{"\"\<\\!\\(\>\"", "<>", 
               RowBox[{"ToString", "[", "h", "]"}], "<>", 
               "\"\<\\&-\\)\>\""}]}]}], "]"}], ";", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{"Another", " ", "induced", " ", "metric"}], ",", " ", 
             RowBox[{
             "I", " ", "used", " ", "the", " ", "cd", " ", "for", " ", "the", 
              " ", "angular", " ", "derivative"}], ",", " ", 
             RowBox[{
             "it", " ", "is", " ", "cheating", " ", "I", " ", "will", " ", 
              "sort", " ", "it", " ", "later"}]}], "*)"}], 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"DefTensor", "[", 
            RowBox[{
             RowBox[{"n", "[", 
              RowBox[{"-", "ind1"}], "]"}], ",", 
             RowBox[{"{", "Manifold", "}"}], ",", 
             RowBox[{"OrthogonalTo", "\[Rule]", 
              RowBox[{"{", 
               RowBox[{"u", "[", "ind1", "]"}], "}"}]}], ",", 
             RowBox[{"ProjectedWith", "\[Rule]", 
              RowBox[{"{", 
               RowBox[{"h", "[", 
                RowBox[{"ind1", ",", 
                 RowBox[{"-", "ind2"}]}], "]"}], "}"}]}], ",", 
             RowBox[{"PrintAs", "\[Rule]", 
              RowBox[{"\"\<\\!\\(\>\"", "<>", 
               RowBox[{"ToString", "[", "n", "]"}], "<>", 
               "\"\<\\&-\\)\>\""}]}]}], "]"}], ";", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"DirectionVectorQ", "[", "n", "]"}], "=", "True"}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
             RowBox[{
              RowBox[{
              "I", " ", "use", " ", "NSS", " ", "as", " ", "the", " ", 
               "screen", " ", "space", " ", "metric", " ", "because", " ", 
               "the", " ", "Silent", " ", "metric", " ", "is", " ", "3"}], 
              "-", "D"}], ",", " ", 
             RowBox[{
             "I", " ", "will", " ", "clean", " ", "up", " ", "these", " ", 
              "later"}]}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{"CP", ":", " ", 
             RowBox[{
             "OK", " ", "Obinna", " ", "I", " ", "see", " ", "what", " ", 
              "you", " ", 
              RowBox[{"do", " ", "!"}]}]}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{"DefTensor", "[", 
            RowBox[{
             RowBox[{"NSS", "[", 
              RowBox[{
               RowBox[{"-", "ind1"}], ",", 
               RowBox[{"-", "ind2"}]}], "]"}], ",", 
             RowBox[{"{", "Manifold", "}"}], ",", 
             RowBox[{"Symmetric", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"-", "ind1"}], ",", 
                RowBox[{"-", "ind2"}]}], "}"}], "]"}], ",", 
             RowBox[{"OrthogonalTo", "\[Rule]", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"u", "[", "ind1", "]"}], ",", 
                RowBox[{"u", "[", "ind2", "]"}], ",", 
                RowBox[{"n", "[", "ind1", "]"}], ",", 
                RowBox[{"n", "[", "ind2", "]"}]}], "}"}]}], ",", 
             RowBox[{"ProjectedWith", "\[Rule]", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"h", "[", 
                 RowBox[{"ind1", ",", 
                  RowBox[{"-", "ind4"}]}], "]"}], ",", 
                RowBox[{"h", "[", 
                 RowBox[{"ind2", ",", 
                  RowBox[{"-", "ind5"}]}], "]"}]}], 
               RowBox[{"(*", 
                RowBox[{",", 
                 RowBox[{"NSS", "[", 
                  RowBox[{"ind1", ",", 
                   RowBox[{"-", "ind4"}]}], "]"}], ",", 
                 RowBox[{"NSS", "[", 
                  RowBox[{"ind2", ",", 
                   RowBox[{"-", "ind5"}]}], "]"}]}], "*)"}], "}"}]}], ",", 
             RowBox[{"PrintAs", "\[Rule]", 
              RowBox[{"\"\<\\!\\(\>\"", "<>", 
               RowBox[{"ToString", "[", "NSS", "]"}], "<>", 
               "\"\<\\&-\\)\>\""}]}]}], "]"}], ";", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
             RowBox[{
             "So", " ", "let", " ", "me", " ", "try", " ", "to", " ", 
              "define", " ", "separately", " ", "the", " ", "CovD"}], ",", 
             " ", 
             RowBox[{
             "So", " ", "That", " ", "I", " ", "suppress", " ", "this", " ", 
              "definition"}]}], " ", "*)"}], "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{"DefMetric", "[", 
              RowBox[{"1", ",", 
               RowBox[{"Silenth", "[", 
                RowBox[{
                 RowBox[{"-", "ind1"}], ",", 
                 RowBox[{"-", "ind2"}]}], "]"}], ",", "cd2", ",", 
               RowBox[{"{", 
                RowBox[{"cd2post", ",", "cd2pre"}], "}"}], ",", 
               RowBox[{"InducedFrom", "\[Rule]", 
                RowBox[{"{", 
                 RowBox[{"g", ",", "n"}], "}"}]}], ",", 
               RowBox[{"PrintAs", "\[Rule]", 
                RowBox[{"\"\<\\!\\(\>\"", "<>", 
                 RowBox[{"ToString", "[", "h", "]"}], "<>", 
                 "\"\<\\&-\\)\>\""}]}]}], "]"}], ";"}], "*)"}], 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{"CP", ":", " ", 
             RowBox[{
             "Let", " ", "me", " ", "try", " ", "this", " ", "implementation",
               " ", "for", " ", "the", " ", "CovD", " ", "twice", " ", 
              "projected"}]}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
            "This", " ", "seems", " ", "cleaner", " ", "than", " ", "to", " ",
              "define", " ", "a", " ", "Silent", " ", 
             RowBox[{"Metric", "."}]}], "*)"}], "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"DefCovD", "[", 
            RowBox[{
             RowBox[{"cd2", "[", 
              RowBox[{"-", "ind1"}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"cd2post", ",", "cd2pre"}], "}"}]}], "]"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"cd2", "[", "ind1_", "]"}], "[", 
             RowBox[{"NSS", "[", 
              RowBox[{"ind2_", ",", "ind3_"}], "]"}], "]"}], ":=", "0"}], ";",
            "\[IndentingNewLine]", 
           RowBox[{"AutomaticRules", "[", 
            RowBox[{"NSS", ",", 
             RowBox[{"MakeRule", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"NSS", "[", 
                  RowBox[{"ind1", ",", "ind2"}], "]"}], " ", 
                 RowBox[{"n", "[", 
                  RowBox[{"-", "ind2"}], "]"}]}], ",", "0"}], "}"}], "]"}]}], 
            "]"}], ";", "\[IndentingNewLine]", 
           RowBox[{"AutomaticRules", "[", 
            RowBox[{"NSS", ",", 
             RowBox[{"MakeRule", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"NSS", "[", 
                  RowBox[{"ind1", ",", "ind2"}], "]"}], " ", 
                 RowBox[{"u", "[", 
                  RowBox[{"-", "ind2"}], "]"}]}], ",", "0"}], "}"}], "]"}]}], 
            "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{
             "I", " ", "used", " ", "AutomaticRule", " ", "to", " ", "assign",
               " ", "rules", " ", "to", " ", "NSS"}], "..."}], "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{"Well", " ", "it", " ", 
             RowBox[{"doesn", "'"}], "t", " ", "work", " ", "well"}], "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{
              RowBox[{"NSS", "[", 
               RowBox[{
                RowBox[{"-", "ind1"}], ",", 
                RowBox[{"-", "ind2"}]}], "]"}], "^:=", 
              RowBox[{"2", "/;", 
               RowBox[{
                RowBox[{"ind1", "+", "ind2"}], "\[Equal]", "0"}]}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"NSS", "[", 
                RowBox[{
                 RowBox[{"-", "ind1"}], ",", 
                 RowBox[{"-", "ind2"}]}], "]"}], 
               RowBox[{"NSS", "[", 
                RowBox[{"ind1", ",", "ind2"}], "]"}]}], "^:=", "2"}], ";"}], 
            "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{"AutomaticRules", "[", 
             RowBox[{"NSS", ",", 
              RowBox[{"MakeRule", "[", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"NSS", "[", 
                  RowBox[{
                   RowBox[{"-", "ind1"}], ",", 
                   RowBox[{"-", "ind2"}]}], "]"}], ",", 
                 RowBox[{
                  RowBox[{"h", "[", 
                   RowBox[{
                    RowBox[{"-", "ind1"}], ",", 
                    RowBox[{"-", "ind2"}]}], "]"}], "-", 
                  RowBox[{
                   RowBox[{"n", "[", 
                    RowBox[{"-", "ind1"}], "]"}], 
                   RowBox[{"n", "[", 
                    RowBox[{"-", "ind2"}], "]"}]}]}]}], "}"}], "]"}]}], "]"}],
             "*)"}], 
           RowBox[{"AutomaticRules", "[", 
            RowBox[{"NSS", ",", 
             RowBox[{"MakeRule", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"NSS", "[", 
                  RowBox[{"ind1", ",", "ind2"}], "]"}], " ", 
                 RowBox[{"NSS", "[", 
                  RowBox[{
                   RowBox[{"-", "ind2"}], ",", 
                   RowBox[{"-", "ind3"}]}], "]"}]}], ",", 
                RowBox[{"NSS", "[", 
                 RowBox[{"ind1", ",", 
                  RowBox[{"-", "ind3"}]}], "]"}]}], "}"}], "]"}]}], "]"}], 
           ";", "\[IndentingNewLine]", 
           RowBox[{"AutomaticRules", "[", 
            RowBox[{"NSS", ",", 
             RowBox[{"MakeRule", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"NSS", "[", 
                  RowBox[{
                   RowBox[{"-", "ind1"}], ",", 
                   RowBox[{"-", "ind2"}]}], "]"}], " ", 
                 RowBox[{"NSS", "[", 
                  RowBox[{"ind2", ",", "ind3"}], "]"}]}], ",", 
                RowBox[{"NSS", "[", 
                 RowBox[{
                  RowBox[{"-", "ind1"}], ",", "ind3"}], "]"}]}], "}"}], 
              "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
           RowBox[{"AutomaticRules", "[", 
            RowBox[{"NSS", ",", 
             RowBox[{"MakeRule", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"NSS", "[", 
                 RowBox[{
                  RowBox[{"-", "ind1"}], ",", "ind1"}], "]"}], " ", ",", 
                RowBox[{"dim", "-", "2"}]}], "}"}], "]"}]}], "]"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
             RowBox[{
             "Who", " ", "knows", " ", "we", " ", "might", " ", "allow", " ", 
              "for", " ", "1"}], "+", "1", "+", 
             RowBox[{
             "n", " ", "splitting", " ", "so", " ", "here", " ", "that", " ", 
              "should", " ", "be", " ", "n"}], "-", "2."}], "*)"}], 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"On", "[", 
            RowBox[{"DefMetric", "::", "old"}], "]"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
            "We", " ", "remove", " ", "automatic", " ", "Leibniz", " ", 
             "rule", " ", "when", " ", "there", " ", "is", " ", "a", " ", 
             "Scalar", " ", 
             RowBox[{"Head", ".", "This"}], " ", "is", " ", "to", " ", 
             "ensure", " ", "that", " ", "the", " ", "induced", " ", 
             "derivative", " ", "does", " ", "not", " ", "spoil", " ", 
             RowBox[{"an", "'"}], 
             RowBox[{"InducedDecomposition", "'"}]}], "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{"prot", "=", 
            RowBox[{"Unprotect", "[", "cd", "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"cd", "[", "a_", "]"}], "[", 
             RowBox[{"Scalar", "[", "expr_", "]"}], "]"}], "=."}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"cd2", "[", "a_", "]"}], "[", 
             RowBox[{"Scalar", "[", "expr_", "]"}], "]"}], "=."}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"Protect", "[", "prot", "]"}], ";", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
             RowBox[{"CP", ".", " ", "Do"}], " ", "you", " ", "remember", " ",
              "why", " ", "we", " ", "had", " ", 
             RowBox[{"this", "?"}]}], " ", "*)"}], "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"$Rulecdh", "[", "h1_", "]"}], ":=", 
            RowBox[{"{", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"h1", "[", 
                 RowBox[{
                  RowBox[{"-", "a_"}], ",", "b_"}], "]"}], " ", 
                RowBox[{
                 RowBox[{"cd", "[", "a_", "]"}], "[", "expr1_", "]"}]}], 
               "\[RuleDelayed]", 
               RowBox[{
                RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{
                RowBox[{"h1", "[", 
                 RowBox[{"a_", ",", "b_"}], "]"}], " ", 
                RowBox[{
                 RowBox[{"cd", "[", 
                  RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}], 
               "\[RuleDelayed]", 
               RowBox[{
                RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{
                RowBox[{"h1", "[", 
                 RowBox[{"b_", ",", 
                  RowBox[{"-", "a_"}]}], "]"}], " ", 
                RowBox[{
                 RowBox[{"cd", "[", "a_", "]"}], "[", "expr1_", "]"}]}], 
               "\[RuleDelayed]", 
               RowBox[{
                RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{
                RowBox[{"h1", "[", 
                 RowBox[{"b_", ",", "a_"}], "]"}], " ", 
                RowBox[{
                 RowBox[{"cd", "[", 
                  RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}], 
               "\[RuleDelayed]", 
               RowBox[{
                RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{
                RowBox[{"h1", "[", 
                 RowBox[{
                  RowBox[{"-", "a_"}], ",", "b_"}], "]"}], " ", 
                RowBox[{
                 RowBox[{"cd", "[", "c_", "]"}], "@", 
                 RowBox[{
                  RowBox[{"cd", "[", "a_", "]"}], "[", "expr1_", "]"}]}]}], 
               "\[RuleDelayed]", 
               RowBox[{
                RowBox[{"cd", "[", "c", "]"}], "@", 
                RowBox[{
                 RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}]}], ",", 
              
              RowBox[{
               RowBox[{
                RowBox[{"h1", "[", 
                 RowBox[{"a_", ",", "b_"}], "]"}], " ", 
                RowBox[{
                 RowBox[{"cd", "[", "c_", "]"}], "@", 
                 RowBox[{
                  RowBox[{"cd", "[", 
                   RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}]}], 
               "\[RuleDelayed]", 
               RowBox[{
                RowBox[{"cd", "[", "c", "]"}], "@", 
                RowBox[{
                 RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}]}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{
                RowBox[{"h1", "[", 
                 RowBox[{"b_", ",", 
                  RowBox[{"-", "a_"}]}], "]"}], " ", 
                RowBox[{
                 RowBox[{"cd", "[", "c_", "]"}], "@", 
                 RowBox[{
                  RowBox[{"cd", "[", "a_", "]"}], "[", "expr1_", "]"}]}]}], 
               "\[RuleDelayed]", 
               RowBox[{
                RowBox[{"cd", "[", "c", "]"}], "@", 
                RowBox[{
                 RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}]}], ",", 
              
              RowBox[{
               RowBox[{
                RowBox[{"h1", "[", 
                 RowBox[{"b_", ",", "a_"}], "]"}], " ", 
                RowBox[{
                 RowBox[{"cd", "[", "c_", "]"}], "@", 
                 RowBox[{
                  RowBox[{"cd", "[", 
                   RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}]}], 
               "\[RuleDelayed]", 
               RowBox[{
                RowBox[{"cd", "[", "c", "]"}], "@", 
                RowBox[{
                 RowBox[{"cd", "[", "b", "]"}], "[", "expr1", "]"}]}]}]}], 
             "}"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"$Rulecdh", "[", "NSS1_", "]"}], ":=", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"NSS1", "[", 
                 RowBox[{
                  RowBox[{"-", "a_"}], ",", "b_"}], "]"}], " ", 
                RowBox[{
                 RowBox[{"cd2", "[", "a_", "]"}], "[", "expr1_", "]"}]}], 
               "\[RuleDelayed]", 
               RowBox[{
                RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{
                RowBox[{"NSS", "[", 
                 RowBox[{"a_", ",", "b_"}], "]"}], " ", 
                RowBox[{
                 RowBox[{"cd2", "[", 
                  RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}], 
               "\[RuleDelayed]", 
               RowBox[{
                RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{
                RowBox[{"NSS1", "[", 
                 RowBox[{"b_", ",", 
                  RowBox[{"-", "a_"}]}], "]"}], " ", 
                RowBox[{
                 RowBox[{"cd2", "[", "a_", "]"}], "[", "expr1_", "]"}]}], 
               "\[RuleDelayed]", 
               RowBox[{
                RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{
                RowBox[{"NSS", "[", 
                 RowBox[{"b_", ",", "a_"}], "]"}], " ", 
                RowBox[{
                 RowBox[{"cd2", "[", 
                  RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}], 
               "\[RuleDelayed]", 
               RowBox[{
                RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{
                RowBox[{"NSS1", "[", 
                 RowBox[{
                  RowBox[{"-", "a_"}], ",", "b_"}], "]"}], " ", 
                RowBox[{
                 RowBox[{"cd2", "[", "c_", "]"}], "@", 
                 RowBox[{
                  RowBox[{"cd2", "[", "a_", "]"}], "[", "expr1_", "]"}]}]}], 
               "\[RuleDelayed]", 
               RowBox[{
                RowBox[{"cd2", "[", "c", "]"}], "@", 
                RowBox[{
                 RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}]}], ",", 
              RowBox[{
               RowBox[{
                RowBox[{"NSS1", "[", 
                 RowBox[{"a_", ",", "b_"}], "]"}], " ", 
                RowBox[{
                 RowBox[{"cd2", "[", "c_", "]"}], "@", 
                 RowBox[{
                  RowBox[{"cd2", "[", 
                   RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}]}], 
               "\[RuleDelayed]", 
               RowBox[{
                RowBox[{"cd2", "[", "c", "]"}], "@", 
                RowBox[{
                 RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}]}], ",", 
              RowBox[{
               RowBox[{
                RowBox[{"NSS1", "[", 
                 RowBox[{"b_", ",", 
                  RowBox[{"-", "a_"}]}], "]"}], " ", 
                RowBox[{
                 RowBox[{"cd2", "[", "c_", "]"}], "@", 
                 RowBox[{
                  RowBox[{"cd2", "[", "a_", "]"}], "[", "expr1_", "]"}]}]}], 
               "\[RuleDelayed]", 
               RowBox[{
                RowBox[{"cd2", "[", "c", "]"}], "@", 
                RowBox[{
                 RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}]}], ",", 
              RowBox[{
               RowBox[{
                RowBox[{"NSS1", "[", 
                 RowBox[{"b_", ",", "a_"}], "]"}], " ", 
                RowBox[{
                 RowBox[{"cd2", "[", "c_", "]"}], "@", 
                 RowBox[{
                  RowBox[{"cd2", "[", 
                   RowBox[{"-", "a_"}], "]"}], "[", "expr1_", "]"}]}]}], 
               "\[RuleDelayed]", 
               RowBox[{
                RowBox[{"cd2", "[", "c", "]"}], "@", 
                RowBox[{
                 RowBox[{"cd2", "[", "b", "]"}], "[", "expr1", "]"}]}]}]}], 
             "}"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", "\n",
            "\[IndentingNewLine]", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{
              RowBox[{"SpaceType", "[", "h", "]"}], "^=", "SpaceTimeType"}], 
             ";"}], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
            "The", " ", "default", " ", "positionof", " ", "indices", " ", 
             "for", " ", "the", " ", "extrinsic", " ", "curvature", " ", 
             "and", " ", "the", " ", "acceleration", " ", "is", " ", "down"}],
             "*)"}], "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
             RowBox[{
             "CP", " ", "This", " ", "could", " ", "be", " ", "rewritten", 
              " ", "in", " ", "a", " ", "more", " ", "compact", " ", "form", 
              " ", "gathering", " ", "n", " ", "and", " ", "u"}], ",", " ", 
             RowBox[{"h", " ", "and", " ", "silenth"}]}], "*)"}], 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{
               RowBox[{"SlotsOfTensor", "[", "#", "]"}], "^:=", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"-", 
                  RowBox[{"Tangent", "[", "Manifold", "]"}]}], ",", 
                 RowBox[{"-", 
                  RowBox[{"Tangent", "[", "Manifold", "]"}]}]}], "}"}]}], 
              ")"}], "&"}], "/@", 
            RowBox[{"{", 
             RowBox[{"ExtrinsicK", "[", "h", "]"}], "}"}]}], ";", "\n", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{
               RowBox[{"SlotsOfTensor", "[", "#", "]"}], "^:=", 
               RowBox[{"{", 
                RowBox[{"-", 
                 RowBox[{"Tangent", "[", "Manifold", "]"}]}], "}"}]}], ")"}], 
             "&"}], "/@", 
            RowBox[{"{", 
             RowBox[{"Acceleration", "[", "u", "]"}], "}"}]}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{
               RowBox[{"SlotsOfTensor", "[", "#", "]"}], "^:=", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"-", 
                  RowBox[{"Tangent", "[", "Manifold", "]"}]}], ",", 
                 RowBox[{"-", 
                  RowBox[{"Tangent", "[", "Manifold", "]"}]}]}], "}"}]}], 
              ")"}], "&"}], "/@", 
            RowBox[{"{", 
             RowBox[{"ExtrinsicK", "[", "Silenth", "]"}], "}"}]}], ";", "\n", 
           
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{
               RowBox[{"SlotsOfTensor", "[", "#", "]"}], "^:=", 
               RowBox[{"{", 
                RowBox[{"-", 
                 RowBox[{"Tangent", "[", "Manifold", "]"}]}], "}"}]}], ")"}], 
             "&"}], "/@", 
            RowBox[{"{", 
             RowBox[{"Acceleration", "[", "n", "]"}], "}"}]}], ";", 
           "\[IndentingNewLine]", "\n", 
           RowBox[{"(*", 
            RowBox[{
            "The", " ", "acceleration", " ", "should", " ", "vanish", " ", 
             "for", " ", "homogeneous", " ", 
             RowBox[{"spacetimes", "."}]}], "*)"}], "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"Acceleration", "[", "u", "]"}], "[", "ind1_", "]"}], 
            "=", "0"}], ";", "\n", 
           RowBox[{"AutomaticRules", "[", 
            RowBox[{"u", ",", 
             RowBox[{"MakeRule", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"u", "[", "ind1", "]"}], " ", 
                 RowBox[{"u", "[", 
                  RowBox[{"-", "ind1"}], "]"}]}], ",", "normu"}], "}"}], 
              "]"}]}], "]"}], ";", "\n", 
           RowBox[{"AutomaticRules", "[", 
            RowBox[{"u", ",", 
             RowBox[{"MakeRule", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"u", "[", 
                  RowBox[{"-", "ind1"}], "]"}], " ", 
                 RowBox[{"g", "[", 
                  RowBox[{"ind1", ",", "ind2"}], "]"}]}], ",", 
                RowBox[{"u", "[", "ind2", "]"}]}], "}"}], "]"}]}], "]"}], ";",
            "\n", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{"AutomaticRules", "[", 
              RowBox[{"u", ",", 
               RowBox[{"MakeRule", "[", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"g", "[", 
                    RowBox[{"ind1", ",", "ind2"}], "]"}], " ", 
                   RowBox[{"u", "[", 
                    RowBox[{"-", "ind2"}], "]"}], " ", 
                   RowBox[{"u", "[", 
                    RowBox[{"-", "ind1"}], "]"}]}], ",", "normu"}], "}"}], 
                "]"}]}], "]"}], ";"}], "*)"}], "\[IndentingNewLine]", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
             RowBox[{
             "CP", " ", "Here", " ", "it", " ", "is", " ", "because", " ", 
              "we", " ", "assume", " ", "non", " ", "Binachi", " ", "for", 
              " ", 
              RowBox[{"n", ".", " ", "Otherwise"}], " ", "this", " ", "is", 
              " ", "more", " ", "general", " ", 
              RowBox[{"probably", ".", " ", "Even"}], " ", "if", " ", "we", 
              " ", "now", " ", "we", " ", "specialize", " ", "to", " ", 
              "FL"}], ",", " ", 
             RowBox[{
              RowBox[{"the", " ", "1"}], "+", "1", "+", 
              RowBox[{
              "2", " ", "splitting", " ", "would", " ", "be", " ", "great", 
               " ", "if", " ", "it", " ", "could", " ", "be", " ", "as", " ", 
               "general", " ", "as", " ", 
               RowBox[{"possible", ".", " ", "So"}], " ", "here", " ", "we", 
               " ", "should", " ", "extend", " ", "this", " ", "definition", 
               " ", "and", " ", "have", " ", "it", " ", "restricted", " ", 
               "to", " ", "0", " ", "only", " ", "if", " ", "the", " ", 
               "TypeOfPScaetime", " ", "is", " ", "non", " ", 
               RowBox[{"Bianchi", "."}]}]}]}], "*)"}], "\[IndentingNewLine]", 
           
           RowBox[{
            RowBox[{
             RowBox[{"Acceleration", "[", "n", "]"}], "[", "ind1_", "]"}], 
            "=", "0"}], ";", "\n", 
           RowBox[{"AutomaticRules", "[", 
            RowBox[{"n", ",", 
             RowBox[{"MakeRule", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"n", "[", "ind1", "]"}], " ", 
                 RowBox[{"n", "[", 
                  RowBox[{"-", "ind1"}], "]"}]}], ",", "normn"}], "}"}], 
              "]"}]}], "]"}], ";", "\n", 
           RowBox[{"AutomaticRules", "[", 
            RowBox[{"n", ",", 
             RowBox[{"MakeRule", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"n", "[", 
                  RowBox[{"-", "ind1"}], "]"}], " ", 
                 RowBox[{"g", "[", 
                  RowBox[{"ind1", ",", "ind2"}], "]"}]}], ",", 
                RowBox[{"n", "[", "ind2", "]"}]}], "}"}], "]"}]}], "]"}], ";",
            "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{"AutomaticRules", "[", 
              RowBox[{"n", ",", 
               RowBox[{"MakeRule", "[", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"g", "[", 
                    RowBox[{"ind1", ",", "ind2"}], "]"}], " ", 
                   RowBox[{"n", "[", 
                    RowBox[{"-", "ind2"}], "]"}], " ", 
                   RowBox[{"n", "[", 
                    RowBox[{"-", "ind1"}], "]"}]}], ",", "normn"}], "}"}], 
                "]"}]}], "]"}], ";"}], "*)"}], "\n", "\[IndentingNewLine]", 
           "\n", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"IntegerQ", "@", "dim"}], "&&", 
              RowBox[{"dim", "\[GreaterEqual]", "2"}]}], ",", 
             RowBox[{
              RowBox[{"indsdim", "=", 
               RowBox[{"GetIndicesOfVBundle", "[", 
                RowBox[{
                 RowBox[{"Tangent", "@", "Manifold"}], ",", "dim", ",", 
                 RowBox[{"{", "ind5", "}"}]}], "]"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"AutomaticRules", "[", 
               RowBox[{
                RowBox[{"epsilon", "[", "g", "]"}], ",", 
                RowBox[{"MakeRule", "[", 
                 RowBox[{"Evaluate", "[", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{"epsilon", "[", "g", "]"}], "@@", "indsdim"}], 
                    " ", 
                    RowBox[{"u", "[", 
                    RowBox[{"-", 
                    RowBox[{"indsdim", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "]"}], " ", 
                    RowBox[{"h", "[", 
                    RowBox[{
                    RowBox[{"-", 
                    RowBox[{"indsdim", "[", 
                    RowBox[{"[", "2", "]"}], "]"}]}], ",", "ind5"}], "]"}]}], 
                    ",", 
                    RowBox[{
                    RowBox[{"ReplaceIndex", "[", 
                    RowBox[{
                    RowBox[{"Evaluate", "[", 
                    RowBox[{
                    RowBox[{"epsilon", "[", "g", "]"}], "@@", "indsdim"}], 
                    "]"}], ",", 
                    RowBox[{
                    RowBox[{"indsdim", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], "\[Rule]", "ind5"}]}], 
                    "]"}], " ", 
                    RowBox[{"u", "[", 
                    RowBox[{"-", 
                    RowBox[{"indsdim", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "]"}]}]}], "}"}], "]"}],
                  "]"}]}], "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], 
           ";"}]}], "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
      "]"}]}], "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True],

Cell["\<\
This is an ad-hoc form of induced decomposition, I will still optimize it \
further \
\>", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ToInducedDerivativeScreenSpace", "[", 
     RowBox[{"expr_", ",", "supercd_", ",", "cd_"}], "]"}], ":=", 
    "\[IndentingNewLine]", 
    RowBox[{"ToInducedDerivative", "[", 
     RowBox[{"expr", ",", "supercd", ",", "cd"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ToInducedDerivativeScreenSpace", "[", 
    RowBox[{"expr_", ",", "supercd_", ",", "cd_", ",", "cd2_"}], "]"}], ":=", 
   
   RowBox[{"expr", "/.", 
    RowBox[{
     RowBox[{
      RowBox[{"supercd", "[", "ind_", "]"}], "[", 
      RowBox[{"expr1", ":", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{"_", "?", "xTensorQ"}], "[", "___", "]"}], "|", 
         RowBox[{
          RowBox[{"_", "?", "InertHeadQ"}], "[", "___", "]"}], "|", 
         RowBox[{
          RowBox[{"cd", "[", "_", "]"}], "[", "_", "]"}], "|", 
         RowBox[{
          RowBox[{"LieD", "[", "_", "]"}], "[", "_", "]"}]}], ")"}]}], "]"}], 
     "\[RuleDelayed]", 
     RowBox[{
      RowBox[{"-", 
       RowBox[{
        RowBox[{"cd", "[", "ind", "]"}], "[", "expr1", "]"}]}], "+", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"frees", "=", 
          RowBox[{"FindFreeIndices", "[", "expr1", "]"}]}], "}"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"ToInducedDerivative", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"supercd", "[", "ind", "]"}], "[", "expr1", "]"}], ",", 
           "supercd", ",", "cd"}], "]"}], "+", 
         RowBox[{"ToInducedDerivative", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"cd", "[", "ind", "]"}], "[", "expr1", "]"}], ",", "cd", 
           ",", "cd2"}], "]"}]}]}], "]"}]}]}]}]}], ";"}]}], "Input",
 InitializationCell->True]
}, Open  ]],

Cell[CellGroupData[{

Cell["Defining twice projected tensors.", "Subsubsection"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "DefScreenProjecteTensor", "]"}], "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"PrintAs", "\[Rule]", "Identity"}], ",", 
      RowBox[{"TensorProperties", "\[Rule]", 
       RowBox[{"{", 
        RowBox[{
        "\"\<SymmetricTensor\>\"", ",", "\"\<Traceless\>\"", ",", 
         "\"\<Transverse\>\""}], "}"}]}], ",", 
      RowBox[{"SpaceTimesOfDefinition", "\[Rule]", 
       RowBox[{"{", 
        RowBox[{"\"\<Background\>\"", ",", "\"\<Perturbed\>\""}], "}"}]}]}], 
     "}"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"DefScreenProjecteTensorQ", "[", 
    RowBox[{"Name_", ",", "h___"}], "]"}], ":=", "False"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PropertiesList", "[", "Name_", "]"}], ":=", 
   RowBox[{"{", "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"InducedMetricOf", "[", "Name_", "]"}], ":=", 
    RowBox[{"{", "}"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"Review", " ", "all", " ", "these", " ", 
    RowBox[{"properties", "."}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"DefScreenProjecteTensor", "[", 
    RowBox[{
     RowBox[{"Name_", "[", "inds___", "]"}], ",", 
     RowBox[{"h_", "?", "InducedMetricQ"}], ",", 
     RowBox[{"n_", "?", "DirectionVectorQ"}], ",", 
     RowBox[{"options___", "?", "OptionQ"}]}], "]"}], ":=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"DefScreenProjectedTensorQ", "[", 
        RowBox[{"Name", ",", "h"}], "]"}], ",", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{"$DefInfoQ", ",", "\[IndentingNewLine]", 
          RowBox[{"Throw", "@", 
           RowBox[{"Print", "[", 
            RowBox[{
            "\"\<** DefScreenProjectedTensor: The projection properties on \
the hypersurfaces associated with the induced metric \>\"", ",", " ", "h", 
             ",", "\"\< and direction vector\>\"", ",", " ", "n", ",", 
             "\"\< have already been defined for the tensor \>\"", ",", " ", 
             "Name", ",", "\"\<.\>\""}], "]"}]}], ",", "\[IndentingNewLine]", 
          
          RowBox[{"Throw", "[", "Null", "]"}]}], "\[IndentingNewLine]", "]"}],
         ";"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"DefScreenProjectedTensorQ", "[", "Name", "]"}], ",", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{"$DefInfoQ", ",", "\[IndentingNewLine]", 
          RowBox[{"Print", "[", 
           RowBox[{
           "\"\<** DefScreenProjectedTensor: Projection properties for the \
tensor \>\"", ",", " ", "Name", ",", 
            "\"\< have been defined for another slicing. New projection \
properties on the hypersurfaces associated with the induced metric\>\"", ",", 
            " ", "h", ",", "\"\< and direction vector\>\"", ",", " ", "n", 
            ",", "\"\< are now added.\>\""}], "]"}]}], "\[IndentingNewLine]", 
         "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], ";"}], 
    "\[IndentingNewLine]", ")"}]}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"etc", "..."}], " ", "*)"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"SetNumberOfArguments", "[", 
  RowBox[{"DefScreenProjectedTensor", ",", 
   RowBox[{"{", 
    RowBox[{"3", ",", "Infinity"}], "}"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "DefScreenProjectedTensor", "]"}], ";"}]}], "Input",
 
 InitializationCell->True]
}, Open  ]],

Cell[CellGroupData[{

Cell["Defining standard perturbations for matter and metric", "Subsubsection"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DefinedPerturbationParameter", "[", "x_", "]"}], ":=", "False"}], 
  ";"}]], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"DefMetricFields", "[", 
     RowBox[{
      RowBox[{"g_", "?", "MetricQ"}], ",", "dg_", ",", 
      RowBox[{"h_", "?", "InducedMetricQ"}], ",", 
      RowBox[{"n_", "?", "DirectionVectorQ"}], ",", 
      RowBox[{"PerturbParameter_:", "\[Epsilon]"}]}], "]"}], ":=", 
    RowBox[{"Print", "[", "\"\<Dobidoouah\>\"", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetNumberOfArguments", "[", 
   RowBox[{"DefMetricFields", ",", 
    RowBox[{"{", 
     RowBox[{"4", ",", "5"}], "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "DefMetricFields", "]"}], ";"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"DefMatterFields", "[", 
     RowBox[{"uf_", ",", "duf_", ",", 
      RowBox[{"h_", "?", "InducedMetricQ"}], ",", 
      RowBox[{"n_", "?", "DirectionVectorQ"}], ",", " ", 
      RowBox[{"PerturbParameter_:", "\[Epsilon]"}]}], "]"}], ":=", 
    RowBox[{"Print", "[", "\"\<Dobidoouah\>\"", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"SetNumberOfArguments", "[", 
  RowBox[{"DefMatterFields", ",", 
   RowBox[{"{", 
    RowBox[{"4", ",", "5"}], "}"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "DefMatterFields", "]"}], ";"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"SplitMetric", "[", 
    RowBox[{
     RowBox[{"g_", "?", "MetricQ"}], ",", "dg_", ",", 
     RowBox[{"h_", "?", "InducedMetricQ"}], ",", 
     RowBox[{"n_", "?", "DirectionVectorQ"}], ",", 
     RowBox[{"gauge_", "?", "GaugeQ"}]}], "]"}], ":=", 
   RowBox[{"Print", "[", "\"\<Dobidoouah\>\"", "]"}]}], ";"}]], "Input",
 InitializationCell->True]
}, Open  ]],

Cell[CellGroupData[{

Cell["Conformal Transformation Tools (from xPand)", "Subsubsection"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"IndicesDown", "[", "expr_", "]"}], ":=", " ", 
  RowBox[{"Fold", "[", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"SeparateMetric", "[", 
       RowBox[{"First", "@", "$Metrics"}], "]"}], "[", 
      RowBox[{"#1", ",", "#2"}], "]"}], "&"}], ",", "expr", ",", 
    RowBox[{"Select", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"IndicesOf", "[", "Up", "]"}], "[", "expr", "]"}], ",", 
      RowBox[{
       RowBox[{"Not", "@", 
        RowBox[{"LIndexQ", "[", "#", "]"}]}], "&"}]}], "]"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"IndicesUp", "[", "expr_", "]"}], ":=", " ", 
   RowBox[{"Fold", "[", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"SeparateMetric", "[", 
        RowBox[{"First", "@", "$Metrics"}], "]"}], "[", 
       RowBox[{"#1", ",", "#2"}], "]"}], "&"}], ",", "expr", ",", 
     RowBox[{"Select", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"IndicesOf", "[", "Down", "]"}], "[", "expr", "]"}], ",", 
       RowBox[{
        RowBox[{"Not", "@", 
         RowBox[{"LIndexQ", "[", "#", "]"}]}], "&"}]}], "]"}]}], "]"}]}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"IndicesDown", "[", "0", "]"}], ":=", "0"}], " ", ";"}], 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"This", " ", "is", " ", "to", " ", "avoid", " ", "bugs"}], 
    "..."}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"IndicesUp", "[", "0", "]"}], ":=", "0"}], " ", ";"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"ConformalMetricName", "[", 
    RowBox[{
     RowBox[{"g_", "?", "MetricQ"}], ",", "1"}], "]"}], ":=", "g"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ConformalMetricName", "[", 
    RowBox[{
     RowBox[{"g_", "?", "MetricQ"}], ",", "conffactor_"}], "]"}], ":=", 
   RowBox[{"SymbolJoin", "[", 
    RowBox[{"g", ",", "conffactor", ",", "2"}], "]"}]}], ";"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"DefConformalMetric", "[", 
    RowBox[{
     RowBox[{"g_", "?", "MetricQ"}], ",", "conffactor_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"n", ",", "q"}], "}"}], ",", 
     RowBox[{"Catch", "@", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"M", "=", 
           RowBox[{"ManifoldOfCovD", "@", 
            RowBox[{"CovDOfMetric", "@", "g"}]}]}], ",", 
          RowBox[{"CD", "=", 
           RowBox[{"CovDOfMetric", "@", "g"}]}]}], "}"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"With", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"i1", "=", 
             RowBox[{"DummyIn", "[", 
              RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ",", 
            RowBox[{"i2", "=", 
             RowBox[{"DummyIn", "[", 
              RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ",", 
            RowBox[{"sy1", "=", 
             RowBox[{
              RowBox[{"SymbolOfCovD", "[", "CD", "]"}], "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], ",", 
            RowBox[{"sy2", "=", 
             RowBox[{
              RowBox[{"SymbolOfCovD", "[", "CD", "]"}], "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], ",", 
            RowBox[{"metlist", "=", 
             RowBox[{"Select", "[", 
              RowBox[{"$Metrics", ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"InducedFrom", "[", "#", "]"}], "===", "Null"}], 
                "&"}]}], "]"}]}]}], "}"}], ",", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"Not", "@", 
              RowBox[{"DefTensorQ", "[", "conffactor", "]"}]}], ",", 
             RowBox[{"DefTensor", "[", 
              RowBox[{
               RowBox[{"conffactor", "[", 
                RowBox[{
                 RowBox[{"LI", "[", "n", "]"}], ",", 
                 RowBox[{"LI", "[", "q", "]"}]}], "]"}], ",", 
               RowBox[{"{", "M", "}"}], ",", 
               RowBox[{"PrintAs", "->", 
                RowBox[{"ToString", "[", "conffactor", "]"}]}]}], "]"}]}], 
            "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"Off", "[", 
            StyleBox[
             RowBox[{"DefMetric", "::", "old"}], "MessageName"], "]"}], ";", 
           RowBox[{"(*", " ", 
            RowBox[{"Annoying", " ", "message", " ", "turned", " ", "off"}], 
            "*)"}], "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"Not", "[", 
              RowBox[{"DefTensorQ", "[", 
               RowBox[{"ConformalMetricName", "[", 
                RowBox[{"g", ",", "conffactor"}], "]"}], "]"}], "]"}], ",", 
             "\[IndentingNewLine]", "\[IndentingNewLine]", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"DefMetric", "[", 
               RowBox[{
                RowBox[{"-", "1"}], ",", 
                RowBox[{
                 RowBox[{"ConformalMetricName", "[", 
                  RowBox[{"g", ",", "conffactor"}], "]"}], "[", 
                 RowBox[{
                  RowBox[{"-", "i1"}], ",", 
                  RowBox[{"-", "i2"}]}], "]"}], ",", 
                RowBox[{"SymbolJoin", "[", 
                 RowBox[{"CD", ",", "conffactor", ",", "2"}], "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"\"\<:\>\"", ",", 
                  RowBox[{"StringJoin", "[", 
                   RowBox[{"sy2", ",", 
                    RowBox[{"ToString", "[", "conffactor", "]"}], ",", 
                    RowBox[{"ToString", "[", "2", "]"}]}], "]"}]}], "}"}], 
                ",", 
                RowBox[{"PrintAs", "\[Rule]", 
                 RowBox[{"StringJoin", "[", 
                  RowBox[{"\"\<[\>\"", ",", 
                   RowBox[{"PrintAs", "[", "g", "]"}], ",", 
                   RowBox[{"\"\<\\!\\(\>\"", "<>", 
                    RowBox[{"PrintAs", "[", "conffactor", "]"}], "<>", 
                    "\"\<\\^2\\)\>\""}], ",", "\"\<]\>\""}], 
                  RowBox[{"(*", 
                   RowBox[{
                    RowBox[{"ToString", "[", "conffactor", "]"}], ",", 
                    RowBox[{"ToString", "[", "2", "]"}]}], "*)"}], "]"}]}], 
                ",", 
                RowBox[{"ConformalTo", "\[Rule]", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"g", "[", 
                    RowBox[{
                    RowBox[{"-", "i1"}], ",", 
                    RowBox[{"-", "i2"}]}], "]"}], ",", 
                   RowBox[{
                    RowBox[{"conffactor", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "0", "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}]}], "]"}], "^", "2"}]}], 
                  "}"}]}]}], "]"}], ";"}]}], "\[IndentingNewLine]", 
            "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
           RowBox[{"On", "[", 
            StyleBox[
             RowBox[{"DefMetric", "::", "old"}], "MessageName"], "]"}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
            "We", " ", "have", " ", "to", " ", "ensure", " ", "it", " ", "is",
              " ", "safe"}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Perturbation", "[", 
             RowBox[{
              RowBox[{"conffactor", "[", 
               RowBox[{
                RowBox[{"LI", "[", "0", "]"}], ",", 
                RowBox[{"LI", "[", "q_", "]"}], ",", "indices___"}], "]"}], 
              ",", "n_"}], "]"}], "^:=", 
            RowBox[{"0", "/;", 
             RowBox[{"n", "\[GreaterEqual]", "1"}]}]}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"Off", "[", 
            StyleBox[
             RowBox[{"ConformalRules", "::", "unknown"}], "MessageName"], 
            "]"}], ";", "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
            "We", " ", "use", " ", "the", " ", "error", " ", "sent", " ", 
             "by", " ", "ConformalRules", " ", "to", " ", "chekc", " ", 
             "whether", " ", "or", " ", "not", " ", "the", " ", "metric", " ",
              "in", " ", "the", " ", "list", " ", "metlist", " ", "is", " ", 
             "conformallyr", " ", "elated", " ", "to", " ", "the", " ", 
             "metric", " ", 
             RowBox[{"g", ".", "\[IndentingNewLine]", "If"}], " ", "it", " ", 
             "is", " ", "the", " ", "case", " ", "we", " ", "enforce", " ", 
             "transitivity", " ", "of", " ", "the", " ", "conformal", " ", 
             RowBox[{"relations", "."}]}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"Catch", "@", 
                 RowBox[{"ConformalRules", "[", 
                  RowBox[{"g", ",", "#"}], "]"}]}], "=!=", "Null"}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{"SetConformalTo", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"SymbolJoin", "[", 
                   RowBox[{"g", ",", "conffactor", ",", "2"}], "]"}], "[", 
                  RowBox[{
                   RowBox[{"-", "i1"}], ",", 
                   RowBox[{"-", "i2"}]}], "]"}], ",", " ", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"#", "[", 
                    RowBox[{
                    RowBox[{"-", "i1"}], ",", " ", 
                    RowBox[{"-", "i2"}]}], "]"}], ",", 
                   RowBox[{
                    RowBox[{"ConformalFactor", "[", 
                    RowBox[{"g", ",", "#"}], "]"}], "*", " ", 
                    RowBox[{
                    RowBox[{"conffactor", "[", 
                    RowBox[{
                    RowBox[{"LI", "[", "0", "]"}], ",", 
                    RowBox[{"LI", "[", "0", "]"}]}], "]"}], "^", "2"}]}]}], 
                  "}"}]}], "]"}]}], "]"}], "&"}], "/@", "metlist"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"On", "[", 
            StyleBox[
             RowBox[{"ConformalRules", "::", "unknown"}], "MessageName"], 
            "]"}], ";"}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
         "]"}]}], "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"SetNumberOfArguments", "[", 
  RowBox[{"DefConformalMetric", ",", "2"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "DefConformalMetric", "]"}], ";"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ConfHead", "[", 
     RowBox[{"_", ",", "_"}], "]"}], "[", 
    RowBox[{"delta", "[", 
     RowBox[{"\[Mu]_", ",", "\[Nu]_"}], "]"}], "]"}], ":=", 
   RowBox[{"delta", "[", 
    RowBox[{"\[Mu]", ",", "\[Nu]"}], "]"}]}], 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
    "Because", " ", "I", " ", "know", " ", "that", " ", "when", " ", "there", 
     " ", "is", " ", "delta", " ", "function", " ", "in", " ", "an", " ", 
     "expression"}], ",", " ", 
    RowBox[{
     RowBox[{
      RowBox[{
      "it", " ", "is", " ", "always", " ", "with", " ", "one", " ", "index", 
       " ", "up", " ", "and", " ", "one", " ", "down"}], "..."}], "so", " ", 
     "this", " ", "should", " ", "be", " ", 
     RowBox[{"fine", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", " "}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ConfHead", "[", 
     RowBox[{
      RowBox[{"metric1_", "?", "MetricQ"}], ",", 
      RowBox[{"metric2_", "?", "MetricQ"}]}], "]"}], "[", 
    RowBox[{
     RowBox[{"ConfHead", "[", 
      RowBox[{
       RowBox[{"metric2_", "?", "MetricQ"}], ",", 
       RowBox[{"metric1_", "?", "MetricQ"}]}], "]"}], "[", "expr_", "]"}], 
    "]"}], ":=", "expr"}], " ", 
  RowBox[{"(*", " ", 
   RowBox[{"Not", " ", "necessary"}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ConfHead", "[", 
    RowBox[{
     RowBox[{"metric1_", "?", "MetricQ"}], ",", 
     RowBox[{"metric1_", "?", "MetricQ"}]}], "]"}], "[", "expr_", "]"}], ":=",
   "expr"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ConfHead", "[", 
     RowBox[{
      RowBox[{"metric2_", "?", "MetricQ"}], ",", 
      RowBox[{"metric3_", "?", "MetricQ"}]}], "]"}], "[", 
    RowBox[{
     RowBox[{"ConfHead", "[", 
      RowBox[{
       RowBox[{"metric1_", "?", "MetricQ"}], ",", 
       RowBox[{"metric2_", "?", "MetricQ"}]}], "]"}], "[", "expr_", "]"}], 
    "]"}], ":=", 
   RowBox[{
    RowBox[{"ConfHead", "[", 
     RowBox[{"metric1", ",", "metric3"}], "]"}], "[", "expr", "]"}]}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
    "Thanks", " ", "to", " ", "Jolyon", " ", "and", " ", "Leo", " ", 
     "Stein"}], ",", " ", 
    RowBox[{
    "the", " ", "definition", " ", "below", " ", "should", " ", "be", " ", 
     "much", " ", "more", " ", 
     RowBox[{"general", "."}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "The", " ", "main", " ", "reason", " ", "is", " ", "that", " ", "the", " ",
     "delta", " ", "tensor", " ", "is", " ", "greedy", " ", "and", " ", 
    "wants", " ", "to", " ", "contract", " ", "through", " ", "expressions", 
    " ", "like", "\n", 
    RowBox[{
     RowBox[{
      RowBox[{"ConfHead", "[", "...", "]"}], "[", 
      RowBox[{"f", "[", 
       RowBox[{"Scalar", "[", 
        RowBox[{"phi", "[", "]"}], "]"}], "]"}], "]"}], "."}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ConfHead", "/:", 
   RowBox[{"IsIndexOf", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"ConfHead", "[", 
       RowBox[{"_", ",", "_"}], "]"}], "[", "_", "]"}], ",", "_", ",", 
     "delta"}], "]"}], ":=", "False"}], ";"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"$BoolBasicConformalWeight", "=", "True"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"WeightOfIndicesList", "[", "indices_List", "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"aindex", "=", 
       RowBox[{"Select", "[", 
        RowBox[{"indices", ",", 
         RowBox[{
          RowBox[{"Not", "[", 
           RowBox[{"LIndexQ", "[", "#", "]"}], "]"}], "&"}]}], "]"}]}], "}"}],
      ",", 
     RowBox[{
      RowBox[{"Length", "@", 
       RowBox[{"Select", "[", 
        RowBox[{"aindex", ",", "DownIndexQ"}], "]"}]}], "-", 
      RowBox[{"Length", "@", 
       RowBox[{"Select", "[", 
        RowBox[{"aindex", ",", "UpIndexQ"}], "]"}]}]}]}], "]"}]}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"Conformal", " ", "weight", " ", "of", " ", "a", " ", "tensor"}], 
   " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ConformalWeight", "[", 
    RowBox[{"tens_", "?", "xTensorQ"}], "]"}], ":=", "0"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ConformalWeight", "[", 
    RowBox[{
     RowBox[{"tens_", "?", "xTensorQ"}], "[", "indices___", "]"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"ConformalWeight", "[", "tens", "]"}], "+", 
    RowBox[{"WeightOfIndicesList", "[", 
     RowBox[{"{", "indices", "}"}], "]"}]}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ConformalWeight", "[", 
     RowBox[{"f_", "?", "ScalarFunctionQ"}], "]"}], ":=", "0"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MyChangeChristoffel", "[", 
    RowBox[{"expr_", ",", "cd_", ",", "cd_"}], "]"}], ":=", "expr"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MyChangeChristoffel", "[", 
    RowBox[{"expr_", ",", "cd2list_List", ",", "cd1_"}], "]"}], ":=", 
   RowBox[{"Fold", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"MyChangeChristoffel", "[", 
       RowBox[{"#1", ",", "#2", ",", "cd1"}], "]"}], "&"}], ",", "expr", ",", 
     "cd2list"}], "]"}]}], "\[IndentingNewLine]"}], "\n", 
 RowBox[{
  RowBox[{"MyChangeChristoffel", "[", 
   RowBox[{"expr_", ",", "cd2_", ",", "cd1_"}], "]"}], ":=", 
  RowBox[{"With", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"vb", "=", 
      RowBox[{"Tangent", "[", 
       RowBox[{"ManifoldOfCovD", "[", "cd1", "]"}], "]"}]}], "}"}], ",", 
    RowBox[{"With", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"chr1", "=", 
         RowBox[{"Head", "[", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"Christoffel", "[", "cd1", "]"}], ")"}], "[", 
           RowBox[{
            RowBox[{"DummyIn", "[", "vb", "]"}], ",", 
            RowBox[{"-", 
             RowBox[{"DummyIn", "[", "vb", "]"}]}], ",", 
            RowBox[{"-", 
             RowBox[{"DummyIn", "[", "vb", "]"}]}]}], "]"}], "]"}]}], ",", 
        RowBox[{"chr2", "=", 
         RowBox[{"Head", "[", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"Christoffel", "[", "cd2", "]"}], ")"}], "[", 
           RowBox[{
            RowBox[{"DummyIn", "[", "vb", "]"}], ",", 
            RowBox[{"-", 
             RowBox[{"DummyIn", "[", "vb", "]"}]}], ",", 
            RowBox[{"-", 
             RowBox[{"DummyIn", "[", "vb", "]"}]}]}], "]"}], "]"}]}], ",", 
        RowBox[{"chr21", "=", 
         RowBox[{"Head", "[", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"Christoffel", "@@", 
             RowBox[{"Sort", "[", 
              RowBox[{"{", 
               RowBox[{"cd2", ",", "cd1"}], "}"}], "]"}]}], ")"}], "[", 
           RowBox[{
            RowBox[{"DummyIn", "[", "vb", "]"}], ",", 
            RowBox[{"-", 
             RowBox[{"DummyIn", "[", "vb", "]"}]}], ",", 
            RowBox[{"-", 
             RowBox[{"DummyIn", "[", "vb", "]"}]}]}], "]"}], "]"}]}], ",", 
        RowBox[{"sign", "=", 
         RowBox[{"Order", "[", 
          RowBox[{"cd2", ",", "cd1"}], "]"}]}]}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"expr", "/.", 
       RowBox[{
        RowBox[{"chr2", "[", 
         RowBox[{"i1_", ",", "i2_", ",", "i3_"}], "]"}], "\[RuleDelayed]", 
        RowBox[{
         RowBox[{"chr1", "[", 
          RowBox[{"i1", ",", "i2", ",", "i3"}], "]"}], "+", 
         RowBox[{"sign", "*", 
          RowBox[{"chr21", "[", 
           RowBox[{"i1", ",", "i2", ",", "i3"}], "]"}]}]}]}]}]}], 
     "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"ExistInertHead", "[", "head_", "]"}], ":=", 
   RowBox[{
    RowBox[{"Length", "@", 
     RowBox[{"Cases", "[", 
      RowBox[{"$InertHeads", ",", "head"}], "]"}]}], ">", "0"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"RulesConf", "[", 
   RowBox[{
    RowBox[{"metric1_", "?", "MetricQ"}], ",", 
    RowBox[{"metric2_", "?", "MetricQ"}]}], "]"}], ":=", 
  RowBox[{"(", "\[IndentingNewLine]", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "cd1", ",", "cd2", ",", "confa2", ",", "confa", ",", "M", ",", "res", 
       ",", "inds"}], "}"}], ",", 
     RowBox[{
      RowBox[{"cd1", "=", 
       RowBox[{"CovDOfMetric", "[", "metric1", "]"}]}], ";", 
      RowBox[{"cd2", "=", 
       RowBox[{"CovDOfMetric", "[", "metric2", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"confa2", "=", 
       RowBox[{"ConformalFactor", "[", 
        RowBox[{"metric2", ",", "metric1"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"confa", "=", 
       RowBox[{
        RowBox[{"Sqrt", "[", 
         RowBox[{"ConformalFactor", "[", 
          RowBox[{"metric2", ",", "metric1"}], "]"}], "]"}], "/.", 
        RowBox[{
         RowBox[{"Sqrt", "[", 
          RowBox[{"x_", "^", 
           RowBox[{"n_", "?", "EvenQ"}]}], "]"}], ":>", 
         RowBox[{"x", "^", 
          RowBox[{"(", 
           RowBox[{"n", "/", "2"}], ")"}]}]}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "In", " ", "principle", " ", "this", " ", "should", " ", "give", " ", 
        "a", " ", "or", " ", 
        RowBox[{"1", "/", "a"}], " ", "depending", " ", "if", " ", "we", " ", 
        "go", " ", "from", " ", "metric1", " ", "to", " ", "metric2", " ", 
        "or", " ", "metric2", " ", "to", " ", "metric1"}], "*)"}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"M", "=", 
       RowBox[{"ManifoldOfCovD", "[", "cd1", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"inds", "=", 
       RowBox[{"DummyIn", "/@", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"Tangent", "[", "M", "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"Range", "[", "4", "]"}], "}"}]}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"i1", "=", 
           RowBox[{"inds", "[", 
            RowBox[{"[", "1", "]"}], "]"}]}], ",", 
          RowBox[{"i2", "=", 
           RowBox[{"inds", "[", 
            RowBox[{"[", "2", "]"}], "]"}]}], ",", 
          RowBox[{"i3", "=", 
           RowBox[{"inds", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}], ",", 
          RowBox[{"i4", "=", 
           RowBox[{"inds", "[", 
            RowBox[{"[", "4", "]"}], "]"}]}]}], "}"}], ",", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "Once", " ", "confheads", " ", "are", " ", "put", " ", "on", " ", 
          "expression", " ", 
          RowBox[{"(", 
           RowBox[{
           "as", " ", "a", " ", "result", " ", "of", " ", "a", " ", "formal", 
            " ", "conformal", " ", "transformation"}], ")"}], " ", "then", 
          " ", "we", " ", "remove", " ", "them", " ", "by", " ", "expressing",
           " ", "what", " ", "they", " ", "mean", " ", "in", " ", "function", 
          " ", "of", " ", "the", " ", "original", " ", "tensors", " ", "and", 
          " ", "the", " ", "scale", " ", "factor"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"res", "=", "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"RuleDelayed", "@@", 
             RowBox[{"Hold", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"ConfHead", "[", 
                 RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"Riemann", "@", "cd1"}], ")"}], "[", 
                 RowBox[{"i1_", ",", "i2_", ",", "i3_", ",", "i4_"}], "]"}], 
                "]"}], ",", 
               RowBox[{
                RowBox[{"confa", "^", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"WeightOfIndicesList", "[", 
                    RowBox[{"{", 
                    RowBox[{"i1", ",", "i2", ",", "i3", ",", "i4"}], "}"}], 
                    "]"}], "-", "2"}], ")"}]}], 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"Riemann", "@", "cd2"}], ")"}], "[", 
                 RowBox[{"i1", ",", "i2", ",", "i3", ",", "i4"}], "]"}]}]}], 
              "]"}]}], ",", "\[IndentingNewLine]", 
            RowBox[{"RuleDelayed", "@@", 
             RowBox[{"Hold", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"ConfHead", "[", 
                 RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"Ricci", "@", "cd1"}], ")"}], "[", 
                 RowBox[{"i1_", ",", "i2_"}], "]"}], "]"}], ",", 
               RowBox[{
                RowBox[{"confa", "^", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"WeightOfIndicesList", "[", 
                    RowBox[{"{", 
                    RowBox[{"i1", ",", "i2"}], "}"}], "]"}], "-", "2"}], 
                  ")"}]}], 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"Ricci", "@", "cd2"}], ")"}], "[", 
                 RowBox[{"i1", ",", "i2"}], "]"}]}]}], "]"}]}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"RuleDelayed", "@@", 
             RowBox[{"Hold", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"ConfHead", "[", 
                 RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"RicciScalar", "@", "cd1"}], ")"}], "[", "]"}], 
                "]"}], ",", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"RicciScalar", "@", "cd2"}], ")"}], "[", "]"}]}], 
              "]"}]}], ",", "\[IndentingNewLine]", 
            RowBox[{"RuleDelayed", "@@", 
             RowBox[{"Hold", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"ConfHead", "[", 
                 RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"Christoffel", "@", "cd1"}], ")"}], "[", 
                 RowBox[{"i1_", ",", "i2_", ",", "i3_"}], "]"}], "]"}], ",", 
               RowBox[{
                RowBox[{"confa", "^", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"WeightOfIndicesList", "[", 
                    RowBox[{"{", 
                    RowBox[{"i1", ",", "i2", ",", "i3"}], "}"}], "]"}], "-", 
                   "1"}], ")"}]}], "*", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"Christoffel", "@", "cd2"}], ")"}], "[", 
                 RowBox[{"i1", ",", "i2", ",", "i3"}], "]"}]}]}], "]"}]}], 
            ",", "\[IndentingNewLine]", 
            RowBox[{"RuleDelayed", "@@", 
             RowBox[{"Hold", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"ConfHead", "[", 
                 RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"Determinant", "[", 
                   RowBox[{"metric1", ",", "AIndex"}], "]"}], ")"}], "[", 
                 "]"}], "]"}], ",", 
               RowBox[{"(*", " ", 
                RowBox[{
                "This", " ", "is", " ", "removed", " ", "because", " ", "now",
                  " ", "xTensor", " ", "is", " ", "patched", " ", 
                 RowBox[{
                  RowBox[{"confa2", "^", 
                   RowBox[{"DimOfManifold", "[", "M", "]"}]}], ".", " ", 
                  "Thanks"}], " ", "to", " ", "Leo", " ", 
                 RowBox[{"Stein", "."}]}], "*)"}], 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"Determinant", "[", 
                  RowBox[{"metric2", ",", "AIndex"}], "]"}], ")"}], "[", 
                "]"}]}], "]"}]}], ",", "\[IndentingNewLine]", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
              RowBox[{
              "This", " ", "line", " ", "below", " ", "is", " ", "not", " ", 
               "working", " ", 
               RowBox[{"well", ".", "  ", "The"}], " ", "problem", " ", 
               "should", " ", "be", " ", "considered", " ", "later", " ", 
               "when", " ", "xTensor", " ", "knows", " ", "how", " ", "to", 
               " ", "handle", " ", "the", " ", "epsilon", " ", "of", " ", "a",
                " ", "frozen", " ", 
               RowBox[{"metric", ".", " ", "So"}], " ", "this", " ", "really",
                " ", "works", " ", "only", " ", "when", " ", "metric1", " ", 
               "is", " ", "the", " ", "ambient", " ", "metric"}], "..."}], 
             " ", "*)"}], "\[IndentingNewLine]", 
            RowBox[{"RuleDelayed", "@@", 
             RowBox[{"Hold", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"ConfHead", "[", 
                 RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"epsilon", "@", "metric1"}], ")"}], "[", 
                 RowBox[{"inds__", "?", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "#", "}"}], "]"}], "===", 
                    RowBox[{"DimOfManifold", "[", "M", "]"}]}], "&"}], 
                   ")"}]}], "]"}], "]"}], ",", 
               RowBox[{"(*", 
                RowBox[{"confa2", "^", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"DimOfManifold", "[", "M", "]"}], "/", "2"}], 
                  ")"}]}], "*)"}], 
               RowBox[{
                RowBox[{"confa", "^", 
                 RowBox[{"(", 
                  RowBox[{"WeightOfIndicesList", "[", 
                   RowBox[{"{", "inds", "}"}], "]"}], ")"}]}], 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"epsilon", "@", "metric1"}], ")"}], "[", "inds", 
                 "]"}]}]}], "]"}]}], ",", "\[IndentingNewLine]", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
             "Not", " ", "really", " ", "satisfactory", " ", "but", " ", 
              "minimalist", " ", "for", " ", "scalar", " ", "functions"}], 
             " ", "*)"}], "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
              RowBox[{
              "Following", " ", "Leo", " ", "Stein", " ", "suggestion"}], ",",
               " ", 
              RowBox[{
              "we", " ", "allow", " ", "the", " ", "scalar", " ", "function", 
               " ", "to", " ", "have", " ", "several", " ", "arguments"}]}], 
             " ", "*)"}], "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"ConfHead", "[", 
               RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
              RowBox[{
               RowBox[{"f_", "?", "ScalarFunctionQ"}], "[", "arg___", "]"}], 
              "]"}], ":>", 
             RowBox[{
              RowBox[{"Simplify", "[", 
               RowBox[{
                RowBox[{"confa2", "^", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{"ConformalWeight", "[", "f", "]"}], ")"}], "/", 
                   "2"}], ")"}]}], ",", 
                RowBox[{"Assumptions", "\[Rule]", 
                 RowBox[{"confa", ">", "0"}]}]}], "]"}], 
              RowBox[{"f", "[", "arg", "]"}]}]}], ",", "\[IndentingNewLine]", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"ConfHead", "[", 
               RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
              RowBox[{
               RowBox[{"tens_", "?", "xTensorQ"}], "[", "indss___", "]"}], 
              "]"}], "\[RuleDelayed]", 
             RowBox[{
              RowBox[{"Simplify", "[", 
               RowBox[{
                RowBox[{"confa2", "^", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"ConformalWeight", "[", 
                    RowBox[{"tens", "[", "indss", "]"}], "]"}], "/", "2"}], 
                  ")"}]}], ",", 
                RowBox[{"Assumptions", "\[Rule]", 
                 RowBox[{"confa", ">", "0"}]}]}], "]"}], 
              RowBox[{"tens", "[", "indss", "]"}]}]}]}], 
           "\[IndentingNewLine]", "}"}]}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", "res"}]}], "\[IndentingNewLine]", "]"}]}]}], 
    "\[IndentingNewLine]", "]"}], "\[IndentingNewLine]", ")"}]}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RemoveInducedDerivative", "[", 
     RowBox[{"expr_", ",", "cd_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "res", "}"}], ",", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"h", "=", 
          RowBox[{"MetricOfCovD", "@", "cd"}]}], "}"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"InducedFrom", "@", "h"}], "===", "Null"}], ",", "expr", 
          ",", "\[IndentingNewLine]", 
          RowBox[{"With", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"g", "=", 
              RowBox[{"First", "@", 
               RowBox[{"InducedFrom", "@", "h"}]}]}], "}"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"With", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"CD", "=", 
                RowBox[{"CovDOfMetric", "@", "g"}]}], "}"}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"res", "=", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"expr", "//.", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"cd", "[", "ind_", "]"}], "[", "Expr___", "]"}], ":>", 
                    RowBox[{
                    RowBox[{"Projector", "[", "h", "]"}], "[", 
                    RowBox[{
                    RowBox[{"CD", "[", "ind", "]"}], "[", "Expr", "]"}], 
                    "]"}]}]}], ")"}], "/.", 
                 RowBox[{
                  RowBox[{"Projector", "[", "h", "]"}], "\[Rule]", 
                  RowBox[{"ProjectWith", "[", "h", "]"}]}]}]}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{"res", "=!=", "expr"}], ",", 
                 RowBox[{
                  RowBox[{
                  "Print", "[", 
                   "\"\<** Warning: you are using ToMetric or Conformal with \
induced covariant derivatives. \\nThese induced derivatives are first \
expressed in function of the covariant derivative form which they are induced \
since we do not know very well how to handle that. **\>\"", "]"}], ";"}]}], 
                "]"}], ";", "\[IndentingNewLine]", "res"}]}], 
             "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}], 
         "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RemoveAllInducedDerivatives", "[", "expr_", "]"}], ":=", 
    RowBox[{"With", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"InducedMetrics", "=", 
        RowBox[{"Select", "[", 
         RowBox[{"$Metrics", ",", 
          RowBox[{
           RowBox[{
            RowBox[{"InducedFrom", "[", "#", "]"}], "=!=", "Null"}], "&"}]}], 
         "]"}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"Fold", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"RemoveInducedDerivative", "[", 
          RowBox[{"#1", ",", 
           RowBox[{"CovDOfMetric", "[", "#2", "]"}]}], "]"}], "&"}], ",", 
        "expr", ",", "InducedMetrics"}], "]"}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ToMetric", "[", 
     RowBox[{"expr_", ",", 
      RowBox[{"metric1_", "?", "MetricQ"}]}], "]"}], ":=", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"InducedFrom", "@", "metric1"}], "=!=", "Null"}], ",", "expr", 
      ",", "\[IndentingNewLine]", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"res", ",", "preexpression"}], "}"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Off", "[", 
          StyleBox[
           RowBox[{"ConformalRules", "::", "unknown"}], "MessageName"], 
          StyleBox["]", "MessageName"]}], 
         StyleBox[";", "MessageName"], "\[IndentingNewLine]", 
         RowBox[{"With", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"cd1", "=", 
              RowBox[{"CovDOfMetric", "[", "metric1", "]"}]}], ",", 
             RowBox[{"$CovDsNotInduced", "=", 
              RowBox[{"Select", "[", 
               RowBox[{
                RowBox[{"Rest", "@", "$CovDs"}], ",", 
                RowBox[{
                 RowBox[{
                  RowBox[{"InducedFrom", "[", 
                   RowBox[{"MetricOfCovD", "[", "#", "]"}], "]"}], "===", 
                  "Null"}], "&"}]}], "]"}]}]}], "}"}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"With", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"$CovDsNotInducedRelatedTocd1", "=", 
               RowBox[{"Select", "[", 
                RowBox[{"$CovDsNotInduced", ",", 
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"Catch", "@", 
                    RowBox[{"ConformalRules", "[", 
                    RowBox[{"metric1", ",", 
                    RowBox[{"MetricOfCovD", "[", "#", "]"}]}], "]"}]}], "=!=",
                     "Null"}], ")"}], "&"}]}], "]"}]}], "}"}], ",", 
             "\[IndentingNewLine]", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"preexpression", "=", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{
                    RowBox[{
                    RowBox[{"RemoveAllInducedDerivatives", "[", "expr", "]"}],
                     "//", "ProjectorToMetric"}], "//", "EinsteinToRicci"}], "//",
                    "WeylToRiemann"}], "//", "ContractMetric"}], "//", 
                 "ToCanonical"}], ")"}]}], ";", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"res", "=", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{"ChangeCovD", "[", 
                    RowBox[{"#", ",", "$CovDsNotInduced", ",", "cd1"}], "]"}],
                     "&"}], "@", "\[IndentingNewLine]", 
                    RowBox[{"ChristoffelToGradConformal", "[", 
                    RowBox[{
                    "#", ",", "$CovDsNotInducedRelatedTocd1", ",", "cd1"}], 
                    "]"}]}], "&"}], "@", "\[IndentingNewLine]", 
                    RowBox[{"MyChangeChristoffel", "[", 
                    RowBox[{
                    "#", ",", "$CovDsNotInducedRelatedTocd1", ",", "cd1"}], 
                    "]"}]}], "&"}], "@", "\[IndentingNewLine]", 
                    RowBox[{"ChangeCovD", "[", 
                    RowBox[{"#", ",", "$CovDsNotInduced", ",", "cd1"}], 
                    "]"}]}], "&"}], "@", "\[IndentingNewLine]", 
                  RowBox[{"ChangeCurvature", "[", 
                   RowBox[{"#", ",", "$CovDsNotInduced", ",", "cd1"}], 
                   "]"}]}], "&"}], "@", "preexpression"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"Off", "[", 
               StyleBox[
                RowBox[{"ConformalRules", "::", "unknown"}], "MessageName"], 
               StyleBox["]", "MessageName"]}], 
              StyleBox[";", "MessageName"], 
              StyleBox["\[IndentingNewLine]", "MessageName"], 
              StyleBox["\[IndentingNewLine]", "MessageName"], 
              RowBox[{
               StyleBox["Fold", "MessageName"], 
               StyleBox["[", "MessageName"], 
               StyleBox[
                RowBox[{
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{"#1", "/.", 
                    RowBox[{"ConformalRules", "[", 
                    RowBox[{
                    RowBox[{"MetricOfCovD", "[", "#2", "]"}], ",", 
                    "metric1"}], "]"}]}], ")"}], "&"}], ",", "res", ",", 
                 "$CovDsNotInducedRelatedTocd1"}], "MessageName"], "]"}]}]}], 
            "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}]}], 
       "\[IndentingNewLine]", "]"}]}], 
     StyleBox["\[IndentingNewLine]", "MessageName"], 
     StyleBox["]", "MessageName"]}]}], 
   StyleBox[";", "MessageName"]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ToMetric", "[", "expr_", "]"}], ":=", 
    RowBox[{"ToMetric", "[", 
     RowBox[{"expr", ",", 
      RowBox[{"First", "@", "$Metrics"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"SetNumberOfArguments", "[", 
  RowBox[{"ToMetric", ",", 
   RowBox[{"{", 
    RowBox[{"1", ",", "2"}], "}"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "ToMetric", "]"}], ";"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{"InverseMetricQ", "[", 
   RowBox[{"x_", "?", "xTensorQ"}], "]"}], ":=", 
  RowBox[{"With", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"tid", "=", 
      RowBox[{"TensorID", "@", "x"}]}], "}"}], ",", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{
       RowBox[{"Length", "@", "tid"}], ">", "0"}], ")"}], "&&", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"tid", "[", 
        RowBox[{"[", "1", "]"}], "]"}], "===", 
       "xAct`xTensor`Private`InvMetric"}], ")"}]}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"InverseMetricQ", "[", "_", "]"}], ":=", "False"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"SeparateIndicesDownOfInverseMetric", "[", 
     RowBox[{"invmetric_", "?", "InverseMetricQ"}], "]"}], "[", "expr_", 
    "]"}], ":=", 
   RowBox[{"Fold", "[", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"SeparateMetric", "[", 
        RowBox[{"First", "@", "$Metrics"}], "]"}], "[", 
       RowBox[{"#1", ",", "#2"}], "]"}], "&"}], ",", "expr", ",", 
     RowBox[{
      RowBox[{"IndicesOf", "[", 
       RowBox[{"Down", ",", "invmetric"}], "]"}], "[", "expr", "]"}]}], 
    "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SeparateIndicesDownOfInverseMetric", "[", "_", "]"}], "[", 
   "expr_", "]"}], ":=", "expr"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"Conformal", "[", 
      RowBox[{"metricbase_", "?", "MetricQ"}], "]"}], "[", 
     RowBox[{
      RowBox[{"metric1_", "?", "MetricQ"}], ",", 
      RowBox[{"metric2_", "?", "MetricQ"}]}], "]"}], "[", "expr_", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"cdb", ",", "cd1", ",", "cd2", ",", "res", ",", "res2", ",", 
       RowBox[{"(*", 
        RowBox[{"oldpre", ","}], "*)"}], "resbis", ",", "exprnoproj", ",", 
       "M", ",", "i1", ",", "i2", ",", "beforeputtingconfheads", ",", 
       "IDInvMetric"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "The", " ", "conflict", " ", "with", " ", "CreenDollarIndicea", " ", 
       "has", " ", "now", " ", "been", " ", 
       RowBox[{"solved", ".", " ", "So"}], " ", "there", " ", "is", " ", "no",
        " ", "need", " ", "to", " ", "redefine", " ", "tempararoly", " ", 
       "$PrePrint"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"oldpre", "=", "$PrePrint"}], ";", 
       RowBox[{"$PrePrint", "=", "Identity"}], ";"}], "*)"}], 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
       "we", " ", "define", " ", "the", " ", "Covds", " ", "associated", " ", 
        "with", " ", "the", " ", 
        RowBox[{"metric", ".", " ", "The"}], " ", "starting", " ", "metric", 
        " ", "is", " ", "metric1"}], ",", " ", 
       RowBox[{
       "the", " ", "conformally", " ", "transformed", " ", "metric", " ", 
        "is", " ", "metric2"}], ",", " ", 
       RowBox[{
       "and", " ", "metricbase", " ", "i", " ", "the", " ", "base", " ", 
        "metric", " ", "for", " ", "raising", " ", "and", " ", "lowering", 
        " ", 
        RowBox[{"indiced", ".", " ", "It"}], " ", "might", " ", "be", " ", 
        "one", " ", "of", " ", "the", " ", "other", " ", "two"}], ",", " ", 
       RowBox[{
        RowBox[{"but", " ", "it", " ", "might", " ", "not", " ", "be"}], 
        "..."}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"cdb", "=", 
       RowBox[{"CovDOfMetric", "[", "metricbase", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"cd1", "=", 
       RowBox[{"CovDOfMetric", "[", "metric1", "]"}]}], ";", 
      RowBox[{"Off", "[", 
       RowBox[{"ConformalFactor", "::", "\"\<unknown\>\""}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"cd2", "=", 
       RowBox[{"CovDOfMetric", "[", "metric2", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"exprnoproj", "=", 
       RowBox[{"expr", "//", "ProjectorToMetric"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"M", "=", 
       RowBox[{"ManifoldOfCovD", "[", "cd1", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"i1", "=", 
       RowBox[{"DummyIn", "[", 
        RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"i2", "=", 
       RowBox[{"DummyIn", "[", 
        RowBox[{"Tangent", "[", "M", "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"IDInvMetric", "=", 
       RowBox[{"SeparateIndicesDownOfInverseMetric", "[", 
        RowBox[{"Inv", "[", "metric1", "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"beforeputtingconfheads", "=", 
       RowBox[{
        RowBox[{"IDInvMetric", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"IndicesDown", "@", 
             RowBox[{"ToMetric", "[", 
              RowBox[{"exprnoproj", ",", "metric1"}], "]"}]}], ")"}], 
           "\[IndentingNewLine]", "/.", 
           RowBox[{
            RowBox[{"Scalar", "[", "ex_", "]"}], "\[RuleDelayed]", 
            RowBox[{"Scalar", "[", 
             RowBox[{"IndicesDown", "[", "ex", "]"}], "]"}]}]}], "/.", 
          RowBox[{
           RowBox[{
            RowBox[{"sf_", "?", "ScalarFunctionQ"}], "[", "args___", "]"}], 
           "\[RuleDelayed]", 
           RowBox[{"sf", "@@", 
            RowBox[{"IndicesDown", "/@", 
             RowBox[{"{", "args", "}"}]}]}]}]}], "]"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"/.", 
          RowBox[{
           RowBox[{"Scalar", "[", "ex_", "]"}], "\[RuleDelayed]", 
           RowBox[{"Scalar", "[", 
            RowBox[{"IDInvMetric", "[", "ex", "]"}], "]"}]}]}], "/.", 
         RowBox[{
          RowBox[{
           RowBox[{"sf_", "?", "ScalarFunctionQ"}], "[", "args___", "]"}], 
          "\[RuleDelayed]", 
          RowBox[{"sf", "@@", 
           RowBox[{"IDInvMetric", "/@", 
            RowBox[{"{", "args", "}"}]}]}]}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Above", " ", "we", " ", "make", " ", "sure", " ", "that", " ", 
        "IndicesDown", " ", "and", " ", "SeparateIndicesDownOfInverseMetric", 
        " ", "goes", " ", "inside", " ", "the", " ", "scalar", " ", "Head"}], 
       "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "We", " ", "use", " ", "ToMetric", " ", "to", " ", "have", " ", "only",
         " ", "references", " ", "to", " ", "the", " ", "metric1", " ", "and",
         " ", "its", " ", "associated", " ", "CovD", " ", "and", " ", 
        "curvature", " ", "tensors"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Print", "[", 
         RowBox[{
         "\"\<beforeputtingconfheads \>\"", ",", "beforeputtingconfheads"}], 
         "]"}], ";"}], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Then", " ", "we", " ", "place", " ", "the", " ", "ConfHead", " ", 
        "on", " ", "every", " ", "expression", " ", "to", " ", "perform", " ",
         "formally", " ", "the", " ", "conformal", " ", 
        RowBox[{"transformation", "."}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"res", "=", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"beforeputtingconfheads", "\[IndentingNewLine]", 
             RowBox[{"(*", " ", 
              RowBox[{
              "Dirty", " ", "case", " ", "of", " ", "scalar", " ", 
               "functions"}], " ", "*)"}], "\[IndentingNewLine]", "/.", 
             RowBox[{
              RowBox[{
               RowBox[{"f_", "?", "ScalarFunctionQ"}], "[", "ex___", "]"}], 
              "\[RuleDelayed]", 
              RowBox[{
               RowBox[{"ConfHead", "[", 
                RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
               RowBox[{"f", "[", "ex", "]"}], "]"}]}]}], 
            "\[IndentingNewLine]", 
            RowBox[{"(*", " ", "tensors", " ", "*)"}], "\[IndentingNewLine]", 
            "/.", 
            RowBox[{
             RowBox[{
              RowBox[{"tens_", "?", "xTensorQ"}], "[", "inds___", "]"}], ":>", 
             RowBox[{
              RowBox[{"ConfHead", "[", 
               RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
              RowBox[{"tens", "[", "inds", "]"}], "]"}]}]}], 
           "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{"Covariant", " ", "derivatives"}], " ", "*)"}], 
           "\[IndentingNewLine]", "/.", 
           RowBox[{
            RowBox[{"cd1", "[", 
             RowBox[{"i1_", "?", "DownIndexQ"}], "]"}], ":>", 
            RowBox[{"cd2", "[", "i1", "]"}]}]}], "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{
           "Now", " ", "that", " ", "we", " ", "have", " ", "ConfHead", " ", 
            "everywhere", " ", "we", " ", "need", " ", "to", " ", "remove", 
            " ", "the", " ", "head", " ", "by", " ", "specifying", " ", "the",
             " ", "change"}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{
           "First", " ", "Obvious", " ", "rules", " ", "for", " ", "metric", 
            " ", "and", " ", "inverse", " ", "metric"}], "*)"}], 
          "\[IndentingNewLine]", "/.", 
          RowBox[{
           RowBox[{
            RowBox[{"ConfHead", "[", 
             RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
            RowBox[{"metric1", "[", 
             RowBox[{
              RowBox[{"i1_", "?", "DownIndexQ"}], ",", 
              RowBox[{"i2_", "?", "DownIndexQ"}]}], "]"}], "]"}], ":>", 
           RowBox[{"metric2", "[", 
            RowBox[{"i1", ",", "i2"}], "]"}]}]}], "\[IndentingNewLine]", "/.", 
         RowBox[{
          RowBox[{
           RowBox[{"ConfHead", "[", 
            RowBox[{"metric1", ",", "metric2"}], "]"}], "[", 
           RowBox[{
            RowBox[{"Inv", "[", "metric1", "]"}], "[", 
            RowBox[{
             RowBox[{"i1_", "?", "UpIndexQ"}], ",", 
             RowBox[{"i2_", "?", "UpIndexQ"}]}], "]"}], "]"}], ":>", 
          RowBox[{
           RowBox[{"Inv", "[", "metric2", "]"}], "[", 
           RowBox[{"i1", ",", "i2"}], "]"}]}]}], ")"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "And", " ", "then", " ", "all", " ", "other", " ", "rules", " ", "to", 
        " ", "remove", " ", "the", " ", "ConfHead"}], "*)"}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"resbis", "=", 
       RowBox[{"res", "//.", 
        RowBox[{"RulesConf", "[", 
         RowBox[{"metric1", ",", "metric2"}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
        "So", " ", "here", " ", "we", " ", "have", " ", "conformally", " ", 
         "transformed", " ", "the", " ", "expression"}], ",", " ", 
        RowBox[{
         RowBox[{
          RowBox[{
          "but", " ", "now", " ", "we", " ", "want", " ", "to", " ", 
           "express", " ", "it", " ", "in", " ", "function", " ", "of", " ", 
           "the", " ", "original", " ", "metric", " ", "and", " ", "orginal", 
           " ", "covD", " ", "etc"}], "..."}], "\[IndentingNewLine]", 
         "Indeed", " ", "at", " ", "that", " ", "point"}], ",", " ", 
        RowBox[{
        "we", " ", "still", " ", "have", " ", "the", " ", "second", " ", 
         "metric"}], ",", " ", 
        RowBox[{
        "and", " ", "the", " ", "Riemann", " ", "of", " ", "the", " ", 
         "second", " ", "metric", " ", "for", " ", 
         RowBox[{"instance", ".", " ", "SO"}], " ", "we", " ", "use", " ", 
         "again", " ", "ToMetric"}]}], "*)"}], "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"$PrePrint", "=", "oldpre"}], ";"}], "*)"}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"On", "[", 
       RowBox[{"ConformalFactor", "::", "\"\<unknown\>\""}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Off", "[", 
       RowBox[{"ToCanonical", "::", "\"\<cmods\>\""}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"res2", "=", 
       RowBox[{"ToCanonical", "@", 
        RowBox[{"ContractMetric", "@", 
         RowBox[{"NoScalar", "[", 
          RowBox[{"ToMetric", "[", 
           RowBox[{"resbis", ",", "metricbase"}], "]"}], "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"On", "[", 
       RowBox[{"ToCanonical", "::", "\"\<cmods\>\""}], "]"}], ";", 
      "\[IndentingNewLine]", "res2"}]}], "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
    "In", " ", "case", " ", "the", " ", "base", " ", "metric", " ", "is", " ",
      "unspecified"}], ",", " ", 
    RowBox[{
     RowBox[{
     "it", " ", "is", " ", "the", " ", "base", " ", "metric", " ", "of", " ", 
      "course"}], "..."}]}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Conformal", "[", 
    RowBox[{
     RowBox[{"metric1_", "?", "MetricQ"}], ",", 
     RowBox[{"metric2_", "?", "MetricQ"}]}], "]"}], "[", "expr_", "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{"Conformal", "[", 
     RowBox[{"First", "@", "$Metrics"}], "]"}], "[", 
    RowBox[{"metric1", ",", "metric2"}], "]"}], "[", "expr", 
   "]"}]}]}], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["Splitting in 1 + 1 + (n - 2) of covariant derivatives", "Subsubsection"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SplitPerturbations", "[", 
    RowBox[{"expr_", ",", "ListPairs_List", ",", 
     RowBox[{"h_", "?", "InducedMetricQ"}], ",", 
     RowBox[{"n_", "?", "DirectionVectorQ"}]}], "]"}], ":=", 
   RowBox[{"Print", "[", "\"\<Dobidoouah\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SplitPerturbations", "[", 
   RowBox[{"expr_", ",", 
    RowBox[{"h_", "?", "InducedMetricQ"}], ",", 
    RowBox[{"n_", "?", "DirectionVectorQ"}]}], "]"}], ":=", 
  RowBox[{"SplitPerturbations", "[", 
   RowBox[{"expr", ",", 
    RowBox[{"{", "}"}], ",", "h", ",", "n"}], "]"}]}], "\n", 
 RowBox[{"SetNumberOfArguments", "[", 
  RowBox[{"SplitPerturbations", ",", 
   RowBox[{"{", 
    RowBox[{"3", ",", "4"}], "}"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "SplitPerturbations", "]"}], ";"}]}], "Input",
 InitializationCell->True]
}, Open  ]],

Cell[CellGroupData[{

Cell["Automatization of the whole process", "Subsubsection"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ToLightConeFromRules", "[", 
     RowBox[{"expr_", ",", "RulesList_List", ",", 
      RowBox[{"h_", "?", "InducedMetricQ"}], ",", 
      RowBox[{"n_", "?", "DirectionVectorQ"}], ",", "order_"}], 
     RowBox[{"(*", 
      RowBox[{"?", "IntegerQ"}], "*)"}], "]"}], ":=", 
    RowBox[{"Print", "[", "\"\<Dobidoouah\>\"", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"SetNumberOfArguments", "[", 
  RowBox[{"ToLightConeFromRules", ",", 
   RowBox[{"{", 
    RowBox[{"4", ",", "5"}], "}"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{"Protect", "[", "ToLightConeFromRules", "]"}]}], "Input",
 InitializationCell->True]
}, Open  ]],

Cell[CellGroupData[{

Cell["Vizualization of the results", "Subsubsection"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ExtractComponents", "[", 
     RowBox[{"expr_", ",", 
      RowBox[{"h_", "?", "InducedMetricQ"}], ",", 
      RowBox[{"n_", "?", "DirectionVectorQ"}], ",", "roj_List", ",", 
      "ListIndsToContract_List"}], "]"}], ":=", 
    RowBox[{"Print", "[", "\"\<Dobidoouah\>\"", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetNumberOfArguments", "[", 
   RowBox[{"ExtractComponents", ",", 
    RowBox[{"{", 
     RowBox[{"3", ",", "5"}], "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Protect", "[", "ExtractComponents", "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"VisualizeTensor", "[", 
     RowBox[{"expr_", ",", 
      RowBox[{"h_", "?", "InducedMetricQ"}], ",", 
      RowBox[{"n_", "?", "DirectionVectorQ"}]}], "]"}], ":=", 
    RowBox[{"Print", "[", "\"\<Dobidoouah\>\"", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetNumberOfArguments", "[", 
   RowBox[{"VisualizeTensor", ",", "3"}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "VisualizeTensor", "]"}], ";"}]}], "Input",
 InitializationCell->True]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["End private and package",
 FontColor->RGBColor[0, 0, 1]]], "Subsubsection"],

Cell[BoxData[
 RowBox[{
  RowBox[{"On", "[", 
   RowBox[{"RuleDelayed", "::", "rhs"}], "]"}], ";"}]], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{"End", "[", "]"}], "\[IndentingNewLine]", 
 RowBox[{"EndPackage", "[", "]"}]}], "Input",
 InitializationCell->True],

Cell[BoxData["\<\"xAct`xLightCone`Private`\"\>"], "Output"]
}, Open  ]]
}, Closed]]
}, Open  ]]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
WindowSize->{1081, 860},
WindowMargins->{{Automatic, 159}, {Automatic, 10}},
PrivateNotebookOptions->{"FileOutlineCache"->False},
ShowSelection->True,
TrackCellChangeTimes->False,
Magnification->1,
FrontEndVersion->"9.0 for Mac OS X x86 (32-bit, 64-bit Kernel) (November 20, \
2012)",
StyleDefinitions->FrontEnd`FileName[{"Creative"}, "PastelColor.nb", 
  CharacterEncoding -> "UTF-8"]
]

